<body>

    <nav class="tab-nav">
        <div class="tab-nav-item active" data-tab="list"><span>ğŸ“‹</span>ãƒªã‚¹ãƒˆ</div>
        <div class="tab-nav-item" data-tab="status"><span>ğŸ“Š</span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
        <div class="tab-nav-item" data-tab="journal"><span>ğŸ“</span>ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</div>
    </nav>

    <!-- ãƒªã‚¹ãƒˆã‚¿ãƒ– -->
    <div id="tab-list" class="tab-content active">
        <header>
            <div class="bar">
                <div class="bar-title">ãƒªã‚¹ãƒˆ</div>
                <button class="bar-btn" id="refreshBtn">â†»</button>
            </div>
        </header>
        <main>
            <div id="missionTaskContainer"></div>
            <div class="add">
                <input id="newTitle" placeholder="ğŸ’ª ä»Šæ—¥ã‚‚é›ãˆã‚‹ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›â€¦" />
                <button id="btnAdd">è¿½åŠ </button>
            </div>
            <div class="divider-label">ğŸ¯ ToDoã‚¿ã‚¹ã‚¯</div>
            <div id="critical" class="list"></div>
            <div id="high" class="list"></div>
            <div id="active" class="list"></div>
            <div class="divider-label">âœ… é”æˆã‚¿ã‚¹ã‚¯</div>
            <div id="completed" class="list"></div>
        </main>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ– -->
    <div id="tab-status" class="tab-content">
        <header>
            <div class="bar">
                <div class="bar-title">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                <button class="bar-btn" id="statusRefreshBtn">â†»</button>
            </div>
        </header>
        <main>
            <div class="status-section daily-task-card" id="dailyTaskCard">
                <div class="daily-task-header">
                    <div class="status-section-title"><span>ğŸ‹ï¸</span> ãƒ‡ã‚¤ãƒªãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</div>
                    <span class="daily-task-arrow">â–¼</span>
                </div>
                <div class="daily-task-content">
                    <div class="habit-list" id="habitList"></div>
                    <div class="daily-task-buttons">
                        <button class="daily-btn daily-btn-cancel" id="habitCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="daily-btn daily-btn-save" id="habitSaveBtn">ğŸ’ª è¨˜éŒ²ã™ã‚‹</button>
                    </div>
                </div>
            </div>
            <div class="status-section">
                <div class="week-view-header">
                    <div class="status-section-title" style="margin-bottom:0;"><span>ğŸ“…</span> é€±é–“ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ­ã‚°</div>
                    <button class="detail-view-btn" id="openMonthlyAnalysis"><span>ğŸ“Š</span> è©³ã—ãè¦‹ã‚‹</button>
                </div>
                <table class="week-table" id="weekTable">
                    <thead><tr><th>ç¿’æ…£</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th><th>æ—¥</th></tr></thead>
                    <tbody id="weekTableBody"></tbody>
                </table>
            </div>
            <div class="status-section">
                <div class="status-section-title"><span>ğŸ’ª</span> æˆé•·åˆ†æ</div>
                <div class="progress-bar-container">
                    <div class="progress-label">
                        <span class="progress-label-name">é€±é–“é”æˆç‡</span>
                        <span class="progress-label-value" id="weekProgressValue">0%</span>
                    </div>
                    <div class="progress-bar-bg"><div class="progress-bar-fill" id="weekProgressBar" style="width:0%"></div></div>
                </div>
            </div>
        </main>
    </div>

    <!-- ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚¿ãƒ– -->
    <div id="tab-journal" class="tab-content">
        <header>
            <div class="bar">
                <div class="bar-title">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</div>
                <button class="bar-btn" id="journalRefreshBtn">â†»</button>
            </div>
        </header>
        <main>
            <div class="journal-form">
                <div class="status-section-title" style="margin-bottom:16px;"><span>ğŸ“</span> ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²</div>
                <div class="form-group">
                    <label class="form-label">æ—¥ä»˜</label>
                    <input type="date" class="form-input" id="journalDate" />
                </div>
                <div class="form-group">
                    <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" class="form-input" id="journalTitle" placeholder="ä»Šæ—¥ã®ã²ã¨ã“ã¨â€¦" />
                </div>
                <div class="form-group">
                    <label class="form-label">æŒ¯ã‚Šè¿”ã‚Šå†…å®¹</label>
                    <textarea class="form-textarea" id="journalContent" placeholder="ä»Šæ—¥ã®æˆé•·ã‚’è¨˜éŒ²ã—ã‚ˆã†â€¦"></textarea>
                </div>
                <button class="journal-submit-btn" id="journalSubmitBtn">ğŸ’ª è¨˜éŒ²ã‚’ä¿å­˜</button>
            </div>
            <div class="divider-label">ğŸ“š éå»ã®è¨˜éŒ²</div>
            <div class="journal-list" id="journalList"></div>
        </main>
    </div>

    <!-- ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="journalDetailModal" class="modal-root">
        <div class="modal-backdrop" id="journalDetailBackdrop"></div>
        <div class="modal-panel" style="max-height:80vh;overflow-y:auto;">
            <div id="journalViewContent" class="journal-view-content">
                <div class="journal-modal-header">
                    <div>
                        <div class="journal-modal-date" id="journalModalDate"></div>
                        <div class="journal-modal-title" id="journalModalTitle"></div>
                    </div>
                    <button id="closeJournalDetail" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
                </div>
                <div class="journal-tasks-section">
                    <div class="journal-tasks-header"><span>âœ“</span> ã“ã®æ—¥ã«é”æˆã—ãŸã‚¿ã‚¹ã‚¯</div>
                    <div class="journal-tasks-list" id="journalModalTasks"></div>
                </div>
                <div class="journal-content-section">
                    <div class="journal-content-label">æŒ¯ã‚Šè¿”ã‚Šå†…å®¹</div>
                    <div class="journal-content-body" id="journalModalContent"></div>
                </div>
                <div class="journal-modal-actions">
                    <button class="journal-close-btn" id="journalCloseBtn">é–‰ã˜ã‚‹</button>
                    <button class="journal-edit-modal-btn" id="journalEditBtn">âœï¸ ç·¨é›†ã™ã‚‹</button>
                </div>
            </div>
            <div id="journalEditContent" class="journal-edit-form">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;margin-top:10px;">
                    <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;">ğŸ“ ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ç·¨é›†</div>
                    <button id="closeJournalEdit" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
                </div>
                <div class="form-group"><label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" class="form-input" id="editJournalTitle" /></div>
                <div class="form-group"><label class="form-label">å†…å®¹</label><textarea class="form-textarea" id="editJournalContent" style="min-height:150px;"></textarea></div>
                <div class="journal-modal-actions">
                    <button class="journal-close-btn" id="journalCancelEditBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="journal-edit-modal-btn" id="journalSaveEditBtn">ğŸ’ª ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æœˆé–“åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="monthlyAnalysisModal" class="modal-root">
        <div class="modal-backdrop" id="monthlyAnalysisBackdrop"></div>
        <div class="modal-panel" style="max-height:85vh;overflow-y:auto;">
            <div class="monthly-analysis-header">
                <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;">ğŸ“Š æœˆé–“ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°åˆ†æ</div>
                <button id="closeMonthlyAnalysis" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
            </div>
            <div class="month-selector">
                <button class="month-selector-btn" id="prevMonthBtn">&lt;</button>
                <div class="current-month" id="currentMonthLabel"></div>
                <button class="month-selector-btn" id="nextMonthBtn">&gt;</button>
            </div>
            <div class="monthly-stats-summary" style="margin-top:16px;">
                <div class="monthly-stat-card"><div class="monthly-stat-value" id="monthlyTotalDays">0</div><div class="monthly-stat-label">è¨˜éŒ²æ—¥æ•°</div></div>
                <div class="monthly-stat-card"><div class="monthly-stat-value" id="monthlyAchievement">0%</div><div class="monthly-stat-label">ç·åˆé”æˆç‡</div></div>
                <div class="monthly-stat-card"><div class="monthly-stat-value" id="monthlyBestStreak">0</div><div class="monthly-stat-label">æœ€é•·é€£ç¶š</div></div>
            </div>
            <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:14px;margin:16px 0 8px;">ğŸ“… æ—¥åˆ¥é”æˆçŠ¶æ³</div>
            <div class="monthly-table-container">
                <table class="monthly-table">
                    <thead><tr><th>æ—¥ä»˜</th><th>ğŸŒ…</th><th>ğŸ¯</th><th>ğŸ“š</th><th>ğŸ“</th><th>ğŸš«</th><th>ğŸ’ª</th><th>é”æˆ</th></tr></thead>
                    <tbody id="monthlyTableBody"></tbody>
                </table>
            </div>
            <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:14px;margin:16px 0 8px;">ğŸ“ˆ é”æˆç‡ã®æ¨ç§»</div>
            <div class="monthly-chart-container"><canvas id="monthlyChart"></canvas></div>
        </div>
    </div>

    <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="detailModal" class="modal-root">
        <div id="detailBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;" id="modalTitle">ã‚¿ã‚¹ã‚¯è©³ç´°</div>
                <button id="detailCloseBtn" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
            </div>
            <div id="detailTaskTitle" style="font-size:14px;color:var(--text-secondary);margin:8px 0 16px;padding:10px;background:var(--bg-main);border-radius:10px;"></div>
            <div id="scoreGroup">
                <div class="slider-group"><div class="slider-label-row"><span>ğŸ¯ å„ªå…ˆåº¦</span><span class="value" id="valPriority"></span></div><input id="inputPriority" type="range" min="0" max="10" step="1" style="width:100%" /></div>
                <div class="slider-group"><div class="slider-label-row"><span>ğŸ”® ãƒ“ã‚¸ãƒ§ãƒ³é–¢é€£åº¦</span><span class="value" id="valVision"></span></div><input id="inputVision" type="range" min="0" max="10" step="1" style="width:100%" /></div>
                <div class="slider-group"><div class="slider-label-row"><span>âœ¨ ã‚ãã‚ãåº¦</span><span class="value" id="valExcite"></span></div><input id="inputExcite" type="range" min="0" max="10" step="1" style="width:100%" /></div>
                <div class="slider-group"><div class="slider-label-row"><span>ğŸ’ª æˆé•·åº¦</span><span class="value" id="valGrowth"></span></div><input id="inputGrowth" type="range" min="0" max="10" step="1" style="width:100%" /></div>
            </div>
            <div id="remindGroup" class="slider-group">
                <div class="slider-label-row"><span>ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ‰æ—¥æ™‚</span><span class="value" id="valRemindAt"></span></div>
                <input id="inputRemindAt" type="datetime-local" style="width:100%;padding:12px;border:2px solid rgba(13,27,42,0.1);border-radius:12px;font-size:14px;" />
            </div>
            <div class="modal-footer">
                <button id="detailCancelBtn" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="detailSaveBtn" class="btn-primary-solid">ğŸ’ª ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å„ªå…ˆé †ä½é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="priorityModal" class="modal-root">
        <div id="priorityBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;margin-bottom:10px;">
                <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;">âš¡ å„ªå…ˆé †ä½ã‚’è¨­å®š</div>
                <button id="priorityCloseBtn" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
            </div>
            <div id="priorityTaskTitle" style="font-size:14px;color:var(--text-secondary);margin-bottom:16px;"></div>
            <div class="priority-selector">
                <div class="priority-option critical" data-priority="critical">
                    <div class="priority-option-icon">ğŸ”¥</div>
                    <div class="priority-option-text">
                        <div class="priority-option-title">æœ€é‡è¦</div>
                        <div class="priority-option-desc">ä»Šã™ãå–ã‚Šçµ„ã‚€ã¹ãæœ€å„ªå…ˆã‚¿ã‚¹ã‚¯</div>
                    </div>
                </div>
                <div class="priority-option high" data-priority="high">
                    <div class="priority-option-icon">âš¡</div>
                    <div class="priority-option-text">
                        <div class="priority-option-title">é‡è¦</div>
                        <div class="priority-option-desc">å„ªå…ˆçš„ã«å‡¦ç†ã™ã¹ãã‚¿ã‚¹ã‚¯</div>
                    </div>
                </div>
                <div class="priority-option normal" data-priority="normal">
                    <div class="priority-option-icon">ğŸ“Œ</div>
                    <div class="priority-option-text">
                        <div class="priority-option-title">ãƒãƒ¼ãƒãƒ«</div>
                        <div class="priority-option-desc">é€šå¸¸ã®å„ªå…ˆåº¦ã«æˆ»ã™</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008372898-2q9qWmxv";
        const API_BASE = "https://lumicreate.xvps.jp/webhook";

        let userId = null;
        let currentDetailTask = null;
        let currentPriorityTask = null;
        let modalMode = "detail";

        const HABITS = [
            { id: 'early_wake', name: 'æ—©èµ·ã', icon: 'ğŸŒ…' },
            { id: 'mission', name: 'ãƒŸãƒƒã‚·ãƒ§ãƒ³', icon: 'ğŸ¯' },
            { id: 'reading', name: 'èª­æ›¸/å­¦ç¿’', icon: 'ğŸ“š' },
            { id: 'journal', name: 'ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«', icon: 'ğŸ“' },
            { id: 'no_alcohol', name: 'ç¦é…’', icon: 'ğŸš«' },
            { id: 'workout', name: 'ä»Šæ—¥ãƒˆãƒ¬', icon: 'ğŸ’ª' }
        ];

        let todayHabits = {};
        let weekHabitsData = {};
        let currentMission = null;
        let missionCompletedToday = false;
        let selectedMonth = new Date();
        let monthlyChart = null;
        let currentEditJournal = null;
        let journalsData = [];

        const STRONG_RATIO = 0.85;
        const SNAP_THRESHOLD = 40;
        let isDraggingCard = false;

        const criticalEl = document.getElementById("critical");
        const highEl = document.getElementById("high");
        const activeEl = document.getElementById("active");
        const completedEl = document.getElementById("completed");

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                userId = profile.userId;
            } catch (e) {
                console.error("LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e);
                userId = "demo_user";
            }
            bindUI();
            await loadAllData();
        }

        function bindUI() {
            document.querySelectorAll('.tab-nav-item').forEach(item => {
                item.addEventListener('click', () => switchTab(item.dataset.tab));
            });
            document.getElementById('refreshBtn').onclick = loadList;
            document.getElementById('btnAdd').onclick = addTask;
            document.getElementById('newTitle').addEventListener('keypress', e => { if (e.key === 'Enter') addTask(); });
            document.getElementById('statusRefreshBtn').onclick = loadHabits;
            document.getElementById('dailyTaskCard').addEventListener('click', e => {
                if (!e.target.closest('.habit-checkbox') && !e.target.closest('.daily-btn')) {
                    document.getElementById('dailyTaskCard').classList.toggle('expanded');
                }
            });
            document.getElementById('habitSaveBtn').onclick = saveHabits;
            document.getElementById('habitCancelBtn').onclick = () => document.getElementById('dailyTaskCard').classList.remove('expanded');
            renderHabitList();
            document.getElementById('journalRefreshBtn').onclick = loadJournals;
            document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('journalSubmitBtn').onclick = saveJournal;
            bindModalUI();
            bindMonthlyAnalysisUI();
            bindJournalDetailModalUI();
            bindPriorityModalUI();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-nav-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab-nav-item[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        async function loadAllData() {
            await Promise.all([loadList(), loadMissionTask(), loadHabits(), loadJournals()]);
        }

        // ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¹ã‚¯
        async function loadMissionTask() {
            const demoData = {
                mission: { id: 'demo', title: 'ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³', description: 'æ¯æ—¥10åˆ†é–“ã®ç‘æƒ³ã‚’è¡Œã„ã€å¿ƒã‚’è½ã¡ç€ã‘ã‚ˆã†', expires_at: getNextSunday() },
                completed_today: false,
                today_completions: 42
            };
            try {
                const res = await fetch(`${API_BASE}/mission?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                currentMission = data.mission || null;
                missionCompletedToday = data.completed_today || false;
                renderMissionTask(data);
            } catch (e) {
                currentMission = demoData.mission;
                missionCompletedToday = demoData.completed_today;
                renderMissionTask(demoData);
            }
        }

        function getNextSunday() {
            const today = new Date();
            const daysUntilSunday = (7 - today.getDay()) % 7 || 7;
            const nextSunday = new Date(today);
            nextSunday.setDate(today.getDate() + daysUntilSunday);
            nextSunday.setHours(23, 59, 59);
            return nextSunday.toISOString();
        }

        function renderMissionTask(data) {
            const container = document.getElementById('missionTaskContainer');
            if (!data.mission) { container.innerHTML = ''; return; }
            const mission = data.mission;
            const completedToday = data.completed_today;
            const todayCount = data.today_completions || 0;
            const daysLeft = Math.ceil((new Date(mission.expires_at) - new Date()) / (1000 * 60 * 60 * 24));

            container.innerHTML = `
                <div class="mission-task-wrapper">
                    <div class="mission-achievement-bubble">ğŸ”¥ ${todayCount}äººãŒé”æˆ</div>
                    <div class="mission-task-card">
                        <div class="mission-task-header">
                            <div class="mission-task-badge"><span>ğŸ¯</span><span>WEEKLY MISSION</span></div>
                        </div>
                        <div class="mission-task-title">${mission.title || 'ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³'}</div>
                        <div class="mission-task-desc">${mission.description || ''}</div>
                        <div class="mission-task-actions">
                            <button class="mission-complete-btn ${completedToday ? 'completed' : ''}" id="missionCompleteBtn">
                                ${completedToday ? 'âœ“ COMPLETED' : 'ğŸ’ª CHALLENGE'}
                            </button>
                            <div class="mission-expire">æ®‹ã‚Š${daysLeft}æ—¥</div>
                        </div>
                    </div>
                </div>`;
            document.getElementById('missionCompleteBtn').addEventListener('click', async () => {
                if (completedToday) return;
                await completeMission(mission.id);
            });
        }

        async function completeMission(missionId) {
            const updateUI = () => {
                missionCompletedToday = true;
                const btn = document.getElementById('missionCompleteBtn');
                if (btn) { btn.classList.add('completed'); btn.textContent = 'âœ“ COMPLETED'; }
            };
            try {
                const res = await fetch(`${API_BASE}/mission/complete`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, mission_id: missionId })
                });
                if (res.ok) { missionCompletedToday = true; await loadMissionTask(); }
                else updateUI();
            } catch (e) { updateUI(); }
        }

        // ãƒªã‚¹ãƒˆ
        async function loadList() {
            try {
                const res = await fetch(`${API_BASE}/list?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('API Error');
                renderList(await res.json());
            } catch (e) {
                renderList({ critical: [], high: [], active: [], completed: [] });
            }
        }

        function renderList(payload) {
            criticalEl.innerHTML = "";
            highEl.innerHTML = "";
            activeEl.innerHTML = "";
            completedEl.innerHTML = "";

            const critical = Array.isArray(payload.critical) ? payload.critical : [];
            const high = Array.isArray(payload.high) ? payload.high : [];
            const active = Array.isArray(payload.active) ? payload.active : [];
            const completed = Array.isArray(payload.completed) ? payload.completed : [];

            // æ—§ãƒ”ãƒ³ä»˜ãã‚¿ã‚¹ã‚¯ã‚’å„ªå…ˆé †ä½ã«å¤‰æ›
            const pinned = Array.isArray(payload.pinned) ? payload.pinned : [];
            pinned.forEach(t => { t.priority_level = t.priority_level || 'high'; });

            [...critical, ...pinned.filter(t => t.priority_level === 'critical')].forEach(t => { t.priority_level = 'critical'; criticalEl.appendChild(taskCard(t, false)); });
            [...high, ...pinned.filter(t => t.priority_level === 'high')].forEach(t => { t.priority_level = 'high'; highEl.appendChild(taskCard(t, false)); });
            active.filter(t => !t.priority_level || t.priority_level === 'normal').forEach(t => { t.priority_level = 'normal'; activeEl.appendChild(taskCard(t, false)); });
            completed.forEach(t => completedEl.appendChild(taskCard(t, true)));
        }

        async function addTask() {
            const input = document.getElementById('newTitle');
            const title = input.value.trim();
            if (!title) return;
            await action("create", null, { task_name: title });
            input.value = "";
        }

        function taskCard(t, isCompleted = false) {
            const wrap = document.createElement("div");
            wrap.className = "card";
            const priorityLevel = t.priority_level || 'normal';
            wrap.classList.add(`priority-${priorityLevel}`);
            if (isCompleted) wrap.classList.add("completed");

            const rail = document.createElement("div");
            rail.className = "actions-rail";

            const left = document.createElement("div");
            left.className = "actions-left";
            if (!isCompleted) {
                left.append(mkBtn("å®Œäº†", () => action("complete", t.id), "btn-complete"), mkBtn("é€šçŸ¥", () => openRemind(t), "btn-plus2h"));
            } else {
                left.append(mkBtn("æœªå®Œ", () => action("uncomplete", t.id), "btn-complete"));
            }

            const right = document.createElement("div");
            right.className = "actions-right";
            right.append(
                mkBtn("è©³ç´°", () => openDetail(t), "btn-detail"),
                mkBtn("å„ªå…ˆ", () => openPriorityModal(t), "btn-priority"),
                mkBtn("å‰Šé™¤", () => action("delete", t.id), "btn-delete")
            );

            rail.append(left, right);

            const sl = document.createElement("div");
            sl.className = "sl";

            const leftBox = document.createElement("div");
            leftBox.style.cssText = "display:flex;align-items:center;gap:8px;flex:1;";

            // å„ªå…ˆé †ä½ãƒãƒƒã‚¸
            if (priorityLevel === 'critical') {
                const badge = document.createElement("span");
                badge.className = "priority-badge";
                badge.textContent = "æœ€é‡è¦";
                leftBox.appendChild(badge);
            } else if (priorityLevel === 'high') {
                const badge = document.createElement("span");
                badge.className = "priority-badge";
                badge.textContent = "é‡è¦";
                leftBox.appendChild(badge);
            }

            const titleEl = document.createElement("div");
            titleEl.className = "title";
            titleEl.textContent = t.task_name || t.title || "(ç„¡é¡Œ)";
            leftBox.appendChild(titleEl);

            const rightBox = document.createElement("div");
            rightBox.style.cssText = "display:flex;align-items:center;";

            if (t.remind_at) {
                const remindEl = document.createElement("div");
                remindEl.className = "remindAt";
                remindEl.textContent = formatRemindLabel(t.remind_at);
                rightBox.appendChild(remindEl);
            }

            const handle = document.createElement("div");
            handle.className = "handle";
            handle.textContent = "â˜°";
            rightBox.appendChild(handle);

            sl.append(leftBox, rightBox);
            wrap.append(rail, sl);

            requestAnimationFrame(() => {
                wrap.dataset.leftWidth = left.getBoundingClientRect().width || 140;
                wrap.dataset.rightWidth = right.getBoundingClientRect().width || 140;
            });

            // PCç‰ˆã‚¯ãƒªãƒƒã‚¯
            if (!/Mobi|Android/i.test(navigator.userAgent)) {
                sl.addEventListener("click", e => {
                    const rect = sl.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const leftW = Number(wrap.dataset.leftWidth) || 140;
                    const rightW = Number(wrap.dataset.rightWidth) || 140;
                    if (wrap.classList.contains("open-left") || wrap.classList.contains("open-right")) {
                        wrap.classList.remove("open-left", "open-right");
                        sl.style.transform = "translateX(0)";
                        return;
                    }
                    if (x < rect.width / 2) { wrap.classList.add("open-left"); sl.style.transform = `translateX(${leftW}px)`; }
                    else { wrap.classList.add("open-right"); sl.style.transform = `translateX(${-rightW}px)`; }
                });
            }

            // ã‚¹ãƒãƒ›ã‚¹ãƒ¯ã‚¤ãƒ—
            let startX = 0, dx = 0, isScrolling = null, isHandleDrag = false;
            wrap.addEventListener("touchstart", e => {
                if (isDraggingCard || e.target.closest("button")) return;
                if (e.target.closest(".handle")) { isHandleDrag = true; return; }
                isHandleDrag = false;
                startX = e.touches[0].clientX;
                dx = 0; isScrolling = null;
                sl.style.transition = "none";
            }, { passive: true });

            wrap.addEventListener("touchmove", e => {
                if (isDraggingCard || isHandleDrag || !e.touches.length) return;
                const dy = e.touches[0].clientY - (e.touches[0].clientY || 0);
                dx = e.touches[0].clientX - startX;
                if (isScrolling === null && (Math.abs(dx) > 8 || Math.abs(dy) > 8)) isScrolling = Math.abs(dy) > Math.abs(dx);
                if (isScrolling) return;
                if (Math.abs(dx) > 8) e.preventDefault();
                sl.style.transform = `translateX(${dx}px)`;
            }, { passive: false });

            wrap.addEventListener("touchend", () => {
                if (isDraggingCard) return;
                if (isHandleDrag || isScrolling) { isHandleDrag = false; sl.style.transition = ""; sl.style.transform = "translateX(0)"; return; }
                sl.style.transition = "transform .15s";
                const leftW = Number(wrap.dataset.leftWidth) || 140;
                const rightW = Number(wrap.dataset.rightWidth) || 140;
                if (dx > leftW * STRONG_RATIO) { isCompleted ? action("uncomplete", t.id) : action("complete", t.id); wrap.classList.remove("open-left", "open-right"); sl.style.transform = "translateX(0)"; return; }
                if (dx < -rightW * STRONG_RATIO) { action("delete", t.id); wrap.classList.remove("open-left", "open-right"); sl.style.transform = "translateX(0)"; return; }
                if (dx > SNAP_THRESHOLD) { wrap.classList.add("open-left"); wrap.classList.remove("open-right"); sl.style.transform = `translateX(${leftW}px)`; }
                else if (dx < -SNAP_THRESHOLD) { wrap.classList.add("open-right"); wrap.classList.remove("open-left"); sl.style.transform = `translateX(${-rightW}px)`; }
                else { wrap.classList.remove("open-left", "open-right"); sl.style.transform = "translateX(0)"; }
            });

            // ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆä¸¦ã³æ›¿ãˆï¼‰
            const startDrag = (startEvent) => {
                startEvent.preventDefault();
                startEvent.stopPropagation();
                const card = wrap, list = card.parentElement;
                if (!list) return;
                isDraggingCard = true;
                card.classList.remove("open-left", "open-right");
                sl.style.transition = ""; sl.style.transform = "translateX(0)";
                const cardRect = card.getBoundingClientRect();
                const startY = startEvent.clientY || (startEvent.touches && startEvent.touches[0].clientY);
                const cardStartTop = cardRect.top, cardHeight = cardRect.height;
                const placeholder = document.createElement("div");
                placeholder.className = "card drag-placeholder";
                placeholder.style.height = cardHeight + "px";
                list.insertBefore(placeholder, card);
                card.classList.add("dragging");
                card.style.cssText = `position:fixed;left:${cardRect.left}px;top:${cardRect.top}px;width:${cardRect.width}px;height:${cardHeight}px;pointer-events:none;`;
                document.body.style.userSelect = "none";
                document.body.appendChild(card);

                const getY = ev => ev.touches?.length ? ev.touches[0].clientY : ev.clientY;
                const onMove = ev => {
                    const currentY = getY(ev), deltaY = currentY - startY;
                    card.style.top = (cardStartTop + deltaY) + "px";
                    const cardCenterY = cardStartTop + deltaY + cardHeight / 2;
                    const siblings = Array.from(list.querySelectorAll(".card:not(.dragging)"));
                    for (const sibling of siblings) {
                        if (sibling === placeholder) continue;
                        const siblingRect = sibling.getBoundingClientRect();
                        if (cardCenterY < siblingRect.top + siblingRect.height / 2) { if (placeholder.nextSibling !== sibling) list.insertBefore(placeholder, sibling); return; }
                    }
                    if (placeholder.nextSibling !== null) list.appendChild(placeholder);
                };
                const onUp = () => {
                    document.removeEventListener("pointermove", onMove);
                    document.removeEventListener("pointerup", onUp);
                    document.removeEventListener("touchmove", onMove);
                    document.removeEventListener("touchend", onUp);
                    card.classList.remove("dragging");
                    card.style.cssText = "";
                    card.classList.remove("open-left", "open-right");
                    const slEl = card.querySelector(".sl");
                    if (slEl) { slEl.style.transition = ""; slEl.style.transform = "translateX(0)"; }
                    if (placeholder?.parentNode === list) { list.insertBefore(card, placeholder); placeholder.remove(); }
                    else if (list) { list.appendChild(card); placeholder?.parentNode?.removeChild(placeholder); }
                    document.body.style.userSelect = "";
                    setTimeout(() => isDraggingCard = false, 100);
                    saveSortOrder();
                };
                document.addEventListener("pointermove", onMove);
                document.addEventListener("pointerup", onUp);
                document.addEventListener("touchmove", onMove, { passive: false });
                document.addEventListener("touchend", onUp);
            };
            handle.addEventListener("pointerdown", e => { e.preventDefault(); startDrag(e); });
            handle.addEventListener("touchstart", e => { e.preventDefault(); e.stopPropagation(); startDrag(e); }, { passive: false });

            wrap.__taskData = t;
            wrap.dataset.taskId = t.id;
            return wrap;
        }

        async function saveSortOrder() {
            if (!userId) return;
            const orders = [];
            [criticalEl, highEl, activeEl, completedEl].forEach((listEl, idx) => {
                const section = ['critical', 'high', 'active', 'completed'][idx];
                listEl.querySelectorAll('.card').forEach((card, index) => {
                    const t = card.__taskData;
                    if (t) orders.push({ id: t.id, sort_order: index, section });
                });
            });
            if (orders.length) await action("sort_update", null, { orders });
        }

        // å„ªå…ˆé †ä½ãƒ¢ãƒ¼ãƒ€ãƒ«
        function bindPriorityModalUI() {
            const modal = document.getElementById('priorityModal');
            const close = () => { modal.classList.remove('visible'); currentPriorityTask = null; };
            document.getElementById('priorityBackdrop').onclick = close;
            document.getElementById('priorityCloseBtn').onclick = close;
            document.querySelectorAll('.priority-option').forEach(opt => {
                opt.addEventListener('click', async () => {
                    if (!currentPriorityTask) return;
                    const priority = opt.dataset.priority;
                    await action("set_priority", currentPriorityTask.id, { priority_level: priority });
                    close();
                });
            });
        }

        function openPriorityModal(t) {
            currentPriorityTask = t;
            document.getElementById('priorityTaskTitle').textContent = t.task_name || t.title || "(ç„¡é¡Œ)";
            document.getElementById('priorityModal').classList.add('visible');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        function renderHabitList() {
            const container = document.getElementById('habitList');
            container.innerHTML = HABITS.map(h => `<div class="habit-item" data-habit="${h.id}"><div class="habit-checkbox" data-habit="${h.id}"></div><span class="habit-name">${h.name}</span><span class="habit-icon">${h.icon}</span></div>`).join('');
            container.querySelectorAll('.habit-item').forEach(item => {
                item.addEventListener('click', e => {
                    e.stopPropagation();
                    const id = item.dataset.habit, cb = item.querySelector('.habit-checkbox');
                    todayHabits[id] = !todayHabits[id];
                    cb.classList.toggle('checked', todayHabits[id]);
                    cb.textContent = todayHabits[id] ? 'âœ“' : '';
                    item.classList.toggle('checked', todayHabits[id]);
                });
            });
        }

        async function loadHabits() {
            try {
                const res = await fetch(`${API_BASE}/habits?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error();
                const data = await res.json();
                weekHabitsData = data.week || {};
                todayHabits = data.today || {};
                renderWeekView();
                renderHabitAnalysis(data);
                updateHabitCheckboxes();
            } catch (e) { renderWeekView(); renderHabitAnalysis({ week_progress: 0 }); }
        }

        function updateHabitCheckboxes() {
            document.querySelectorAll('.habit-item').forEach(item => {
                const id = item.dataset.habit, cb = item.querySelector('.habit-checkbox'), isChecked = !!todayHabits[id];
                cb.classList.toggle('checked', isChecked);
                cb.textContent = isChecked ? 'âœ“' : '';
                item.classList.toggle('checked', isChecked);
            });
        }

        function renderWeekView() {
            const tbody = document.getElementById('weekTableBody');
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            tbody.innerHTML = HABITS.map(h => `<tr><td>${h.icon} ${h.name}</td>${days.map(d => `<td class="${weekHabitsData[d]?.[h.id] ? 'checked' : 'unchecked'}">${weekHabitsData[d]?.[h.id] ? 'â—' : 'â—‹'}</td>`).join('')}</tr>`).join('');
        }

        function renderHabitAnalysis(data) {
            const progress = data.week_progress || 0;
            document.getElementById('weekProgressValue').textContent = `${progress}%`;
            document.getElementById('weekProgressBar').style.width = `${progress}%`;
        }

        async function saveHabits() {
            try {
                await fetch(`${API_BASE}/habits/save`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: userId, date: new Date().toISOString().split('T')[0], habits: todayHabits }) });
                document.getElementById('dailyTaskCard').classList.remove('expanded');
                await loadHabits();
                alert('ğŸ’ª è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            } catch (e) { alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
        }

        // æœˆé–“åˆ†æ
        function bindMonthlyAnalysisUI() {
            const modal = document.getElementById('monthlyAnalysisModal');
            const close = () => modal.classList.remove('visible');
            document.getElementById('openMonthlyAnalysis').onclick = () => { selectedMonth = new Date(); modal.classList.add('visible'); loadMonthlyData(); };
            document.getElementById('monthlyAnalysisBackdrop').onclick = close;
            document.getElementById('closeMonthlyAnalysis').onclick = close;
            document.getElementById('prevMonthBtn').onclick = () => { selectedMonth.setMonth(selectedMonth.getMonth() - 1); loadMonthlyData(); };
            document.getElementById('nextMonthBtn').onclick = () => {
                const now = new Date();
                if (selectedMonth.getFullYear() < now.getFullYear() || (selectedMonth.getFullYear() === now.getFullYear() && selectedMonth.getMonth() < now.getMonth())) {
                    selectedMonth.setMonth(selectedMonth.getMonth() + 1);
                    loadMonthlyData();
                }
            };
        }

        async function loadMonthlyData() {
            const year = selectedMonth.getFullYear(), month = selectedMonth.getMonth() + 1;
            document.getElementById('currentMonthLabel').textContent = `${year}å¹´${month}æœˆ`;
            try {
                const res = await fetch(`${API_BASE}/habits/monthly?user_id=${encodeURIComponent(userId)}&year=${year}&month=${month}`);
                if (!res.ok) throw new Error();
                renderMonthlyAnalysis(await res.json());
            } catch (e) { renderMonthlyAnalysis(generateDemoMonthlyData(year, month)); }
        }

        function generateDemoMonthlyData(year, month) {
            const daysInMonth = new Date(year, month, 0).getDate(), days = {};
            for (let d = 1; d <= daysInMonth; d++) {
                if (Math.random() > 0.3) {
                    days[`${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`] = {
                        early_wake: Math.random() > 0.4, mission: Math.random() > 0.5, reading: Math.random() > 0.3,
                        journal: Math.random() > 0.4, no_alcohol: Math.random() > 0.2, workout: Math.random() > 0.5
                    };
                }
            }
            return { days };
        }

        function renderMonthlyAnalysis(data) {
            const days = data.days || {}, year = selectedMonth.getFullYear(), month = selectedMonth.getMonth() + 1;
            const daysInMonth = new Date(year, month, 0).getDate();
            let totalChecks = 0, totalPossible = 0, currentStreak = 0, bestStreak = 0;
            const dailyRates = [];
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`, dayData = days[dateStr];
                if (dayData) {
                    const checked = Object.values(dayData).filter(v => v).length;
                    totalChecks += checked; totalPossible += 6; currentStreak++;
                    bestStreak = Math.max(bestStreak, currentStreak);
                    dailyRates.push({ day: d, rate: Math.round((checked / 6) * 100) });
                } else { currentStreak = 0; dailyRates.push({ day: d, rate: 0 }); }
            }
            document.getElementById('monthlyTotalDays').textContent = Object.keys(days).length;
            document.getElementById('monthlyAchievement').textContent = `${totalPossible ? Math.round((totalChecks / totalPossible) * 100) : 0}%`;
            document.getElementById('monthlyBestStreak').textContent = bestStreak;

            const tbody = document.getElementById('monthlyTableBody');
            tbody.innerHTML = Array.from({ length: daysInMonth }, (_, i) => {
                const d = i + 1, dateStr = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayData = days[dateStr], dow = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][new Date(dateStr).getDay()];
                const cells = HABITS.map(h => `<td class="${dayData?.[h.id] ? 'cell-check' : 'cell-uncheck'}">${dayData?.[h.id] ? 'â—' : 'â—‹'}</td>`).join('');
                const dayChecked = dayData ? Object.values(dayData).filter(v => v).length : 0;
                return `<tr><td>${month}/${d}(${dow})</td>${cells}<td>${dayChecked}/6</td></tr>`;
            }).join('');

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            if (monthlyChart) monthlyChart.destroy();
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: { labels: dailyRates.map(d => `${d.day}æ—¥`), datasets: [{ label: 'é”æˆç‡', data: dailyRates.map(d => d.rate), borderColor: '#ff9f43', backgroundColor: 'rgba(255,159,67,0.15)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#ff9f43' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { stepSize: 25, callback: v => `${v}%` } }, x: { ticks: { maxTicksLimit: 10 } } }, plugins: { legend: { display: false } } }
            });
        }

        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
        async function loadJournals() {
            try {
                const res = await fetch(`${API_BASE}/journals?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error();
                journalsData = (await res.json()).journals || [];
            } catch (e) { journalsData = generateDemoJournals(); }
            renderJournals(journalsData);
        }

        function generateDemoJournals() {
            return Array.from({ length: 5 }, (_, i) => {
                const d = new Date(); d.setDate(d.getDate() - i);
                return { id: `demo-${i}`, date: d.toISOString().split('T')[0], title: ['ä»Šæ—¥ã‚‚é ‘å¼µã£ãŸ','å……å®Ÿã—ãŸä¸€æ—¥','æ–°ã—ã„ç™ºè¦‹','ã¾ã‚ã¾ã‚ã®æ—¥','åçœç‚¹ã‚ã‚Š'][i], content: `ä»Šæ—¥ã¯é ‘å¼µã£ãŸã€‚`, tasks_completed_count: Math.floor(Math.random() * 6) + 1 };
            });
        }

        function renderJournals(journals) {
            const container = document.getElementById('journalList');
            if (!journals.length) { container.innerHTML = '<div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
            container.innerHTML = journals.map(j => `<div class="journal-card" data-id="${j.id}"><div class="journal-card-header"><div class="journal-date">ğŸ“… ${formatDate(j.date)}</div><div class="journal-tasks-count">âœ“ ${j.tasks_completed_count || 0}ã‚¿ã‚¹ã‚¯é”æˆ</div></div><div class="journal-title-text">${j.title || 'ç„¡é¡Œ'}</div><div class="journal-preview">${(j.content || '').substring(0, 50)}...</div></div>`).join('');
            container.querySelectorAll('.journal-card').forEach(card => card.onclick = () => {
                const j = journalsData.find(x => x.id == card.dataset.id);
                if (j) openJournalDetailModal(j);
            });
        }

        function openJournalDetailModal(journal) {
            currentEditJournal = journal;
            document.getElementById('journalViewContent').classList.remove('hidden');
            document.getElementById('journalEditContent').classList.remove('active');
            const d = new Date(journal.date);
            document.getElementById('journalModalDate').textContent = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
            document.getElementById('journalModalTitle').textContent = journal.title || 'ç„¡é¡Œ';
            document.getElementById('journalModalContent').textContent = journal.content || 'å†…å®¹ãªã—';
            document.getElementById('journalModalTasks').innerHTML = (journal.completed_tasks || HABITS.slice(0, journal.tasks_completed_count || 0).map(h => h.name)).map(t => `<span class="journal-task-chip">${t}</span>`).join('') || '<span style="color:var(--text-muted);font-size:12px;">é”æˆã‚¿ã‚¹ã‚¯ãªã—</span>';
            document.getElementById('journalDetailModal').classList.add('visible');
        }

        function bindJournalDetailModalUI() {
            const modal = document.getElementById('journalDetailModal');
            const close = () => { modal.classList.remove('visible'); currentEditJournal = null; };
            document.getElementById('journalDetailBackdrop').onclick = close;
            document.getElementById('closeJournalDetail').onclick = close;
            document.getElementById('journalCloseBtn').onclick = close;
            document.getElementById('closeJournalEdit').onclick = close;
            document.getElementById('journalEditBtn').onclick = () => {
                if (!currentEditJournal) return;
                document.getElementById('journalViewContent').classList.add('hidden');
                document.getElementById('journalEditContent').classList.add('active');
                document.getElementById('editJournalTitle').value = currentEditJournal.title || '';
                document.getElementById('editJournalContent').value = currentEditJournal.content || '';
            };
            document.getElementById('journalCancelEditBtn').onclick = () => {
                document.getElementById('journalViewContent').classList.remove('hidden');
                document.getElementById('journalEditContent').classList.remove('active');
            };
            document.getElementById('journalSaveEditBtn').onclick = async () => {
                if (!currentEditJournal) return;
                const newTitle = document.getElementById('editJournalTitle').value.trim();
                const newContent = document.getElementById('editJournalContent').value.trim();
                currentEditJournal.title = newTitle; currentEditJournal.content = newContent;
                document.getElementById('journalModalTitle').textContent = newTitle || 'ç„¡é¡Œ';
                document.getElementById('journalModalContent').textContent = newContent || 'å†…å®¹ãªã—';
                document.getElementById('journalViewContent').classList.remove('hidden');
                document.getElementById('journalEditContent').classList.remove('active');
                renderJournals(journalsData);
                alert('ğŸ’ª æ›´æ–°ã—ã¾ã—ãŸï¼');
            };
        }

        async function saveJournal() {
            const date = document.getElementById('journalDate').value;
            const title = document.getElementById('journalTitle').value.trim();
            const content = document.getElementById('journalContent').value.trim();
            if (!title && !content) { alert('ã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            journalsData.unshift({ id: `demo-${Date.now()}`, date, title, content, tasks_completed_count: 0 });
            document.getElementById('journalTitle').value = '';
            document.getElementById('journalContent').value = '';
            renderJournals(journalsData);
            alert('ğŸ’ª ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«
        function bindModalUI() {
            const modal = document.getElementById('detailModal');
            const close = () => modal.classList.remove("visible");
            document.getElementById('detailBackdrop').onclick = close;
            document.getElementById('detailCloseBtn').onclick = close;
            document.getElementById('detailCancelBtn').onclick = close;
            ['Priority', 'Vision', 'Excite', 'Growth'].forEach(name => {
                const input = document.getElementById(`input${name}`), val = document.getElementById(`val${name}`);
                input.addEventListener('input', () => val.textContent = input.value);
            });
            document.getElementById('inputRemindAt').addEventListener('change', e => {
                document.getElementById('valRemindAt').textContent = e.target.value ? formatRemindLabel(new Date(e.target.value).toISOString()) : '';
            });
            document.getElementById('detailSaveBtn').onclick = async () => {
                if (!currentDetailTask) return;
                if (modalMode === "detail") {
                    await action("update_detail", currentDetailTask.id, {
                        priority: Number(document.getElementById('inputPriority').value),
                        vision_score: Number(document.getElementById('inputVision').value),
                        excite_score: Number(document.getElementById('inputExcite').value),
                        growth_score: Number(document.getElementById('inputGrowth').value),
                    });
                } else {
                    const inputVal = document.getElementById('inputRemindAt').value;
                    await action("remind_custom", currentDetailTask.id, { remind_at: inputVal ? new Date(inputVal).toISOString() : null, kind: inputVal ? "custom_datetime" : "clear" });
                }
                close();
            };
        }

        function openDetail(t) {
            modalMode = "detail"; currentDetailTask = t;
            document.getElementById('modalTitle').textContent = "ğŸ’ª ã‚¿ã‚¹ã‚¯è©³ç´°";
            document.getElementById('detailTaskTitle').textContent = t.task_name || t.title || "(ç„¡é¡Œ)";
            document.getElementById('scoreGroup').style.display = "block";
            document.getElementById('remindGroup').style.display = "none";
            ['Priority', 'Vision', 'Excite', 'Growth'].forEach(name => {
                const val = t[name.toLowerCase() + (name === 'Priority' ? '' : '_score')] ?? 0;
                document.getElementById(`input${name}`).value = val;
                document.getElementById(`val${name}`).textContent = val;
            });
            document.getElementById('detailModal').classList.add("visible");
        }

        function openRemind(t) {
            modalMode = "remind"; currentDetailTask = t;
            document.getElementById('modalTitle').textContent = "ğŸ”” é€šçŸ¥è¨­å®š";
            document.getElementById('detailTaskTitle').textContent = t.task_name || t.title || "(ç„¡é¡Œ)";
            document.getElementById('scoreGroup').style.display = "none";
            document.getElementById('remindGroup').style.display = "block";
            const input = document.getElementById('inputRemindAt'), val = document.getElementById('valRemindAt');
            if (t.remind_at) { input.value = toLocalDatetimeValue(t.remind_at); val.textContent = formatRemindLabel(t.remind_at); }
            else { input.value = ''; val.textContent = ''; }
            document.getElementById('detailModal').classList.add("visible");
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function mkBtn(label, onClick, cls) {
            const b = document.createElement("button");
            b.textContent = label; if (cls) b.className = cls;
            b.addEventListener("click", e => { e.stopPropagation(); e.preventDefault(); onClick(); });
            return b;
        }

        async function action(kind, id, extra = {}) {
            try {
                const res = await fetch(`${API_BASE}/action`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ user_id: userId, action: kind, task_id: id, ...extra }) });
                if (!res.ok) alert("æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ");
            } catch (e) { console.error("[ACTION] error:", e); }
            finally { if (kind !== "remind_custom") loadList(); }
        }

        function formatRemindLabel(iso) { if (!iso) return ""; const d = new Date(iso); return `ğŸ””${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`; }
        function toLocalDatetimeValue(iso) { if (!iso) return ""; const d = new Date(iso); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
        function formatDate(dateStr) { const d = new Date(dateStr); return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }

        init();
    </script>
</body>
</html>
<body>

    <nav class="tab-nav">
        <div class="tab-nav-item active" data-tab="list">ãƒªã‚¹ãƒˆ</div>
        <div class="tab-nav-item" data-tab="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
        <div class="tab-nav-item" data-tab="journal">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</div>
    </nav>

    <!-- ãƒªã‚¹ãƒˆã‚¿ãƒ– -->
    <div id="tab-list" class="tab-content active">
        <header>
            <div class="bar">
                <div class="bar-title">ãƒªã‚¹ãƒˆ</div>
                <div class="bar-add">
                    <input id="newTitle" placeholder="ğŸ’ª ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›â€¦" />
                    <button id="btnAdd">è¿½åŠ </button>
                </div>
                <button class="bar-btn" id="refreshBtn">â†»</button>
            </div>
        </header>
        <main>
            <div id="missionTaskContainer"></div>
            <div class="divider-label">ğŸ¯ ToDoã‚¿ã‚¹ã‚¯</div>
            <div id="critical" class="list"></div>
            <div id="high" class="list"></div>
            <div id="active" class="list"></div>
            <div class="divider-label">âœ… é”æˆã‚¿ã‚¹ã‚¯</div>
            <div id="completed" class="list"></div>
        </main>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ– -->
    <div id="tab-status" class="tab-content">
        <header>
            <div class="bar">
                <div class="bar-title">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                <button class="msc-open-btn" id="mscOpenBtn">MSC</button>
                <button class="bar-btn" id="statusRefreshBtn">â†»</button>
            </div>
        </header>
        <main>
            <!-- MSC æˆé•·ã‚«ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤ºãƒ»å…¨ç”»é¢è¡¨ç¤ºï¼‰ -->
            <div id="msc-card-view" class="msc-view">
                <button class="msc-close-btn" id="mscCloseBtn">&times;</button>
                <div class="msc-container">
                    <div class="msc-card">
                        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                        <div class="msc-header">
                            <div class="msc-header-left">
                                <div class="msc-icon">ğŸ’ª</div>
                                <div class="msc-title-area">
                                    <div class="msc-title">ãƒ ã‚­ãƒ ã‚­å±æ€§</div>
                                    <div class="msc-mbti-tag" id="mscMbtiTag" onclick="openMbtiModal()">MBTIæœªè¨­å®š</div>
                                </div>
                            </div>
                            <div class="msc-header-right">
                                <div class="msc-level-badge" id="mscLevelBadge">Lv.1 è¦‹ç¿’ã„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ¼</div>
                                <div class="msc-level-score">
                                    <span class="msc-stars" id="mscStars">â˜…â˜…â˜…â˜…â˜†</span>
                                    <span class="msc-score" id="mscScore">3.5</span>
                                </div>
                                <div class="msc-exp-bar"><div class="msc-exp-fill" id="mscExpFill" style="width:35%"></div></div>
                                <div class="msc-exp-text" id="mscExpText">350 / 1000 EXP</div>
                            </div>
                        </div>

                        <!-- ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ -->
                        <div class="msc-radar-section">
                            <div class="msc-radar-container">
                                <canvas id="mscRadarChart"></canvas>
                            </div>
                            <div class="msc-radar-date" id="mscRadarDate">â€»ç´¯è¨ˆãƒ‡ãƒ¼ã‚¿åŸºæº–</div>
                        </div>

                        <!-- å¼·ã¿ -->
                        <div class="msc-traits-section">
                            <div class="msc-traits-title msc-strength-title">å¼·ã¿</div>
                            <div id="mscStrengths">
                                <div class="msc-trait-item">
                                    <div class="msc-trait-icon">ğŸŒ…</div>
                                    <div class="msc-trait-content">
                                        <div class="msc-trait-header">
                                            <span class="msc-trait-name">è¦å¾‹ã‚·ãƒ¼ãƒ«ãƒ‰</span>
                                            <span class="msc-trait-level">Lv.4.2</span>
                                        </div>
                                        <div class="msc-trait-desc">æ—©èµ·ãã¨ç¦é…’ã‚’ç¶™ç¶šã—ã€è¦å¾‹æ­£ã—ã„ç”Ÿæ´»ã‚’é€ã£ã¦ã„ã‚‹ã€‚</div>
                                    </div>
                                </div>
                                <div class="msc-trait-item">
                                    <div class="msc-trait-icon">ğŸ“š</div>
                                    <div class="msc-trait-content">
                                        <div class="msc-trait-header">
                                            <span class="msc-trait-name">æ¢ç©¶ãƒ–ãƒ¼ã‚¹ãƒˆ</span>
                                            <span class="msc-trait-level">Lv.3.8</span>
                                        </div>
                                        <div class="msc-trait-desc">èª­æ›¸ãƒ»å­¦ç¿’ç¿’æ…£ãŒæ ¹ä»˜ã„ã¦ãŠã‚Šã€çŸ¥çš„å¥½å¥‡å¿ƒãŒæ—ºç››ã€‚</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å¼±ã¿ -->
                        <div class="msc-traits-section">
                            <div class="msc-traits-title msc-weakness-title">å¼±ã¿</div>
                            <div id="mscWeaknesses">
                                <div class="msc-trait-item">
                                    <div class="msc-trait-icon">ğŸ“</div>
                                    <div class="msc-trait-content">
                                        <div class="msc-trait-header">
                                            <span class="msc-trait-name">å†…çœã‚¿ã‚¤ãƒ </span>
                                            <span class="msc-trait-level">Lv.2.1</span>
                                        </div>
                                        <div class="msc-trait-desc">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«è¨˜éŒ²ãŒä¸å®‰å®šã€‚æŒ¯ã‚Šè¿”ã‚Šã®ç¿’æ…£åŒ–ãŒèª²é¡Œã€‚</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç”Ÿæ…‹ãƒ¡ãƒ¢ -->
                        <div class="msc-bio-section">
                            <div class="msc-bio-title">ç”Ÿæ…‹ãƒ¡ãƒ¢</div>
                            <div class="msc-bio-text" id="mscBioText">
                                æœå‹ã®ç”Ÿæ´»ãƒªã‚ºãƒ ã‚’å¥½ã¿ã€ã‚³ãƒ„ã‚³ãƒ„ã¨ç©ã¿ä¸Šã’ã‚‹ã“ã¨ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã€‚
                                çŸ¥è­˜æ¬²ãŒå¼·ãã€å¸¸ã«æ–°ã—ã„ã“ã¨ã‚’å­¦ã¼ã†ã¨ã™ã‚‹å§¿å‹¢ã‚’æŒã¤ã€‚
                            </div>
                        </div>

                        <div class="msc-footer">Â©2025 ãƒ ã‚­ãƒ ã‚­ã‚¿ã‚¹ãã‚“</div>
                    </div>
                </div>
            </div>

            <!-- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ­ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºï¼‰ -->
            <div id="msc-log-view" class="msc-view">
                <div class="status-section daily-task-card" id="dailyTaskCard">
                    <div class="daily-task-header">
                        <div class="status-section-title"><span>ğŸ‹ï¸</span> ãƒ‡ã‚¤ãƒªãƒ¼ã‚¿ã‚¹ã‚¯</div>
                        <span class="daily-task-arrow">â–¼</span>
                    </div>
                    <div class="daily-task-content">
                        <div class="habit-list" id="habitList"></div>
                        <div class="daily-task-buttons">
                            <button class="daily-btn daily-btn-cancel" id="habitCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button class="daily-btn daily-btn-save" id="habitSaveBtn">ğŸ’ª è¨˜éŒ²ã™ã‚‹</button>
                        </div>
                    </div>
                </div>
                <div class="status-section">
                    <div class="week-view-header">
                        <div class="status-section-title" style="margin-bottom:0;"><span>ğŸ“…</span> é€±é–“ãƒ­ã‚°</div>
                        <button class="detail-view-btn" id="openMonthlyAnalysis"><span>ğŸ“Š</span> è©³ã—ãè¦‹ã‚‹</button>
                    </div>
                    <table class="week-table" id="weekTable">
                        <thead><tr><th>ç¿’æ…£</th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th>åœŸ</th><th>æ—¥</th></tr></thead>
                        <tbody id="weekTableBody"></tbody>
                    </table>
                </div>
                <div class="status-section">
                    <div class="status-section-title"><span>ğŸ’ª</span> æˆé•·åˆ†æ</div>
                    <div class="progress-bar-container">
                        <div class="progress-label">
                            <span class="progress-label-name">é€±é–“é”æˆç‡</span>
                            <span class="progress-label-value" id="weekProgressValue">0%</span>
                        </div>
                        <div class="progress-bar-bg"><div class="progress-bar-fill" id="weekProgressBar" style="width:0%"></div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚¿ãƒ– -->
    <div id="tab-journal" class="tab-content">
        <header>
            <div class="bar">
                <div class="bar-title">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</div>
                <button class="bar-btn" id="journalRefreshBtn">â†»</button>
            </div>
        </header>
        <main>
            <div class="journal-form">
                <div class="status-section-title" style="margin-bottom:16px;"><span>ğŸ“</span> ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²</div>
                <div class="form-group">
                    <label class="form-label">æ—¥ä»˜</label>
                    <input type="date" class="form-input" id="journalDate" />
                </div>
                <div class="form-group">
                    <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" class="form-input" id="journalTitle" placeholder="ä»Šæ—¥ã®ã²ã¨ã“ã¨â€¦" />
                </div>
                <div class="form-group">
                    <label class="form-label">æŒ¯ã‚Šè¿”ã‚Šå†…å®¹</label>
                    <textarea class="form-textarea" id="journalContent" placeholder="ä»Šæ—¥ã®æˆé•·ã‚’è¨˜éŒ²ã—ã‚ˆã†â€¦"></textarea>
                </div>
                <button class="journal-submit-btn" id="journalSubmitBtn">ğŸ’ª è¨˜éŒ²ã‚’ä¿å­˜</button>
            </div>
            <div class="divider-label">ğŸ“š éå»ã®è¨˜éŒ²</div>
            <div class="journal-list" id="journalList"></div>
        </main>
    </div>

    <!-- ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="journalDetailModal" class="modal-root">
        <div class="modal-backdrop" id="journalDetailBackdrop"></div>
        <div class="modal-panel" style="max-height:80vh;overflow-y:auto;">
            <div id="journalViewContent" class="journal-view-content">
                <div class="journal-modal-header">
                    <div>
                        <div class="journal-modal-date" id="journalModalDate"></div>
                        <div class="journal-modal-title" id="journalModalTitle"></div>
                    </div>
                    <button id="closeJournalDetail" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
                </div>
                <div class="journal-tasks-section">
                    <div class="journal-tasks-header"><span>âœ“</span> ã“ã®æ—¥ã«é”æˆã—ãŸã‚¿ã‚¹ã‚¯</div>
                    <div class="journal-tasks-list" id="journalModalTasks"></div>
                </div>
                <div class="journal-content-section">
                    <div class="journal-content-label">æŒ¯ã‚Šè¿”ã‚Šå†…å®¹</div>
                    <div class="journal-content-body" id="journalModalContent"></div>
                </div>
                <div class="journal-modal-actions">
                    <button class="journal-close-btn" id="journalCloseBtn">é–‰ã˜ã‚‹</button>
                    <button class="journal-edit-modal-btn" id="journalEditBtn">âœï¸ ç·¨é›†ã™ã‚‹</button>
                </div>
            </div>
            <div id="journalEditContent" class="journal-edit-form">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;margin-top:10px;">
                    <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;">ğŸ“ ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ç·¨é›†</div>
                    <button id="closeJournalEdit" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
                </div>
                <div class="form-group"><label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" class="form-input" id="editJournalTitle" /></div>
                <div class="form-group"><label class="form-label">å†…å®¹</label><textarea class="form-textarea" id="editJournalContent" style="min-height:150px;"></textarea></div>
                <div class="journal-modal-actions">
                    <button class="journal-close-btn" id="journalCancelEditBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="journal-edit-modal-btn" id="journalSaveEditBtn">ğŸ’ª ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æœˆé–“åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="monthlyAnalysisModal" class="modal-root">
        <div class="modal-backdrop" id="monthlyAnalysisBackdrop"></div>
        <div class="modal-panel" style="max-height:85vh;overflow-y:auto;">
            <div class="monthly-analysis-header">
                <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;">ğŸ“Š æœˆé–“ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°åˆ†æ</div>
                <button id="closeMonthlyAnalysis" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
            </div>
            <div class="month-selector">
                <button class="month-selector-btn" id="prevMonthBtn">&lt;</button>
                <div class="current-month" id="currentMonthLabel"></div>
                <button class="month-selector-btn" id="nextMonthBtn">&gt;</button>
            </div>
            <div class="monthly-stats-summary" style="margin-top:16px;">
                <div class="monthly-stat-card"><div class="monthly-stat-value" id="monthlyTotalDays">0</div><div class="monthly-stat-label">è¨˜éŒ²æ—¥æ•°</div></div>
                <div class="monthly-stat-card"><div class="monthly-stat-value" id="monthlyAchievement">0%</div><div class="monthly-stat-label">ç·åˆé”æˆç‡</div></div>
                <div class="monthly-stat-card"><div class="monthly-stat-value" id="monthlyBestStreak">0</div><div class="monthly-stat-label">æœ€é•·é€£ç¶š</div></div>
            </div>
            <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:14px;margin:16px 0 8px;">ğŸ“… æ—¥åˆ¥é”æˆçŠ¶æ³</div>
            <div class="monthly-table-container">
                <table class="monthly-table">
                    <thead><tr><th>æ—¥ä»˜</th><th>ğŸŒ…</th><th>ğŸ¯</th><th>ğŸ“š</th><th>ğŸ“</th><th>ğŸš«</th><th>ğŸ’ª</th><th>é”æˆ</th></tr></thead>
                    <tbody id="monthlyTableBody"></tbody>
                </table>
            </div>
            <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:14px;margin:16px 0 8px;">ğŸ“ˆ é”æˆç‡ã®æ¨ç§»</div>
            <div class="monthly-chart-container"><canvas id="monthlyChart"></canvas></div>
        </div>
    </div>

    <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="detailModal" class="modal-root">
        <div id="detailBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;" id="modalTitle">ã‚¿ã‚¹ã‚¯è©³ç´°</div>
                <button id="detailCloseBtn" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
            </div>
            <div id="detailTaskTitle" style="font-size:14px;color:var(--text-secondary);margin:8px 0 16px;padding:10px;background:var(--bg-main);border-radius:10px;"></div>
            <div id="scoreGroup">
                <div class="slider-group"><div class="slider-label-row"><span>ğŸ¯ å„ªå…ˆåº¦</span><span class="value" id="valPriority"></span></div><input id="inputPriority" type="range" min="0" max="10" step="1" style="width:100%" /></div>
                <div class="slider-group"><div class="slider-label-row"><span>ğŸ”® ãƒ“ã‚¸ãƒ§ãƒ³é–¢é€£åº¦</span><span class="value" id="valVision"></span></div><input id="inputVision" type="range" min="0" max="10" step="1" style="width:100%" /></div>
                <div class="slider-group"><div class="slider-label-row"><span>âœ¨ ã‚ãã‚ãåº¦</span><span class="value" id="valExcite"></span></div><input id="inputExcite" type="range" min="0" max="10" step="1" style="width:100%" /></div>
                <div class="slider-group"><div class="slider-label-row"><span>ğŸ’ª æˆé•·åº¦</span><span class="value" id="valGrowth"></span></div><input id="inputGrowth" type="range" min="0" max="10" step="1" style="width:100%" /></div>
            </div>
            <div id="remindGroup" class="slider-group">
                <div class="slider-label-row"><span>ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ‰æ—¥æ™‚</span><span class="value" id="valRemindAt"></span></div>
                <input id="inputRemindAt" type="datetime-local" style="width:100%;padding:12px;border:2px solid rgba(13,27,42,0.1);border-radius:12px;font-size:14px;" />
            </div>
            <div class="modal-footer">
                <button id="detailCancelBtn" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="detailSaveBtn" class="btn-primary-solid">ğŸ’ª ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- MBTIé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="mbtiModal" class="modal-root">
        <div id="mbtiBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel" style="max-height:80vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;margin-bottom:10px;">
                <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;">ğŸ§  MBTIã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</div>
                <button id="mbtiCloseBtn" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
            </div>
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">ã‚ãªãŸã®æ€§æ ¼ã‚¿ã‚¤ãƒ—ã‚’é¸ã‚“ã§ãã ã•ã„</div>
            <div class="mbti-grid" id="mbtiGrid">
                <div class="mbti-option" data-mbti="INTJ"><div class="mbti-option-type">INTJ</div><div class="mbti-option-name">å»ºç¯‰å®¶</div></div>
                <div class="mbti-option" data-mbti="INTP"><div class="mbti-option-type">INTP</div><div class="mbti-option-name">è«–ç†å­¦è€…</div></div>
                <div class="mbti-option" data-mbti="ENTJ"><div class="mbti-option-type">ENTJ</div><div class="mbti-option-name">æŒ‡æ®å®˜</div></div>
                <div class="mbti-option" data-mbti="ENTP"><div class="mbti-option-type">ENTP</div><div class="mbti-option-name">è¨è«–è€…</div></div>
                <div class="mbti-option" data-mbti="INFJ"><div class="mbti-option-type">INFJ</div><div class="mbti-option-name">æå”±è€…</div></div>
                <div class="mbti-option" data-mbti="INFP"><div class="mbti-option-type">INFP</div><div class="mbti-option-name">ä»²ä»‹è€…</div></div>
                <div class="mbti-option" data-mbti="ENFJ"><div class="mbti-option-type">ENFJ</div><div class="mbti-option-name">ä¸»äººå…¬</div></div>
                <div class="mbti-option" data-mbti="ENFP"><div class="mbti-option-type">ENFP</div><div class="mbti-option-name">åºƒå ±é‹å‹•å®¶</div></div>
                <div class="mbti-option" data-mbti="ISTJ"><div class="mbti-option-type">ISTJ</div><div class="mbti-option-name">ç®¡ç†è€…</div></div>
                <div class="mbti-option" data-mbti="ISFJ"><div class="mbti-option-type">ISFJ</div><div class="mbti-option-name">æ“è­·è€…</div></div>
                <div class="mbti-option" data-mbti="ESTJ"><div class="mbti-option-type">ESTJ</div><div class="mbti-option-name">å¹¹éƒ¨</div></div>
                <div class="mbti-option" data-mbti="ESFJ"><div class="mbti-option-type">ESFJ</div><div class="mbti-option-name">é ˜äº‹å®˜</div></div>
                <div class="mbti-option" data-mbti="ISTP"><div class="mbti-option-type">ISTP</div><div class="mbti-option-name">å·¨åŒ </div></div>
                <div class="mbti-option" data-mbti="ISFP"><div class="mbti-option-type">ISFP</div><div class="mbti-option-name">å†’é™ºå®¶</div></div>
                <div class="mbti-option" data-mbti="ESTP"><div class="mbti-option-type">ESTP</div><div class="mbti-option-name">èµ·æ¥­å®¶</div></div>
                <div class="mbti-option" data-mbti="ESFP"><div class="mbti-option-type">ESFP</div><div class="mbti-option-name">ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒŠãƒ¼</div></div>
            </div>
            <div class="modal-footer">
                <button id="mbtiClearBtn" class="btn-secondary">ã‚¯ãƒªã‚¢</button>
                <button id="mbtiSaveBtn" class="btn-primary-solid">ğŸ’ª ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å„ªå…ˆé †ä½é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="priorityModal" class="modal-root">
        <div id="priorityBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;margin-bottom:10px;">
                <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;">âš¡ å„ªå…ˆé †ä½ã‚’è¨­å®š</div>
                <button id="priorityCloseBtn" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
            </div>
            <div id="priorityTaskTitle" style="font-size:14px;color:var(--text-secondary);margin-bottom:16px;"></div>
            <div class="priority-selector">
                <div class="priority-option critical" data-priority="critical">
                    <div class="priority-option-icon">ğŸ”¥</div>
                    <div class="priority-option-text">
                        <div class="priority-option-title">æœ€é‡è¦</div>
                        <div class="priority-option-desc">ä»Šã™ãå–ã‚Šçµ„ã‚€ã¹ãæœ€å„ªå…ˆã‚¿ã‚¹ã‚¯</div>
                    </div>
                </div>
                <div class="priority-option high" data-priority="high">
                    <div class="priority-option-icon">âš¡</div>
                    <div class="priority-option-text">
                        <div class="priority-option-title">é‡è¦</div>
                        <div class="priority-option-desc">å„ªå…ˆçš„ã«å‡¦ç†ã™ã¹ãã‚¿ã‚¹ã‚¯</div>
                    </div>
                </div>
                <div class="priority-option normal" data-priority="normal">
                    <div class="priority-option-icon">ğŸ“Œ</div>
                    <div class="priority-option-text">
                        <div class="priority-option-title">ãƒãƒ¼ãƒãƒ«</div>
                        <div class="priority-option-desc">é€šå¸¸ã®å„ªå…ˆåº¦ã«æˆ»ã™</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008372898-2q9qWmxv";
        const API_BASE = "https://lumicreate.xvps.jp/webhook";

        let userId = null;
        let currentDetailTask = null;
        let currentPriorityTask = null;
        let modalMode = "detail";

        const HABITS = [
            { id: 'early_wake', name: 'æ—©èµ·ã', icon: 'ğŸŒ…' },
            { id: 'mission', name: 'ãƒŸãƒƒã‚·ãƒ§ãƒ³', icon: 'ğŸ¯' },
            { id: 'reading', name: 'èª­æ›¸/å­¦ç¿’', icon: 'ğŸ“š' },
            { id: 'journal', name: 'ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«', icon: 'ğŸ“' },
            { id: 'no_alcohol', name: 'ç¦é…’', icon: 'ğŸš«' },
            { id: 'workout', name: 'ä»Šæ—¥ãƒˆãƒ¬', icon: 'ğŸ’ª' }
        ];

        let todayHabits = {};
        let weekHabitsData = {};
        let currentMission = null;
        let missionCompletedToday = false;
        let selectedMonth = new Date();
        let monthlyChart = null;
        let currentEditJournal = null;
        let journalsData = [];
        let journalsGrouped = [];
        let openMonthKey = null;

        // MSCé–¢é€£
        let mscRadarChart = null;
        let userMbti = null;
        let selectedMbti = null;
        let mscData = {
            level: 1,
            exp: 0,
            totalExp: 1000,
            score: 0,
            radarData: { discipline: 0, purpose: 0, curiosity: 0, reflection: 0, action: 0, consistency: 0 },
            strengths: [],
            weaknesses: [],
            bio: ''
        };

        const MBTI_NAMES = {
            'INTJ': 'å»ºç¯‰å®¶', 'INTP': 'è«–ç†å­¦è€…', 'ENTJ': 'æŒ‡æ®å®˜', 'ENTP': 'è¨è«–è€…',
            'INFJ': 'æå”±è€…', 'INFP': 'ä»²ä»‹è€…', 'ENFJ': 'ä¸»äººå…¬', 'ENFP': 'åºƒå ±é‹å‹•å®¶',
            'ISTJ': 'ç®¡ç†è€…', 'ISFJ': 'æ“è­·è€…', 'ESTJ': 'å¹¹éƒ¨', 'ESFJ': 'é ˜äº‹å®˜',
            'ISTP': 'å·¨åŒ ', 'ISFP': 'å†’é™ºå®¶', 'ESTP': 'èµ·æ¥­å®¶', 'ESFP': 'ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒŠãƒ¼'
        };

        const LEVEL_TITLES = [
            { min: 1, max: 5, title: 'è¦‹ç¿’ã„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ¼' },
            { min: 6, max: 10, title: 'ãƒ«ãƒ¼ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ã‚¿ãƒ¼' },
            { min: 11, max: 20, title: 'ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã‚¦ã‚©ãƒªã‚¢ãƒ¼' },
            { min: 21, max: 35, title: 'ã‚·ãƒ«ãƒãƒ¼ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³' },
            { min: 36, max: 50, title: 'ã‚´ãƒ¼ãƒ«ãƒ‰ãƒã‚¹ã‚¿ãƒ¼' },
            { min: 51, max: 75, title: 'ãƒ—ãƒ©ãƒãƒŠã‚¨ãƒªãƒ¼ãƒˆ' },
            { min: 76, max: 100, title: 'ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰' },
            { min: 101, max: 999, title: 'ãƒ ã‚­ãƒ ã‚­ç¥' }
        ];

        const STRONG_RATIO = 0.85;
        const SNAP_THRESHOLD = 40;
        let isDraggingCard = false;

        const criticalEl = document.getElementById("critical");
        const highEl = document.getElementById("high");
        const activeEl = document.getElementById("active");
        const completedEl = document.getElementById("completed");

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                userId = profile.userId;
            } catch (e) {
                console.error("LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e);
                userId = "demo_user";
            }
            bindUI();
            await loadAllData();
        }

        function bindUI() {
            document.querySelectorAll('.tab-nav-item').forEach(item => {
                item.addEventListener('click', () => switchTab(item.dataset.tab));
            });
            document.getElementById('refreshBtn').onclick = loadList;
            document.getElementById('btnAdd').onclick = addTask;
            document.getElementById('newTitle').addEventListener('keypress', e => { if (e.key === 'Enter') addTask(); });
            document.getElementById('statusRefreshBtn').onclick = loadHabits;
            document.getElementById('dailyTaskCard').addEventListener('click', e => {
                if (!e.target.closest('.habit-checkbox') && !e.target.closest('.daily-btn')) {
                    document.getElementById('dailyTaskCard').classList.toggle('expanded');
                }
            });
            document.getElementById('habitSaveBtn').onclick = saveHabits;
            document.getElementById('habitCancelBtn').onclick = () => document.getElementById('dailyTaskCard').classList.remove('expanded');
            renderHabitList();
            document.getElementById('journalRefreshBtn').onclick = loadJournals;
            document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('journalSubmitBtn').onclick = saveJournal;
            bindModalUI();
            bindMonthlyAnalysisUI();
            bindJournalDetailModalUI();
            bindPriorityModalUI();
            bindMscUI();
            bindMbtiModalUI();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-nav-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab-nav-item[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        async function loadAllData() {
            await Promise.all([loadList(), loadMissionTask(), loadHabits(), loadJournals(), loadMscData()]);
        }

        // ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¹ã‚¯
        function getNextSunday() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysUntilSunday = (7 - dayOfWeek) % 7 || 7;
            const nextSunday = new Date(today);
            nextSunday.setDate(today.getDate() + daysUntilSunday);
            nextSunday.setHours(23, 59, 59);
            return nextSunday.toISOString();
        }

        async function loadMissionTask() {
            // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼ˆAPIãŒãªã„å ´åˆã«ä½¿ç”¨ï¼‰
            const demoData = {
                mission: {
                    id: 'demo',
                    title: 'ä»Šé€±ã®é™ç•Œçªç ´ãƒŸãƒƒã‚·ãƒ§ãƒ³',
                    description: 'æ¯æ—¥10åˆ†é–“ã®ç‘æƒ³ã§å¿ƒã‚’é›ãˆã€å†…ãªã‚‹ç‚ã‚’ç‡ƒã‚„ã›',
                    expires_at: getNextSunday()
                },
                completed_today: false,
                today_completions: 42
            };

            try {
                const res = await fetch(`${API_BASE}/mission?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                currentMission = data.mission || null;
                missionCompletedToday = data.completed_today || false;
                renderMissionTask(data);
            } catch (e) {
                console.log('Mission API unavailable, showing demo mission');
                currentMission = demoData.mission;
                missionCompletedToday = demoData.completed_today;
                renderMissionTask(demoData);
            }
        }

        function renderMissionTask(data) {
            const container = document.getElementById('missionTaskContainer');
            if (!data.mission) { container.innerHTML = ''; return; }
            const mission = data.mission;
            const completedToday = data.completed_today;
            const todayCount = data.today_completions || 0;
            const daysLeft = Math.ceil((new Date(mission.expires_at) - new Date()) / (1000 * 60 * 60 * 24));

            container.innerHTML = `
                <div class="mission-task-wrapper">
                    <div class="mission-achievement-bubble">ğŸ”¥ ${todayCount}äººãŒé”æˆ</div>
                    <div class="mission-task-card ${completedToday ? 'completed' : ''}" id="missionCard">
                        <div class="mission-peel-back"></div>
                        <img class="mission-completed-stamp" src="../ç”»åƒ/ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¹ã‚¯_COMPLETEDãƒãƒ³ã‚³.png" alt="COMPLETED" />
                        <div class="mission-task-header">
                            <div class="mission-task-badge"><span>ğŸ¯</span><span>WEEKLY MISSION</span></div>
                        </div>
                        <div class="mission-task-title">${mission.title || 'ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³'}</div>
                        <div class="mission-task-desc">${mission.description || ''}</div>
                        <div class="mission-task-actions">
                            <div class="mission-expire">æ®‹ã‚Š${daysLeft > 0 ? daysLeft : 0}æ—¥</div>
                        </div>
                        ${!completedToday ? '<div class="mission-swipe-hint">ã‚¹ãƒ¯ã‚¤ãƒ—ã§é”æˆ</div>' : ''}
                    </div>
                </div>`;

            // å®Œäº†æ¸ˆã¿ã§ãªã„å ´åˆã®ã¿ã‚¹ãƒ¯ã‚¤ãƒ—å‡¦ç†ã‚’è¨­å®š
            if (!completedToday) {
                setupMissionSwipe(mission.id);
            }
        }

        function setupMissionSwipe(missionId) {
            const card = document.getElementById('missionCard');
            if (!card) return;

            const peelBack = card.querySelector('.mission-peel-back');
            let startX = 0, currentX = 0, dx = 0;
            let isSwiping = false;
            const COMPLETE_THRESHOLD = 150; // ã“ã®è·é›¢ã‚’è¶…ãˆãŸã‚‰å®Œäº†

            const updatePeelEffect = (swipeDistance) => {
                // ã‚¹ãƒ¯ã‚¤ãƒ—è·é›¢ã«å¿œã˜ã¦ã‚ãã‚Œã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’æ›´æ–°
                const peelWidth = Math.min(Math.max(swipeDistance * 0.8, 0), 200);
                const shadowWidth = Math.min(Math.max(swipeDistance * 0.4, 0), 80);

                // è£é¢ã®å¹…ã‚’èª¿æ•´
                peelBack.style.width = `${peelWidth}px`;
                peelBack.style.transition = 'none';

                // å½±ã®å¹…ã‚’CSSå¤‰æ•°ã§èª¿æ•´
                card.style.setProperty('--peel-shadow', `${shadowWidth}px`);

                // ã‚«ãƒ¼ãƒ‰ã«è»½ã„å‚¾ãã‚’è¿½åŠ 
                const rotateY = Math.min(swipeDistance * 0.03, 8);
                const rotateZ = Math.min(swipeDistance * 0.01, 2);
                card.style.transform = `perspective(1000px) rotateY(${rotateY}deg) rotateZ(${rotateZ}deg)`;
                card.style.transition = 'none';

                // ã—ãã„å€¤ã‚’è¶…ãˆãŸã‚‰ã‚«ãƒ¼ãƒ‰ã«peelingã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                if (swipeDistance > 30) {
                    card.classList.add('peeling');
                } else {
                    card.classList.remove('peeling');
                }
            };

            const resetPeelEffect = () => {
                peelBack.style.transition = 'width 0.3s ease-out';
                peelBack.style.width = '0';
                card.style.transition = 'transform 0.3s ease-out';
                card.style.transform = '';
                card.classList.remove('peeling');
            };

            const completeMissionWithAnimation = async () => {
                // ã‚ãã‚Šå®Œäº†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                peelBack.style.transition = 'width 0.4s ease-out';
                peelBack.style.width = '100%';
                card.style.transition = 'transform 0.4s ease-out';
                card.style.transform = 'perspective(1000px) rotateY(15deg) rotateZ(3deg)';

                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤ºã¨å®Œäº†å‡¦ç†
                setTimeout(async () => {
                    card.classList.add('completed');
                    card.classList.remove('peeling');

                    // ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ’ãƒ³ãƒˆã‚’å‰Šé™¤
                    const hint = card.querySelector('.mission-swipe-hint');
                    if (hint) hint.remove();

                    // ã‚«ãƒ¼ãƒ‰ã‚’å…ƒã«æˆ»ã™
                    setTimeout(() => {
                        peelBack.style.width = '0';
                        card.style.transform = '';
                    }, 300);

                    await completeMission(missionId);
                }, 400);
            };

            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
            card.addEventListener('touchstart', (e) => {
                if (card.classList.contains('completed')) return;
                startX = e.touches[0].clientX;
                currentX = startX;
                isSwiping = true;
            }, { passive: true });

            card.addEventListener('touchmove', (e) => {
                if (!isSwiping || card.classList.contains('completed')) return;
                currentX = e.touches[0].clientX;
                dx = startX - currentX; // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ãªã®ã§æ­£ã®å€¤

                if (dx > 10) {
                    e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²æ­¢
                    updatePeelEffect(dx);
                }
            }, { passive: false });

            card.addEventListener('touchend', async () => {
                if (!isSwiping || card.classList.contains('completed')) return;
                isSwiping = false;

                if (dx >= COMPLETE_THRESHOLD) {
                    await completeMissionWithAnimation();
                } else {
                    resetPeelEffect();
                }
                dx = 0;
            });

            // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆPCå¯¾å¿œï¼‰
            let isMouseDown = false;

            card.addEventListener('mousedown', (e) => {
                if (card.classList.contains('completed')) return;
                startX = e.clientX;
                currentX = startX;
                isMouseDown = true;
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isMouseDown || card.classList.contains('completed')) return;
                currentX = e.clientX;
                dx = startX - currentX;

                if (dx > 10) {
                    updatePeelEffect(dx);
                }
            });

            document.addEventListener('mouseup', async () => {
                if (!isMouseDown || card.classList.contains('completed')) return;
                isMouseDown = false;

                if (dx >= COMPLETE_THRESHOLD) {
                    await completeMissionWithAnimation();
                } else {
                    resetPeelEffect();
                }
                dx = 0;
            });
        }

        async function completeMission(missionId) {
            const updateUI = () => {
                missionCompletedToday = true;
                const btn = document.getElementById('missionCompleteBtn');
                if (btn) {
                    btn.classList.add('completed');
                    btn.textContent = 'âœ“ COMPLETED';
                }
            };

            try {
                const res = await fetch(`${API_BASE}/mission/complete`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, mission_id: missionId })
                });
                if (res.ok) {
                    missionCompletedToday = true;
                    await loadMissionTask();
                } else {
                    updateUI();
                }
            } catch (e) {
                console.log('Mission complete - demo mode');
                updateUI();
            }
        }

        // ãƒªã‚¹ãƒˆ
        async function loadList() {
            try {
                const res = await fetch(`${API_BASE}/list?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('API Error');
                renderList(await res.json());
            } catch (e) {
                renderList({ critical: [], high: [], active: [], completed: [] });
            }
        }

        function renderList(payload) {
            criticalEl.innerHTML = "";
            highEl.innerHTML = "";
            activeEl.innerHTML = "";
            completedEl.innerHTML = "";

            const critical = Array.isArray(payload.critical) ? payload.critical : [];
            const high = Array.isArray(payload.high) ? payload.high : [];
            const active = Array.isArray(payload.active) ? payload.active : [];
            const completed = Array.isArray(payload.completed) ? payload.completed : [];

            critical.forEach(t => { t.priority_level = 'critical'; criticalEl.appendChild(taskCard(t, false)); });
            high.forEach(t => { t.priority_level = 'high'; highEl.appendChild(taskCard(t, false)); });
            active.forEach(t => { t.priority_level = t.priority_level || 'normal'; activeEl.appendChild(taskCard(t, false)); });
            completed.forEach(t => completedEl.appendChild(taskCard(t, true)));
        }

        async function addTask() {
            const input = document.getElementById('newTitle');
            const title = input.value.trim();
            if (!title) return;
            await action("create", null, { task_name: title });
            input.value = "";
        }

        function taskCard(t, isCompleted = false) {
            const wrap = document.createElement("div");
            wrap.className = "card";
            const priorityLevel = t.priority_level || 'normal';
            wrap.classList.add(`priority-${priorityLevel}`);
            if (isCompleted) wrap.classList.add("completed");

            const rail = document.createElement("div");
            rail.className = "actions-rail";

            const left = document.createElement("div");
            left.className = "actions-left";
            if (!isCompleted) {
                left.append(mkBtn("å®Œäº†", () => action("complete", t.id), "btn-complete"), mkBtn("é€šçŸ¥", () => openRemind(t), "btn-plus2h"));
            } else {
                left.append(mkBtn("æœªå®Œ", () => action("uncomplete", t.id), "btn-complete"));
            }

            const right = document.createElement("div");
            right.className = "actions-right";
            right.append(
                mkBtn("è©³ç´°", () => openDetail(t), "btn-detail"),
                mkBtn("å„ªå…ˆ", () => openPriorityModal(t), "btn-priority"),
                mkBtn("å‰Šé™¤", () => action("delete", t.id), "btn-delete")
            );

            rail.append(left, right);

            const sl = document.createElement("div");
            sl.className = "sl";

            const leftBox = document.createElement("div");
            leftBox.style.cssText = "display:flex;align-items:center;gap:8px;flex:1;";

            if (priorityLevel === 'critical') {
                const badge = document.createElement("span");
                badge.className = "priority-badge";
                badge.textContent = "æœ€é‡è¦";
                leftBox.appendChild(badge);
            } else if (priorityLevel === 'high') {
                const badge = document.createElement("span");
                badge.className = "priority-badge";
                badge.textContent = "é‡è¦";
                leftBox.appendChild(badge);
            }

            const titleEl = document.createElement("div");
            titleEl.className = "title";
            titleEl.textContent = t.task_name || t.title || "(ç„¡é¡Œ)";
            leftBox.appendChild(titleEl);

            const rightBox = document.createElement("div");
            rightBox.style.cssText = "display:flex;align-items:center;";

            if (t.remind_at) {
                const remindEl = document.createElement("div");
                remindEl.className = "remindAt";
                remindEl.textContent = formatRemindLabel(t.remind_at);
                rightBox.appendChild(remindEl);
            }

            const handle = document.createElement("div");
            handle.className = "handle";
            handle.textContent = "â˜°";
            rightBox.appendChild(handle);

            sl.append(leftBox, rightBox);
            wrap.append(rail, sl);

            requestAnimationFrame(() => {
                wrap.dataset.leftWidth = left.getBoundingClientRect().width || 140;
                wrap.dataset.rightWidth = right.getBoundingClientRect().width || 140;
            });

            // PCç‰ˆã‚¯ãƒªãƒƒã‚¯
            if (!/Mobi|Android/i.test(navigator.userAgent)) {
                sl.addEventListener("click", e => {
                    const rect = sl.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const leftW = Number(wrap.dataset.leftWidth) || 140;
                    const rightW = Number(wrap.dataset.rightWidth) || 140;
                    if (wrap.classList.contains("open-left") || wrap.classList.contains("open-right")) {
                        wrap.classList.remove("open-left", "open-right");
                        sl.style.transform = "translateX(0)";
                        return;
                    }
                    if (x < rect.width / 2) { wrap.classList.add("open-left"); sl.style.transform = `translateX(${leftW}px)`; }
                    else { wrap.classList.add("open-right"); sl.style.transform = `translateX(${-rightW}px)`; }
                });
            }

            // ã‚¹ãƒãƒ›ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆä¸Šä¸‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å„ªå…ˆï¼‰
            let startX = 0, startY = 0, dx = 0, dy = 0, isScrolling = null, isHandleDrag = false;
            const SCROLL_THRESHOLD = 10; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®šã®é–¾å€¤

            wrap.addEventListener("touchstart", e => {
                if (isDraggingCard || e.target.closest("button")) return;
                if (e.target.closest(".handle")) { isHandleDrag = true; return; }
                isHandleDrag = false;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                dx = 0; dy = 0; isScrolling = null;
                sl.style.transition = "none";
            }, { passive: true });

            wrap.addEventListener("touchmove", e => {
                if (isDraggingCard || isHandleDrag || !e.touches.length) return;
                dy = e.touches[0].clientY - startY;
                dx = e.touches[0].clientX - startX;
                // ä¸Šä¸‹ç§»å‹•ãŒæ¨ªç§»å‹•ã‚ˆã‚Šå¤§ãã„å ´åˆã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã—ã¦åˆ¤å®š
                if (isScrolling === null && (Math.abs(dx) > SCROLL_THRESHOLD || Math.abs(dy) > SCROLL_THRESHOLD)) {
                    isScrolling = Math.abs(dy) > Math.abs(dx);
                }
                // ä¸Šä¸‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«ä»»ã›ã‚‹ï¼‰
                if (isScrolling) {
                    sl.style.transform = "translateX(0)";
                    return;
                }
                // æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ã®å ´åˆã®ã¿preventDefaultã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ­¢ã‚ã‚‹
                if (Math.abs(dx) > SCROLL_THRESHOLD) e.preventDefault();
                sl.style.transform = `translateX(${dx}px)`;
            }, { passive: false });

            wrap.addEventListener("touchend", () => {
                if (isDraggingCard) return;
                if (isHandleDrag || isScrolling) { isHandleDrag = false; sl.style.transition = ""; sl.style.transform = "translateX(0)"; return; }
                sl.style.transition = "transform .15s";
                const leftW = Number(wrap.dataset.leftWidth) || 140;
                const rightW = Number(wrap.dataset.rightWidth) || 140;
                if (dx > leftW * STRONG_RATIO) { isCompleted ? action("uncomplete", t.id) : action("complete", t.id); wrap.classList.remove("open-left", "open-right"); sl.style.transform = "translateX(0)"; return; }
                if (dx < -rightW * STRONG_RATIO) { action("delete", t.id); wrap.classList.remove("open-left", "open-right"); sl.style.transform = "translateX(0)"; return; }
                if (dx > SNAP_THRESHOLD) { wrap.classList.add("open-left"); wrap.classList.remove("open-right"); sl.style.transform = `translateX(${leftW}px)`; }
                else if (dx < -SNAP_THRESHOLD) { wrap.classList.add("open-right"); wrap.classList.remove("open-left"); sl.style.transform = `translateX(${-rightW}px)`; }
                else { wrap.classList.remove("open-left", "open-right"); sl.style.transform = "translateX(0)"; }
            });

            // ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆä¸¦ã³æ›¿ãˆï¼‰- é«˜é€Ÿç‰ˆ
            const startDrag = (startEvent) => {
                startEvent.preventDefault();
                startEvent.stopPropagation();
                const card = wrap, list = card.parentElement;
                if (!list) return;
                isDraggingCard = true;
                card.classList.remove("open-left", "open-right");
                sl.style.transition = "none"; sl.style.transform = "translateX(0)";

                const cardRect = card.getBoundingClientRect();
                const dragStartY = startEvent.clientY || (startEvent.touches && startEvent.touches[0].clientY);
                const cardStartTop = cardRect.top, cardHeight = cardRect.height, cardWidth = cardRect.width;

                // ãƒ‰ãƒ©ãƒƒã‚°ç”¨ã®ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆï¼ˆå…ƒã‚«ãƒ¼ãƒ‰ã¯éè¡¨ç¤ºã«ã—ãªã„ï¼‰
                const dragClone = card.cloneNode(true);
                dragClone.style.cssText = `position:fixed;left:${cardRect.left}px;top:${cardRect.top}px;width:${cardWidth}px;height:${cardHeight}px;pointer-events:none;z-index:1000;opacity:0.95;box-shadow:0 8px 20px rgba(0,0,0,0.3);transition:none;`;
                dragClone.classList.add("dragging");
                document.body.appendChild(dragClone);

                // å…ƒã‚«ãƒ¼ãƒ‰ã‚’é€æ˜ã«ã—ã¦ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¨ã—ã¦ä½¿ç”¨
                card.style.opacity = "0.3";
                card.style.transition = "none";
                document.body.style.userSelect = "none";

                let currentY = dragStartY;

                const getY = ev => ev.touches?.length ? ev.touches[0].clientY : ev.clientY;

                const updatePosition = (y) => {
                    const deltaY = y - dragStartY;
                    // ç›´æ¥DOMã‚’æ›´æ–°ï¼ˆRAFã‚’ä½¿ã‚ãšå³åº§ã«åæ˜ ï¼‰
                    dragClone.style.top = (cardStartTop + deltaY) + "px";

                    const cloneCenterY = cardStartTop + deltaY + cardHeight / 2;
                    const siblings = Array.from(list.querySelectorAll(".card"));

                    for (const sibling of siblings) {
                        if (sibling === card) continue;
                        const siblingRect = sibling.getBoundingClientRect();
                        if (cloneCenterY < siblingRect.top + siblingRect.height / 2) {
                            if (card.nextSibling !== sibling) list.insertBefore(card, sibling);
                            return;
                        }
                    }
                    // æœ€å¾Œã«ç§»å‹•
                    if (list.lastElementChild !== card) list.appendChild(card);
                };

                const onMove = ev => {
                    ev.preventDefault();
                    currentY = getY(ev);
                    updatePosition(currentY);
                };

                const onUp = () => {
                    document.removeEventListener("pointermove", onMove);
                    document.removeEventListener("pointerup", onUp);
                    document.removeEventListener("touchmove", onMove);
                    document.removeEventListener("touchend", onUp);

                    // ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’å‰Šé™¤
                    dragClone.remove();

                    // å…ƒã‚«ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
                    card.style.opacity = "";
                    card.style.transition = "";
                    card.classList.remove("open-left", "open-right");
                    const slEl = card.querySelector(".sl");
                    if (slEl) { slEl.style.transition = ""; slEl.style.transform = "translateX(0)"; }

                    document.body.style.userSelect = "";
                    setTimeout(() => isDraggingCard = false, 50);
                    saveSortOrder();
                };

                document.addEventListener("pointermove", onMove, { passive: false });
                document.addEventListener("pointerup", onUp);
                document.addEventListener("touchmove", onMove, { passive: false });
                document.addEventListener("touchend", onUp);
            };
            handle.addEventListener("pointerdown", e => { e.preventDefault(); startDrag(e); });
            handle.addEventListener("touchstart", e => { e.preventDefault(); e.stopPropagation(); startDrag(e); }, { passive: false });

            wrap.__taskData = t;
            wrap.dataset.taskId = t.id;
            return wrap;
        }

        async function saveSortOrder() {
            if (!userId) return;
            const orders = [];
            [criticalEl, highEl, activeEl, completedEl].forEach((listEl, idx) => {
                const section = ['critical', 'high', 'active', 'completed'][idx];
                listEl.querySelectorAll('.card').forEach((card, index) => {
                    const t = card.__taskData;
                    if (t) orders.push({ id: t.id, sort_order: index, section });
                });
            });
            if (orders.length) await action("sort_update", null, { orders });
        }

        // å„ªå…ˆé †ä½ãƒ¢ãƒ¼ãƒ€ãƒ«
        function bindPriorityModalUI() {
            const modal = document.getElementById('priorityModal');
            const close = () => { modal.classList.remove('visible'); currentPriorityTask = null; };
            document.getElementById('priorityBackdrop').onclick = close;
            document.getElementById('priorityCloseBtn').onclick = close;
            document.querySelectorAll('.priority-option').forEach(opt => {
                opt.addEventListener('click', async () => {
                    if (!currentPriorityTask) return;
                    const priority = opt.dataset.priority;
                    await action("set_priority", currentPriorityTask.id, { priority_level: priority });
                    close();
                });
            });
        }

        function openPriorityModal(t) {
            currentPriorityTask = t;
            document.getElementById('priorityTaskTitle').textContent = t.task_name || t.title || "(ç„¡é¡Œ)";
            document.getElementById('priorityModal').classList.add('visible');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        function renderHabitList() {
            const container = document.getElementById('habitList');
            container.innerHTML = HABITS.map(h => `<div class="habit-item" data-habit="${h.id}"><div class="habit-checkbox" data-habit="${h.id}"></div><span class="habit-name">${h.name}</span><span class="habit-icon">${h.icon}</span></div>`).join('');
            container.querySelectorAll('.habit-item').forEach(item => {
                item.addEventListener('click', e => {
                    e.stopPropagation();
                    const id = item.dataset.habit, cb = item.querySelector('.habit-checkbox');
                    todayHabits[id] = !todayHabits[id];
                    cb.classList.toggle('checked', todayHabits[id]);
                    cb.textContent = todayHabits[id] ? 'âœ“' : '';
                    item.classList.toggle('checked', todayHabits[id]);
                });
            });
        }

        async function loadHabits() {
            try {
                const res = await fetch(`${API_BASE}/habits?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error();
                const data = await res.json();
                weekHabitsData = data.week || {};
                todayHabits = data.today || {};
                renderWeekView();
                renderHabitAnalysis(data);
                updateHabitCheckboxes();
            } catch (e) {
                renderWeekView();
                renderHabitAnalysis({ week_progress: 0 });
            }
        }

        function updateHabitCheckboxes() {
            document.querySelectorAll('.habit-item').forEach(item => {
                const id = item.dataset.habit, cb = item.querySelector('.habit-checkbox'), isChecked = !!todayHabits[id];
                cb.classList.toggle('checked', isChecked);
                cb.textContent = isChecked ? 'âœ“' : '';
                item.classList.toggle('checked', isChecked);
            });
        }

        function renderWeekView() {
            const tbody = document.getElementById('weekTableBody');
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            tbody.innerHTML = HABITS.map(h => `<tr><td>${h.icon} ${h.name}</td>${days.map(d => `<td class="${weekHabitsData[d]?.[h.id] ? 'checked' : 'unchecked'}">${weekHabitsData[d]?.[h.id] ? 'â—' : 'â—‹'}</td>`).join('')}</tr>`).join('');
        }

        function renderHabitAnalysis(data) {
            const progress = data.week_progress || 0;
            document.getElementById('weekProgressValue').textContent = `${progress}%`;
            document.getElementById('weekProgressBar').style.width = `${progress}%`;
        }

        async function saveHabits() {
            try {
                await fetch(`${API_BASE}/habits/save`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: userId, date: new Date().toISOString().split('T')[0], habits: todayHabits }) });
                document.getElementById('dailyTaskCard').classList.remove('expanded');
                await loadHabits();
                alert('ğŸ’ª è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            } catch (e) { alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
        }

        // æœˆé–“åˆ†æ
        function bindMonthlyAnalysisUI() {
            const modal = document.getElementById('monthlyAnalysisModal');
            const close = () => modal.classList.remove('visible');
            document.getElementById('openMonthlyAnalysis').onclick = () => { selectedMonth = new Date(); modal.classList.add('visible'); loadMonthlyData(); };
            document.getElementById('monthlyAnalysisBackdrop').onclick = close;
            document.getElementById('closeMonthlyAnalysis').onclick = close;
            document.getElementById('prevMonthBtn').onclick = () => { selectedMonth.setMonth(selectedMonth.getMonth() - 1); loadMonthlyData(); };
            document.getElementById('nextMonthBtn').onclick = () => {
                const now = new Date();
                if (selectedMonth.getFullYear() < now.getFullYear() || (selectedMonth.getFullYear() === now.getFullYear() && selectedMonth.getMonth() < now.getMonth())) {
                    selectedMonth.setMonth(selectedMonth.getMonth() + 1);
                    loadMonthlyData();
                }
            };
        }

        async function loadMonthlyData() {
            const year = selectedMonth.getFullYear(), month = selectedMonth.getMonth() + 1;
            document.getElementById('currentMonthLabel').textContent = `${year}å¹´${month}æœˆ`;
            try {
                const res = await fetch(`${API_BASE}/habits/monthly?user_id=${encodeURIComponent(userId)}&year=${year}&month=${month}`);
                if (!res.ok) throw new Error();
                renderMonthlyAnalysis(await res.json());
            } catch (e) {
                renderMonthlyAnalysis({ days: {} });
            }
        }

        function renderMonthlyAnalysis(data) {
            const days = data.days || {}, year = selectedMonth.getFullYear(), month = selectedMonth.getMonth() + 1;
            const daysInMonth = new Date(year, month, 0).getDate();
            let totalChecks = 0, totalPossible = 0, currentStreak = 0, bestStreak = 0;
            const dailyRates = [];
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`, dayData = days[dateStr];
                if (dayData && Object.keys(dayData).length > 0) {
                    const checked = Object.values(dayData).filter(v => v).length;
                    totalChecks += checked; totalPossible += 6; currentStreak++;
                    bestStreak = Math.max(bestStreak, currentStreak);
                    dailyRates.push({ day: d, rate: Math.round((checked / 6) * 100) });
                } else { currentStreak = 0; dailyRates.push({ day: d, rate: 0 }); }
            }
            document.getElementById('monthlyTotalDays').textContent = Object.keys(days).filter(k => Object.values(days[k] || {}).some(v => v)).length;
            document.getElementById('monthlyAchievement').textContent = `${totalPossible ? Math.round((totalChecks / totalPossible) * 100) : 0}%`;
            document.getElementById('monthlyBestStreak').textContent = bestStreak;

            const tbody = document.getElementById('monthlyTableBody');
            tbody.innerHTML = Array.from({ length: daysInMonth }, (_, i) => {
                const d = i + 1, dateStr = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayData = days[dateStr], dow = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][new Date(dateStr).getDay()];
                const cells = HABITS.map(h => `<td class="${dayData?.[h.id] ? 'cell-check' : 'cell-uncheck'}">${dayData?.[h.id] ? 'â—' : 'â—‹'}</td>`).join('');
                const dayChecked = dayData ? Object.values(dayData).filter(v => v).length : 0;
                return `<tr><td>${month}/${d}(${dow})</td>${cells}<td>${dayChecked}/6</td></tr>`;
            }).join('');

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            if (monthlyChart) monthlyChart.destroy();
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: { labels: dailyRates.map(d => `${d.day}æ—¥`), datasets: [{ label: 'é”æˆç‡', data: dailyRates.map(d => d.rate), borderColor: '#ff9f43', backgroundColor: 'rgba(255,159,67,0.15)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#ff9f43' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { stepSize: 25, callback: v => `${v}%` } }, x: { ticks: { maxTicksLimit: 10 } } }, plugins: { legend: { display: false } } }
            });
        }

        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
        async function loadJournals() {
            try {
                const res = await fetch(`${API_BASE}/journals?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error();
                const data = await res.json();
                journalsData = data.journals || [];
                journalsGrouped = data.grouped || [];
            } catch (e) {
                journalsData = [];
                journalsGrouped = [];
            }
            renderJournals();
        }

        function renderJournals() {
            const container = document.getElementById('journalList');
            if (!journalsGrouped.length) {
                container.innerHTML = '<div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // ä»Šæœˆã®ã‚­ãƒ¼ã‚’ç‰¹å®š
            const now = new Date();
            const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            if (!openMonthKey) openMonthKey = currentMonthKey;

            container.innerHTML = journalsGrouped.map(group => {
                const key = `${group.year}-${String(group.month).padStart(2, '0')}`;
                const isOpen = key === openMonthKey;
                return `
                    <div class="journal-month-group" data-month-key="${key}">
                        <div class="journal-month-header ${isOpen ? 'active' : ''}">
                            <div class="journal-month-title">ğŸ“… ${group.label}</div>
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div class="journal-month-count">${group.journals.length}ä»¶</div>
                                <span class="journal-month-arrow">â–¼</span>
                            </div>
                        </div>
                        <div class="journal-month-content ${isOpen ? 'active' : ''}">
                            <div class="journal-month-content-inner">
                                ${group.journals.map(j => `
                                    <div class="journal-card" data-id="${j.id}">
                                        <div class="journal-card-header">
                                            <div class="journal-date">ğŸ“… ${formatDate(j.date)}</div>
                                            <div class="journal-tasks-count">âœ“ ${j.tasks_completed_count || 0}ã‚¿ã‚¹ã‚¯é”æˆ</div>
                                        </div>
                                        <div class="journal-title-text">${j.title || 'ç„¡é¡Œ'}</div>
                                        <div class="journal-preview">${(j.content || '').substring(0, 50)}...</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // æœˆåˆ¥ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            container.querySelectorAll('.journal-month-header').forEach(header => {
                header.onclick = () => {
                    const group = header.closest('.journal-month-group');
                    const key = group.dataset.monthKey;

                    // ä»–ã®æœˆã‚’é–‰ã˜ã‚‹
                    container.querySelectorAll('.journal-month-group').forEach(g => {
                        if (g !== group) {
                            g.querySelector('.journal-month-header').classList.remove('active');
                            g.querySelector('.journal-month-content').classList.remove('active');
                        }
                    });

                    // ãƒˆã‚°ãƒ«
                    const isNowOpen = header.classList.contains('active');
                    header.classList.toggle('active', !isNowOpen);
                    group.querySelector('.journal-month-content').classList.toggle('active', !isNowOpen);
                    openMonthKey = isNowOpen ? null : key;
                };
            });

            // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚«ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            container.querySelectorAll('.journal-card').forEach(card => {
                card.onclick = (e) => {
                    e.stopPropagation();
                    const cardId = String(card.dataset.id);
                    // journalsDataã‹ã‚‰æ¤œç´¢ã€è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°groupedã‹ã‚‰ã‚‚æ¤œç´¢
                    let j = journalsData.find(x => String(x.id) === cardId);
                    if (!j) {
                        for (const group of journalsGrouped) {
                            j = group.journals.find(x => String(x.id) === cardId);
                            if (j) break;
                        }
                    }
                    if (j) openJournalDetailModal(j);
                };
            });
        }

        function openJournalDetailModal(journal) {
            currentEditJournal = journal;
            document.getElementById('journalViewContent').classList.remove('hidden');
            document.getElementById('journalEditContent').classList.remove('active');
            const d = new Date(journal.date);
            document.getElementById('journalModalDate').textContent = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
            document.getElementById('journalModalTitle').textContent = journal.title || 'ç„¡é¡Œ';
            document.getElementById('journalModalContent').textContent = journal.content || 'å†…å®¹ãªã—';
            const tasks = journal.completed_tasks || [];
            document.getElementById('journalModalTasks').innerHTML = tasks.length
                ? tasks.map(t => `<span class="journal-task-chip">${t}</span>`).join('')
                : '<span style="color:var(--text-muted);font-size:12px;">é”æˆã‚¿ã‚¹ã‚¯ãªã—</span>';
            document.getElementById('journalDetailModal').classList.add('visible');
        }

        function bindJournalDetailModalUI() {
            const modal = document.getElementById('journalDetailModal');
            const close = () => { modal.classList.remove('visible'); currentEditJournal = null; };
            document.getElementById('journalDetailBackdrop').onclick = close;
            document.getElementById('closeJournalDetail').onclick = close;
            document.getElementById('journalCloseBtn').onclick = close;
            document.getElementById('closeJournalEdit').onclick = close;
            document.getElementById('journalEditBtn').onclick = () => {
                if (!currentEditJournal) return;
                document.getElementById('journalViewContent').classList.add('hidden');
                document.getElementById('journalEditContent').classList.add('active');
                document.getElementById('editJournalTitle').value = currentEditJournal.title || '';
                document.getElementById('editJournalContent').value = currentEditJournal.content || '';
            };
            document.getElementById('journalCancelEditBtn').onclick = () => {
                document.getElementById('journalViewContent').classList.remove('hidden');
                document.getElementById('journalEditContent').classList.remove('active');
            };
            document.getElementById('journalSaveEditBtn').onclick = async () => {
                if (!currentEditJournal) return;
                const newTitle = document.getElementById('editJournalTitle').value.trim();
                const newContent = document.getElementById('editJournalContent').value.trim();
                try {
                    await fetch(`${API_BASE}/journals/update`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: currentEditJournal.id,
                            user_id: userId,
                            title: newTitle,
                            content: newContent
                        })
                    });
                    currentEditJournal.title = newTitle;
                    currentEditJournal.content = newContent;
                    document.getElementById('journalModalTitle').textContent = newTitle || 'ç„¡é¡Œ';
                    document.getElementById('journalModalContent').textContent = newContent || 'å†…å®¹ãªã—';
                    document.getElementById('journalViewContent').classList.remove('hidden');
                    document.getElementById('journalEditContent').classList.remove('active');
                    await loadJournals();
                    alert('ğŸ’ª æ›´æ–°ã—ã¾ã—ãŸï¼');
                } catch (e) {
                    alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            };
        }

        async function saveJournal() {
            const date = document.getElementById('journalDate').value;
            const title = document.getElementById('journalTitle').value.trim();
            const content = document.getElementById('journalContent').value.trim();
            if (!title && !content) { alert('ã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            try {
                await fetch(`${API_BASE}/journals/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        date: date,
                        title: title,
                        content: content,
                        tasks_completed_count: 0,
                        completed_tasks: []
                    })
                });
                document.getElementById('journalTitle').value = '';
                document.getElementById('journalContent').value = '';
                await loadJournals();
                alert('ğŸ’ª ä¿å­˜ã—ã¾ã—ãŸï¼');
            } catch (e) {
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«
        function bindModalUI() {
            const modal = document.getElementById('detailModal');
            const close = () => modal.classList.remove("visible");
            document.getElementById('detailBackdrop').onclick = close;
            document.getElementById('detailCloseBtn').onclick = close;
            document.getElementById('detailCancelBtn').onclick = close;
            ['Priority', 'Vision', 'Excite', 'Growth'].forEach(name => {
                const input = document.getElementById(`input${name}`), val = document.getElementById(`val${name}`);
                input.addEventListener('input', () => val.textContent = input.value);
            });
            document.getElementById('inputRemindAt').addEventListener('change', e => {
                document.getElementById('valRemindAt').textContent = e.target.value ? formatRemindLabel(new Date(e.target.value).toISOString()) : '';
            });
            document.getElementById('detailSaveBtn').onclick = async () => {
                if (!currentDetailTask) return;
                if (modalMode === "detail") {
                    await action("update_detail", currentDetailTask.id, {
                        priority: Number(document.getElementById('inputPriority').value),
                        vision_score: Number(document.getElementById('inputVision').value),
                        excite_score: Number(document.getElementById('inputExcite').value),
                        growth_score: Number(document.getElementById('inputGrowth').value),
                    });
                } else {
                    const inputVal = document.getElementById('inputRemindAt').value;
                    await action("remind_custom", currentDetailTask.id, { remind_at: inputVal ? new Date(inputVal).toISOString() : null, kind: inputVal ? "custom_datetime" : "clear" });
                }
                close();
            };
        }

        function openDetail(t) {
            modalMode = "detail"; currentDetailTask = t;
            document.getElementById('modalTitle').textContent = "ğŸ’ª ã‚¿ã‚¹ã‚¯è©³ç´°";
            document.getElementById('detailTaskTitle').textContent = t.task_name || t.title || "(ç„¡é¡Œ)";
            document.getElementById('scoreGroup').style.display = "block";
            document.getElementById('remindGroup').style.display = "none";
            ['Priority', 'Vision', 'Excite', 'Growth'].forEach(name => {
                const val = t[name.toLowerCase() + (name === 'Priority' ? '' : '_score')] ?? 0;
                document.getElementById(`input${name}`).value = val;
                document.getElementById(`val${name}`).textContent = val;
            });
            document.getElementById('detailModal').classList.add("visible");
        }

        function openRemind(t) {
            modalMode = "remind"; currentDetailTask = t;
            document.getElementById('modalTitle').textContent = "ğŸ”” é€šçŸ¥è¨­å®š";
            document.getElementById('detailTaskTitle').textContent = t.task_name || t.title || "(ç„¡é¡Œ)";
            document.getElementById('scoreGroup').style.display = "none";
            document.getElementById('remindGroup').style.display = "block";
            const input = document.getElementById('inputRemindAt'), val = document.getElementById('valRemindAt');
            if (t.remind_at) { input.value = toLocalDatetimeValue(t.remind_at); val.textContent = formatRemindLabel(t.remind_at); }
            else { input.value = ''; val.textContent = ''; }
            document.getElementById('detailModal').classList.add("visible");
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function mkBtn(label, onClick, cls) {
            const b = document.createElement("button");
            b.textContent = label; if (cls) b.className = cls;
            b.addEventListener("click", e => { e.stopPropagation(); e.preventDefault(); onClick(); });
            return b;
        }

        async function action(kind, id, extra = {}) {
            try {
                const res = await fetch(`${API_BASE}/action`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ user_id: userId, action: kind, task_id: id, ...extra }) });
                if (!res.ok) alert("æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ");
            } catch (e) { console.error("[ACTION] error:", e); }
            finally { if (kind !== "remind_custom") loadList(); }
        }

        function formatRemindLabel(iso) { if (!iso) return ""; const d = new Date(iso); return `ğŸ””${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`; }
        function toLocalDatetimeValue(iso) { if (!iso) return ""; const d = new Date(iso); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
        function formatDate(dateStr) { const d = new Date(dateStr); return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }

        // =====================
        // MSCï¼ˆãƒ ã‚­ãƒ ã‚­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ï¼‰é–¢é€£
        // =====================

        function bindMscUI() {
            // MSCãƒœã‚¿ãƒ³ã§ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            const mscOpenBtn = document.getElementById('mscOpenBtn');
            const mscCloseBtn = document.getElementById('mscCloseBtn');
            const mscCardView = document.getElementById('msc-card-view');

            function showMsc() {
                mscCardView.classList.add('active');
                mscOpenBtn.classList.add('active');
                mscOpenBtn.textContent = 'â† æˆ»ã‚‹';
            }

            function hideMsc() {
                mscCardView.classList.remove('active');
                mscOpenBtn.classList.remove('active');
                mscOpenBtn.textContent = 'MSC';
            }

            mscOpenBtn.addEventListener('click', () => {
                if (mscCardView.classList.contains('active')) {
                    hideMsc();
                } else {
                    showMsc();
                }
            });

            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
            if (mscCloseBtn) {
                mscCloseBtn.addEventListener('click', hideMsc);
            }

            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            mscCardView.addEventListener('click', (e) => {
                if (e.target === mscCardView) {
                    hideMsc();
                }
            });
        }

        async function loadMscData() {
            try {
                const res = await fetch(`${API_BASE}/msc?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('MSC API not available');
                const data = await res.json();
                mscData = data;
                userMbti = data.mbti || null;
            } catch (e) {
                console.log('MSC API unavailable, calculating from habits data');
                // APIãŒãªã„å ´åˆã¯ç¿’æ…£ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¨ˆç®—
                await calculateMscFromHabits();
            }
            renderMsc();
        }

        async function calculateMscFromHabits() {
            // ç¿’æ…£ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
            const habitData = weekHabitsData || {};
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

            // å„ç¿’æ…£ã®é”æˆç‡ã‚’è¨ˆç®—
            let disciplineScore = 0; // æ—©èµ·ã + ç¦é…’
            let purposeScore = 0;    // ãƒŸãƒƒã‚·ãƒ§ãƒ³
            let curiosityScore = 0;  // èª­æ›¸/å­¦ç¿’
            let reflectionScore = 0; // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
            let actionScore = 0;     // ä»Šæ—¥ãƒˆãƒ¬
            let activeDays = 0;

            days.forEach(day => {
                const dayData = habitData[day];
                if (dayData) {
                    if (dayData.early_wake) disciplineScore++;
                    if (dayData.no_alcohol) disciplineScore++;
                    if (dayData.mission) purposeScore++;
                    if (dayData.reading) curiosityScore++;
                    if (dayData.journal) reflectionScore++;
                    if (dayData.workout) actionScore++;
                    if (Object.values(dayData).some(v => v)) activeDays++;
                }
            });

            // ã‚¹ã‚³ã‚¢ã‚’5æ®µéšã«æ­£è¦åŒ–ï¼ˆæœ€å¤§7æ—¥åˆ†ï¼‰
            const maxDiscipline = 14; // 2é …ç›® Ã— 7æ—¥
            const maxOther = 7; // 1é …ç›® Ã— 7æ—¥

            mscData.radarData = {
                discipline: Math.round((disciplineScore / maxDiscipline) * 5 * 10) / 10,
                purpose: Math.round((purposeScore / maxOther) * 5 * 10) / 10,
                curiosity: Math.round((curiosityScore / maxOther) * 5 * 10) / 10,
                reflection: Math.round((reflectionScore / maxOther) * 5 * 10) / 10,
                action: Math.round((actionScore / maxOther) * 5 * 10) / 10,
                consistency: Math.round((activeDays / 7) * 5 * 10) / 10
            };

            // ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®—
            const values = Object.values(mscData.radarData);
            mscData.score = Math.round((values.reduce((a, b) => a + b, 0) / values.length) * 100) / 100;

            // ãƒ¬ãƒ™ãƒ«ãƒ»EXPè¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼šç·åˆã‚¹ã‚³ã‚¢ Ã— é€±æ•°ã‚’æƒ³å®šï¼‰
            const totalWeeks = 4; // ä»®ã®é€±æ•°
            mscData.exp = Math.round(mscData.score * 200 * totalWeeks);
            mscData.level = Math.floor(mscData.exp / 1000) + 1;
            mscData.totalExp = mscData.level * 1000;

            // å¼·ã¿ãƒ»å¼±ã¿ã‚’åˆ†æ
            analyzeMscTraits();
        }

        function analyzeMscTraits() {
            const traits = [
                { key: 'discipline', name: 'è¦å¾‹ã‚·ãƒ¼ãƒ«ãƒ‰', icon: 'ğŸŒ…', desc: 'æ—©èµ·ãã¨ç¦é…’ã‚’ç¶™ç¶šã—ã€è¦å¾‹æ­£ã—ã„ç”Ÿæ´»ã‚’é€ã£ã¦ã„ã‚‹ã€‚' },
                { key: 'purpose', name: 'ç›®çš„ãƒ–ãƒ¼ã‚¹ãƒˆ', icon: 'ğŸ¯', desc: 'ãƒŸãƒƒã‚·ãƒ§ãƒ³é”æˆã¸ã®æ„è­˜ãŒé«˜ãã€ç›®æ¨™ã«å‘ã‹ã£ã¦é€²ã‚“ã§ã„ã‚‹ã€‚' },
                { key: 'curiosity', name: 'æ¢ç©¶ãƒ‘ãƒ¯ãƒ¼', icon: 'ğŸ“š', desc: 'èª­æ›¸ãƒ»å­¦ç¿’ç¿’æ…£ãŒæ ¹ä»˜ã„ã¦ãŠã‚Šã€çŸ¥çš„å¥½å¥‡å¿ƒãŒæ—ºç››ã€‚' },
                { key: 'reflection', name: 'å†…çœã‚¿ã‚¤ãƒ ', icon: 'ğŸ“', desc: 'ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã§æŒ¯ã‚Šè¿”ã‚Šã‚’è¡Œã„ã€è‡ªå·±ç†è§£ã‚’æ·±ã‚ã¦ã„ã‚‹ã€‚' },
                { key: 'action', name: 'è¡Œå‹•ã‚¨ãƒŠã‚¸ãƒ¼', icon: 'ğŸ’ª', desc: 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç¶™ç¶šã—ã€è¡Œå‹•åŠ›ã‚’ç™ºæ®ã—ã¦ã„ã‚‹ã€‚' },
                { key: 'consistency', name: 'ç¶™ç¶šãƒã‚¤ãƒ³ãƒ‰', icon: 'ğŸ”¥', desc: 'ç©ºç™½æ—¥ãŒå°‘ãªãã€ã‚³ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆã«å–ã‚Šçµ„ã‚“ã§ã„ã‚‹ã€‚' }
            ];

            const scores = traits.map(t => ({ ...t, score: mscData.radarData[t.key] }));
            scores.sort((a, b) => b.score - a.score);

            // å¼·ã¿ï¼šä¸Šä½2ã¤ï¼ˆã‚¹ã‚³ã‚¢2.5ä»¥ä¸Šï¼‰
            mscData.strengths = scores.filter(s => s.score >= 2.5).slice(0, 2);
            // å¼±ã¿ï¼šä¸‹ä½2ã¤ï¼ˆã‚¹ã‚³ã‚¢3.0æœªæº€ï¼‰
            mscData.weaknesses = scores.filter(s => s.score < 3.0).slice(-2).reverse();

            // ç”Ÿæ…‹ãƒ¡ãƒ¢ã‚’ç”Ÿæˆ
            generateBioMemo();
        }

        function generateBioMemo() {
            const strengths = mscData.strengths.map(s => s.name).join('ã¨');
            const topTrait = mscData.strengths[0];

            const bios = [
                `${topTrait ? topTrait.name.replace(/ã‚·ãƒ¼ãƒ«ãƒ‰|ãƒ–ãƒ¼ã‚¹ãƒˆ|ãƒ‘ãƒ¯ãƒ¼|ã‚¿ã‚¤ãƒ |ã‚¨ãƒŠã‚¸ãƒ¼|ãƒã‚¤ãƒ³ãƒ‰/, '') : 'æˆé•·'}ã¸ã®æƒ…ç†±ã‚’æŒã¡ã€æ—¥ã€…ã®ç©ã¿é‡ã­ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã€‚`,
                'ä¸€æ­©ä¸€æ­©ç€å®Ÿã«å‰é€²ã—ã€è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§æˆé•·ã‚’ç¶šã‘ã‚‹ã‚¿ã‚¤ãƒ—ã€‚',
                'å›°é›£ãŒã‚ã£ã¦ã‚‚è«¦ã‚ãšã€ç²˜ã‚Šå¼·ãå–ã‚Šçµ„ã‚€å§¿å‹¢ãŒå…‰ã‚‹ã€‚'
            ];

            if (mscData.radarData.discipline >= 3.5) {
                bios.push('æœå‹ã®ç”Ÿæ´»ãƒªã‚ºãƒ ã‚’å¥½ã¿ã€ã‚³ãƒ„ã‚³ãƒ„ã¨ç©ã¿ä¸Šã’ã‚‹ã“ã¨ã‚’å¾—æ„ã¨ã™ã‚‹ã€‚');
            }
            if (mscData.radarData.curiosity >= 3.5) {
                bios.push('çŸ¥è­˜æ¬²ãŒå¼·ãã€å¸¸ã«æ–°ã—ã„ã“ã¨ã‚’å­¦ã¼ã†ã¨ã™ã‚‹å§¿å‹¢ã‚’æŒã¤ã€‚');
            }
            if (mscData.radarData.action >= 3.5) {
                bios.push('æ€ã„ç«‹ã£ãŸã‚‰å³è¡Œå‹•ã€‚ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã«å‹•ãå›ã‚‹ã‚¿ã‚¤ãƒ—ã€‚');
            }

            mscData.bio = bios.slice(0, 2).join('\n');
        }

        function renderMsc() {
            // MBTI
            const mbtiTag = document.getElementById('mscMbtiTag');
            if (userMbti && MBTI_NAMES[userMbti]) {
                mbtiTag.textContent = `${userMbti} (${MBTI_NAMES[userMbti]})`;
            } else {
                mbtiTag.textContent = 'MBTIã‚’è¨­å®š';
            }

            // ãƒ¬ãƒ™ãƒ«ãƒ»EXP
            const levelTitle = LEVEL_TITLES.find(l => mscData.level >= l.min && mscData.level <= l.max)?.title || 'è¦‹ç¿’ã„';
            document.getElementById('mscLevelBadge').textContent = `Lv.${mscData.level} ${levelTitle}`;

            const score = mscData.score || 0;
            const fullStars = Math.floor(score);
            const halfStar = score % 1 >= 0.5 ? 1 : 0;
            const emptyStars = 5 - fullStars - halfStar;
            document.getElementById('mscStars').textContent = 'â˜…'.repeat(fullStars) + (halfStar ? 'â˜†' : '') + 'â˜†'.repeat(emptyStars);
            document.getElementById('mscScore').textContent = score.toFixed(2);

            const expInLevel = mscData.exp % 1000;
            document.getElementById('mscExpFill').style.width = `${(expInLevel / 1000) * 100}%`;
            document.getElementById('mscExpText').textContent = `${expInLevel} / 1000 EXP`;

            // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
            renderMscRadarChart();

            // å¼·ã¿
            const strengthsHtml = mscData.strengths.length > 0
                ? mscData.strengths.map(s => `
                    <div class="msc-trait-item">
                        <div class="msc-trait-icon">${s.icon}</div>
                        <div class="msc-trait-content">
                            <div class="msc-trait-header">
                                <span class="msc-trait-name">${s.name}</span>
                                <span class="msc-trait-level">Lv.${s.score.toFixed(1)}</span>
                            </div>
                            <div class="msc-trait-desc">${s.desc}</div>
                        </div>
                    </div>
                `).join('')
                : '<div class="msc-trait-item"><div class="msc-trait-desc">ãƒ‡ãƒ¼ã‚¿ã‚’è“„ç©ä¸­...</div></div>';
            document.getElementById('mscStrengths').innerHTML = strengthsHtml;

            // å¼±ã¿
            const weaknessesHtml = mscData.weaknesses.length > 0
                ? mscData.weaknesses.map(w => `
                    <div class="msc-trait-item">
                        <div class="msc-trait-icon">${w.icon}</div>
                        <div class="msc-trait-content">
                            <div class="msc-trait-header">
                                <span class="msc-trait-name">${w.name}</span>
                                <span class="msc-trait-level">Lv.${w.score.toFixed(1)}</span>
                            </div>
                            <div class="msc-trait-desc">${w.desc.replace('ã—ã¦ã„ã‚‹', 'ãŒèª²é¡Œ')}</div>
                        </div>
                    </div>
                `).join('')
                : '<div class="msc-trait-item"><div class="msc-trait-desc">ãƒ‡ãƒ¼ã‚¿ã‚’è“„ç©ä¸­...</div></div>';
            document.getElementById('mscWeaknesses').innerHTML = weaknessesHtml;

            // ç”Ÿæ…‹ãƒ¡ãƒ¢
            document.getElementById('mscBioText').textContent = mscData.bio || 'ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„ã§ã™ã€‚æ—¥ã€…ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç¶šã‘ã¦ã€ã‚ãªãŸã®ç‰¹æ€§ã‚’åˆ†æã—ã¾ã—ã‚‡ã†ã€‚';
        }

        function renderMscRadarChart() {
            const ctx = document.getElementById('mscRadarChart').getContext('2d');

            if (mscRadarChart) {
                mscRadarChart.destroy();
            }

            const data = mscData.radarData;

            mscRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['è¦å¾‹åŠ›', 'ç›®çš„åŠ›', 'æ¢ç©¶åŠ›', 'å†…çœåŠ›', 'è¡Œå‹•åŠ›', 'ç¶™ç¶šåŠ›'],
                    datasets: [{
                        label: 'ãƒ ã‚­ãƒ ã‚­æŒ‡æ•°',
                        data: [data.discipline, data.purpose, data.curiosity, data.reflection, data.action, data.consistency],
                        backgroundColor: 'rgba(255, 255, 255, 0.2)',
                        borderColor: 'rgba(254, 202, 87, 1)',
                        borderWidth: 3,
                        pointBackgroundColor: 'rgba(254, 202, 87, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            min: 0,
                            max: 5,
                            ticks: {
                                stepSize: 1,
                                display: false
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            },
                            angleLines: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            },
                            pointLabels: {
                                color: 'rgba(255, 255, 255, 0.9)',
                                font: {
                                    size: 11,
                                    weight: '600'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // MBTIé–¢é€£
        function bindMbtiModalUI() {
            const modal = document.getElementById('mbtiModal');
            const close = () => { modal.classList.remove('visible'); selectedMbti = null; };

            document.getElementById('mbtiBackdrop').onclick = close;
            document.getElementById('mbtiCloseBtn').onclick = close;

            document.querySelectorAll('.mbti-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    document.querySelectorAll('.mbti-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    selectedMbti = opt.dataset.mbti;
                });
            });

            document.getElementById('mbtiClearBtn').onclick = () => {
                document.querySelectorAll('.mbti-option').forEach(o => o.classList.remove('selected'));
                selectedMbti = null;
            };

            document.getElementById('mbtiSaveBtn').onclick = async () => {
                userMbti = selectedMbti;
                await saveMbti();
                renderMsc();
                close();
            };
        }

        function openMbtiModal() {
            selectedMbti = userMbti;
            document.querySelectorAll('.mbti-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.mbti === userMbti);
            });
            document.getElementById('mbtiModal').classList.add('visible');
        }

        async function saveMbti() {
            try {
                await fetch(`${API_BASE}/msc/mbti`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, mbti: userMbti })
                });
            } catch (e) {
                console.log('MBTI save to API failed, storing locally');
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚ä¿å­˜
                localStorage.setItem(`msc_mbti_${userId}`, userMbti || '');
            }
        }

        init();
    </script>
</body>
</html>
