<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LISTï½œã‚¿ã‚¹ã‚¯ä¸€è¦§</title>
  <style>
    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      margin: 0;
      background: #f7f7f8;
      color: #111;
    }
    header {
      position: sticky;
      top: 0;
      background: #fff;
      border-bottom: 1px solid #eee;
      z-index: 10;
    }
    .bar {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
    }
    .tabs {
      display: flex;
      gap: 8px;
    }
    .tab {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    .tab.active {
      background: #111;
      color: #fff;
      border-color: #111;
    }

    .section {
      padding: 12px 16px;
    }
    .list {
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .card {
      height: 60px;
      min-height: 60px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 0;
      box-shadow: 0 1px 2px rgba(0,0,0,.03);
      position: relative;
      overflow: hidden;
      touch-action: pan-y;
      border-left: 0;
      border-right: 0;
      border-top: 0;
    }
    .list .card:first-child {
      border-top: 0;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: space-between;
      width: 100%;
    }
    .title {
      font-size: 16px;
      font-weight: 600;
      word-break: break-word;
      line-height: 1.5;
      display: flex;
      align-items: center;
    }
    /* å®Œäº†ã‚¿ã‚¹ã‚¯ã®è¦‹ãŸç›® */
    .card.completed .title {
      color: #9ca3af;
      text-decoration: line-through;
    }

    .empty {
      color: #777;
      text-align: center;
      padding: 24px 0;
      font-size: 13px;
    }
    .divider {
      margin: 0;
      border-top: 1px dashed #e6e6e6;
    }

    .divider-label {
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
      margin: 4px 0 8px;
    }

    .add {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .add input {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      font-size: 14px;
    }

    button {
      appearance: none;
      border: 0;
      background: #fff;
      border-radius: 10px;
      padding: 0;
      cursor: pointer;
    }
    button.primary {
      background: #111;
      color: #fff;
      border-color: #111;
      padding: 0 14px;
      font-size: 13px;
    }

    .section {
      padding-left: 0;
      padding-right: 0;
    }

    /* ===== ã‚¹ãƒ¯ã‚¤ãƒ—UI ===== */
    .sl {
      height: 100%;
      position: relative;
      width: 100%;
      transition: transform .15s ease;
      will-change: transform;
      background: #fff;
      z-index: 2;
    }
    .sl .content {
      height: 100%;
      display: flex;
      align-items: center;
      padding: 0 12px;
    }
    .actions-rail {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      border-radius: 0;
      z-index: 1;
      pointer-events: none;
    }
    .card.open-left .actions-rail,
    .card.open-right .actions-rail {
      pointer-events: auto;
    }

    :root {
      --rail-w: clamp(128px, 35vw, 220px);
    }
    .actions-left, .actions-right {
      position: absolute;
      top: 0;
      bottom: 0;
      width: var(--rail-w);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0;
      padding: 0;
    }
    .actions-left {
      left: 0;
      justify-content: flex-start;
      background: #e8f7ee;
    }
    .actions-right {
      right: 0;
      justify-content: flex-end;
      background: #fdeeee;
    }
    .actions-rail button {
      height: 100%;
      box-sizing: border-box;
      min-width: 64px;
      font-size: 12px;
      padding: 0 10px;
      border-radius: 0;
      border: 0;
      color: #fff;
      transition: background 0.2s;
    }
    button.btn-complete { background: #7e6dff; }
    button.btn-plus2h   { background: #8012e2; }
    button.btn-detail   { background: #1e928b; }
    button.btn-pin      { background: #d97706; }
    button.btn-delete   { background: #f03d30; }

    .card.open-left .sl {
      transform: translateX(var(--rail-w));
    }
    .card.open-right .sl {
      transform: translateX(calc(var(--rail-w) * -1 * 1.5));
    }

    /* ä¸¦ã³æ›¿ãˆãƒãƒ³ãƒ‰ãƒ« */
    .handle {
      margin-left: auto;
      cursor: grab;
      user-select: none;
      -webkit-user-select: none; /* iOS Safari */
      font-size: 20px;
      opacity: 0.1;
      padding: 0 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: none;
    }
    .card.placeholder {
      visibility: hidden;
    }
    .card.dragging {
      opacity: 0.5;
      transform: scale(0.98);
      transition: transform 0.1s;
    }
    .ghost {
      opacity: 0.6;
    }

    /* ====== è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
    .modal-root {
      position: fixed;
      inset: 0;
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 50;
      font-size: 14px;
    }
    .modal-root.visible {
      display: flex;
    }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,.25);
    }
    .modal-panel {
      position: relative;
      width: 100%;
      max-width: 480px;
      background: #fff;
      border-radius: 20px 20px 0 0;
      padding: 16px 18px 20px;
      box-shadow: 0 -4px 24px rgba(0,0,0,.18);
      animation: slideUp .18s ease-out;
    }
    @keyframes slideUp {
      from { transform: translateY(40px); opacity: 0; }
      to   { transform: translateY(0);    opacity: 1; }
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .modal-title {
      font-weight: 600;
      font-size: 15px;
    }
    .modal-close {
      background: transparent;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 18px;
      line-height: 1;
    }
    .modal-task-title {
      font-size: 13px;
      color: #555;
      margin-bottom: 8px;
    }
    .slider-group {
      margin: 8px 0 12px;
    }
    .slider-label-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 2px;
      font-size: 12px;
    }
    .slider-label-row span.value {
      font-weight: 600;
      font-size: 13px;
    }
    .slider-group input[type="range"] {
      width: 100%;
    }
    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .btn-secondary {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #f9f9f9;
      font-size: 13px;
    }
    .btn-primary-solid {
      padding: 8px 16px;
      border-radius: 999px;
      border: 0;
      background: #7e6dff;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<header>
  <div class="bar">
    <div style="font-weight:700">LIST</div>
    <div class="tabs">
      <div class="tab active" id="tabTasks">ã‚¿ã‚¹ã‚¯</div>
      <div class="tab" id="tabJournal">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</div>
    </div>
    <div id="refreshBtn" class="tab" title="æ›´æ–°">â†»</div>
  </div>
</header>

<main class="section">
  <div class="add">
    <input id="newTitle" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šãƒ¬ãƒãƒ¼ãƒˆæå‡ºï¼‰" />
    <button id="btnAdd" class="primary">è¿½åŠ </button>
  </div>

  <!-- æœªå®Œäº†ã‚¿ã‚¹ã‚¯ï¼ˆãƒ”ãƒ³ï¼‹é€šå¸¸ï¼‰ -->
  <div id="incompleteLabel" class="divider-label">â€•â€•â€• æœªå®Œäº†ã‚¿ã‚¹ã‚¯ â€•â€•â€•</div>
  <div id="pinned" class="list"></div>
  <div id="pinnedDivider" class="divider" style="display:none"></div>
  <div id="active" class="list"></div>

  <!-- å®Œäº†ã‚¿ã‚¹ã‚¯å´ï¼ˆç·šã‚ˆã‚Šä¸‹ï¼‰ -->
  <div id="completedLine" class="divider" style="margin-top:12px;"></div>
  <div class="divider-label">â€•â€•â€• é”æˆã‚¿ã‚¹ã‚¯ â€•â€•â€•</div>
  <div id="completed" class="list"></div>

  <div id="empty" class="empty" style="display:none">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>
</main>

<!-- ===== è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div id="detailModal" class="modal-root">
  <div class="modal-backdrop" id="detailBackdrop"></div>
  <div class="modal-panel">
    <div class="modal-header">
      <div class="modal-title">ã‚¿ã‚¹ã‚¯è©³ç´°</div>
      <button class="modal-close" id="detailCloseBtn">&times;</button>
    </div>
    <div class="modal-task-title" id="detailTaskTitle"></div>

    <div class="slider-group">
      <div class="slider-label-row">
        <span>å„ªå…ˆåº¦</span>
        <span class="value" id="valPriority">0</span>
      </div>
      <input type="range" id="inputPriority" min="0" max="10" step="1">
    </div>

    <div class="slider-group">
      <div class="slider-label-row">
        <span>ãƒ“ã‚¸ãƒ§ãƒ³é–¢é€£åº¦</span>
        <span class="value" id="valVision">0</span>
      </div>
      <input type="range" id="inputVision" min="0" max="10" step="1">
    </div>

    <div class="slider-group">
      <div class="slider-label-row">
        <span>ã‚ãã‚ãåº¦</span>
        <span class="value" id="valExcite">0</span>
      </div>
      <input type="range" id="inputExcite" min="0" max="10" step="1">
    </div>

    <div class="slider-group">
      <div class="slider-label-row">
        <span>æˆé•·åº¦</span>
        <span class="value" id="valGrowth">0</span>
      </div>
      <input type="range" id="inputGrowth" min="0" max="10" step="1">
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" id="detailCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-primary-solid" id="detailSaveBtn">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
  const LIFF_ID = '2008372898-2q9qWmxv'; // å®Ÿéš›ã®LIFF IDã«åˆã‚ã›ã¦å¤‰æ›´
  const API_BASE = 'https://yamasho.xvps.jp/webhook';

  const EXPOSE_W = 129;
  const EXPOSE_X = 193;
  const SNAP_MIN = 30;
  const STRONG_SWIPE = 180;
  const MAX_DRAG = EXPOSE_W;

  let userId = null;
  let profile = null;

  // è©³ç´°ç·¨é›†ä¸­ã®ã‚¿ã‚¹ã‚¯
  let currentDetailTask = null;

      /* === PCç‰ˆã‚¯ãƒªãƒƒã‚¯ã«ã‚ˆã‚‹è‡ªå‹•ã‚¹ãƒ¯ã‚¤ãƒ— === */
    if (!/Mobi|Android/i.test(navigator.userAgent)) {
      // PCåˆ¤å®š
      slide.addEventListener("click", (e) => {
        const rect = slide.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const half = rect.width / 2;

        // card open çŠ¶æ…‹ãªã‚‰é–‰ã˜ã‚‹
        if (wrap.classList.contains("open-left") || wrap.classList.contains("open-right")) {
          wrap.classList.remove("open-left", "open-right");
          slide.style.transform = "translateX(0px)";
          return;
        }

        if (clickX < half) {
          // å·¦åŠåˆ†ã‚¯ãƒªãƒƒã‚¯ â†’ å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå·¦å´ãƒœã‚¿ãƒ³è¡¨ç¤ºï¼‰
          wrap.classList.add("open-left");
          wrap.classList.remove("open-right");
          slide.style.transform = `translateX(${EXPOSE_W}px)`;
        } else {
          // å³åŠåˆ†ã‚¯ãƒªãƒƒã‚¯ â†’ å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå³å´ãƒœã‚¿ãƒ³è¡¨ç¤ºï¼‰
          wrap.classList.add("open-right");
          wrap.classList.remove("open-left");
          slide.style.transform = `translateX(${-EXPOSE_X}px)`;
        }
      });
    }


  async function init() {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();
    try {
      profile = await liff.getProfile();
      userId = profile.userId;
    } catch (e) {
      console.error('LIFF profile error', e);
      alert('LINEãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      return;
    }
    bindUI();
    bindDetailModalUI();
    await loadList();
    enableSorting();
  }

  function bindUI() {
    document.getElementById('tabTasks').addEventListener('click', () => {
      // ä»Šã¯ã“ã®ç”»é¢ãŒã‚¿ã‚¹ã‚¯ãªã®ã§ä½•ã‚‚ã—ãªã„
    });
    document.getElementById('tabJournal').addEventListener('click', () => {
      // TODO: ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”»é¢ã«é·ç§»
      alert('ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”»é¢ã¯ã“ã‚Œã‹ã‚‰å®Ÿè£…äºˆå®šã§ã™');
    });
    document.getElementById('refreshBtn').addEventListener('click', loadList);
    document.getElementById('btnAdd').addEventListener('click', onAdd);
  }

  /* ===== è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
  function bindDetailModalUI() {
    const backdrop = document.getElementById('detailBackdrop');
    const closeBtn = document.getElementById('detailCloseBtn');
    const cancelBtn = document.getElementById('detailCancelBtn');
    const saveBtn = document.getElementById('detailSaveBtn');

    [backdrop, closeBtn, cancelBtn].forEach(el => {
      el.addEventListener('click', () => closeDetail());
    });
    saveBtn.addEventListener('click', saveDetail);

    const bindSlider = (idInput, idLabel) => {
      const input = document.getElementById(idInput);
      const label = document.getElementById(idLabel);
      input.addEventListener('input', () => {
        label.textContent = input.value;
      });
    };
    bindSlider('inputPriority', 'valPriority');
    bindSlider('inputVision', 'valVision');
    bindSlider('inputExcite', 'valExcite');
    bindSlider('inputGrowth', 'valGrowth');
  }

  function openDetail(task) {
    currentDetailTask = task;
    document.getElementById('detailTaskTitle').textContent = task.title || '(ç„¡é¡Œ)';

    const priority = Number(task.priority ?? 0);
    const vision = Number(task.vision_score ?? 0);
    const excite = Number(task.excite_score ?? 0);
    const growth = Number(task.growth_score ?? 0);

    document.getElementById('inputPriority').value = priority;
    document.getElementById('valPriority').textContent = priority;

    document.getElementById('inputVision').value = vision;
    document.getElementById('valVision').textContent = vision;

    document.getElementById('inputExcite').value = excite;
    document.getElementById('valExcite').textContent = excite;

    document.getElementById('inputGrowth').value = growth;
    document.getElementById('valGrowth').textContent = growth;

    document.getElementById('detailModal').classList.add('visible');
  }

  function closeDetail() {
    currentDetailTask = null;
    document.getElementById('detailModal').classList.remove('visible');
  }

  async function saveDetail() {
    if (!currentDetailTask) return;
    const taskId = currentDetailTask.id;

    const priority = Number(document.getElementById('inputPriority').value);
    const vision_score = Number(document.getElementById('inputVision').value);
    const excite_score = Number(document.getElementById('inputExcite').value);
    const growth_score = Number(document.getElementById('inputGrowth').value);

    try {
      await action('update_detail', taskId, {
        priority,
        vision_score,
        excite_score,
        growth_score
      });
      closeDetail();
    } catch (e) {
      console.error(e);
    }
  }

  /* ====== API: LISTå–å¾— ====== */
  async function loadList() {
    setLoading(true);
    try {
      const url = `${API_BASE}/list?user_id=${encodeURIComponent(userId)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('list api failed');
      const data = await res.json();
      renderList(data);
    } catch (err) {
      console.error(err);
      alert('ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setLoading(false);
    }
  }

  function setLoading(on) {
    document.body.style.opacity = on ? .6 : 1;
  }

  function renderList(payload) {
    const pinned = document.getElementById('pinned');
    const active = document.getElementById('active');
    const completed = document.getElementById('completed');
    const empty = document.getElementById('empty');
    const pinnedDivider = document.getElementById('pinnedDivider');

    [pinned, active, completed].forEach(el => el.innerHTML = '');

    const p = payload.pinned || [];
    const a = payload.active || [];
    const c = payload.completed || [];

    if (p.length) {
      p.forEach(t => pinned.appendChild(taskCard(t, false)));
      pinnedDivider.style.display = 'block';
    } else pinnedDivider.style.display = 'none';

    if (a.length) a.forEach(t => active.appendChild(taskCard(t, false)));

    if (c.length) {
      c.forEach(t => completed.appendChild(taskCard(t, true)));
    }

    empty.style.display = (p.length + a.length + c.length) ? 'none' : 'block';
  }

  function taskCard(t, isCompleted = false) {
    const wrap = document.createElement('div');
    wrap.className = 'card';
    if (isCompleted) {
      wrap.classList.add('completed', 'ghost');
    }

    // èƒŒé¢ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    const rail = document.createElement('div');
    rail.className = 'actions-rail';
    const leftRail = document.createElement('div');
    leftRail.className = 'actions-left';
    const rightRail = document.createElement('div');
    rightRail.className = 'actions-right';

    // å·¦ãƒ¬ãƒ¼ãƒ«ï¼šæœªå®Œãªã‚‰ã€Œå®Œäº†ã€ã€å®Œäº†ãªã‚‰ã€Œæœªå®Œã€
    if (!isCompleted) {
      leftRail.append(
        mkBtn('å®Œäº†', () => action('complete', t.id), 'btn-complete'),
        mkBtn('+2h', () => action('remind_plus2h', t.id), 'btn-plus2h')
      );
    } else {
      leftRail.append(
        mkBtn('æœªå®Œ', () => action('uncomplete', t.id), 'btn-complete')
      );
    }

    // å³ãƒ¬ãƒ¼ãƒ«ï¼šè©³ç´° / ãƒ”ãƒ³ / å‰Šé™¤ï¼ˆãƒ”ãƒ³ä¸­ã¯å‰Šé™¤ä¸å¯ï¼‰
    rightRail.append(
      mkBtn('è©³ç´°', () => openDetail(t), 'btn-detail'),
      mkBtn(t.pinned ? 'ãƒ”ãƒ³è§£é™¤' : 'ãƒ”ãƒ³', () => action('toggle_pin', t.id), 'btn-pin'),
      mkBtn('å‰Šé™¤', () => {
        if (t.pinned) {
          alert('ãƒ”ãƒ³ã‚’å¤–ã—ã¦ãã ã•ã„');
          return;
        }
        action('delete', t.id);
      }, 'btn-delete')
    );
    rail.append(leftRail, rightRail);

    // å‰é¢
    const slide = document.createElement('div');
    slide.className = 'sl';
    const content = document.createElement('div');
    content.className = 'content';
    const row = document.createElement('div');
    row.className = 'row';
    const left = document.createElement('div');

    const title = document.createElement('div');
    title.className = 'title';

    // ãƒ”ãƒ³ä¸­ãªã‚‰ğŸ“ã‚’å…ˆé ­ã«è¡¨ç¤º
    if (t.pinned) {
      const pinIcon = document.createElement('span');
      pinIcon.textContent = 'ğŸ“';
      pinIcon.style.marginRight = '4px';
      title.appendChild(pinIcon);
    }
    title.appendChild(document.createTextNode(t.title || '(ç„¡é¡Œ)'));

    left.append(title);

    const handle = document.createElement('div');
    handle.className = 'handle';
    handle.textContent = 'â˜°';

    row.append(left, handle);
    content.append(row);
    slide.append(content);

    wrap.append(rail, slide);

    // ã‚¹ãƒ¯ã‚¤ãƒ—å‡¦ç†
    let startX = 0, startY = 0, dx = 0, dy = 0, dragging = false, open = 'none';

    const onStart = (x, y) => {
      startX = x; startY = y;
      dx = 0; dy = 0;
      dragging = true;
      slide.style.transition = 'none';
    };
    const onMove = (x, y) => {
      if (!dragging) return;
      dx = x - startX; dy = y - startY;
      if (Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 8) {
        onEnd(true);
        return;
      }
      const base = (open === 'left') ? EXPOSE_W : (open === 'right' ? -EXPOSE_W : 0);
      let tx = base + dx;
      tx = Math.max(-MAX_DRAG, Math.min(MAX_DRAG, tx));
      slide.style.transform = `translateX(${tx}px)`;
    };
    const onEnd = (cancel = false) => {
      if (!dragging) return;
      dragging = false;
      slide.style.transition = 'transform .15s ease';

      if (cancel) { snapTo(open); return; }

      const base = (open === 'left') ? EXPOSE_W : (open === 'right' ? -EXPOSE_W : 0);
      const tx = base + dx;

      if (tx >= STRONG_SWIPE) {
        open = 'none';
        slide.style.transform = 'translateX(0px)';
        action('complete', t.id);
        return;
      }
      if (tx <= -STRONG_SWIPE) {
        open = 'none';
        slide.style.transform = 'translateX(0px)';
        if (t.pinned) {
          alert('ãƒ”ãƒ³ã‚’å¤–ã—ã¦ãã ã•ã„');
        } else {
          action('delete', t.id);
        }
        return;
      }

      if (tx > SNAP_MIN) { open = 'left'; snapTo('left'); }
      else if (tx < -SNAP_MIN) { open = 'right'; snapTo('right'); }
      else { open = 'none'; snapTo('none'); }
    };

    function snapTo(which) {
      if (which === 'left') {
        wrap.classList.add('open-left');
        wrap.classList.remove('open-right');
        slide.style.transform = `translateX(${EXPOSE_W}px)`;
      } else if (which === 'right') {
        wrap.classList.add('open-right');
        wrap.classList.remove('open-left');
        slide.style.transform = `translateX(${-EXPOSE_X}px)`;
      } else {
        wrap.classList.remove('open-left', 'open-right');
        slide.style.transform = 'translateX(0px)';
      }
    }

    wrap.addEventListener('click', e => {
      if (open !== 'none') {
        open = 'none';
        snapTo('none');
        e.preventDefault();
        e.stopPropagation();
      }
    });

    wrap.addEventListener('touchstart', e =>
      onStart(e.touches[0].clientX, e.touches[0].clientY),
      { passive: true }
    );
    wrap.addEventListener('touchmove', e => {
      const x = e.touches[0].clientX, y = e.touches[0].clientY;
      const tmpDx = x - startX;
      const tmpDy = y - startY;
      if (Math.abs(tmpDx) > Math.abs(tmpDy)) e.preventDefault();
      onMove(x, y);
    }, { passive: false });
    wrap.addEventListener('touchend', () => onEnd());
    // PC ã®å ´åˆã¯ã‚¹ãƒ¯ã‚¤ãƒ—é–‹å§‹ã•ã›ãªã„
    wrap.addEventListener('mousedown', e => {
        if (!/Mobi|Android/i.test(navigator.userAgent)) return;
        onStart(e.clientX, e.clientY);
    });

    window.addEventListener('mousemove', e => dragging && onMove(e.clientX, e.clientY));
    window.addEventListener('mouseup', () => dragging && onEnd());

    wrap.setAttribute('draggable', 'true');
    return wrap;
  }

  function mkBtn(label, onClick, extraClass = '') {
    const b = document.createElement('button');
    b.textContent = label;
    if (extraClass) b.classList.add(extraClass);
    b.addEventListener('click', e => {
      e.stopPropagation();
      onClick();
    });
    return b;
  }

  async function action(kind, taskId, extra = {}) {
    try {
      const res = await fetch(`${API_BASE}/action`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: userId,
          action: kind,
          task_id: taskId,
          ...extra
        })
      });
      if (!res.ok) throw new Error('action failed');
      const { ok, message } = await res.json();
      if (!ok) throw new Error(message || 'NG');
      await loadList();
    } catch (e) {
      console.error(e);
      alert('æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ');
      throw e;
    }
  }

  async function onAdd() {
    const title = document.getElementById('newTitle').value.trim();
    if (!title) return;
    await action('create', null, { title });
    document.getElementById('newTitle').value = '';
  }

  function enableSorting() {
    const lists = document.querySelectorAll('.list');
    lists.forEach(list => {
      list.addEventListener('dragstart', e => {
        if (!e.target.classList.contains('card')) return;
        e.target.classList.add('dragging');
      });
      list.addEventListener('dragend', e => {
        e.target.classList.remove('dragging');
      });
      list.addEventListener('dragover', e => {
        e.preventDefault();
        const after = getDragAfterElement(list, e.clientY);
        const dragging = document.querySelector('.dragging');
        if (!dragging) return;
        if (after == null) list.appendChild(dragging);
        else list.insertBefore(dragging, after);
      });
    });
  }

  function getDragAfterElement(container, y) {
    const cards = [...container.querySelectorAll('.card:not(.dragging)')];
    return cards.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      return offset < 0 && offset > closest.offset
        ? { offset, element: child }
        : closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  // ã‚¹ãƒãƒ›é•·æŠ¼ã—ã§ç¸¦ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆâ˜°ã§ç™ºç«ã€iOSé¸æŠã‚’æŠ‘åˆ¶ï¼‰
  (() => {
    const LONG = 400;
    let pressTimer = null;
    let draggingCard = null;
    let placeholder = null;
    let originList = null;
    let startOffsetY = 0;
    let startRect = null;

    function onPointerDown(e) {
      const handle = e.target.closest('.handle');
      if (!handle) return;
      const card = handle.closest('.card');
      if (!card) return;

      // iOSã®ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’æŠ‘åˆ¶
      e.preventDefault();
      document.body.style.userSelect = 'none';
      document.body.style.webkitUserSelect = 'none';

      clearTimeout(pressTimer);
      pressTimer = setTimeout(() => beginDrag(e, card), LONG);
    }

    function beginDrag(e, card) {
      draggingCard = card;
      originList = card.parentElement;

      startRect = card.getBoundingClientRect();
      startOffsetY = e.clientY - startRect.top;

      placeholder = document.createElement('div');
      placeholder.className = 'card placeholder';
      placeholder.style.height = `${startRect.height}px`;
      originList.insertBefore(placeholder, card.nextSibling);

      card.style.width = `${startRect.width}px`;
      card.style.position = 'fixed';
      card.style.left = `${startRect.left}px`;
      card.style.top = `${e.clientY - startOffsetY}px`;
      card.style.zIndex = 999;
      card.classList.add('dragging');

      if (card.setPointerCapture && e.pointerId != null) {
        try { card.setPointerCapture(e.pointerId); } catch {}
      }
    }

    function onPointerMove(e) {
      if (!draggingCard) {
        clearTimeout(pressTimer);
        return;
      }
      e.preventDefault();
      draggingCard.style.top = `${e.clientY - startOffsetY}px`;

      const list = originList;
      const after = getDragAfterElement(list, e.clientY);
      if (!after) list.appendChild(placeholder);
      else list.insertBefore(placeholder, after);
    }

    function onPointerUp() {
      clearTimeout(pressTimer);

      // é¸æŠç¦æ­¢ã‚’è§£é™¤
      document.body.style.userSelect = '';
      document.body.style.webkitUserSelect = '';

      if (!draggingCard) return;

      originList.insertBefore(draggingCard, placeholder);

      draggingCard.style.position = '';
      draggingCard.style.left = '';
      draggingCard.style.top = '';
      draggingCard.style.width = '';
      draggingCard.style.zIndex = '';
      draggingCard.classList.remove('dragging');

      placeholder.remove();
      placeholder = null;
      draggingCard = null;
      startRect = null;
    }

    document.addEventListener('pointerdown', onPointerDown, { passive: false });
    document.addEventListener('pointermove', onPointerMove, { passive: false });
    document.addEventListener('pointerup', onPointerUp, { passive: true });
    document.addEventListener('pointercancel', onPointerUp, { passive: true });
  })();

  /*
    â˜…ãƒ¡ãƒ¢ï¼š3æ—¥çµŒéã—ãŸå®Œäº†ã‚¿ã‚¹ã‚¯ã®è‡ªå‹•å‰Šé™¤ã«ã¤ã„ã¦
    - Supabase å´ã® complete_at ã‚’ã€Œ0/1ã€ã§ã¯ãªã
      ã€Œå®Œäº†æ—¥æ™‚ï¼ˆtimestampï¼‰ã€ã«ã—ã¦ãŠãã¨ã€
      n8n ã® Cron ã§
        NOW() - interval '3 days' ã‚ˆã‚Šå¤ã„ã‚‚ã®ã‚’ DELETE
      ã¨ã„ã†ãƒãƒƒãƒãŒçµ„ã¿ã‚„ã™ã„ã§ã™ã€‚
    - ãƒ•ãƒ­ãƒ³ãƒˆå´ã¯ /list ã®çµæœã‚’æç”»ã™ã‚‹ã ã‘ã§OKã€‚
  */

  init();
</script>
</body>
</html>
