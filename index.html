<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LISTï½œã‚¿ã‚¹ã‚¯ä¸€è¦§</title>
    <style>
        body {
            font-family: -apple-system, system-ui;
            margin: 0;
            background: #f7f7f8;
        }

        header {
            position: sticky;
            top: 0;
            background: #fff;
            border-bottom: 1px solid #eee;
            z-index: 10;
        }

        .bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
        }

        .tab {
            padding: 6px 12px;
            border-radius: 14px;
            border: 1px solid #ddd;
            font-size: 13px;
            cursor: pointer;
        }

            .tab.active {
                background: #111;
                color: white;
                border-color: #111;
            }

        .add {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
        }

            .add input {
                flex: 1;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid #ddd;
                font-size: 16px; /* iOSã®å‹æ‰‹ã‚ºãƒ¼ãƒ é˜²æ­¢ */
            }

        .list {
            display: flex;
            flex-direction: column;
        }

        .card {
            position: relative;
            background: white;
            border-bottom: 1px solid #eee;
            height: 60px;
            overflow: hidden;
            touch-action: pan-y;
            box-sizing: border-box;
        }

            .card.completed .title {
                color: #aaa;
                text-decoration: line-through;
            }

            .card.dragging {
                opacity: 0.9;
                box-shadow: 0 4px 12px rgba(0,0,0,0.18);
                z-index: 5;
            }

        .sl {
            position: relative;
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 0 12px;
            transition: transform .15s ease;
            background: white;
            z-index: 2;
            box-sizing: border-box;
        }

        .actions-rail {
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 1;
        }

        /* ã‚¹ãƒ¯ã‚¤ãƒ—ã§é–‹ã„ã¦ã„ã‚‹ã¨ãã ã‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ */
        .card.open-left .actions-rail,
        .card.open-right .actions-rail {
            pointer-events: auto;
        }

        .actions-left, .actions-right {
            height: 100%;
            display: flex;
            align-items: center;
        }

        .actions-left {
            background: #e8f7ee;
            justify-content: flex-start;
            padding-left: 0;
        }

        .actions-right {
            background: #fdeeee;
            justify-content: flex-end;
            padding-right: 0;
        }

        .actions-rail button {
            height: 100%;
            min-width: 64px;
            border: none;
            color: white;
            font-size: 13px;
            border-radius: 0;
            cursor: pointer;
        }

        .btn-complete {
            background: #7e6dff;
        }

        .btn-plus2h {
            background: #8012e2;
        }

        .btn-detail {
            background: #1e928b;
        }

        .btn-pin {
            background: #d97706;
        }

        .btn-delete {
            background: #f03d30;
        }

        .title {
            font-size: 15px;
        }

        .handle {
            margin-left: auto;
            cursor: grab;
            opacity: 0.25;
            -webkit-user-select: none;
            user-select: none;
            padding: 0 8px;
            font-size: 20px;
            touch-action: none;
        }

        .divider-label {
            text-align: center;
            color: #888;
            font-size: 12px;
            padding: 6px 0;
        }

        /* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-root {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 50;
            align-items: flex-end;
            justify-content: center;
        }

            .modal-root.visible {
                display: flex;
            }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,.25);
            z-index: 0;
        }

        .modal-panel {
            width: 100%;
            max-width: 480px;
            background: #fff;
            border-radius: 20px 20px 0 0;
            padding: 16px;
            animation: slideUp .18s ease-out;
            position: relative;
            z-index: 1;
        }
        /*ã€Œ.ã€ãŒã€Œ@ã€ã«ãªã£ã¦ãŸ...*/
        .keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .slider-group {
            margin: 14px 0;
        }

        .slider-label-row {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
        }

            .slider-label-row span.value {
                font-size: 15px;
                font-weight: 600;
            }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 14px;
        }

        .btn-secondary {
            padding: 8px 14px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: #fafafa;
            cursor: pointer;
        }

        .btn-primary-solid {
            padding: 8px 16px;
            border-radius: 20px;
            background: #7e6dff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight:600;
            line-height: 18px;
            height: 32px;
        }

        .remindAt {
            font-size: 11px;
            color: #666;
            margin-left: 8px;
            white-space: nowrap;
        }
    </style>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

    <header>
        <div class="bar">
            <div style="font-weight:600">LIST</div>
            <div class="tab active">ã‚¿ã‚¹ã‚¯</div>
            <div class="tab" id="refreshBtn">â†»</div>
        </div>
    </header>

    <main>
        <div class="add">
            <input id="newTitle" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›â€¦" />
            <button id="btnAdd" class="tab" style="background:#111;color:white;border-color:#111">è¿½åŠ </button>
        </div>

        <div class="divider-label">ToDoã‚¿ã‚¹ã‚¯</div>
        <div id="pinned" class="list"></div>
        <div id="active" class="list"></div>

        <div class="divider-label" style="margin-top:16px;">--------------------------------------------------------------------<br>é”æˆã‚¿ã‚¹ã‚¯</div>
        <div id="completed" class="list"></div>
    </main>

    <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="detailModal" class="modal-root">
        <div id="detailBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-weight:600">ã‚¿ã‚¹ã‚¯è©³ç´°</div>
                <button id="detailCloseBtn" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
            </div>

            <div id="detailTaskTitle" style="font-size:13px;color:#555;margin-bottom:8px;"></div>

            <div class="slider-group">
                <div class="slider-label-row"><span>ğŸ§  ç²¾ç¥åŠ›ï¼ˆMindï¼‰</span><span class="value" id="valMind"></span></div>
                <input id="inputMind" type="range" min="0" max="100" step="1" />
            </div>

            <div class="slider-group">
                <div class="slider-label-row"><span>ğŸ”¥ è¡Œå‹•åŠ›ï¼ˆActionï¼‰</span><span class="value" id="valAction"></span></div>
                <input id="inputAction" type="range" min="0" max="100" step="1" />
            </div>

            <div class="slider-group">
                <div class="slider-label-row"><span>ğŸŒ™ æ„Ÿæƒ…ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼ˆEmotionï¼‰</span><span class="value" id="valEmotion"></span></div>
                <input id="inputEmotion" type="range" min="0" max="100" step="1" />
            </div>

            <div class="slider-group">
                <div class="slider-label-row"><span>ğŸ”„ ç¶™ç¶šé‹ï¼ˆConsistencyï¼‰</span><span class="value" id="valConsistency"></span></div>
                <input id="inputConsistency" type="range" min="0" max="100" step="1" />
            </div>

            <div class="slider-group">
                <div class="slider-label-row"><span>âš¡ é›†ä¸­åŠ›ï¼ˆFocusï¼‰</span><span class="value" id="valFocus"></span></div>
                <input id="inputFocus" type="range" min="0" max="100" step="1" />
            </div>

            <div class="slider-group">
                <div class="slider-label-row"><span>ğŸ›  ä»•äº‹é‹ï¼ˆWork Impactï¼‰</span><span class="value" id="valWork"></span></div>
                <input id="inputWork" type="range" min="0" max="100" step="1" />
            </div>

            <div class="modal-footer">
                <button id="detailCancelBtn" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="detailSaveBtn" class="btn-primary-solid">ä¿å­˜</button>
            </div>

        </div>
    </div>

    <!-- é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="remindModal" class="modal-root">
        <div id="remindBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-weight:600">é€šçŸ¥è¨­å®š</div>
                <button id="remindCloseBtn" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
            </div>

            <div id="remindTaskTitle" style="font-size:13px;color:#555;margin-bottom:8px;"></div>

            <div class="slider-group">
                <div class="slider-label-row">
                    <span>ãƒªãƒã‚¤ãƒ³ãƒ‰æ—¥æ™‚</span>
                    <span class="value" id="valRemindAt"></span>
                </div>
                <input id="inputRemindAt" type="datetime-local" />
            </div>

            <div class="modal-footer">
                <button id="remindCancelBtn" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="remindSaveBtn" class="btn-primary-solid">ä¿å­˜</button>
            </div>

        </div>
    </div>

    <script>
        const LIFF_ID = "2008372898-2q9qWmxv";
        const API_BASE = "https://yamasho.xvps.jp/webhook";
        let userId = null;
        let currentDetailTask = null;
        let currentRemindTask = null;

        // å¼·ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®šã®æ¯”ç‡
        const STRONG_RATIO = 0.85;  // ãƒœã‚¿ãƒ³å¹…ã®ç´„85%ä»¥ä¸Š
        const SNAP_THRESHOLD = 40;  // ã“ã®pxä»¥ä¸Šã§ã€Œé–‹ãã€ã‚¹ãƒŠãƒƒãƒ—

        // DOMã‚­ãƒ£ãƒƒã‚·ãƒ¥
        const pinnedEl = document.getElementById("pinned");
        const activeEl = document.getElementById("active");
        const completedEl = document.getElementById("completed");
        const refreshBtn = document.getElementById("refreshBtn");
        const btnAdd = document.getElementById("btnAdd");
        const newTitle = document.getElementById("newTitle");

        // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
        const detailModal = document.getElementById("detailModal");
        const detailBackdrop = document.getElementById("detailBackdrop");
        const detailCloseBtn = document.getElementById("detailCloseBtn");
        const detailCancelBtn = document.getElementById("detailCancelBtn");
        const detailSaveBtn = document.getElementById("detailSaveBtn");
        const detailTaskTitle = document.getElementById("detailTaskTitle");

        const inputMind = document.getElementById("inputMind");
        const inputAction = document.getElementById("inputAction");
        const inputEmotion = document.getElementById("inputEmotion");
        const inputConsistency = document.getElementById("inputConsistency");
        const inputFocus = document.getElementById("inputFocus");
        const inputWork = document.getElementById("inputWork");
        const valMind = document.getElementById("valMind");
        const valAction = document.getElementById("valAction");
        const valEmotion = document.getElementById("valEmotion");
        const valConsistency = document.getElementById("valConsistency");
        const valFocus = document.getElementById("valFocus");
        const valWork = document.getElementById("valWork");

        // é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
        const remindModal = document.getElementById("remindModal");
        const remindBackdrop = document.getElementById("remindBackdrop");
        const remindCloseBtn = document.getElementById("remindCloseBtn");
        const remindCancelBtn = document.getElementById("remindCancelBtn");
        const remindSaveBtn = document.getElementById("remindSaveBtn");
        const remindTaskTitle = document.getElementById("remindTaskTitle");
        const inputRemindAt = document.getElementById("inputRemindAt");
        const valRemindAt = document.getElementById("valRemindAt");


        function toLocalDatetimeValue(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            const hh = String(d.getHours()).padStart(2, "0");
            const mi = String(d.getMinutes()).padStart(2, "0");
            return `${yyyy}-${mm}-${dd}T${hh}:${mi}`; // datetime-local ç”¨
        }

        /*ã“ã“ã§ã„ã„ã®ã‹ãª...?ğŸ‘‡*/
        function formatRemindLabel(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            const hh = String(d.getHours()).padStart(2, "0");
            const mi = String(d.getMinutes()).padStart(2, "0");
            return `ğŸ””${yyyy}/${mm}/${dd} ${hh}:${mi}`; // è¡¨ç¤ºç”¨
        }

        /* ==========================
           INIT
        ========================== */
        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                userId = profile.userId;

                bindUI();
                bindModalUI();
                await loadList();
            } catch (e) {
                console.error(e);
                alert("LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        /* ==========================
           bindUI
        ========================== */
        function bindUI() {
            refreshBtn.onclick = loadList;

            btnAdd.onclick = async () => {
                const title = newTitle.value.trim();
                if (!title) return;
                await action("create", null, { task_name: title });
                newTitle.value = "";
            };
        }

        /* ==========================
          ãƒ¢ãƒ¼ãƒ€ãƒ« UI
        ========================== */
        function bindModalUI() {
            // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
            const closeDetail = () => detailModal.classList.remove("visible");
            detailBackdrop.onclick = closeDetail;
            detailCloseBtn.onclick = closeDetail;
            detailCancelBtn.onclick = closeDetail;

            const bindSlider = (input, label) => {
                input.addEventListener("input", () => { label.textContent = input.value; });
            };
            bindSlider(inputMind, valMind);
            bindSlider(inputAction, valAction);
            bindSlider(inputEmotion, valEmotion);
            bindSlider(inputConsistency, valConsistency);
            bindSlider(inputFocus, valFocus);
            bindSlider(inputWork, valWork);

            detailSaveBtn.onclick = async () => {
                if (!currentDetailTask) return;

                const payload = {
                    mind_score: Number(inputMind.value),
                    action_score: Number(inputAction.value),
                    emotion_score: Number(inputEmotion.value),
                    consistency_score: Number(inputConsistency.value),
                    focus_score: Number(inputFocus.value),
                    work_score: Number(inputWork.value),
                };
                await action("update_detail", currentDetailTask.id, payload);
                closeDetail();
            };

            // é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«
            const closeRemind = () => remindModal.classList.remove("visible");
            remindBackdrop.onclick = closeRemind;
            remindCloseBtn.onclick = closeRemind;
            remindCancelBtn.onclick = closeRemind;

            inputRemindAt.addEventListener("change", () => {
                if (inputRemindAt.value) {
                    const d = new Date(inputRemindAt.value);
                    valRemindAt.textContent = formatRemindLabel(d.toISOString());
                } else {
                    valRemindAt.textContent = "";
                }
            });

            remindSaveBtn.onclick = async () => {
                if (!currentRemindTask) return;

                let remind_at = null;
                if (inputRemindAt.value) {
                    const d = new Date(inputRemindAt.value);
                    remind_at = d.toISOString();
                }

                // ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚¿ã‚¹ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›´æ–°
                currentRemindTask.remind_at = remind_at;

                // å¯¾å¿œã™ã‚‹ã‚«ãƒ¼ãƒ‰ã®å³å´ãƒ©ãƒ™ãƒ«ã‚’å³æ™‚æ›´æ–°
                const card = document.querySelector(`.card[data-task-id="${currentRemindTask.id}"]`);
                if (card) {
                    const rightBox = card.querySelector(".rightBox");
                    if (rightBox) {
                        let label = rightBox.querySelector(".remindAt");

                        if (remind_at) {
                            if (!label) {
                                label = document.createElement("div");
                                label.className = "remindAt";
                                const handleEl = rightBox.querySelector(".handle");
                                rightBox.insertBefore(label, handleEl || null);
                            }
                            label.textContent = formatRemindLabel(remind_at);
                        } else {
                            if (label) label.remove();
                        }
                    }
                }

                // ã‚µãƒ¼ãƒãƒ¼å´ã«ã‚‚ä¿å­˜
                await action("remind_custom", currentRemindTask.id, {
                    remind_at,
                    kind: remind_at ? "custom_datetime" : "clear",
                });

                closeRemind();
            };
        }

        /* ==========================
          LIST API
        ========================== */
        async function loadList() {
            const url = `${API_BASE}/list?user_id=${encodeURIComponent(userId)}`;
            console.log("[LIST] request:", url);

            try {
                const res = await fetch(url);
                console.log("[LIST] status:", res.status);

                const text = await res.text();
                console.log("[LIST] raw response:", JSON.stringify(text));

                if (!res.ok) {
                    console.error("[LIST] http error:", res.status, text);
                    alert("ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTPã‚¨ãƒ©ãƒ¼ï¼‰");
                    return;
                }

                if (!text) {
                    console.warn("[LIST] ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã—ãŸ");
                    renderList({ pinned: [], active: [], completed: [] });
                    return;
                }

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error("[LIST] JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", e);
                    alert("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰JSONãŒè¿”ã£ã¦ãã¦ã„ã¾ã›ã‚“");
                    return;
                }

                console.log("[LIST] parsed json:", data);
                renderList(data);

            } catch (e) {
                console.error("[LIST] fetch error:", e);
                alert("ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰");
            }
        }

        function renderList(payload) {
            pinnedEl.innerHTML = "";
            activeEl.innerHTML = "";
            completedEl.innerHTML = "";

            const pinned = Array.isArray(payload.pinned) ? payload.pinned : [];
            const active = Array.isArray(payload.active) ? payload.active : [];
            const completed = Array.isArray(payload.completed) ? payload.completed : [];

            pinned.forEach(t => pinnedEl.appendChild(taskCard(t, false)));
            active.forEach(t => activeEl.appendChild(taskCard(t, false)));
            completed.forEach(t => completedEl.appendChild(taskCard(t, true)));
        }

        /* ==========================
          ä¸¦ã³é †ã‚’ã‚µãƒ¼ãƒãƒ¼ã¸ä¿å­˜
        ========================== */
        async function saveSortOrder() {
            if (!userId) return;

            const orders = [];

            pinnedEl.querySelectorAll(".card").forEach((card, index) => {
                const t = card.__taskData;
                if (!t) return;
                orders.push({ id: t.id, sort_order: index, section: "pinned" });
            });
            activeEl.querySelectorAll(".card").forEach((card, index) => {
                const t = card.__taskData;
                if (!t) return;
                orders.push({ id: t.id, sort_order: index, section: "active" });
            });
            completedEl.querySelectorAll(".card").forEach((card, index) => {
                const t = card.__taskData;
                if (!t) return;
                orders.push({ id: t.id, sort_order: index, section: "completed" });
            });

            console.log("[SORT_UPDATE] orders:", orders);
            await action("sort_update", null, { orders });
        }

        /* ==========================
          TASK CARD
        ========================== */
        function taskCard(t, isCompleted = false) {
            const wrap = document.createElement("div");
            wrap.className = "card";
            if (isCompleted) wrap.classList.add("completed");

            // èƒŒé¢ãƒ¬ãƒ¼ãƒ«
            const rail = document.createElement("div");
            rail.className = "actions-rail";

            const left = document.createElement("div");
            left.className = "actions-left";

            if (!isCompleted) {
                left.append(
                    mkBtn("å®Œäº†", () => action("complete", t.id), "btn-complete"),
                    // â˜… ã€Œé€šçŸ¥ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰ openRemind(t) ã‚’å‘¼ã¶
                    mkBtn("é€šçŸ¥", () => openRemind(t), "btn-plus2h")
                );
            } else {
                left.append(mkBtn("æœªå®Œ", () => action("uncomplete", t.id), "btn-complete"));
            }

            const right = document.createElement("div");
            right.className = "actions-right";
            right.append(
                mkBtn("è©³ç´°", () => openDetail(t), "btn-detail"),
                mkBtn(t.pinned ? "ğŸ“è§£é™¤" : "ğŸ“ãƒ”ãƒ³", () => action("toggle_pin", t.id), "btn-pin"),
                mkBtn("å‰Šé™¤", () => {
                    if (t.pinned) return alert("ãƒ”ãƒ³ã‚’å¤–ã—ã¦ãã ã•ã„ï¼");
                    action("delete", t.id);
                }, "btn-delete")
            );

            rail.append(left, right);

            // å‰é¢
            const sl = document.createElement("div");
            sl.className = "sl";

            const titleEl = document.createElement("div");
            titleEl.className = "title";

            const name = t.task_name || t.title || "(ç„¡é¡Œ)";
            titleEl.textContent = t.pinned ? "ğŸ“ " + name : name;

            // å·¦ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰ã¨å³ï¼ˆãƒªãƒã‚¤ãƒ³ãƒ‰ï¼‹ãƒãƒ³ãƒ‰ãƒ«ï¼‰ã«åˆ†å‰²
            const leftBox = document.createElement("div");
            leftBox.style.flex = "1";
            leftBox.appendChild(titleEl);

            const rightBox = document.createElement("div");
            rightBox.className = "rightBox";           // â˜… è¿½åŠ 
            rightBox.style.display = "flex";
            rightBox.style.alignItems = "center";

            if (t.remind_at) {
                const remindEl = document.createElement("div");
                remindEl.className = "remindAt";
                remindEl.textContent = formatRemindLabel(t.remind_at);
                rightBox.appendChild(remindEl);
            }

            const handle = document.createElement("div");
            handle.className = "handle";
            handle.textContent = "â˜°";
            handle.style.marginLeft = "8px";

            rightBox.appendChild(handle);

            sl.append(leftBox, rightBox);
            wrap.append(rail, sl);


            // ===== ãƒœã‚¿ãƒ³å¹…ã‚’æ¸¬ã£ã¦ data ã«ä¿å­˜ï¼ˆç«¯ã‚’æƒãˆã‚‹ç”¨ï¼‰ =====
            requestAnimationFrame(() => {
                const lRect = left.getBoundingClientRect();
                const rRect = right.getBoundingClientRect();
                wrap.dataset.leftWidth = lRect.width || 140;
                wrap.dataset.rightWidth = rRect.width || 140;
            });

            let holdTimer = null;
            handle.addEventListener("pointerdown", e => {
                holdTimer = setTimeout(() => startDrag(e), 500);
            });

            handle.addEventListener("pointerup", () => clearTimeout(holdTimer));
            handle.addEventListener("pointerleave", () => clearTimeout(holdTimer));


            /* ==========================
                PCç‰ˆ ã‚¯ãƒªãƒƒã‚¯ã§ã‚¹ãƒ¯ã‚¤ãƒ—
            ========================== */
            if (!/Mobi|Android/i.test(navigator.userAgent)) {
                sl.addEventListener("click", e => {
                    const rect = sl.getBoundingClientRect();
                    const x = e.clientX - rect.left;

                    const leftW = Number(wrap.dataset.leftWidth) || 140;
                    const rightW = Number(wrap.dataset.rightWidth) || 140;

                    if (wrap.classList.contains("open-left") || wrap.classList.contains("open-right")) {
                        wrap.classList.remove("open-left", "open-right");
                        sl.style.transform = "translateX(0)";
                        return;
                    }

                    if (x < rect.width / 2) {
                        wrap.classList.add("open-left");
                        wrap.classList.remove("open-right");
                        sl.style.transform = `translateX(${leftW}px)`;
                    } else {
                        wrap.classList.add("open-right");
                        wrap.classList.remove("open-left");
                        sl.style.transform = `translateX(${-rightW}px)`;
                    }
                });
            }

            /* ==========================
                ã‚¹ãƒãƒ›ç‰ˆ ã‚¹ãƒ¯ã‚¤ãƒ—
            ========================== */
            let startX = 0, startY = 0, dx = 0, dy = 0;
            let isHandleDrag = false;      // â˜° ã‹ã‚‰å§‹ã¾ã£ãŸã‹ã©ã†ã‹
            let isHorizontalSwipe = false; // ã“ã®ã‚¿ãƒƒãƒã§æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ã™ã‚‹ã‹ã©ã†ã‹

            wrap.addEventListener("touchstart", e => {
                // ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã„ã‚‹å ´åˆã¯ã‚¹ãƒ¯ã‚¤ãƒ—å‡¦ç†ã‚’èµ·å‹•ã—ãªã„
                if (e.target.closest("button")) {
                    return;
                }

                // â˜°ï¼ˆ.handleï¼‰ã‹ã‚‰å§‹ã¾ã£ãŸã‚¿ãƒƒãƒãªã‚‰ã€ã‚¹ãƒ¯ã‚¤ãƒ—å‡¦ç†ã¯ä¸€åˆ‡ã—ãªã„
                if (e.target.closest(".handle")) {
                    isHandleDrag = true;
                    return;
                } else {
                    isHandleDrag = false;
                }

                if (e.touches.length === 0) return;

                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                dx = dy = 0;
                isHorizontalSwipe = false;

                sl.style.transition = "none";
            }, { passive: true });

            wrap.addEventListener("touchmove", e => {
                if (isHandleDrag) {
                    // â˜° ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã‚‹ã¨ãã¯ã€ã“ã“ï¼ˆæ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ï¼‰ã«ã¯å…¥ã‚‰ãªã„
                    return;
                }
                if (e.touches.length === 0) return;

                const touch = e.touches[0];
                dx = touch.clientX - startX;
                dy = touch.clientY - startY;

                // ã¾ã æ–¹å‘ãŒæ±ºã¾ã£ã¦ã„ãªã„ã¨ã
                if (!isHorizontalSwipe) {
                    // æŒ‡ãŒã»ã¨ã‚“ã©å‹•ã„ã¦ã„ãªã„ â†’ ä½•ã‚‚ã—ãªã„ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚‚å¦¨ã’ãªã„ï¼‰
                    if (Math.abs(dx) < 8 && Math.abs(dy) < 8) {
                        return;
                    }

                    // ç¸¦æ–¹å‘ã®ç§»å‹•ã®æ–¹ãŒå¤§ãã„ â†’ ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã—ã¦æ‰±ã„ã€ä»¥é™ã‚‚ã‚¹ãƒ¯ã‚¤ãƒ—ã—ãªã„
                    if (Math.abs(dy) > Math.abs(dx)) {
                        return;
                    }

                    // ã“ã“ã«æ¥ãŸã‚‰ã€Œæ¨ªæ–¹å‘ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã€ã¨åˆ¤æ–­
                    isHorizontalSwipe = true;
                }

                // æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã ã‘ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ­¢ã‚ã¦æ¨ªã«å‹•ã‹ã™
                e.preventDefault();
                sl.style.transform = `translateX(${dx}px)`;
            }, { passive: false });

            wrap.addEventListener("touchend", () => {
                // â˜° ãƒ‰ãƒ©ãƒƒã‚°ã ã£ãŸå ´åˆã¯ã€ã‚¹ãƒ¯ã‚¤ãƒ—ã®å¾Œå‡¦ç†ã‚’ã—ãªã„
                if (isHandleDrag) {
                    isHandleDrag = false;
                    sl.style.transition = "";
                    sl.style.transform = "translateX(0)";
                    return;
                }

                // æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ã«ãªã‚‰ãªã‹ã£ãŸï¼ˆï¼ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã ã£ãŸï¼‰å ´åˆã¯ã€å…ƒã®ä½ç½®ã«æˆ»ã™ã ã‘
                if (!isHorizontalSwipe) {
                    sl.style.transition = "";
                    sl.style.transform = "translateX(0)";
                    return;
                }

                sl.style.transition = "transform .15s";

                const leftW = Number(wrap.dataset.leftWidth) || 140;
                const rightW = Number(wrap.dataset.rightWidth) || 140;

                const leftStrong = leftW * STRONG_RATIO;
                const rightStrong = rightW * STRONG_RATIO;

                // ã“ã“ã‹ã‚‰ä¸‹ã¯ä»Šã®ã¾ã¾ã®ãƒ­ã‚¸ãƒƒã‚¯ãã®ã¾ã¾ã§OK
                if (dx > leftStrong) {
                    if (!isCompleted) {
                        action("complete", t.id);
                        sl.style.transform = `translateX(${leftW}px)`;
                    } else {
                        sl.style.transform = "translateX(0)";
                    }
                } else if (dx > SNAP_THRESHOLD) {
                    wrap.classList.add("open-left");
                    wrap.classList.remove("open-right");
                    sl.style.transform = `translateX(${leftW}px)`;
                } else if (dx < -rightStrong) {
                    action("delete", t.id);
                    sl.style.transform = `translateX(${-rightW}px)`;
                } else if (dx < -SNAP_THRESHOLD) {
                    wrap.classList.add("open-right");
                    wrap.classList.remove("open-left");
                    sl.style.transform = `translateX(${-rightW}px)`;
                } else {
                    wrap.classList.remove("open-left", "open-right");
                    sl.style.transform = "translateX(0)";
                }
            });


            /* ==========================
                â˜° ã§ä¸¦ã³æ›¿ãˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼‰
            ========================== */
            const startDrag = (startEvent) => {
                startEvent.preventDefault();
                startEvent.stopPropagation();

                const card = wrap;
                const list = card.parentElement;
                if (!list) return;

                card.classList.add("dragging");
                document.body.style.userSelect = "none";

                const pointerId = startEvent.pointerId;

                const getY = (ev) => ev.clientY;

                const onMove = (ev) => {
                    const y = getY(ev);
                    const siblings = Array.from(list.children);
                    const currentIndex = siblings.indexOf(card);
                    if (currentIndex === -1) return;

                    const prev = siblings[currentIndex - 1];
                    const next = siblings[currentIndex + 1];

                    if (prev) {
                        const rect = prev.getBoundingClientRect();
                        if (y < rect.top + rect.height / 2) {
                            list.insertBefore(card, prev);
                            return;
                        }
                    }
                    if (next) {
                        const rect = next.getBoundingClientRect();
                        if (y > rect.top + rect.height / 2) {
                            list.insertBefore(next, card);
                            return;
                        }
                    }
                };

                const onUp = (ev) => {
                    document.removeEventListener("pointermove", onMove);
                    document.removeEventListener("pointerup", onUp);
                    card.classList.remove("dragging");
                    document.body.style.userSelect = "";
                    saveSortOrder();
                };

                document.addEventListener("pointermove", onMove);
                document.addEventListener("pointerup", onUp);
            };

            if (window.PointerEvent) {
                handle.addEventListener("pointerdown", startDrag);
            } else {
                // pointeræœªå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¿…è¦ãªã‚‰ï¼‰
                handle.addEventListener("touchstart", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // ã“ã“ã§åŒæ§˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ã‚‚OKï¼ˆç°¡ç•¥ã®ãŸã‚çœç•¥ï¼‰
                }, { passive: false });
            }

            // ä¸¦ã³æ›¿ãˆç”¨ã«ã‚¿ã‚¹ã‚¯æƒ…å ±ã‚’ç´ä»˜ã‘
            // ä¸¦ã³æ›¿ãˆç”¨ã«ã‚¿ã‚¹ã‚¯æƒ…å ±ã‚’ç´ä»˜ã‘
            wrap.__taskData = t;
            wrap.dataset.taskId = t.id;   // â˜… è¿½åŠ ï¼šDOMã‹ã‚‰é€†å¼•ãã™ã‚‹ç”¨

            return wrap;

        }

        /* ==========================
           MODAL OPEN
        ========================== */
        function openDetail(t) {
            currentDetailTask = t;

            const name = t.task_name || t.title || "(ç„¡é¡Œ)";
            detailTaskTitle.textContent = name;

            inputMind.value = t.mind_score ?? 0;
            valMind.textContent = inputMind.value;

            inputAction.value = t.action_score ?? 0;
            valAction.textContent = inputAction.value;

            inputEmotion.value = t.emotion_score ?? 0;
            valEmotion.textContent = inputEmotion.value;

            inputConsistency.value = t.consistency_score ?? 0;
            valConsistency.textContent = inputConsistency.value;

            inputFocus.value = t.focus_score ?? 0;
            valFocus.textContent = inputFocus.value;

            inputWork.value = t.work_score ?? 0;
            valWork.textContent = inputWork.value;

            detailModal.classList.add("visible");
        }

        function openRemind(t) {
            currentRemindTask = t;

            const name = t.task_name || t.title || "(ç„¡é¡Œ)";
            remindTaskTitle.textContent = name;

            if (t.remind_at) {
                inputRemindAt.value = toLocalDatetimeValue(t.remind_at);
                valRemindAt.textContent = formatRemindLabel(t.remind_at);
            } else {
                inputRemindAt.value = "";
                valRemindAt.textContent = "";
            }

            remindModal.classList.add("visible");
        }

        /* ==========================
           BUTTON HELPER
        ========================== */
        function mkBtn(label, onClick, cls) {
            const b = document.createElement("button");
            b.textContent = label;
            if (cls) b.className = cls;

            const handler = (e) => {
                e.stopPropagation();
                e.preventDefault();
                onClick();
            };

            if ("ontouchend" in window) {
                b.addEventListener("touchend", handler, { passive: false });
            } else {
                b.addEventListener("click", handler);
            }

            return b;
        }

        /* ==========================
           API ACTION
        ========================== */
        async function action(kind, id, extra = {}) {
            const url = `${API_BASE}/action`;
            try {
                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        user_id: userId,
                        action: kind,
                        task_id: id,
                        ...extra
                    })
                });

                const text = await res.text();
                console.log("[ACTION]", kind, "status:", res.status, "resp:", text);

                if (!res.ok) {
                    alert("æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ" + res.status + "ï¼‰");
                    return;
                }
            } catch (e) {
                console.error("[ACTION] fetch error:", e);
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ");
            } finally {
                // â˜… é€šçŸ¥è¨­å®šã®ã¨ãã¯ãƒ•ãƒ­ãƒ³ãƒˆã§ç›´æ¥ãƒ©ãƒ™ãƒ«æ›´æ–°ã—ã¦ã„ã‚‹ã®ã§å†èª­ã¿è¾¼ã¿ã¯ã—ãªã„
                if (kind !== "remind_custom") {
                    loadList();
                }
            }
        }


        init();
    </script>
</body>
</html>





