<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ãƒ ã‚­ãƒ ã‚­ã‚¿ã‚¹ãã‚“</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, system-ui;
            margin: 0;
            background: #f7f7f8;
        }

        /* ========== ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸Šéƒ¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä»˜ç®‹é¢¨ï¼‰ ========== */
        .tab-nav {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, #f0f0f2 0%, #f7f7f8 100%);
            display: flex;
            padding: 12px 12px 0;
            gap: 4px;
            z-index: 100;
        }
        .tab-nav-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            padding: 10px 16px 14px;
            background: #e0e0e3;
            border-radius: 12px 12px 0 0;
            position: relative;
            transition: all 0.2s ease;
            flex: 1;
            border: 1px solid #d0d0d5;
            border-bottom: none;
        }
        .tab-nav-item:hover {
            background: #eaeaec;
        }
        .tab-nav-item.active {
            background: #fff;
            color: #7e6dff;
            font-weight: 600;
            border-color: #ccc;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
            z-index: 2;
        }
        .tab-nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: #fff;
        }
        .tab-nav-item span {
            font-size: 16px;
        }

        /* ========== ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ========== */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* ========== ãƒ˜ãƒƒãƒ€ãƒ¼ ========== */
        header {
            position: sticky;
            top: 0;
            background: #fff;
            border-bottom: 1px solid #eee;
            z-index: 10;
        }
        .bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
        }
        .bar-title {
            font-weight: 600;
            font-size: 16px;
        }
        .bar-btn {
            padding: 6px 12px;
            border-radius: 14px;
            border: 1px solid #ddd;
            font-size: 13px;
            cursor: pointer;
            background: #fff;
        }

        /* ========== ãƒªã‚¹ãƒˆã‚¿ãƒ– ========== */
        .add {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
        }
        .add input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        .add button {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            background: #111;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        .list {
            display: flex;
            flex-direction: column;
        }
        .card {
            position: relative;
            background: white;
            border-bottom: 1px solid #eee;
            height: 60px;
            overflow: hidden;
            touch-action: pan-y;
        }
        .card.completed .title {
            color: #aaa;
            text-decoration: line-through;
        }
        .card.dragging {
            opacity: 0.95;
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            z-index: 100;
            transform: scale(1.02);
            background: #fff;
        }
        .card.drag-placeholder {
            background: #f0f0f0;
            border: 2px dashed #ccc;
        }
        .card.drag-placeholder .sl,
        .card.drag-placeholder .actions-rail {
            visibility: hidden;
        }
        .sl {
            position: relative;
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 0 12px;
            transition: transform .15s ease;
            background: white;
            z-index: 2;
        }
        .actions-rail {
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 1;
        }
        .card.open-left .actions-rail,
        .card.open-right .actions-rail {
            pointer-events: auto;
        }
        .actions-left, .actions-right {
            height: 100%;
            display: flex;
            align-items: center;
        }
        .actions-left {
            background: #e8f7ee;
            justify-content: flex-start;
        }
        .actions-right {
            background: #fdeeee;
            justify-content: flex-end;
        }
        .actions-rail button {
            height: 100%;
            min-width: 64px;
            border: none;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }
        .btn-complete { background: #7e6dff; }
        .btn-plus2h { background: #8012e2; }
        .btn-detail { background: #1e928b; }
        .btn-pin { background: #d97706; }
        .btn-delete { background: #f03d30; }
        .title { font-size: 15px; }
        .handle {
            margin-left: auto;
            cursor: grab;
            opacity: 0.25;
            padding: 0 8px;
            font-size: 20px;
            touch-action: none;
        }
        .divider-label {
            text-align: center;
            color: #888;
            font-size: 12px;
            padding: 10px 0 6px;
            background: #f7f7f8;
        }
        .remindAt {
            font-size: 11px;
            color: #666;
            margin-left: 8px;
            white-space: nowrap;
        }

        /* ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¹ã‚¯ */
        .mission-task-wrapper {
            position: relative;
            margin: 12px 16px;
        }
        .mission-task-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 16px;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        .mission-task-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -30%;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        .mission-task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .mission-task-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
        }
        .mission-task-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .mission-task-desc {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 12px;
        }
        .mission-task-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .mission-complete-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mission-complete-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .mission-complete-btn.completed {
            background: rgba(255, 255, 255, 0.9);
            color: #764ba2;
        }
        .mission-expire {
            font-size: 11px;
            opacity: 0.8;
        }
        /* é”æˆè€…æ•°ã®å¹ãå‡ºã— */
        .mission-achievement-bubble {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff6b6b;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
            animation: pulse 2s infinite;
            z-index: 5;
        }
        .mission-achievement-bubble::before {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #ff6b6b;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ========== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ– ========== */
        .status-section {
            background: #fff;
            margin: 12px;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .status-section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .daily-task-card {
            cursor: pointer;
        }
        .daily-task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .daily-task-arrow {
            font-size: 14px;
            color: #888;
            transition: transform 0.2s;
        }
        .daily-task-card.expanded .daily-task-arrow {
            transform: rotate(180deg);
        }
        .daily-task-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .daily-task-card.expanded .daily-task-content {
            max-height: 400px;
        }
        .habit-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .habit-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: #f7f7f8;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
        }
        .habit-item:active {
            background: #eeeeee;
            transform: scale(0.98);
        }
        .habit-item.checked {
            background: rgba(126, 109, 255, 0.1);
            border: 1px solid rgba(126, 109, 255, 0.3);
        }
        .habit-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            color: #7e6dff;
            transition: all 0.15s;
        }
        .habit-checkbox.checked {
            background: #7e6dff;
            border-color: #7e6dff;
            color: white;
        }
        .habit-name { flex: 1; font-size: 14px; }
        .habit-icon { font-size: 18px; }
        .daily-task-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        .daily-btn {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        .daily-btn-cancel {
            background: #fafafa;
            color: #666;
        }
        .daily-btn-save {
            background: #7e6dff;
            color: white;
            border-color: #7e6dff;
        }
        /* é€±é–“ãƒ“ãƒ¥ãƒ¼ */
        .week-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-top: 8px;
        }
        .week-table th, .week-table td {
            padding: 8px 4px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        .week-table th {
            color: #888;
            font-weight: normal;
        }
        .week-table td:first-child, .week-table th:first-child {
            text-align: left;
            font-size: 12px;
        }
        .week-table .checked { color: #7e6dff; }
        .week-table .unchecked { color: #ddd; }
        /* åˆ†æ */
        .progress-bar-container { margin-top: 8px; }
        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 6px;
        }
        .progress-label-name { color: #888; }
        .progress-label-value { color: #7e6dff; font-weight: 600; }
        .progress-bar-bg {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: #7e6dff;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* ========== ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚¿ãƒ– ========== */
        .journal-form {
            background: #fff;
            margin: 12px;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .form-group { margin-bottom: 12px; }
        .form-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
            display: block;
        }
        .form-input, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #7e6dff;
        }
        .journal-submit-btn {
            width: 100%;
            padding: 12px;
            background: #7e6dff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        .journal-list {
            margin: 0 12px;
        }
        .journal-card {
            background: #fff;
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            cursor: pointer;
        }
        .journal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .journal-date {
            font-size: 11px;
            color: #888;
        }
        .journal-tasks-count {
            font-size: 11px;
            color: #7e6dff;
        }
        .journal-title-text {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .journal-preview {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .journal-card-expand {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .journal-card.expanded .journal-card-expand {
            max-height: 500px;
        }
        .journal-full-content {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }
        .journal-body {
            font-size: 13px;
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .journal-edit-btn {
            margin-top: 12px;
            width: 100%;
            padding: 8px;
            background: #f7f7f8;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }

        /* ========== ãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
        .modal-root {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 50;
            align-items: flex-end;
            justify-content: center;
        }
        .modal-root.visible { display: flex; }
        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,.25);
            z-index: 0;
        }
        .modal-panel {
            width: 100%;
            max-width: 480px;
            background: #fff;
            border-radius: 20px 20px 0 0;
            padding: 16px;
            animation: slideUp .18s ease-out;
            position: relative;
            z-index: 1;
        }
        @keyframes slideUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .slider-group { margin: 14px 0; }
        .slider-label-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }
        .slider-label-row span.value {
            font-size: 13px;
            font-weight: 600;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 14px;
        }
        .btn-secondary {
            padding: 8px 14px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: #fafafa;
            cursor: pointer;
        }
        .btn-primary-solid {
            padding: 8px 16px;
            border-radius: 20px;
            background: #7e6dff;
            color: white;
            border: none;
            cursor: pointer;
        }

        /* ========== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ========== */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 14px;
        }

        /* ========== æœˆé–“åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
        .monthly-analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .month-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .month-selector-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .month-selector-btn:hover {
            background: #f5f5f5;
        }
        .current-month {
            font-size: 16px;
            font-weight: 600;
            min-width: 100px;
            text-align: center;
        }
        .monthly-stats-summary {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        .monthly-stat-card {
            flex: 1;
            background: #f7f7f8;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }
        .monthly-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #7e6dff;
        }
        .monthly-stat-label {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }
        .monthly-table-container {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 16px;
        }
        .monthly-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        .monthly-table th, .monthly-table td {
            padding: 8px 4px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        .monthly-table th {
            background: #f7f7f8;
            position: sticky;
            top: 0;
            font-weight: 600;
            color: #666;
        }
        .monthly-table td:first-child {
            text-align: left;
            font-weight: 500;
        }
        .monthly-table .cell-check { color: #7e6dff; }
        .monthly-table .cell-uncheck { color: #ddd; }
        .monthly-chart-container {
            height: 180px;
            margin-top: 16px;
        }
        .detail-view-btn {
            background: linear-gradient(135deg, #7e6dff 0%, #9d8fff 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .detail-view-btn:hover {
            opacity: 0.9;
        }
        .week-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        /* ========== ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
        .journal-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .journal-modal-date {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }
        .journal-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .journal-tasks-section {
            background: #f7f7f8;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .journal-tasks-header {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .journal-tasks-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .journal-task-chip {
            background: #7e6dff;
            color: white;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 12px;
        }
        .journal-task-chip.not-completed {
            background: #ddd;
            color: #888;
        }
        .journal-content-section {
            margin-bottom: 16px;
        }
        .journal-content-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }
        .journal-content-body {
            font-size: 14px;
            line-height: 1.7;
            color: #333;
            white-space: pre-wrap;
        }
        .journal-modal-actions {
            display: flex;
            gap: 10px;
        }
        .journal-modal-actions button {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
        }
        .journal-close-btn {
            background: #f7f7f8;
            border: 1px solid #ddd;
            color: #666;
        }
        .journal-edit-modal-btn {
            background: #7e6dff;
            border: none;
            color: white;
        }
        .journal-edit-form {
            display: none;
        }
        .journal-edit-form.active {
            display: block;
        }
        .journal-view-content {
            display: block;
        }
        .journal-view-content.hidden {
            display: none;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

    <!-- ========== ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸Šéƒ¨ï¼‰ ========== -->
    <nav class="tab-nav">
        <div class="tab-nav-item active" data-tab="list">
            <span>ğŸ“‹</span>
            ãƒªã‚¹ãƒˆ
        </div>
        <div class="tab-nav-item" data-tab="status">
            <span>ğŸ“Š</span>
            ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        </div>
        <div class="tab-nav-item" data-tab="journal">
            <span>ğŸ“</span>
            ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
        </div>
    </nav>

    <!-- ========== ãƒªã‚¹ãƒˆã‚¿ãƒ– ========== -->
    <div id="tab-list" class="tab-content active">
        <header>
            <div class="bar">
                <div class="bar-title">ãƒªã‚¹ãƒˆ</div>
                <button class="bar-btn" id="refreshBtn">â†»</button>
            </div>
        </header>
        <main>
            <!-- ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¹ã‚¯ -->
            <div id="missionTaskContainer"></div>

            <div class="add">
                <input id="newTitle" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›â€¦" />
                <button id="btnAdd">è¿½åŠ </button>
            </div>
            <div class="divider-label">ToDoã‚¿ã‚¹ã‚¯</div>
            <div id="pinned" class="list"></div>
            <div id="active" class="list"></div>
            <div class="divider-label">é”æˆã‚¿ã‚¹ã‚¯</div>
            <div id="completed" class="list"></div>
        </main>
    </div>

    <!-- ========== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ– ========== -->
    <div id="tab-status" class="tab-content">
        <header>
            <div class="bar">
                <div class="bar-title">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                <button class="bar-btn" id="statusRefreshBtn">â†»</button>
            </div>
        </header>
        <main>
            <!-- ãƒ‡ã‚¤ãƒªãƒ¼ã‚¿ã‚¹ã‚¯ -->
            <div class="status-section daily-task-card" id="dailyTaskCard">
                <div class="daily-task-header">
                    <div class="status-section-title">
                        <span>ğŸ“‹</span> ãƒ‡ã‚¤ãƒªãƒ¼ã‚¿ã‚¹ã‚¯
                    </div>
                    <span class="daily-task-arrow">â–¼</span>
                </div>
                <div class="daily-task-content">
                    <div class="habit-list" id="habitList"></div>
                    <div class="daily-task-buttons">
                        <button class="daily-btn daily-btn-cancel" id="habitCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="daily-btn daily-btn-save" id="habitSaveBtn">ä¿å­˜ã™ã‚‹</button>
                    </div>
                </div>
            </div>

            <!-- é€±é–“ãƒ“ãƒ¥ãƒ¼ -->
            <div class="status-section">
                <div class="week-view-header">
                    <div class="status-section-title" style="margin-bottom:0;">
                        <span>ğŸ“…</span> é€±é–“ãƒ“ãƒ¥ãƒ¼
                    </div>
                    <button class="detail-view-btn" id="openMonthlyAnalysis">
                        <span>ğŸ“Š</span> è©³ã—ãè¦‹ã‚‹
                    </button>
                </div>
                <table class="week-table" id="weekTable">
                    <thead>
                        <tr>
                            <th>ç¿’æ…£</th>
                            <th>æœˆ</th>
                            <th>ç«</th>
                            <th>æ°´</th>
                            <th>æœ¨</th>
                            <th>é‡‘</th>
                            <th>åœŸ</th>
                            <th>æ—¥</th>
                        </tr>
                    </thead>
                    <tbody id="weekTableBody"></tbody>
                </table>
            </div>

            <!-- åˆ†æ -->
            <div class="status-section">
                <div class="status-section-title">
                    <span>ğŸ“Š</span> åˆ†æ
                </div>
                <div class="progress-bar-container">
                    <div class="progress-label">
                        <span class="progress-label-name">é€±é–“é”æˆç‡</span>
                        <span class="progress-label-value" id="weekProgressValue">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="weekProgressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ========== ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚¿ãƒ– ========== -->
    <div id="tab-journal" class="tab-content">
        <header>
            <div class="bar">
                <div class="bar-title">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</div>
                <button class="bar-btn" id="journalRefreshBtn">â†»</button>
            </div>
        </header>
        <main>
            <div class="journal-form">
                <div class="status-section-title" style="margin-bottom:16px;">
                    <span>ğŸ“</span> ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Š
                </div>
                <div class="form-group">
                    <label class="form-label">æ—¥ä»˜</label>
                    <input type="date" class="form-input" id="journalDate" />
                </div>
                <div class="form-group">
                    <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" class="form-input" id="journalTitle" placeholder="ä»Šæ—¥ã®ã²ã¨ã“ã¨â€¦" />
                </div>
                <div class="form-group">
                    <label class="form-label">å†…å®¹</label>
                    <textarea class="form-textarea" id="journalContent" placeholder="ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šã‚’è¨˜éŒ²ã—ã‚ˆã†â€¦"></textarea>
                </div>
                <button class="journal-submit-btn" id="journalSubmitBtn">ä¿å­˜ã™ã‚‹</button>
            </div>

            <div class="divider-label">éå»ã®è¨˜éŒ²</div>
            <div class="journal-list" id="journalList"></div>
        </main>
    </div>

    <!-- ========== ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
    <div id="journalDetailModal" class="modal-root">
        <div class="modal-backdrop" id="journalDetailBackdrop"></div>
        <div class="modal-panel" style="max-height:80vh;overflow-y:auto;">
            <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
            <div id="journalViewContent" class="journal-view-content">
                <div class="journal-modal-header">
                    <div>
                        <div class="journal-modal-date" id="journalModalDate">2025å¹´1æœˆ1æ—¥</div>
                        <div class="journal-modal-title" id="journalModalTitle">ä»Šæ—¥ã®ã²ã¨ã“ã¨</div>
                    </div>
                    <button id="closeJournalDetail" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
                </div>

                <div class="journal-tasks-section">
                    <div class="journal-tasks-header">
                        <span>âœ“</span> ã“ã®æ—¥ã«é”æˆã—ãŸã‚¿ã‚¹ã‚¯
                    </div>
                    <div class="journal-tasks-list" id="journalModalTasks">
                        <!-- ã‚¿ã‚¹ã‚¯ãƒãƒƒãƒ—ãŒã“ã“ã«å…¥ã‚‹ -->
                    </div>
                </div>

                <div class="journal-content-section">
                    <div class="journal-content-label">æŒ¯ã‚Šè¿”ã‚Šå†…å®¹</div>
                    <div class="journal-content-body" id="journalModalContent">
                        å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>

                <div class="journal-modal-actions">
                    <button class="journal-close-btn" id="journalCloseBtn">é–‰ã˜ã‚‹</button>
                    <button class="journal-edit-modal-btn" id="journalEditBtn">ç·¨é›†ã™ã‚‹</button>
                </div>
            </div>

            <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ -->
            <div id="journalEditContent" class="journal-edit-form">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <div style="font-weight:600;font-size:16px;">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ç·¨é›†</div>
                    <button id="closeJournalEdit" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
                </div>

                <div class="form-group">
                    <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" class="form-input" id="editJournalTitle" />
                </div>
                <div class="form-group">
                    <label class="form-label">å†…å®¹</label>
                    <textarea class="form-textarea" id="editJournalContent" style="min-height:150px;"></textarea>
                </div>

                <div class="journal-modal-actions">
                    <button class="journal-close-btn" id="journalCancelEditBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="journal-edit-modal-btn" id="journalSaveEditBtn">ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== æœˆé–“åˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
    <div id="monthlyAnalysisModal" class="modal-root">
        <div class="modal-backdrop" id="monthlyAnalysisBackdrop"></div>
        <div class="modal-panel" style="max-height:85vh;overflow-y:auto;">
            <div class="monthly-analysis-header">
                <div style="font-weight:600;font-size:16px;">ğŸ“Š æœˆé–“åˆ†æ</div>
                <button id="closeMonthlyAnalysis" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
            </div>

            <!-- æœˆé¸æŠ -->
            <div class="month-selector">
                <button class="month-selector-btn" id="prevMonthBtn">&lt;</button>
                <div class="current-month" id="currentMonthLabel">2025å¹´1æœˆ</div>
                <button class="month-selector-btn" id="nextMonthBtn">&gt;</button>
            </div>

            <!-- ã‚µãƒãƒªãƒ¼çµ±è¨ˆ -->
            <div class="monthly-stats-summary" style="margin-top:16px;">
                <div class="monthly-stat-card">
                    <div class="monthly-stat-value" id="monthlyTotalDays">0</div>
                    <div class="monthly-stat-label">è¨˜éŒ²æ—¥æ•°</div>
                </div>
                <div class="monthly-stat-card">
                    <div class="monthly-stat-value" id="monthlyAchievement">0%</div>
                    <div class="monthly-stat-label">ç·åˆé”æˆç‡</div>
                </div>
                <div class="monthly-stat-card">
                    <div class="monthly-stat-value" id="monthlyBestStreak">0</div>
                    <div class="monthly-stat-label">æœ€é•·é€£ç¶š</div>
                </div>
            </div>

            <!-- æœˆé–“ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div style="font-weight:600;font-size:14px;margin:16px 0 8px;">æ—¥åˆ¥é”æˆçŠ¶æ³</div>
            <div class="monthly-table-container">
                <table class="monthly-table">
                    <thead>
                        <tr>
                            <th>æ—¥ä»˜</th>
                            <th>ğŸŒ…</th>
                            <th>ğŸ¯</th>
                            <th>ğŸ“š</th>
                            <th>ğŸ“</th>
                            <th>ğŸš«</th>
                            <th>ğŸ’ª</th>
                            <th>é”æˆ</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyTableBody"></tbody>
                </table>
            </div>

            <!-- æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ• -->
            <div style="font-weight:600;font-size:14px;margin:16px 0 8px;">é”æˆç‡ã®æ¨ç§»</div>
            <div class="monthly-chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ========== è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
    <div id="detailModal" class="modal-root">
        <div id="detailBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-weight:600" id="modalTitle">ã‚¿ã‚¹ã‚¯è©³ç´°</div>
                <button id="detailCloseBtn" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
            </div>
            <div id="detailTaskTitle" style="font-size:13px;color:#555;margin-bottom:8px;"></div>

            <!-- ã‚¹ã‚³ã‚¢è¨­å®šã‚°ãƒ«ãƒ¼ãƒ— -->
            <div id="scoreGroup">
                <div class="slider-group">
                    <div class="slider-label-row"><span>å„ªå…ˆåº¦</span><span class="value" id="valPriority"></span></div>
                    <input id="inputPriority" type="range" min="0" max="10" step="1" style="width:100%" />
                </div>
                <div class="slider-group">
                    <div class="slider-label-row"><span>ãƒ“ã‚¸ãƒ§ãƒ³é–¢é€£åº¦</span><span class="value" id="valVision"></span></div>
                    <input id="inputVision" type="range" min="0" max="10" step="1" style="width:100%" />
                </div>
                <div class="slider-group">
                    <div class="slider-label-row"><span>ã‚ãã‚ãåº¦</span><span class="value" id="valExcite"></span></div>
                    <input id="inputExcite" type="range" min="0" max="10" step="1" style="width:100%" />
                </div>
                <div class="slider-group">
                    <div class="slider-label-row"><span>æˆé•·åº¦</span><span class="value" id="valGrowth"></span></div>
                    <input id="inputGrowth" type="range" min="0" max="10" step="1" style="width:100%" />
                </div>
            </div>

            <!-- ãƒªãƒã‚¤ãƒ³ãƒ‰è¨­å®šã‚°ãƒ«ãƒ¼ãƒ— -->
            <div id="remindGroup" class="slider-group">
                <div class="slider-label-row">
                    <span>ãƒªãƒã‚¤ãƒ³ãƒ‰æ—¥æ™‚</span>
                    <span class="value" id="valRemindAt"></span>
                </div>
                <input id="inputRemindAt" type="datetime-local" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;" />
            </div>

            <div class="modal-footer">
                <button id="detailCancelBtn" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="detailSaveBtn" class="btn-primary-solid">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ========== è¨­å®š ==========
        const LIFF_ID = "2008372898-2q9qWmxv";
        const API_BASE = "https://lumicreate.xvps.jp/webhook";

        let userId = null;
        let currentDetailTask = null;
        let modalMode = "detail";

        const HABITS = [
            { id: 'early_wake', name: 'æ—©èµ·ã', icon: 'ğŸŒ…' },
            { id: 'mission', name: 'ãƒŸãƒƒã‚·ãƒ§ãƒ³', icon: 'ğŸ¯' },
            { id: 'reading', name: 'èª­æ›¸/å­¦ç¿’', icon: 'ğŸ“š' },
            { id: 'journal', name: 'ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«', icon: 'ğŸ“' },
            { id: 'no_alcohol', name: 'ç¦é…’', icon: 'ğŸš«' },
            { id: 'workout', name: 'ä»Šæ—¥ãƒˆãƒ¬', icon: 'ğŸ’ª' }
        ];

        let todayHabits = {};
        let weekHabitsData = {};
        let currentMission = null;
        let missionCompletedToday = false;
        let selectedMonth = new Date();
        let monthlyChart = null;
        let monthlyHabitsData = {};
        let currentEditJournal = null;
        let journalsData = [];

        // ã‚¹ãƒ¯ã‚¤ãƒ—è¨­å®š
        const STRONG_RATIO = 0.85;
        const SNAP_THRESHOLD = 40;

        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ãƒ•ãƒ©ã‚°ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ãŸã‚ï¼‰
        let isDraggingCard = false;

        // DOMè¦ç´ 
        const pinnedEl = document.getElementById("pinned");
        const activeEl = document.getElementById("active");
        const completedEl = document.getElementById("completed");

        // ========== åˆæœŸåŒ– ==========
        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                userId = profile.userId;
            } catch (e) {
                console.error("LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e);
                userId = "demo_user";
            }

            bindUI();
            await loadAllData();
        }

        function bindUI() {
            // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
            document.querySelectorAll('.tab-nav-item').forEach(item => {
                item.addEventListener('click', () => switchTab(item.dataset.tab));
            });

            // ãƒªã‚¹ãƒˆã‚¿ãƒ–
            document.getElementById('refreshBtn').onclick = loadList;
            document.getElementById('btnAdd').onclick = addTask;
            document.getElementById('newTitle').addEventListener('keypress', e => {
                if (e.key === 'Enter') addTask();
            });

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ–
            document.getElementById('statusRefreshBtn').onclick = loadHabits;
            document.getElementById('dailyTaskCard').addEventListener('click', e => {
                if (!e.target.closest('.habit-checkbox') && !e.target.closest('.daily-btn')) {
                    document.getElementById('dailyTaskCard').classList.toggle('expanded');
                }
            });
            document.getElementById('habitSaveBtn').onclick = saveHabits;
            document.getElementById('habitCancelBtn').onclick = () => {
                document.getElementById('dailyTaskCard').classList.remove('expanded');
            };
            renderHabitList();

            // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚¿ãƒ–
            document.getElementById('journalRefreshBtn').onclick = loadJournals;
            document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('journalSubmitBtn').onclick = saveJournal;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«
            bindModalUI();
            bindMonthlyAnalysisUI();
            bindJournalDetailModalUI();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-nav-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab-nav-item[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        async function loadAllData() {
            await Promise.all([
                loadList(),
                loadMissionTask(),
                loadHabits(),
                loadJournals()
            ]);
        }

        // ========== ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¹ã‚¯æ©Ÿèƒ½ ==========
        async function loadMissionTask() {
            // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼ˆAPIãŒãªã„å ´åˆã«ä½¿ç”¨ï¼‰
            const demoData = {
                mission: {
                    id: 'demo',
                    title: 'ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³',
                    description: 'æ¯æ—¥10åˆ†é–“ã®ç‘æƒ³ã‚’è¡Œã„ã€å¿ƒã‚’è½ã¡ç€ã‘ã‚ˆã†',
                    expires_at: getNextSunday()
                },
                completed_today: false,
                today_completions: 42
            };

            try {
                const res = await fetch(`${API_BASE}/mission?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                currentMission = data.mission || null;
                missionCompletedToday = data.completed_today || false;
                renderMissionTask(data);
            } catch (e) {
                console.log("[MISSION] API not available, showing demo:", e.message);
                // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                currentMission = demoData.mission;
                missionCompletedToday = demoData.completed_today;
                renderMissionTask(demoData);
            }
        }

        function getNextSunday() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysUntilSunday = (7 - dayOfWeek) % 7 || 7;
            const nextSunday = new Date(today);
            nextSunday.setDate(today.getDate() + daysUntilSunday);
            nextSunday.setHours(23, 59, 59);
            return nextSunday.toISOString();
        }

        function renderMissionTask(data) {
            const container = document.getElementById('missionTaskContainer');
            if (!data.mission) {
                container.innerHTML = '';
                return;
            }

            const mission = data.mission;
            const completedToday = data.completed_today;
            const todayCount = data.today_completions || 0;
            const expiresAt = new Date(mission.expires_at);
            const daysLeft = Math.ceil((expiresAt - new Date()) / (1000 * 60 * 60 * 24));

            container.innerHTML = `
                <div class="mission-task-wrapper">
                    <div class="mission-achievement-bubble">
                        ä»Šæ—¥ã¯${todayCount}äººãŒé”æˆğŸ”¥
                    </div>
                    <div class="mission-task-card">
                        <div class="mission-task-header">
                            <div class="mission-task-badge">
                                <span>ğŸ¯</span>
                                <span>é€±é–“ãƒŸãƒƒã‚·ãƒ§ãƒ³</span>
                            </div>
                        </div>
                        <div class="mission-task-title">${mission.title || 'ä»Šé€±ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³'}</div>
                        <div class="mission-task-desc">${mission.description || ''}</div>
                        <div class="mission-task-actions">
                            <button class="mission-complete-btn ${completedToday ? 'completed' : ''}" id="missionCompleteBtn">
                                ${completedToday ? 'âœ“ é”æˆæ¸ˆã¿' : 'é”æˆã™ã‚‹'}
                            </button>
                            <div class="mission-expire">æ®‹ã‚Š${daysLeft}æ—¥</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('missionCompleteBtn').addEventListener('click', async () => {
                if (completedToday) return;
                await completeMission(mission.id);
            });
        }

        async function completeMission(missionId) {
            // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯APIå‘¼ã³å‡ºã—
            const updateUI = () => {
                missionCompletedToday = true;
                const btn = document.getElementById('missionCompleteBtn');
                if (btn) {
                    btn.classList.add('completed');
                    btn.textContent = 'âœ“ é”æˆæ¸ˆã¿';
                }
            };

            try {
                const res = await fetch(`${API_BASE}/mission/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        mission_id: missionId
                    })
                });
                if (res.ok) {
                    missionCompletedToday = true;
                    await loadMissionTask();
                } else {
                    // APIå¤±æ•—æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§æ›´æ–°
                    updateUI();
                }
            } catch (e) {
                console.log("[MISSION] complete - demo mode:", e.message);
                // ãƒ‡ãƒ¢ç”¨ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã§å®Œäº†çŠ¶æ…‹ã‚’æ›´æ–°
                updateUI();
            }
        }

        // ========== ãƒªã‚¹ãƒˆæ©Ÿèƒ½ ==========
        async function loadList() {
            try {
                const res = await fetch(`${API_BASE}/list?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                renderList(data);
            } catch (e) {
                console.error("[LIST] error:", e);
                renderList({ pinned: [], active: [], completed: [] });
            }
        }

        function renderList(payload) {
            pinnedEl.innerHTML = "";
            activeEl.innerHTML = "";
            completedEl.innerHTML = "";

            const pinned = Array.isArray(payload.pinned) ? payload.pinned : [];
            const active = Array.isArray(payload.active) ? payload.active : [];
            const completed = Array.isArray(payload.completed) ? payload.completed : [];

            pinned.forEach(t => pinnedEl.appendChild(taskCard(t, false)));
            active.forEach(t => activeEl.appendChild(taskCard(t, false)));
            completed.forEach(t => completedEl.appendChild(taskCard(t, true)));
        }

        async function addTask() {
            const input = document.getElementById('newTitle');
            const title = input.value.trim();
            if (!title) return;
            await action("create", null, { task_name: title });
            input.value = "";
        }

        function taskCard(t, isCompleted = false) {
            const wrap = document.createElement("div");
            wrap.className = "card";
            if (isCompleted) wrap.classList.add("completed");

            const rail = document.createElement("div");
            rail.className = "actions-rail";

            const left = document.createElement("div");
            left.className = "actions-left";
            if (!isCompleted) {
                left.append(
                    mkBtn("å®Œäº†", () => action("complete", t.id), "btn-complete"),
                    mkBtn("é€šçŸ¥", () => openRemind(t), "btn-plus2h")
                );
            } else {
                left.append(mkBtn("æœªå®Œ", () => action("uncomplete", t.id), "btn-complete"));
            }

            const right = document.createElement("div");
            right.className = "actions-right";
            right.append(
                mkBtn("è©³ç´°", () => openDetail(t), "btn-detail"),
                mkBtn(t.pinned ? "ğŸ“è§£é™¤" : "ğŸ“ãƒ”ãƒ³", () => action("toggle_pin", t.id), "btn-pin"),
                mkBtn("å‰Šé™¤", () => {
                    if (t.pinned) return alert("ãƒ”ãƒ³ã‚’å¤–ã—ã¦ãã ã•ã„ï¼");
                    action("delete", t.id);
                }, "btn-delete")
            );

            rail.append(left, right);

            const sl = document.createElement("div");
            sl.className = "sl";

            const titleEl = document.createElement("div");
            titleEl.className = "title";
            const name = t.task_name || t.title || "(ç„¡é¡Œ)";
            titleEl.textContent = t.pinned ? "ğŸ“ " + name : name;

            const leftBox = document.createElement("div");
            leftBox.style.flex = "1";
            leftBox.appendChild(titleEl);

            const rightBox = document.createElement("div");
            rightBox.className = "rightBox";
            rightBox.style.display = "flex";
            rightBox.style.alignItems = "center";

            if (t.remind_at) {
                const remindEl = document.createElement("div");
                remindEl.className = "remindAt";
                remindEl.textContent = formatRemindLabel(t.remind_at);
                rightBox.appendChild(remindEl);
            }

            const handle = document.createElement("div");
            handle.className = "handle";
            handle.textContent = "â˜°";
            rightBox.appendChild(handle);

            sl.append(leftBox, rightBox);
            wrap.append(rail, sl);

            // ãƒœã‚¿ãƒ³å¹…æ¸¬å®š
            requestAnimationFrame(() => {
                wrap.dataset.leftWidth = left.getBoundingClientRect().width || 140;
                wrap.dataset.rightWidth = right.getBoundingClientRect().width || 140;
            });

            // PCç‰ˆã‚¯ãƒªãƒƒã‚¯
            if (!/Mobi|Android/i.test(navigator.userAgent)) {
                sl.addEventListener("click", e => {
                    const rect = sl.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const leftW = Number(wrap.dataset.leftWidth) || 140;
                    const rightW = Number(wrap.dataset.rightWidth) || 140;

                    if (wrap.classList.contains("open-left") || wrap.classList.contains("open-right")) {
                        wrap.classList.remove("open-left", "open-right");
                        sl.style.transform = "translateX(0)";
                        return;
                    }
                    if (x < rect.width / 2) {
                        wrap.classList.add("open-left");
                        sl.style.transform = `translateX(${leftW}px)`;
                    } else {
                        wrap.classList.add("open-right");
                        sl.style.transform = `translateX(${-rightW}px)`;
                    }
                });
            }

            // ã‚¹ãƒãƒ›ç‰ˆã‚¹ãƒ¯ã‚¤ãƒ—
            let startX = 0, startY = 0, dx = 0, dy = 0;
            let isHandleDrag = false;
            let isScrolling = null;

            wrap.addEventListener("touchstart", e => {
                // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ç„¡åŠ¹åŒ–
                if (isDraggingCard) return;
                if (e.target.closest("button")) return;

                // â˜°ï¼ˆ.handleï¼‰ã‹ã‚‰å§‹ã¾ã£ãŸã‚¿ãƒƒãƒãªã‚‰ã‚¹ãƒ¯ã‚¤ãƒ—å‡¦ç†ã—ãªã„
                if (e.target.closest(".handle")) {
                    isHandleDrag = true;
                    return;
                } else {
                    isHandleDrag = false;
                }

                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                dx = 0;
                dy = 0;
                isScrolling = null;
                sl.style.transition = "none";
            }, { passive: true });

            wrap.addEventListener("touchmove", e => {
                if (isDraggingCard) return;
                if (isHandleDrag) return;
                if (e.touches.length === 0) return;

                dx = e.touches[0].clientX - startX;
                dy = e.touches[0].clientY - startY;

                // æ–¹å‘ãŒã¾ã ç¢ºå®šã—ã¦ã„ãªã„å ´åˆã€ä¸€å®šè·é›¢å‹•ã„ãŸã‚‰åˆ¤å®š
                if (isScrolling === null && (Math.abs(dx) > 8 || Math.abs(dy) > 8)) {
                    isScrolling = Math.abs(dy) > Math.abs(dx);
                }

                // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å„ªä½ã®å ´åˆã¯æ¨ªã‚¹ãƒ©ã‚¤ãƒ‰ã—ãªã„
                if (isScrolling) return;

                if (Math.abs(dx) > 8) e.preventDefault();
                sl.style.transform = `translateX(${dx}px)`;
            }, { passive: false });

            wrap.addEventListener("touchend", () => {
                if (isDraggingCard) return;

                if (isHandleDrag) {
                    isHandleDrag = false;
                    sl.style.transition = "";
                    sl.style.transform = "translateX(0)";
                    return;
                }

                if (isScrolling) {
                    sl.style.transition = "";
                    sl.style.transform = "translateX(0)";
                    return;
                }

                sl.style.transition = "transform .15s";
                const leftW = Number(wrap.dataset.leftWidth) || 140;
                const rightW = Number(wrap.dataset.rightWidth) || 140;

                if (dx > leftW * STRONG_RATIO) {
                    isCompleted ? action("uncomplete", t.id) : action("complete", t.id);
                    wrap.classList.remove("open-left", "open-right");
                    sl.style.transform = "translateX(0)";
                    return;
                }
                if (dx < -rightW * STRONG_RATIO) {
                    if (t.pinned) alert("ãƒ”ãƒ³ã‚’å¤–ã—ã¦ãã ã•ã„ï¼");
                    else action("delete", t.id);
                    wrap.classList.remove("open-left", "open-right");
                    sl.style.transform = "translateX(0)";
                    return;
                }

                if (dx > SNAP_THRESHOLD) {
                    wrap.classList.add("open-left");
                    wrap.classList.remove("open-right");
                    sl.style.transform = `translateX(${leftW}px)`;
                } else if (dx < -SNAP_THRESHOLD) {
                    wrap.classList.add("open-right");
                    wrap.classList.remove("open-left");
                    sl.style.transform = `translateX(${-rightW}px)`;
                } else {
                    wrap.classList.remove("open-left", "open-right");
                    sl.style.transform = "translateX(0)";
                }
            });

            // â˜° ã§ä¸¦ã³æ›¿ãˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼‰- æ”¹å–„ç‰ˆ
            const startDrag = (startEvent) => {
                startEvent.preventDefault();
                startEvent.stopPropagation();

                const card = wrap;
                const list = card.parentElement;
                if (!list) return;

                isDraggingCard = true;

                // ã‚¹ãƒ¯ã‚¤ãƒ—çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                card.classList.remove("open-left", "open-right");
                sl.style.transition = "";
                sl.style.transform = "translateX(0)";

                // åˆæœŸä½ç½®ã‚’è¨˜éŒ²
                const cardRect = card.getBoundingClientRect();
                const startY = startEvent.clientY || (startEvent.touches && startEvent.touches[0].clientY);
                const cardStartTop = cardRect.top;
                const cardHeight = cardRect.height;

                // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆï¼ˆå…ƒã®ä½ç½®ã‚’ç¤ºã™ï¼‰
                const placeholder = document.createElement("div");
                placeholder.className = "card drag-placeholder";
                placeholder.style.height = cardHeight + "px";
                list.insertBefore(placeholder, card);

                // ã‚«ãƒ¼ãƒ‰ã‚’æµ®ã‹ã›ã‚‹ï¼ˆposition: fixed ã§ç”»é¢ã«å›ºå®šï¼‰
                card.classList.add("dragging");
                card.style.position = "fixed";
                card.style.left = cardRect.left + "px";
                card.style.top = cardRect.top + "px";
                card.style.width = cardRect.width + "px";
                card.style.height = cardHeight + "px";
                card.style.pointerEvents = "none";

                document.body.style.userSelect = "none";
                document.body.appendChild(card);

                const getY = (ev) => {
                    if (ev.touches && ev.touches.length > 0) {
                        return ev.touches[0].clientY;
                    }
                    return ev.clientY;
                };

                const onMove = (ev) => {
                    const currentY = getY(ev);
                    const deltaY = currentY - startY;

                    // ã‚«ãƒ¼ãƒ‰ã‚’æŒ‡ã«è¿½å¾“ã•ã›ã‚‹
                    card.style.top = (cardStartTop + deltaY) + "px";

                    // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ä½ç½®ã‚’æ›´æ–°
                    const cardCenterY = cardStartTop + deltaY + cardHeight / 2;
                    const siblings = Array.from(list.querySelectorAll(".card:not(.dragging)"));

                    for (let i = 0; i < siblings.length; i++) {
                        const sibling = siblings[i];
                        if (sibling === placeholder) continue;

                        const siblingRect = sibling.getBoundingClientRect();
                        const siblingCenterY = siblingRect.top + siblingRect.height / 2;

                        if (cardCenterY < siblingCenterY) {
                            if (placeholder.nextSibling !== sibling) {
                                list.insertBefore(placeholder, sibling);
                            }
                            return;
                        }
                    }

                    // å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ã‚ˆã‚Šä¸‹ãªã‚‰ã€æœ€å¾Œã«ç§»å‹•
                    if (placeholder.nextSibling !== null) {
                        list.appendChild(placeholder);
                    }
                };

                const onUp = () => {
                    document.removeEventListener("pointermove", onMove);
                    document.removeEventListener("pointerup", onUp);
                    document.removeEventListener("touchmove", onMove);
                    document.removeEventListener("touchend", onUp);

                    // ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                    card.classList.remove("dragging");
                    card.style.position = "";
                    card.style.left = "";
                    card.style.top = "";
                    card.style.width = "";
                    card.style.height = "";
                    card.style.pointerEvents = "";

                    // ã‚¹ãƒ¯ã‚¤ãƒ—çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
                    card.classList.remove("open-left", "open-right");
                    const slEl = card.querySelector(".sl");
                    if (slEl) {
                        slEl.style.transition = "";
                        slEl.style.transform = "translateX(0)";
                    }

                    // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒå­˜åœ¨ã—ã€ãƒªã‚¹ãƒˆå†…ã«ã‚ã‚‹å ´åˆã®ã¿æŒ¿å…¥
                    if (placeholder && placeholder.parentNode === list) {
                        list.insertBefore(card, placeholder);
                        placeholder.remove();
                    } else if (list) {
                        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒãªã„å ´åˆã¯ãƒªã‚¹ãƒˆã®æœ«å°¾ã«è¿½åŠ 
                        list.appendChild(card);
                        if (placeholder && placeholder.parentNode) {
                            placeholder.remove();
                        }
                    }

                    document.body.style.userSelect = "";

                    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†ãƒ•ãƒ©ã‚°ã‚’OFFï¼ˆå°‘ã—é…å»¶ã•ã›ã¦èª¤ä½œå‹•é˜²æ­¢ï¼‰
                    setTimeout(() => {
                        isDraggingCard = false;
                    }, 100);

                    saveSortOrder();
                };

                document.addEventListener("pointermove", onMove);
                document.addEventListener("pointerup", onUp);
                document.addEventListener("touchmove", onMove, { passive: false });
                document.addEventListener("touchend", onUp);
            };

            // PointerEventã¨TouchEventã®ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆ
            handle.addEventListener("pointerdown", (e) => {
                e.preventDefault();
                startDrag(e);
            });
            handle.addEventListener("touchstart", (e) => {
                e.preventDefault();
                e.stopPropagation();
                startDrag(e);
            }, { passive: false });

            wrap.__taskData = t;
            wrap.dataset.taskId = t.id;
            return wrap;
        }

        // ä¸¦ã³é †ä¿å­˜
        async function saveSortOrder() {
            if (!userId) return;

            const orders = [];
            [pinnedEl, activeEl, completedEl].forEach((listEl, sectionIdx) => {
                const section = ['pinned', 'active', 'completed'][sectionIdx];
                listEl.querySelectorAll('.card').forEach((card, index) => {
                    const t = card.__taskData;
                    if (t) orders.push({ id: t.id, sort_order: index, section });
                });
            });

            if (orders.length > 0) {
                await action("sort_update", null, { orders });
            }
        }

        // ========== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ©Ÿèƒ½ ==========
        function renderHabitList() {
            const container = document.getElementById('habitList');
            container.innerHTML = HABITS.map(h => `
                <div class="habit-item" data-habit="${h.id}">
                    <div class="habit-checkbox" data-habit="${h.id}"></div>
                    <span class="habit-name">${h.name}</span>
                    <span class="habit-icon">${h.icon}</span>
                </div>
            `).join('');

            // ã‚«ãƒ¼ãƒ‰å…¨ä½“ã§ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«
            container.querySelectorAll('.habit-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation(); // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚’é˜²æ­¢
                    const id = item.dataset.habit;
                    const cb = item.querySelector('.habit-checkbox');
                    todayHabits[id] = !todayHabits[id];
                    cb.classList.toggle('checked', todayHabits[id]);
                    cb.textContent = todayHabits[id] ? 'âœ“' : '';
                    item.classList.toggle('checked', todayHabits[id]);
                });
            });
        }

        async function loadHabits() {
            try {
                const res = await fetch(`${API_BASE}/habits?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                weekHabitsData = data.week || {};
                todayHabits = data.today || {};
                renderWeekView();
                renderHabitAnalysis(data);
                updateHabitCheckboxes();
            } catch (e) {
                console.error("[HABITS] error:", e);
                renderWeekView();
                renderHabitAnalysis({ week_progress: 0 });
            }
        }

        function updateHabitCheckboxes() {
            document.querySelectorAll('.habit-item').forEach(item => {
                const id = item.dataset.habit;
                const cb = item.querySelector('.habit-checkbox');
                const isChecked = !!todayHabits[id];
                cb.classList.toggle('checked', isChecked);
                cb.textContent = isChecked ? 'âœ“' : '';
                item.classList.toggle('checked', isChecked);
            });
        }

        function renderWeekView() {
            const tbody = document.getElementById('weekTableBody');
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

            let html = '';
            HABITS.forEach(h => {
                html += `<tr><td>${h.icon} ${h.name}</td>`;
                days.forEach(day => {
                    const checked = weekHabitsData[day]?.[h.id] ? 'checked' : 'unchecked';
                    html += `<td class="${checked}">${checked === 'checked' ? 'â—' : 'â—‹'}</td>`;
                });
                html += '</tr>';
            });
            tbody.innerHTML = html;
        }

        function renderHabitAnalysis(data) {
            const progress = data.week_progress || 0;
            document.getElementById('weekProgressValue').textContent = `${progress}%`;
            document.getElementById('weekProgressBar').style.width = `${progress}%`;
        }

        // ========== æœˆé–“åˆ†ææ©Ÿèƒ½ ==========
        function bindMonthlyAnalysisUI() {
            const modal = document.getElementById('monthlyAnalysisModal');
            const closeModal = () => modal.classList.remove('visible');

            document.getElementById('openMonthlyAnalysis').addEventListener('click', () => {
                selectedMonth = new Date();
                modal.classList.add('visible');
                loadMonthlyData();
            });

            document.getElementById('monthlyAnalysisBackdrop').addEventListener('click', closeModal);
            document.getElementById('closeMonthlyAnalysis').addEventListener('click', closeModal);

            document.getElementById('prevMonthBtn').addEventListener('click', () => {
                selectedMonth.setMonth(selectedMonth.getMonth() - 1);
                loadMonthlyData();
            });

            document.getElementById('nextMonthBtn').addEventListener('click', () => {
                const now = new Date();
                if (selectedMonth.getFullYear() < now.getFullYear() ||
                    (selectedMonth.getFullYear() === now.getFullYear() && selectedMonth.getMonth() < now.getMonth())) {
                    selectedMonth.setMonth(selectedMonth.getMonth() + 1);
                    loadMonthlyData();
                }
            });
        }

        async function loadMonthlyData() {
            const year = selectedMonth.getFullYear();
            const month = selectedMonth.getMonth() + 1;
            document.getElementById('currentMonthLabel').textContent = `${year}å¹´${month}æœˆ`;

            try {
                const res = await fetch(`${API_BASE}/habits/monthly?user_id=${encodeURIComponent(userId)}&year=${year}&month=${month}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                monthlyHabitsData = data.days || {};
                renderMonthlyAnalysis(data);
            } catch (e) {
                console.error("[MONTHLY] error:", e);
                // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                renderMonthlyAnalysis(generateDemoMonthlyData(year, month));
            }
        }

        function generateDemoMonthlyData(year, month) {
            const daysInMonth = new Date(year, month, 0).getDate();
            const days = {};
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isRecord = Math.random() > 0.3;
                if (isRecord) {
                    days[dateStr] = {
                        early_wake: Math.random() > 0.4,
                        mission: Math.random() > 0.5,
                        reading: Math.random() > 0.3,
                        journal: Math.random() > 0.4,
                        no_alcohol: Math.random() > 0.2,
                        workout: Math.random() > 0.5
                    };
                }
            }
            return { days, total_days: Object.keys(days).length };
        }

        function renderMonthlyAnalysis(data) {
            const days = data.days || {};
            const year = selectedMonth.getFullYear();
            const month = selectedMonth.getMonth() + 1;
            const daysInMonth = new Date(year, month, 0).getDate();

            // ã‚µãƒãƒªãƒ¼è¨ˆç®—
            const recordDays = Object.keys(days).length;
            let totalChecks = 0;
            let totalPossible = 0;
            let currentStreak = 0;
            let bestStreak = 0;
            const dailyRates = [];

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayData = days[dateStr];

                if (dayData) {
                    const checked = Object.values(dayData).filter(v => v).length;
                    totalChecks += checked;
                    totalPossible += 6;
                    currentStreak++;
                    bestStreak = Math.max(bestStreak, currentStreak);
                    dailyRates.push({ day: d, rate: Math.round((checked / 6) * 100) });
                } else {
                    currentStreak = 0;
                    dailyRates.push({ day: d, rate: 0 });
                }
            }

            const achievement = totalPossible > 0 ? Math.round((totalChecks / totalPossible) * 100) : 0;

            document.getElementById('monthlyTotalDays').textContent = recordDays;
            document.getElementById('monthlyAchievement').textContent = `${achievement}%`;
            document.getElementById('monthlyBestStreak').textContent = bestStreak;

            // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
            const tbody = document.getElementById('monthlyTableBody');
            let tableHtml = '';
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayData = days[dateStr];
                const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][new Date(dateStr).getDay()];

                tableHtml += `<tr>
                    <td>${month}/${d}(${dayOfWeek})</td>`;

                HABITS.forEach(h => {
                    const checked = dayData && dayData[h.id];
                    tableHtml += `<td class="${checked ? 'cell-check' : 'cell-uncheck'}">${checked ? 'â—' : 'â—‹'}</td>`;
                });

                const dayChecked = dayData ? Object.values(dayData).filter(v => v).length : 0;
                tableHtml += `<td>${dayChecked}/6</td></tr>`;
            }
            tbody.innerHTML = tableHtml;

            // ã‚°ãƒ©ãƒ•æç”»
            renderMonthlyChart(dailyRates);
        }

        function renderMonthlyChart(dailyRates) {
            const ctx = document.getElementById('monthlyChart').getContext('2d');

            if (monthlyChart) {
                monthlyChart.destroy();
            }

            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyRates.map(d => `${d.day}æ—¥`),
                    datasets: [{
                        label: 'é”æˆç‡',
                        data: dailyRates.map(d => d.rate),
                        borderColor: '#7e6dff',
                        backgroundColor: 'rgba(126, 109, 255, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointBackgroundColor: '#7e6dff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 25,
                                callback: (value) => `${value}%`
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `é”æˆç‡: ${context.raw}%`
                            }
                        }
                    }
                }
            });
        }

        async function saveHabits() {
            try {
                await fetch(`${API_BASE}/habits/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        date: new Date().toISOString().split('T')[0],
                        habits: todayHabits
                    })
                });
                document.getElementById('dailyTaskCard').classList.remove('expanded');
                await loadHabits();
                alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
            } catch (e) {
                console.error("[HABITS] save error:", e);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ========== ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«æ©Ÿèƒ½ ==========
        async function loadJournals() {
            const container = document.getElementById('journalList');
            try {
                const res = await fetch(`${API_BASE}/journals?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                journalsData = data.journals || [];
                renderJournals(journalsData);
            } catch (e) {
                console.error("[JOURNALS] error:", e);
                // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                journalsData = generateDemoJournals();
                renderJournals(journalsData);
            }
        }

        function generateDemoJournals() {
            const today = new Date();
            const journals = [];
            for (let i = 0; i < 5; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                journals.push({
                    id: `demo-${i}`,
                    date: d.toISOString().split('T')[0],
                    title: ['ä»Šæ—¥ã‚‚é ‘å¼µã£ãŸ', 'å……å®Ÿã—ãŸä¸€æ—¥', 'æ–°ã—ã„ç™ºè¦‹', 'ã¾ã‚ã¾ã‚ã®æ—¥', 'åçœç‚¹ã‚ã‚Š'][i],
                    content: `ä»Šæ—¥ã¯${['ç­‹ãƒˆãƒ¬', 'èª­æ›¸', 'ä»•äº‹', 'å‹‰å¼·', 'ä¼‘æ¯'][i]}ã«é›†ä¸­ã§ããŸã€‚${['æ˜æ—¥ã‚‚ç¶™ç¶šã—ãŸã„', 'ã‚‚ã£ã¨æ™‚é–“ã‚’ä½œã‚ŠãŸã„', 'æ–°ã—ã„ç›®æ¨™ãŒã§ããŸ', 'æ”¹å–„ç‚¹ãŒè¦‹ã¤ã‹ã£ãŸ', 'æ˜æ—¥ã¯é ‘å¼µã‚‹'][i]}ã€‚`,
                    tasks_completed_count: Math.floor(Math.random() * 6) + 1,
                    completed_tasks: ['æ—©èµ·ã', 'ãƒŸãƒƒã‚·ãƒ§ãƒ³', 'èª­æ›¸', 'ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«', 'ç¦é…’', 'ä»Šæ—¥ãƒˆãƒ¬'].slice(0, Math.floor(Math.random() * 6) + 1)
                });
            }
            return journals;
        }

        function renderJournals(journals) {
            const container = document.getElementById('journalList');
            if (journals.length === 0) {
                container.innerHTML = '<div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            container.innerHTML = journals.map(j => `
                <div class="journal-card" data-id="${j.id}">
                    <div class="journal-card-header">
                        <div class="journal-date">ğŸ“… ${formatDate(j.date)}</div>
                        <div class="journal-tasks-count">âœ“ ${j.tasks_completed_count || 0}ã‚¿ã‚¹ã‚¯é”æˆ</div>
                    </div>
                    <div class="journal-title-text">${j.title || 'ç„¡é¡Œ'}</div>
                    <div class="journal-preview">${(j.content || '').substring(0, 50)}${(j.content || '').length > 50 ? '...' : ''}</div>
                </div>
            `).join('');

            container.querySelectorAll('.journal-card').forEach(card => {
                card.addEventListener('click', () => {
                    const journalId = card.dataset.id;
                    const journal = journalsData.find(j => j.id === journalId || j.id === String(journalId));
                    if (journal) {
                        openJournalDetailModal(journal);
                    }
                });
            });
        }

        function openJournalDetailModal(journal) {
            currentEditJournal = journal;

            // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('journalViewContent').classList.remove('hidden');
            document.getElementById('journalEditContent').classList.remove('active');

            // ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            const d = new Date(journal.date);
            document.getElementById('journalModalDate').textContent = `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
            document.getElementById('journalModalTitle').textContent = journal.title || 'ç„¡é¡Œ';
            document.getElementById('journalModalContent').textContent = journal.content || 'å†…å®¹ãªã—';

            // é”æˆã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
            const tasksContainer = document.getElementById('journalModalTasks');
            const completedTasks = journal.completed_tasks || [];
            if (completedTasks.length > 0) {
                tasksContainer.innerHTML = completedTasks.map(task =>
                    `<span class="journal-task-chip">${task}</span>`
                ).join('');
            } else {
                // ãƒ‡ãƒ¢ç”¨ï¼šç¿’æ…£ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¨å®š
                const habitNames = HABITS.map(h => h.name);
                const count = journal.tasks_completed_count || 0;
                const demoTasks = habitNames.slice(0, count);
                if (demoTasks.length > 0) {
                    tasksContainer.innerHTML = demoTasks.map(task =>
                        `<span class="journal-task-chip">${task}</span>`
                    ).join('');
                } else {
                    tasksContainer.innerHTML = '<span style="color:#888;font-size:12px;">é”æˆã‚¿ã‚¹ã‚¯ãªã—</span>';
                }
            }

            document.getElementById('journalDetailModal').classList.add('visible');
        }

        function bindJournalDetailModalUI() {
            const modal = document.getElementById('journalDetailModal');
            const closeModal = () => {
                modal.classList.remove('visible');
                currentEditJournal = null;
            };

            document.getElementById('journalDetailBackdrop').addEventListener('click', closeModal);
            document.getElementById('closeJournalDetail').addEventListener('click', closeModal);
            document.getElementById('journalCloseBtn').addEventListener('click', closeModal);
            document.getElementById('closeJournalEdit').addEventListener('click', closeModal);

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('journalEditBtn').addEventListener('click', () => {
                if (!currentEditJournal) return;

                document.getElementById('journalViewContent').classList.add('hidden');
                document.getElementById('journalEditContent').classList.add('active');

                document.getElementById('editJournalTitle').value = currentEditJournal.title || '';
                document.getElementById('editJournalContent').value = currentEditJournal.content || '';
            });

            // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            document.getElementById('journalCancelEditBtn').addEventListener('click', () => {
                document.getElementById('journalViewContent').classList.remove('hidden');
                document.getElementById('journalEditContent').classList.remove('active');
            });

            // ç·¨é›†ä¿å­˜
            document.getElementById('journalSaveEditBtn').addEventListener('click', async () => {
                if (!currentEditJournal) return;

                const newTitle = document.getElementById('editJournalTitle').value.trim();
                const newContent = document.getElementById('editJournalContent').value.trim();

                if (!newTitle && !newContent) {
                    alert('ã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                try {
                    await fetch(`${API_BASE}/journals/update`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userId,
                            journal_id: currentEditJournal.id,
                            title: newTitle,
                            content: newContent
                        })
                    });

                    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                    currentEditJournal.title = newTitle;
                    currentEditJournal.content = newContent;

                    // è¡¨ç¤ºã‚’æ›´æ–°
                    document.getElementById('journalModalTitle').textContent = newTitle || 'ç„¡é¡Œ';
                    document.getElementById('journalModalContent').textContent = newContent || 'å†…å®¹ãªã—';

                    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹
                    document.getElementById('journalViewContent').classList.remove('hidden');
                    document.getElementById('journalEditContent').classList.remove('active');

                    // ãƒªã‚¹ãƒˆæ›´æ–°
                    await loadJournals();
                    alert('æ›´æ–°ã—ã¾ã—ãŸï¼');
                } catch (e) {
                    console.error("[JOURNALS] update error:", e);
                    // ãƒ‡ãƒ¢ç”¨ï¼šãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°ã®ã¿
                    currentEditJournal.title = newTitle;
                    currentEditJournal.content = newContent;
                    document.getElementById('journalModalTitle').textContent = newTitle || 'ç„¡é¡Œ';
                    document.getElementById('journalModalContent').textContent = newContent || 'å†…å®¹ãªã—';
                    document.getElementById('journalViewContent').classList.remove('hidden');
                    document.getElementById('journalEditContent').classList.remove('active');
                    renderJournals(journalsData);
                    alert('æ›´æ–°ã—ã¾ã—ãŸï¼');
                }
            });
        }

        async function saveJournal() {
            const date = document.getElementById('journalDate').value;
            const title = document.getElementById('journalTitle').value.trim();
            const content = document.getElementById('journalContent').value.trim();

            if (!title && !content) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                await fetch(`${API_BASE}/journals/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, date, title, content })
                });
                document.getElementById('journalTitle').value = '';
                document.getElementById('journalContent').value = '';
                await loadJournals();
                alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
            } catch (e) {
                console.error("[JOURNALS] save error:", e);
                // ãƒ‡ãƒ¢ç”¨ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã«è¿½åŠ 
                journalsData.unshift({
                    id: `demo-${Date.now()}`,
                    date,
                    title,
                    content,
                    tasks_completed_count: 0,
                    completed_tasks: []
                });
                document.getElementById('journalTitle').value = '';
                document.getElementById('journalContent').value = '';
                renderJournals(journalsData);
                alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
            }
        }

        // ========== ãƒ¢ãƒ¼ãƒ€ãƒ« ==========
        function bindModalUI() {
            const modal = document.getElementById('detailModal');
            const close = () => modal.classList.remove("visible");

            document.getElementById('detailBackdrop').onclick = close;
            document.getElementById('detailCloseBtn').onclick = close;
            document.getElementById('detailCancelBtn').onclick = close;

            ['Priority', 'Vision', 'Excite', 'Growth'].forEach(name => {
                const input = document.getElementById(`input${name}`);
                const val = document.getElementById(`val${name}`);
                input.addEventListener('input', () => val.textContent = input.value);
            });

            document.getElementById('inputRemindAt').addEventListener('change', e => {
                const val = document.getElementById('valRemindAt');
                val.textContent = e.target.value ? formatRemindLabel(new Date(e.target.value).toISOString()) : '';
            });

            document.getElementById('detailSaveBtn').onclick = async () => {
                if (!currentDetailTask) return;

                if (modalMode === "detail") {
                    await action("update_detail", currentDetailTask.id, {
                        priority: Number(document.getElementById('inputPriority').value),
                        vision_score: Number(document.getElementById('inputVision').value),
                        excite_score: Number(document.getElementById('inputExcite').value),
                        growth_score: Number(document.getElementById('inputGrowth').value),
                    });
                } else {
                    const inputVal = document.getElementById('inputRemindAt').value;
                    const remind_at = inputVal ? new Date(inputVal).toISOString() : null;
                    await action("remind_custom", currentDetailTask.id, {
                        remind_at,
                        kind: remind_at ? "custom_datetime" : "clear",
                    });
                }
                close();
            };
        }

        function openDetail(t) {
            modalMode = "detail";
            currentDetailTask = t;
            document.getElementById('modalTitle').textContent = "ã‚¿ã‚¹ã‚¯è©³ç´°";
            document.getElementById('detailTaskTitle').textContent = t.task_name || t.title || "(ç„¡é¡Œ)";
            document.getElementById('scoreGroup').style.display = "block";
            document.getElementById('remindGroup').style.display = "none";

            ['Priority', 'Vision', 'Excite', 'Growth'].forEach(name => {
                const key = name.toLowerCase() + (name === 'Priority' ? '' : '_score');
                const val = t[key] ?? t[name.toLowerCase() + '_score'] ?? 0;
                document.getElementById(`input${name}`).value = val;
                document.getElementById(`val${name}`).textContent = val;
            });

            document.getElementById('inputPriority').value = t.priority ?? 0;
            document.getElementById('valPriority').textContent = t.priority ?? 0;
            document.getElementById('inputVision').value = t.vision_score ?? 0;
            document.getElementById('valVision').textContent = t.vision_score ?? 0;
            document.getElementById('inputExcite').value = t.excite_score ?? 0;
            document.getElementById('valExcite').textContent = t.excite_score ?? 0;
            document.getElementById('inputGrowth').value = t.growth_score ?? 0;
            document.getElementById('valGrowth').textContent = t.growth_score ?? 0;

            document.getElementById('detailModal').classList.add("visible");
        }

        function openRemind(t) {
            modalMode = "remind";
            currentDetailTask = t;
            document.getElementById('modalTitle').textContent = "é€šçŸ¥è¨­å®š";
            document.getElementById('detailTaskTitle').textContent = t.task_name || t.title || "(ç„¡é¡Œ)";
            document.getElementById('scoreGroup').style.display = "none";
            document.getElementById('remindGroup').style.display = "block";

            const input = document.getElementById('inputRemindAt');
            const val = document.getElementById('valRemindAt');
            if (t.remind_at) {
                input.value = toLocalDatetimeValue(t.remind_at);
                val.textContent = formatRemindLabel(t.remind_at);
            } else {
                input.value = '';
                val.textContent = '';
            }

            document.getElementById('detailModal').classList.add("visible");
        }

        // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
        function mkBtn(label, onClick, cls) {
            const b = document.createElement("button");
            b.textContent = label;
            if (cls) b.className = cls;
            b.addEventListener("click", e => {
                e.stopPropagation();
                e.preventDefault();
                onClick();
            });
            return b;
        }

        async function action(kind, id, extra = {}) {
            try {
                const res = await fetch(`${API_BASE}/action`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId, action: kind, task_id: id, ...extra })
                });
                if (!res.ok) alert("æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ");
            } catch (e) {
                console.error("[ACTION] error:", e);
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
            } finally {
                if (kind !== "remind_custom") loadList();
            }
        }

        function formatRemindLabel(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            return `ğŸ””${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        function toLocalDatetimeValue(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}T${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
        }

        init();
    </script>
</body>
</html>
