<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LISTï½œã‚¿ã‚¹ã‚¯ä¸€è¦§</title>
<style>
  body { font-family: -apple-system, system-ui; margin:0; background:#f7f7f8; }

  header { position:sticky; top:0; background:#fff; border-bottom:1px solid #eee; z-index:10; }
  .bar { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; }

  .tab { padding:6px 12px; border-radius:14px; border:1px solid #ddd; font-size:13px; cursor:pointer; }
  .tab.active { background:#111; color:white; border-color:#111; }

  .add { display:flex; gap:8px; padding:12px 16px; }
  .add input {
    flex:1;
    padding:10px;
    border-radius:8px;
    border:1px solid #ddd;
    font-size:16px; /* iOSã®å‹æ‰‹ã‚ºãƒ¼ãƒ é˜²æ­¢ */
  }

  .list { display:flex; flex-direction:column; }

  .card {
    position:relative;
    background:white;
    border-bottom:1px solid #eee;
    height:60px;
    overflow:hidden;
    touch-action:pan-y;
    box-sizing:border-box; /* â˜° ã®è¦‹åˆ‡ã‚Œå¯¾ç­– */
  }
  .card.completed .title { color:#aaa; text-decoration:line-through; }

  .sl {
    position:relative;
    height:100%; width:100%;
    display:flex;
    align-items:center;
    padding:0 12px;
    transition:transform .15s ease;
    background:white;
    z-index:2;
    box-sizing:border-box; /* â˜° ã®è¦‹åˆ‡ã‚Œå¯¾ç­– */
  }

  .actions-rail {
    position:absolute; inset:0;
    display:flex; justify-content:space-between; align-items:center;
    pointer-events:none; z-index:1;
  }

  /* ã‚¹ãƒ¯ã‚¤ãƒ—ã§é–‹ã„ã¦ã„ã‚‹ã¨ãã ã‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ */
  .card.open-left .actions-rail,
  .card.open-right .actions-rail {
    pointer-events: auto;
  }

  .actions-left, .actions-right {
    height:100%;
    display:flex; align-items:center;
  }
  .actions-left { background:#e8f7ee; justify-content:flex-start; padding-left:0; }
  .actions-right { background:#fdeeee; justify-content:flex-end; padding-right:0; }

  .actions-rail button {
    height:100%; min-width:64px; border:none; color:white; font-size:13px;
    border-radius:0; cursor:pointer;
  }

  .btn-complete { background:#7e6dff; }
  .btn-plus2h   { background:#8012e2; }
  .btn-detail   { background:#1e928b; }
  .btn-pin      { background:#d97706; }
  .btn-delete   { background:#f03d30; }

  .title { font-size:15px; }

  .handle {
    margin-left:auto; cursor:grab; opacity:0.1;
    -webkit-user-select:none; user-select:none;
    padding:0 12px; font-size:20px;
  }

  .divider-label { text-align:center; color:#888; font-size:12px; padding:6px 0; }

  /* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-root { position:fixed; inset:0; display:none; z-index:50; align-items:flex-end; justify-content:center; }
  .modal-root.visible { display:flex; }
  .modal-backdrop { position:absolute; inset:0; background:rgba(0,0,0,.25); }
  .modal-panel {
    width:100%; max-width:480px; background:#fff;
    border-radius:20px 20px 0 0; padding:16px;
    animation:slideUp .18s ease-out;
  }
  @keyframes slideUp { from{ transform:translateY(40px); opacity:0;} to{ transform:translateY(0); opacity:1;} }

  .slider-group { margin:14px 0; }
  .slider-label-row { display:flex; justify-content:space-between; font-size:12px; }
  .slider-label-row span.value { font-size:13px; font-weight:600; }

  .modal-footer { display:flex; justify-content:flex-end; gap:8px; margin-top:14px; }
  .btn-secondary { padding:8px 14px; border:1px solid #ddd; border-radius:20px; background:#fafafa; cursor:pointer; }
  .btn-primary-solid { padding:8px 16px; border-radius:20px; background:#7e6dff; color:white; border:none; cursor:pointer; }
</style>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<header>
  <div class="bar">
    <div style="font-weight:600">LIST</div>
    <div class="tab active">ã‚¿ã‚¹ã‚¯</div>
    <div class="tab" id="refreshBtn">â†»</div>
  </div>
</header>

<main>
  <div class="add">
    <input id="newTitle" placeholder="ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›â€¦" />
    <button id="btnAdd" class="tab" style="background:#111;color:white;border-color:#111">è¿½åŠ </button>
  </div>

  <div class="divider-label">æœªå®Œäº†ã‚¿ã‚¹ã‚¯</div>
  <div id="pinned" class="list"></div>
  <div id="active" class="list"></div>

  <div class="divider-label" style="margin-top:16px;">é”æˆã‚¿ã‚¹ã‚¯</div>
  <div id="completed" class="list"></div>
</main>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="detailModal" class="modal-root">
  <div id="detailBackdrop" class="modal-backdrop"></div>
  <div class="modal-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:600">ã‚¿ã‚¹ã‚¯è©³ç´°</div>
      <button id="detailCloseBtn" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
    </div>

    <div id="detailTaskTitle" style="font-size:13px;color:#555;margin-bottom:8px;"></div>

    <div class="slider-group">
      <div class="slider-label-row"><span>å„ªå…ˆåº¦</span><span class="value" id="valPriority"></span></div>
      <input id="inputPriority" type="range" min="0" max="10" step="1"/>
    </div>

    <div class="slider-group">
      <div class="slider-label-row"><span>ãƒ“ã‚¸ãƒ§ãƒ³é–¢é€£åº¦</span><span class="value" id="valVision"></span></div>
      <input id="inputVision" type="range" min="0" max="10" step="1"/>
    </div>

    <div class="slider-group">
      <div class="slider-label-row"><span>ã‚ãã‚ãåº¦</span><span class="value" id="valExcite"></span></div>
      <input id="inputExcite" type="range" min="0" max="10" step="1"/>
    </div>

    <div class="slider-group">
      <div class="slider-label-row"><span>æˆé•·åº¦</span><span class="value" id="valGrowth"></span></div>
      <input id="inputGrowth" type="range" min="0" max="10" step="1"/>
    </div>

    <div class="modal-footer">
      <button id="detailCancelBtn" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="detailSaveBtn" class="btn-primary-solid">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
const LIFF_ID = "2008372898-2q9qWmxv";
const API_BASE = "https://yamasho.xvps.jp/webhook";
let userId = null;
let currentDetailTask = null;

// å¼·ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®šã®æ¯”ç‡
const STRONG_RATIO = 0.85;  // ãƒœã‚¿ãƒ³å¹…ã®ç´„85%ä»¥ä¸Š
const SNAP_THRESHOLD = 40;  // ã“ã®pxä»¥ä¸Šã§ã€Œé–‹ãã€ã‚¹ãƒŠãƒƒãƒ—

// DOMã‚­ãƒ£ãƒƒã‚·ãƒ¥
const pinnedEl    = document.getElementById("pinned");
const activeEl    = document.getElementById("active");
const completedEl = document.getElementById("completed");
const refreshBtn  = document.getElementById("refreshBtn");
const btnAdd      = document.getElementById("btnAdd");
const newTitle    = document.getElementById("newTitle");

// ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ 
const detailModal      = document.getElementById("detailModal");
const detailBackdrop   = document.getElementById("detailBackdrop");
const detailCloseBtn   = document.getElementById("detailCloseBtn");
const detailCancelBtn  = document.getElementById("detailCancelBtn");
const detailSaveBtn    = document.getElementById("detailSaveBtn");
const detailTaskTitle  = document.getElementById("detailTaskTitle");

const inputPriority = document.getElementById("inputPriority");
const inputVision   = document.getElementById("inputVision");
const inputExcite   = document.getElementById("inputExcite");
const inputGrowth   = document.getElementById("inputGrowth");
const valPriority   = document.getElementById("valPriority");
const valVision     = document.getElementById("valVision");
const valExcite     = document.getElementById("valExcite");
const valGrowth     = document.getElementById("valGrowth");

/* ==========================
   INIT
========================== */
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    const profile = await liff.getProfile();
    userId = profile.userId;

    bindUI();
    bindModalUI();
    await loadList();
  } catch (e) {
    console.error(e);
    alert("LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

/* ==========================
   bindUI
========================== */
function bindUI() {
  refreshBtn.onclick = loadList;

  btnAdd.onclick = async () => {
    const title = newTitle.value.trim();
    if (!title) return;
    await action("create", null, { task_name: title });
    newTitle.value = "";
  };
}

/* ==========================
  è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« UI
========================== */
function bindModalUI() {
  const close = () => detailModal.classList.remove("visible");

  detailBackdrop.onclick = close;
  detailCloseBtn.onclick = close;
  detailCancelBtn.onclick = close;

  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ãƒ©ãƒ™ãƒ«æ›´æ–°
  const bindSlider = (input, label) => {
    input.addEventListener("input", () => { label.textContent = input.value; });
  };
  bindSlider(inputPriority, valPriority);
  bindSlider(inputVision,   valVision);
  bindSlider(inputExcite,   valExcite);
  bindSlider(inputGrowth,   valGrowth);

  detailSaveBtn.onclick = async () => {
    if (!currentDetailTask) return;
    const payload = {
      priority:     Number(inputPriority.value),
      vision_score: Number(inputVision.value),
      excite_score: Number(inputExcite.value),
      growth_score: Number(inputGrowth.value),
    };
    await action("update_detail", currentDetailTask.id, payload);
    close();
  };
}

/* ==========================
  LIST API
========================== */
async function loadList() {
  const url = `${API_BASE}/list?user_id=${encodeURIComponent(userId)}`;
  console.log("[LIST] request:", url);

  try {
    const res = await fetch(url);
    console.log("[LIST] status:", res.status);

    const text = await res.text();
    console.log("[LIST] raw response:", JSON.stringify(text));

    if (!res.ok) {
      console.error("[LIST] http error:", res.status, text);
      alert("ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTPã‚¨ãƒ©ãƒ¼ï¼‰");
      return;
    }

    if (!text) {
      console.warn("[LIST] ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã—ãŸ");
      renderList({ pinned: [], active: [], completed: [] });
      return;
    }

    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error("[LIST] JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", e);
      alert("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰JSONãŒè¿”ã£ã¦ãã¦ã„ã¾ã›ã‚“");
      return;
    }

    console.log("[LIST] parsed json:", data);
    renderList(data);

  } catch (e) {
    console.error("[LIST] fetch error:", e);
    alert("ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰");
  }
}


function renderList(payload) {
  pinnedEl.innerHTML    = "";
  activeEl.innerHTML    = "";
  completedEl.innerHTML = "";

  const pinned    = Array.isArray(payload.pinned)    ? payload.pinned    : [];
  const active    = Array.isArray(payload.active)    ? payload.active    : [];
  const completed = Array.isArray(payload.completed) ? payload.completed : [];

  pinned.forEach(t    => pinnedEl.appendChild(taskCard(t, false)));
  active.forEach(t    => activeEl.appendChild(taskCard(t, false)));
  completed.forEach(t => completedEl.appendChild(taskCard(t, true)));
}

/* ==========================
  TASK CARD
========================== */
function taskCard(t, isCompleted = false) {
  const wrap = document.createElement("div");
  wrap.className = "card";
  if (isCompleted) wrap.classList.add("completed");

  // èƒŒé¢ãƒ¬ãƒ¼ãƒ«
  const rail = document.createElement("div");
  rail.className = "actions-rail";

  const left = document.createElement("div");
  left.className = "actions-left";

  if (!isCompleted) {
    // æœªå®Œäº†ã‚¿ã‚¹ã‚¯ï¼šå®Œäº† & +2h
    left.append(
      mkBtn("å®Œäº†", () => action("complete", t.id), "btn-complete"),
      mkBtn("+2h", () => action("remind_plus2h", t.id), "btn-plus2h")
    );
  } else {
    // é”æˆã‚¿ã‚¹ã‚¯ï¼šæœªå®Œã«æˆ»ã™
    left.append(mkBtn("æœªå®Œ", () => action("uncomplete", t.id), "btn-complete"));
  }

  const right = document.createElement("div");
  right.className = "actions-right";
  right.append(
    mkBtn("è©³ç´°", () => openDetail(t), "btn-detail"),
    mkBtn(t.pinned ? "ãƒ”ãƒ³è§£é™¤" : "ãƒ”ãƒ³", () => action("toggle_pin", t.id), "btn-pin"),
    mkBtn("å‰Šé™¤", () => {
      if (t.pinned) return alert("ãƒ”ãƒ³ã‚’å¤–ã—ã¦ãã ã•ã„ï¼");
      action("delete", t.id);
    }, "btn-delete")
  );

  rail.append(left, right);

  // å‰é¢
  const sl = document.createElement("div");
  sl.className = "sl";

  const titleEl = document.createElement("div");
  titleEl.className = "title";

  const name = t.task_name || t.title || "(ç„¡é¡Œ)";

  if (t.pinned) {
    titleEl.textContent = "ğŸ“ " + name;
  } else {
    titleEl.textContent = name;
  }

  const handle = document.createElement("div");
  handle.className = "handle";
  handle.textContent = "â˜°";

  sl.append(titleEl, handle);
  wrap.append(rail, sl);

  // ===== ãƒœã‚¿ãƒ³å¹…ã‚’æ¸¬ã£ã¦ data ã«ä¿å­˜ï¼ˆç«¯ã‚’æƒãˆã‚‹ç”¨ï¼‰ =====
  requestAnimationFrame(() => {
    const lRect = left.getBoundingClientRect();
    const rRect = right.getBoundingClientRect();
    wrap.dataset.leftWidth  = lRect.width  || 140;
    wrap.dataset.rightWidth = rRect.width || 140;
  });

  /* ==========================
      PCç‰ˆ ã‚¯ãƒªãƒƒã‚¯ã§ã‚¹ãƒ¯ã‚¤ãƒ—
  ========================== */
  if (!/Mobi|Android/i.test(navigator.userAgent)) {
    sl.addEventListener("click", e => {
      const rect = sl.getBoundingClientRect();
      const x = e.clientX - rect.left;

      const leftW  = Number(wrap.dataset.leftWidth)  || 140;
      const rightW = Number(wrap.dataset.rightWidth) || 140;

      if (wrap.classList.contains("open-left") || wrap.classList.contains("open-right")) {
        wrap.classList.remove("open-left", "open-right");
        sl.style.transform = "translateX(0)";
        return;
      }

      if (x < rect.width / 2) {
        wrap.classList.add("open-left");
        wrap.classList.remove("open-right");
        sl.style.transform = `translateX(${leftW}px)`;
      } else {
        wrap.classList.add("open-right");
        wrap.classList.remove("open-left");
        sl.style.transform = `translateX(${-rightW}px)`;
      }
    });
  }

  /* ==========================
      ã‚¹ãƒãƒ›ç‰ˆ ã‚¹ãƒ¯ã‚¤ãƒ—
  ========================== */
  let startX = 0, dx = 0;

  wrap.addEventListener("touchstart", e => {
    // ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã„ã‚‹å ´åˆã¯ã‚¹ãƒ¯ã‚¤ãƒ—å‡¦ç†ã‚’èµ·å‹•ã—ãªã„
    if (e.target.closest("button")) {
      return;
    }
    startX = e.touches[0].clientX;
    dx = 0;
    sl.style.transition = "none";
  }, { passive:true });

  wrap.addEventListener("touchmove", e => {
    if (e.touches.length === 0) return;
    dx = e.touches[0].clientX - startX;
    if (Math.abs(dx) > 8) e.preventDefault();
    sl.style.transform = `translateX(${dx}px)`;
  }, { passive:false });

  wrap.addEventListener("touchend", () => {
    sl.style.transition = "transform .15s";

    const leftW  = Number(wrap.dataset.leftWidth)  || 140;
    const rightW = Number(wrap.dataset.rightWidth) || 140;

    const leftStrong  = leftW  * STRONG_RATIO;
    const rightStrong = rightW * STRONG_RATIO;

    // å¼·ã‚¹ãƒ¯ã‚¤ãƒ— â†’ å®Œäº† / æœªå®Œ / å‰Šé™¤
    if (dx > leftStrong) {
      // å³ã¸å¼·ã‚¹ãƒ¯ã‚¤ãƒ—
      if (!isCompleted) {
        // æœªå®Œã‚¿ã‚¹ã‚¯ â†’ å®Œäº†
        action("complete", t.id);
      } else {
        // é”æˆã‚¿ã‚¹ã‚¯ â†’ æœªå®Œã«æˆ»ã™
        action("uncomplete", t.id);
      }
      wrap.classList.remove("open-left", "open-right");
      sl.style.transform = "translateX(0)";
      return;
    }
    if (dx < -rightStrong) {
      // å·¦ã¸å¼·ã‚¹ãƒ¯ã‚¤ãƒ— â†’ å‰Šé™¤
      if (t.pinned) {
        alert("ãƒ”ãƒ³ã‚’å¤–ã—ã¦ãã ã•ã„ï¼");
      } else {
        action("delete", t.id);
      }
      wrap.classList.remove("open-left", "open-right");
      sl.style.transform = "translateX(0)";
      return;
    }

    // è»½ã„ã‚¹ãƒ¯ã‚¤ãƒ— â†’ ã€Œé–‹ã„ãŸã€çŠ¶æ…‹ã«ã‚¹ãƒŠãƒƒãƒ—
    if (dx > SNAP_THRESHOLD) {
      wrap.classList.add("open-left");
      wrap.classList.remove("open-right");
      sl.style.transform = `translateX(${leftW}px)`;
    } else if (dx < -SNAP_THRESHOLD) {
      wrap.classList.add("open-right");
      wrap.classList.remove("open-left");
      sl.style.transform = `translateX(${-rightW}px)`;
    } else {
      wrap.classList.remove("open-left", "open-right");
      sl.style.transform = "translateX(0)";
    }
  });

  return wrap;
}

/* ==========================
   MODAL OPEN
========================== */
function openDetail(t) {
  currentDetailTask = t;

  const name = t.task_name || t.title || "(ç„¡é¡Œ)";
  detailTaskTitle.textContent = name;

  inputPriority.value = t.priority ?? 0;
  valPriority.textContent = inputPriority.value;

  inputVision.value = t.vision_score ?? 0;
  valVision.textContent = inputVision.value;

  inputExcite.value = t.excite_score ?? 0;
  valExcite.textContent = inputExcite.value;

  inputGrowth.value = t.growth_score ?? 0;
  valGrowth.textContent = inputGrowth.value;

  detailModal.classList.add("visible");
}

/* ==========================
   BUTTON HELPER
========================== */
function mkBtn(label, onClick, cls) {
  const b = document.createElement("button");
  b.textContent = label;
  if (cls) b.className = cls;

  const handler = (e) => {
    e.stopPropagation();
    e.preventDefault();
    onClick();
  };

  // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã§ã¯ touchend å„ªå…ˆ
  if ("ontouchend" in window) {
    b.addEventListener("touchend", handler, { passive:false });
  } else {
    b.addEventListener("click", handler);
  }

  return b;
}

/* ==========================
   API ACTION
========================== */
async function action(kind, id, extra = {}) {
  const url = `${API_BASE}/action`;
  try {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: userId,
        action: kind,
        task_id: id,
        ...extra
      })
    });

    const text = await res.text();
    console.log("[ACTION]", kind, "status:", res.status, "resp:", text);

    if (!res.ok) {
      alert("æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ" + res.status + "ï¼‰");
      return;
    }
  } catch (e) {
    console.error("[ACTION] fetch error:", e);
    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ");
  } finally {
    // æˆåŠŸ/å¤±æ•—ã«é–¢ã‚ã‚‰ãšä¸€è¦§ã‚’å–ã‚Šç›´ã™
    loadList();
  }
}

init();
</script>
</body>
</html>
