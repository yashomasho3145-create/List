<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LISTÔΩú„Çø„Çπ„ÇØ‰∏ÄË¶ß</title>
    <style>
        body {
            font-family: -apple-system, system-ui;
            margin: 0;
            background: #f7f7f8;
        }

        header {
            position: sticky;
            top: 0;
            background: #fff;
            border-bottom: 1px solid #eee;
            z-index: 10;
        }

        .bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
        }

        .tab {
            padding: 6px 12px;
            border-radius: 14px;
            border: 1px solid #ddd;
            font-size: 13px;
            cursor: pointer;
        }

        .tab.active {
            background: #111;
            color: white;
            border-color: #111;
        }

        .add {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
        }

        .add input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
        }

        main {
            padding: 8px 0 24px;
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 0 12px;
        }

        .card {
            position: relative;
            overflow: hidden;
            border-radius: 14px;
            background: #fff;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        }

        .card.completed .title {
            text-decoration: line-through;
            color: #aaa;
        }

        .card.completed {
            opacity: 0.7;
        }

        .card .sl {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: white;
            transform: translateX(0);
            transition: transform 0.15s ease-out;
            touch-action: pan-y;
        }

        .card.open-left .sl,
        .card.open-right .sl {
            transition: transform 0.15s ease-out;
        }

        .actions-rail {
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: space-between;
            z-index: 1;
        }

        .actions-left,
        .actions-right {
            display: flex;
            height: 100%;
        }

        .actions-left {
            flex-direction: row-reverse;
        }

        .actions-right {
            flex-direction: row;
        }

        .actions-left button,
        .actions-right button {
            height: 100%;
            min-width: 64px;
            border: none;
            color: white;
            font-size: 13px;
            border-radius: 0;
            cursor: pointer;
        }

        .btn-complete {
            background: #7e6dff;
        }

        .btn-remind {
            background: #8012e2;
        }

        .btn-detail {
            background: #1e928b;
        }

        .btn-pin {
            background: #d97706;
        }

        .btn-delete {
            background: #f03d30;
        }

        .title {
            font-size: 15px;
            flex: 1;
        }

        .remind-info {
            font-size: 11px;
            color: #666;
            margin-right: 8px;
        }

        .handle {
            margin-left: auto;
            cursor: grab;
            opacity: 0.25;
            -webkit-user-select: none;
            user-select: none;
            padding: 0 8px;
            font-size: 20px;
            touch-action: none;
        }

        .divider-label {
            text-align: center;
            color: #888;
            font-size: 12px;
            padding: 6px 0;
        }

        /* „É¢„Éº„ÉÄ„É´ÂÖ±ÈÄö */
        .modal-root {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 50;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-root.visible {
            display: flex;
        }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, .25);
        }

        .modal-panel {
            position: relative;
            width: 100%;
            max-width: 480px;
            background: #fff;
            border-radius: 16px 16px 0 0;
            padding: 16px 16px 20px;
            box-shadow: 0 -4px 20px rgba(15, 23, 42, .2);
        }

        .modal-footer {
            margin-top: 16px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .btn-secondary {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: #fafafa;
            cursor: pointer;
        }

        .btn-primary-solid {
            padding: 8px 16px;
            border-radius: 20px;
            background: #7e6dff;
            color: white;
            border: none;
            cursor: pointer;
        }

        .slider-group {
            margin-top: 12px;
        }

        .slider-label-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #444;
        }

        .slider-label-row .value {
            font-weight: 600;
            min-width: 24px;
            text-align: right;
        }

        .slider-group input[type=range] {
            width: 100%;
        }
    </style>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

    <header>
        <div class="bar">
            <div style="font-weight:600">LIST</div>
            <div class="tab active">„Çø„Çπ„ÇØ</div>
            <div class="tab" id="refreshBtn">‚Üª</div>
        </div>
    </header>

    <main>
        <div class="add">
            <input id="newTitle" placeholder="„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ‚Ä¶" />
            <button id="btnAdd" class="tab" style="background:#111;color:white;border-color:#111">ËøΩÂä†</button>
        </div>

        <div class="divider-label">ToDo„Çø„Çπ„ÇØ</div>
        <div id="pinned" class="list"></div>
        <div id="active" class="list"></div>

        <div class="divider-label" style="margin-top:16px;">----...-------------------------------------------------<br>ÈÅîÊàê„Çø„Çπ„ÇØ</div>
        <div id="completed" class="list"></div>
    </main>

    <!-- Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
    <div id="detailModal" class="modal-root">
        <div id="detailBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-weight:600">„Çø„Çπ„ÇØË©≥Á¥∞</div>
                <button id="detailCloseBtn" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
            </div>

            <div id="detailTaskTitle" style="font-size:13px;color:#555;margin-bottom:8px;"></div>

            <div class="slider-group">
                <div class="slider-label-row"><span>ÂÑ™ÂÖàÂ∫¶</span><span class="value" id="valPriority"></span></div>
                <input id="inputPriority" type="range" min="0" max="10" step="1" />
            </div>

            <div class="slider-group">
                <div class="slider-label-row"><span>„Éì„Ç∏„Éß„É≥Èñ¢ÈÄ£Â∫¶</span><span class="value" id="valVision"></span></div>
                <input id="inputVision" type="range" min="0" max="10" step="1" />
            </div>

            <div class="slider-group">
                <div class="slider-label-row"><span>„Çè„Åè„Çè„ÅèÂ∫¶</span><span class="value" id="valExcite"></span></div>
                <input id="inputExcite" type="range" min="0" max="10" step="1" />
            </div>

            <div class="slider-group">
                <div class="slider-label-row"><span>ÊàêÈï∑Â∫¶</span><span class="value" id="valGrowth"></span></div>
                <input id="inputGrowth" type="range" min="0" max="10" step="1" />
            </div>

            <div class="modal-footer">
                <button id="detailCancelBtn" class="btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
                <button id="detailSaveBtn" class="btn-primary-solid">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- „É™„Éû„Ç§„É≥„Éâ„É¢„Éº„ÉÄ„É´ -->
    <div id="remindModal" class="modal-root">
        <div id="remindBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-weight:600">ÈÄöÁü•„ÇíË®≠ÂÆö</div>
            </div>
            <div id="remindTaskTitle" style="font-size:13px;color:#555;margin-bottom:12px;"></div>
            <label for="remindDatetime" style="font-size:13px;color:#444;display:block;margin-bottom:4px;">ÈÄöÁü•„Åô„ÇãÊó•ÊôÇ</label>
            <input id="remindDatetime" type="datetime-local" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;font-size:14px;box-sizing:border-box;" />
            <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px;">
                <button id="remindCancelBtn" class="btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
                <button id="remindSaveBtn" class="btn-primary-solid">Ë®≠ÂÆö</button>
            </div>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008372898-2q9qWmxv";
        const API_BASE = "https://yamasho.xvps.jp/webhook";
        let userId = null;
        let currentDetailTask = null;
        let currentRemindTask = null;

        // Âº∑„Çπ„ÉØ„Ç§„ÉóÂà§ÂÆö„ÅÆÊØîÁéá
        const STRONG_RATIO = 0.85;  // „Éú„Çø„É≥ÂπÖ„ÅÆÁ¥Ñ85%‰ª•‰∏ä
        const SNAP_THRESHOLD = 40;  // „Åì„ÅÆpx‰ª•‰∏ä„Åß„ÄåÈñã„Åè„Äç„Çπ„Éä„ÉÉ„Éó

        // DOM„Ç≠„É£„ÉÉ„Ç∑„É•
        const pinnedEl = document.getElementById("pinned");
        const activeEl = document.getElementById("active");
        const completedEl = document.getElementById("completed");
        const refreshBtn = document.getElementById("refreshBtn");
        const btnAdd = document.getElementById("btnAdd");
        const newTitle = document.getElementById("newTitle");

        // „É¢„Éº„ÉÄ„É´Ë¶ÅÁ¥†
        const detailModal = document.getElementById("detailModal");
        const detailBackdrop = document.getElementById("detailBackdrop");
        const detailCloseBtn = document.getElementById("detailCloseBtn");
        const detailCancelBtn = document.getElementById("detailCancelBtn");
        const detailSaveBtn = document.getElementById("detailSaveBtn");
        const detailTaskTitle = document.getElementById("detailTaskTitle");

        const inputPriority = document.getElementById("inputPriority");
        const inputVision = document.getElementById("inputVision");
        const inputExcite = document.getElementById("inputExcite");
        const inputGrowth = document.getElementById("inputGrowth");

        const remindModal = document.getElementById("remindModal");
        const remindBackdrop = document.getElementById("remindBackdrop");
        const remindTaskTitle = document.getElementById("remindTaskTitle");
        const remindDatetime = document.getElementById("remindDatetime");
        const remindCancelBtn = document.getElementById("remindCancelBtn");
        const remindSaveBtn = document.getElementById("remindSaveBtn");

        const valPriority = document.getElementById("valPriority");
        const valVision = document.getElementById("valVision");
        const valExcite = document.getElementById("valExcite");
        const valGrowth = document.getElementById("valGrowth");

        /* ==========================
          ÂàùÊúüÂåñ
        ========================== */
        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                userId = profile.userId;

                bindUI();
                bindModalUI();
                bindRemindModalUI();
                await loadList();
            } catch (e) {
                console.error(e);
                alert("LIFFÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
            }
        }

        /* ==========================
          „Ç§„Éô„É≥„Éà„Éê„Ç§„É≥„Éâ
        ========================== */
        function bindUI() {
            refreshBtn.onclick = loadList;

            btnAdd.onclick = async () => {
                const title = newTitle.value.trim();
                if (!title) return;
                await action("create", null, { task_name: title });
                newTitle.value = "";
            };
        }

        /* ==========================
          Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ UI
        ========================== */
        function bindModalUI() {
            const close = () => detailModal.classList.remove("visible");

            detailBackdrop.onclick = close;
            detailCloseBtn.onclick = close;
            detailCancelBtn.onclick = close;

            const bindSlider = (input, label) => {
                input.addEventListener("input", () => { label.textContent = input.value; });
            };
            bindSlider(inputPriority, valPriority);
            bindSlider(inputVision, valVision);
            bindSlider(inputExcite, valExcite);
            bindSlider(inputGrowth, valGrowth);

            detailSaveBtn.onclick = async () => {
                if (!currentDetailTask) return;
                const payload = {
                    priority: Number(inputPriority.value),
                    vision_score: Number(inputVision.value),
                    excite_score: Number(inputExcite.value),
                    growth_score: Number(inputGrowth.value),
                };
                await action("update_detail", currentDetailTask.id, payload);
                close();
            };
        }

        function bindRemindModalUI() {
            const close = () => {
                remindModal.classList.remove("visible");
                currentRemindTask = null;
            };

            remindBackdrop.onclick = close;
            remindCancelBtn.onclick = close;

            remindSaveBtn.onclick = async () => {
                if (!currentRemindTask) return;
                const value = remindDatetime.value;
                if (!value) {
                    alert("ÈÄöÁü•„Åô„ÇãÊó•ÊôÇ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                    return;
                }
                const iso = new Date(value).toISOString();
                await action("remind_custom", currentRemindTask.id, { remind_at: iso });
                close();
                await loadList();
            };
        }

        function openDetail(task) {
            currentDetailTask = task;

            const name = task.task_name || task.title || "(ÁÑ°È°å)";
            detailTaskTitle.textContent = name;

            inputPriority.value = Number(task.priority ?? 0);
            inputVision.value = Number(task.vision_score ?? 0);
            inputExcite.value = Number(task.excite_score ?? 0);
            inputGrowth.value = Number(task.growth_score ?? 0);

            valPriority.textContent = inputPriority.value;
            valVision.textContent = inputVision.value;
            valExcite.textContent = inputExcite.value;
            valGrowth.textContent = inputGrowth.value;

            detailModal.classList.add("visible");
        }

        function openRemindModal(task) {
            currentRemindTask = task;
            const name = task.task_name || task.title || "(ÁÑ°È°å)";
            remindTaskTitle.textContent = name;

            let baseDate;
            if (task.remind_at) {
                baseDate = new Date(task.remind_at);
            } else {
                baseDate = new Date();
                baseDate.setHours(baseDate.getHours() + 2);
            }

            const pad = (n) => String(n).padStart(2, "0");
            const yyyy = baseDate.getFullYear();
            const mm = pad(baseDate.getMonth() + 1);
            const dd = pad(baseDate.getDate());
            const hh = pad(baseDate.getHours());
            const mi = pad(baseDate.getMinutes());

            remindDatetime.value = `${yyyy}-${mm}-${dd}T${hh}:${mi}`;

            remindModal.classList.add("visible");
        }

        /* ==========================
          LIST API
        ========================== */
        async function loadList() {
            const url = `${API_BASE}/list?user_id=${encodeURIComponent(userId)}`;
            console.log("[LIST] request:", url);

            try {
                const res = await fetch(url);
                console.log("[LIST] status:", res.status);

                const text = await res.text();
                console.log("[LIST] raw response:", JSON.stringify(text));

                if (!res.ok) {
                    console.error("[LIST] http error:", res.status, text);
                    alert("„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºàHTTP„Ç®„É©„ÉºÔºâ");
                    return;
                }

                if (!text) {
                    console.warn("[LIST] Á©∫„É¨„Çπ„Éù„É≥„Çπ„Åß„Åó„Åü");
                    renderList({ pinned: [], active: [], completed: [] });
                    return;
                }

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error("[LIST] JSON „Éë„Éº„Çπ„Ç®„É©„Éº:", e);
                    alert("„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºàJSON„Ç®„É©„ÉºÔºâ");
                    return;
                }

                renderList(data);
            } catch (err) {
                console.error("[LIST] fetch error:", err);
                alert("„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºà„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„ÉºÔºâ");
            }
        }

        function renderList(data) {
            pinnedEl.innerHTML = "";
            activeEl.innerHTML = "";
            completedEl.innerHTML = "";

            (data.pinned || []).forEach(t => pinnedEl.appendChild(taskCard(t, false)));
            (data.active || []).forEach(t => activeEl.appendChild(taskCard(t, false)));
            (data.completed || []).forEach(t => completedEl.appendChild(taskCard(t, true)));
        }

        /* ==========================
          „Ç¢„ÇØ„Ç∑„Éß„É≥ÂÖ±ÈÄö
        ========================== */
        async function action(kind, id, extra = {}) {
            const url = `${API_BASE}/action`;
            try {
                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        user_id: userId,
                        action: kind,
                        task_id: id,
                        ...extra
                    })
                });

                const text = await res.text();
                console.log("[ACTION]", kind, "status:", res.status, "resp:", text);

                if (!res.ok) {
                    console.error("[ACTION] http error:", res.status, text);
                    alert("Êìç‰Ωú„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
                    return;
                }

                await loadList();
            } catch (err) {
                console.error("[ACTION] fetch error:", err);
                alert("Êìç‰Ωú„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºà„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„ÉºÔºâ");
            }
        }

        /* ==========================
          ‰∏¶„Å≥È†ÜÊõ¥Êñ∞
        ========================== */
        async function updateSort() {
            if (!userId) return;

            const orders = [];

            pinnedEl.querySelectorAll(".card").forEach((card, index) => {
                const t = card.__taskData;
                if (!t) return;
                orders.push({ id: t.id, sort_order: index, section: "pinned" });
            });
            activeEl.querySelectorAll(".card").forEach((card, index) => {
                const t = card.__taskData;
                if (!t) return;
                orders.push({ id: t.id, sort_order: index, section: "active" });
            });
            completedEl.querySelectorAll(".card").forEach((card, index) => {
                const t = card.__taskData;
                if (!t) return;
                orders.push({ id: t.id, sort_order: index, section: "completed" });
            });

            console.log("[SORT_UPDATE] orders:", orders);
            await action("sort_update", null, { orders });
        }

        /* ==========================
          TASK CARD
        ========================== */
        function taskCard(t, isCompleted = false) {
            const wrap = document.createElement("div");
            wrap.className = "card";
            if (isCompleted) wrap.classList.add("completed");

            // ËÉåÈù¢„É¨„Éº„É´
            const rail = document.createElement("div");
            rail.className = "actions-rail";

            const left = document.createElement("div");
            left.className = "actions-left";

            if (!isCompleted) {
                left.append(
                    mkBtn("ÂÆå‰∫Ü", () => action("complete", t.id), "btn-complete"),
                    mkBtn("ÈÄöÁü•", () => openRemindModal(t), "btn-remind")
                );
            } else {
                left.append(mkBtn("Êú™ÂÆå", () => action("uncomplete", t.id), "btn-complete"));
            }

            const right = document.createElement("div");
            right.className = "actions-right";
            right.append(
                mkBtn("Ë©≥Á¥∞", () => openDetail(t), "btn-detail"),
                mkBtn(t.pinned ? "üìçËß£Èô§" : "üìç„Éî„É≥", () => action("toggle_pin", t.id), "btn-pin"),
                mkBtn("ÂâäÈô§", () => {
                    if (t.pinned) return alert("„Éî„É≥„ÇíÂ§ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
                    action("delete", t.id);
                }, "btn-delete")
            );

            rail.append(left, right);

            // ÂâçÈù¢
            const sl = document.createElement("div");
            sl.className = "sl";

            const titleEl = document.createElement("div");
            titleEl.className = "title";

            const name = t.task_name || t.title || "(ÁÑ°È°å)";
            titleEl.textContent = t.pinned ? "üìç " + name : name;

            const remindInfo = document.createElement("div");
            remindInfo.className = "remind-info";
            if (t.remind_at) {
                const d = new Date(t.remind_at);
                const y = d.getFullYear();
                const m = d.getMonth() + 1;
                const day = d.getDate();
                const hh = String(d.getHours()).padStart(2, "0");
                const mm = String(d.getMinutes()).padStart(2, "0");
                remindInfo.textContent = `üîî ${y}/${m}/${day} ${hh}:${mm}`;
            }

            const handle = document.createElement("div");
            handle.className = "handle";
            handle.textContent = "‚ò∞";

            handle.addEventListener("touchstart", e => {
                e.stopPropagation();
            }, { passive: true });

            handle.addEventListener("touchmove", e => {
                e.preventDefault();   // ‚Üê „Çπ„ÇØ„É≠„Éº„É´„ÇíÊ≠¢„ÇÅ„Çã
                e.stopPropagation();  // ‚Üê wrap „Åæ„Åß„Ç§„Éô„É≥„Éà„ÅåË°å„Åã„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
            }, { passive: false });

            sl.append(titleEl, remindInfo, handle);
            wrap.append(rail, sl);

            // ===== „Éú„Çø„É≥ÂπÖ„ÇíÊ∏¨„Å£„Å¶ data „Å´‰øùÂ≠òÔºàÁ´Ø„ÇíÊèÉ„Åà„ÇãÁî®Ôºâ =====
            requestAnimationFrame(() => {
                const lRect = left.getBoundingClientRect();
                const rRect = right.getBoundingClientRect();
                wrap.dataset.leftWidth = lRect.width || 140;
                wrap.dataset.rightWidth = rRect.width || 140;
            });

            let holdTimer = null;
            handle.addEventListener("pointerdown", e => {
                holdTimer = setTimeout(() => startDrag(e, wrap), 500);
            });

            handle.addEventListener("pointerup", () => clearTimeout(holdTimer));
            handle.addEventListener("pointerleave", () => clearTimeout(holdTimer));

            /* ==========================
                PCÁâà „ÇØ„É™„ÉÉ„ÇØ„Åß„Çπ„ÉØ„Ç§„Éó
            ========================== */
            if (!/Mobi|Android/i.test(navigator.userAgent)) {
                sl.addEventListener("click", () => {
                    const rect = sl.getBoundingClientRect();
                    const x = event.clientX - rect.left;

                    const leftW = Number(wrap.dataset.leftWidth) || 140;
                    const rightW = Number(wrap.dataset.rightWidth) || 140;

                    if (wrap.classList.contains("open-left") || wrap.classList.contains("open-right")) {
                        wrap.classList.remove("open-left", "open-right");
                        sl.style.transform = "translateX(0)";
                        return;
                    }

                    if (x < rect.width / 2) {
                        wrap.classList.add("open-left");
                        wrap.classList.remove("open-right");
                        sl.style.transform = `translateX(${leftW}px)`;
                    } else {
                        wrap.classList.add("open-right");
                        wrap.classList.remove("open-left");
                        sl.style.transform = `translateX(-${rightW}px)`;
                    }
                });
            }

            // ==========================
            // „Çπ„ÉØ„Ç§„ÉóÂá¶ÁêÜÔºà„Çø„ÉÉ„ÉÅÔºâ
            // ==========================
            let startX = 0;
            let currentX = 0;
            let isSwiping = false;

            const onTouchStart = (e) => {
                const touch = e.touches[0];
                startX = touch.clientX;
                currentX = startX;
                isSwiping = true;
                sl.style.transition = "none";
            };

            const onTouchMove = (e) => {
                if (!isSwiping) return;
                const touch = e.touches[0];
                currentX = touch.clientX;
                const deltaX = currentX - startX;
                const leftW = Number(wrap.dataset.leftWidth) || 140;
                const rightW = Number(wrap.dataset.rightWidth) || 140;

                if (deltaX > 0) {
                    const d = Math.min(deltaX, leftW);
                    sl.style.transform = `translateX(${d}px)`;
                } else {
                    const d = Math.max(deltaX, -rightW);
                    sl.style.transform = `translateX(${d}px)`;
                }
            };

            const onTouchEnd = () => {
                if (!isSwiping) return;
                isSwiping = false;

                sl.style.transition = "transform 0.15s ease-out";

                const deltaX = currentX - startX;
                const leftW = Number(wrap.dataset.leftWidth) || 140;
                const rightW = Number(wrap.dataset.rightWidth) || 140;

                if (deltaX > SNAP_THRESHOLD) {
                    wrap.classList.add("open-left");
                    wrap.classList.remove("open-right");
                    sl.style.transform = `translateX(${leftW}px)`;
                } else if (deltaX < -SNAP_THRESHOLD) {
                    wrap.classList.add("open-right");
                    wrap.classList.remove("open-left");
                    sl.style.transform = `translateX(-${rightW}px)`;
                } else {
                    wrap.classList.remove("open-left", "open-right");
                    sl.style.transform = "translateX(0)";
                }
            };

            sl.addEventListener("touchstart", onTouchStart, { passive: true });
            sl.addEventListener("touchmove", onTouchMove, { passive: true });
            sl.addEventListener("touchend", onTouchEnd);
            sl.addEventListener("touchcancel", onTouchEnd);

            // „Ç´„Éº„Éâ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰øùÊåÅÔºà‰∏¶„Å≥Êõø„ÅàÁî®Ôºâ
            wrap.__taskData = t;

            return wrap;
        }

        function mkBtn(label, onClick, className) {
            const btn = document.createElement("button");
            btn.textContent = label;
            btn.className = className;
            btn.onclick = (e) => {
                e.stopPropagation();
                onClick();
            };
            return btn;
        }

        /* ==========================
            ‚ò∞ „Åß‰∏¶„Å≥Êõø„ÅàÔºà„Éâ„É©„ÉÉ„Ç∞Ôºâ
        ========================== */
        function startDrag(startEvent, card) {
            startEvent.preventDefault();
            startEvent.stopPropagation();

            const list = card.parentElement;
            if (!list) return;

            card.classList.add("dragging");
            document.body.style.userSelect = "none";

            const pointerId = startEvent.pointerId;
            const getY = (ev) => ev.clientY;

            const onMove = (ev) => {
                if (ev.pointerId !== pointerId) return;
                const y = getY(ev);
                const siblings = Array.from(list.children);
                const currentIndex = siblings.indexOf(card);
                if (currentIndex === -1) return;

                const prev = siblings[currentIndex - 1];
                const next = siblings[currentIndex + 1];

                if (prev) {
                    const rect = prev.getBoundingClientRect();
                    if (y < rect.top + rect.height / 2) {
                        list.insertBefore(card, prev);
                        updateSort();
                        return;
                    }
                }

                if (next) {
                    const rect = next.getBoundingClientRect();
                    if (y > rect.top + rect.height / 2) {
                        list.insertBefore(next, card);
                        updateSort();
                        return;
                    }
                }
            };

            const onUp = (ev) => {
                if (ev.pointerId !== pointerId) return;
                document.removeEventListener("pointermove", onMove);
                document.removeEventListener("pointerup", onUp);
                card.classList.remove("dragging");
                document.body.style.userSelect = "";
            };

            document.addEventListener("pointermove", onMove);
            document.addEventListener("pointerup", onUp);
        }

        init();
    </script>
</body>
</html>
