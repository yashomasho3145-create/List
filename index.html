<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>üí™ „É†„Ç≠„É†„Ç≠„Çø„Çπ„Åè„Çì</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@500;700&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --dark-navy: #0d1b2a;
            --deep-navy: #1b263b;
            --navy-blue: #415a77;
            --slate-gray: #778da9;
            --energy-orange: #ff9f43;
            --golden-yellow: #feca57;
            --power-red: #ff6b6b;
            --success-green: #26de81;
            --muscle-purple: #a55eea;
            --priority-critical-bg: linear-gradient(135deg, #1a0a0a 0%, #2d0a0a 50%, #1a0a0a 100%);
            --priority-critical-border: #ff3333;
            --priority-critical-glow: rgba(255, 51, 51, 0.6);
            --priority-high-bg: linear-gradient(135deg, #1a1a0a 0%, #2d2d0a 50%, #1a1a0a 100%);
            --priority-high-border: #ffa500;
            --priority-high-glow: rgba(255, 165, 0, 0.4);
            --mission-dark: #0a0a0a;
            --mission-steel: #1a1a1a;
            --mission-ember: #cc2200;
            --mission-flame: #ff4422;
            --gradient-power: linear-gradient(135deg, #ff9f43 0%, #ff6b6b 100%);
            --gradient-energy: linear-gradient(135deg, #feca57 0%, #ff9f43 100%);
            --gradient-muscle: linear-gradient(135deg, #a55eea 0%, #ff6b6b 100%);
            --gradient-dark: linear-gradient(180deg, #1b263b 0%, #0d1b2a 100%);
            --text-primary: #0d1b2a;
            --text-secondary: #415a77;
            --text-muted: #778da9;
            --text-light: #e0e1dd;
            --bg-main: #f8f9fa;
            --bg-card: #ffffff;
            --bg-dark: #0d1b2a;
        }
        * { box-sizing: border-box; }
        body { font-family: 'M PLUS Rounded 1c', -apple-system, system-ui, sans-serif; margin: 0; background: var(--bg-main); color: var(--text-primary); }
        .heading-serif { font-family: 'Noto Serif JP', serif; font-weight: 700; }

        /* „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .tab-nav { position: sticky; top: 0; left: 0; right: 0; background: var(--gradient-dark); display: flex; padding: 12px 12px 0; gap: 4px; z-index: 100; box-shadow: 0 4px 20px rgba(13, 27, 42, 0.3); }
        .tab-nav-item { display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 13px; font-weight: 500; color: var(--slate-gray); cursor: pointer; padding: 12px 16px 14px; background: rgba(255, 255, 255, 0.05); border-radius: 12px 12px 0 0; position: relative; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); flex: 1; border: 1px solid rgba(255, 255, 255, 0.1); border-bottom: none; }
        .tab-nav-item:hover { background: rgba(255, 255, 255, 0.1); color: var(--text-light); }
        .tab-nav-item.active { background: var(--bg-main); color: var(--energy-orange); font-weight: 700; border-color: rgba(255, 159, 67, 0.3); box-shadow: 0 -4px 15px rgba(255, 159, 67, 0.2); z-index: 2; }
        .tab-nav-item.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 3px; background: var(--bg-main); }
        .tab-nav-item.active::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 30px; height: 3px; background: var(--gradient-power); border-radius: 0 0 3px 3px; }
        .tab-nav-item span { font-size: 18px; transition: transform 0.3s ease; }
        .tab-nav-item.active span { animation: tabIconBounce 0.5s ease; }
        @keyframes tabIconBounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        /* „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        header { position: sticky; top: 0; background: var(--bg-card); border-bottom: 1px solid rgba(13, 27, 42, 0.08); z-index: 10; }
        .bar { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; }
        .bar-title { font-family: 'Noto Serif JP', serif; font-weight: 700; font-size: 18px; color: var(--dark-navy); display: flex; align-items: center; gap: 8px; }
        .bar-title::before { content: 'üí™'; font-size: 20px; }
        .bar-btn { padding: 8px 14px; border-radius: 20px; border: 2px solid var(--energy-orange); font-size: 14px; font-weight: 600; cursor: pointer; background: transparent; color: var(--energy-orange); transition: all 0.3s ease; flex-shrink: 0; }
        .bar-btn:hover { background: var(--energy-orange); color: white; transform: rotate(180deg); }
        .bar-add { display: flex; gap: 6px; flex: 1; max-width: 280px; margin: 0 8px; }
        .bar-add input { flex: 1; padding: 8px 12px; border-radius: 20px; border: 2px solid rgba(13, 27, 42, 0.1); font-size: 13px; font-family: inherit; transition: all 0.3s ease; background: var(--bg-main); min-width: 0; }
        .bar-add input:focus { outline: none; border-color: var(--energy-orange); box-shadow: 0 0 0 3px rgba(255, 159, 67, 0.15); }
        .bar-add button { padding: 8px 14px; border-radius: 20px; border: none; background: var(--gradient-power); color: white; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3); white-space: nowrap; flex-shrink: 0; }
        .bar-add button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4); }

        /* MSCÈñã„Åè„Éú„Çø„É≥ */
        .msc-open-btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: 2px solid #cc2200;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(135deg, #1a0a0a 0%, #2d0808 100%);
            color: #ff4422;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(204, 34, 0, 0.3), inset 0 1px 0 rgba(255, 68, 34, 0.2);
            text-shadow: 0 0 8px rgba(255, 68, 34, 0.5);
        }
        .msc-open-btn:hover {
            background: linear-gradient(135deg, #cc2200 0%, #ff4422 100%);
            color: white;
            box-shadow: 0 0 20px rgba(255, 68, 34, 0.5), 0 0 40px rgba(204, 34, 0, 0.3);
        }
        .msc-open-btn.active {
            background: linear-gradient(135deg, #cc2200 0%, #990000 100%);
            color: white;
            border-color: #ff4422;
        }

        /* „É™„Çπ„Éà„Çø„Éñ */
        .list { display: flex; flex-direction: column; }

        /* „Ç´„Éº„ÉâÂü∫Êú¨„Çπ„Çø„Ç§„É´ */
        .card { position: relative; background: var(--bg-card); border-bottom: 1px solid rgba(13, 27, 42, 0.06); height: 68px; overflow: hidden; touch-action: pan-y; transition: all 0.3s ease; }
        .card:hover { background: rgba(255, 159, 67, 0.03); }

        /* ÂÑ™ÂÖàÈ†Ü‰ΩçÂà•„Ç´„Éº„Éâ„Çπ„Çø„Ç§„É´ */
        .card.priority-critical { background: var(--priority-critical-bg); border-left: 4px solid var(--priority-critical-border); box-shadow: inset 0 0 30px rgba(255, 51, 51, 0.1), 0 0 15px var(--priority-critical-glow); animation: criticalPulse 3s infinite; }
        .card.priority-critical .sl { background: linear-gradient(135deg, #1a0a0a 0%, #2d0a0a 50%, #1a0a0a 100%); }
        .card.priority-critical .title { color: #fff; font-weight: 700; text-shadow: 0 0 10px rgba(255, 51, 51, 0.5); }
        .card.priority-critical .priority-badge { background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%); color: white; padding: 3px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 2px 8px rgba(255, 51, 51, 0.4); animation: badgeGlow 2s infinite; }
        @keyframes criticalPulse { 0%, 100% { box-shadow: inset 0 0 30px rgba(255, 51, 51, 0.1), 0 0 15px var(--priority-critical-glow); } 50% { box-shadow: inset 0 0 40px rgba(255, 51, 51, 0.15), 0 0 25px var(--priority-critical-glow); } }
        @keyframes badgeGlow { 0%, 100% { box-shadow: 0 2px 8px rgba(255, 51, 51, 0.4); } 50% { box-shadow: 0 2px 15px rgba(255, 51, 51, 0.6); } }

        .card.priority-high { background: var(--priority-high-bg); border-left: 4px solid var(--priority-high-border); box-shadow: inset 0 0 20px rgba(255, 165, 0, 0.08), 0 0 10px var(--priority-high-glow); }
        .card.priority-high .sl { background: linear-gradient(135deg, #1a1a0a 0%, #2d2d0a 50%, #1a1a0a 100%); }
        .card.priority-high .title { color: #f0f0f0; font-weight: 600; }
        .card.priority-high .priority-badge { background: linear-gradient(135deg, #ffa500 0%, #cc8400 100%); color: #1a1a0a; padding: 3px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

        .card.priority-normal { background: var(--bg-card); }
        .priority-badge { display: none; }
        .card.priority-critical .priority-badge, .card.priority-high .priority-badge { display: inline-block; margin-right: 8px; }
        .card.completed .title { color: var(--text-muted); text-decoration: line-through; }
        .card.completed { background: rgba(38, 222, 129, 0.05); }
        .card.completed.priority-critical, .card.completed.priority-high { opacity: 0.6; }
        .card.dragging { opacity: 0.95; box-shadow: 0 12px 30px rgba(13, 27, 42, 0.25); z-index: 100; transform: scale(1.02); border-radius: 12px; }
        .card.drag-placeholder { background: rgba(255, 159, 67, 0.1); border: 2px dashed var(--energy-orange); }
        .card.drag-placeholder .sl, .card.drag-placeholder .actions-rail { visibility: hidden; }

        .sl { position: relative; height: 100%; width: 100%; display: flex; align-items: center; padding: 0 14px; transition: transform .15s ease; background: var(--bg-card); z-index: 2; }
        .actions-rail { position: absolute; inset: 0; display: flex; justify-content: space-between; align-items: center; pointer-events: none; z-index: 1; }
        .card.open-left .actions-rail, .card.open-right .actions-rail { pointer-events: auto; }
        .actions-left, .actions-right { height: 100%; display: flex; align-items: center; }
        .actions-left { background: linear-gradient(90deg, var(--success-green) 0%, #20bf6b 100%); justify-content: flex-start; }
        .actions-right { background: linear-gradient(90deg, #4a5568 0%, #2d3748 100%); justify-content: flex-end; }
        .actions-rail button { height: 100%; min-width: 60px; border: none; color: white; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .btn-complete { background: var(--success-green); }
        .btn-plus2h { background: var(--muscle-purple); }
        .btn-detail { background: var(--navy-blue); }
        .btn-priority { background: #e67e22; }
        .btn-delete { background: var(--power-red); }

        .title { font-size: 15px; font-weight: 500; color: var(--text-primary); flex: 1; }
        .handle { cursor: grab; opacity: 0.3; padding: 0 8px; font-size: 20px; touch-action: none; transition: all 0.2s ease; }
        .card.priority-critical .handle, .card.priority-high .handle { color: #888; }
        .handle:hover { opacity: 0.6; color: var(--energy-orange); }

        .divider-label { text-align: center; color: var(--text-secondary); font-size: 12px; font-weight: 600; padding: 14px 0 8px; background: var(--bg-main); text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .divider-label::before, .divider-label::after { content: ''; width: 30px; height: 2px; background: linear-gradient(90deg, transparent, var(--slate-gray), transparent); }
        .remindAt { font-size: 11px; color: var(--muscle-purple); margin-left: 8px; white-space: nowrap; font-weight: 500; background: rgba(165, 94, 234, 0.1); padding: 3px 8px; border-radius: 10px; }

        /* „Éü„ÉÉ„Ç∑„Éß„É≥„Çø„Çπ„ÇØ - ÁæäÁöÆÁ¥ô„Çπ„Çø„Ç§„É´ */
        .mission-task-wrapper {
            position: relative;
            margin: 16px;
            perspective: 1000px;
        }
        .mission-task-card {
            background: url('../ÁîªÂÉè/„Éü„ÉÉ„Ç∑„Éß„É≥„Çø„Çπ„ÇØ_ËÉåÊôØ.jpg') center/cover;
            border-radius: 4px;
            padding: 24px 28px;
            color: #3d2b1f;
            position: relative;
            overflow: visible;
            border: none;
            box-shadow:
                0 4px 15px rgba(0, 0, 0, 0.2),
                0 1px 3px rgba(0, 0, 0, 0.1),
                inset 0 0 30px rgba(139, 115, 85, 0.2);
            min-height: 120px;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }
        .mission-task-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.1) 0%,
                transparent 40%,
                transparent 60%,
                rgba(0, 0, 0, 0.05) 100%);
            pointer-events: none;
            border-radius: 4px;
        }
        /* „ÇÅ„Åè„Çå„Ç®„Éï„Çß„ÇØ„ÉàÁî®„ÅÆÂè≥Á´Ø„ÅÆÂΩ± */
        .mission-task-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: var(--peel-shadow, 0px);
            height: 100%;
            background: linear-gradient(to left,
                rgba(0, 0, 0, 0.35) 0%,
                rgba(0, 0, 0, 0.15) 40%,
                transparent 100%);
            pointer-events: none;
            z-index: 3;
            transition: width 0.1s ease-out;
            border-radius: 0 4px 4px 0;
        }
        .mission-task-card.peeling::after {
            width: var(--peel-shadow, 60px);
        }
        /* „ÇÅ„Åè„Çå„ÅüË£èÈù¢ */
        .mission-peel-back {
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(to right, #c9b896 0%, #d4c4a8 50%, #e8dcc8 100%);
            transform-origin: left center;
            transform: rotateY(0deg);
            transition: width 0.1s ease-out;
            z-index: 2;
            border-radius: 0 4px 4px 0;
            box-shadow: inset 3px 0 8px rgba(0, 0, 0, 0.15);
        }
        .mission-task-card.peeling .mission-peel-back {
            width: 80px;
        }
        .mission-task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            position: relative;
            z-index: 2;
        }
        .mission-task-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            font-weight: 700;
            background: linear-gradient(135deg, #8b4513 0%, #654321 100%);
            padding: 5px 12px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #f5deb3;
            border: 1px solid #a0522d;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .mission-task-title {
            font-family: 'Noto Serif JP', serif;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #2d1f14;
            text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 2;
        }
        .mission-task-desc {
            font-size: 13px;
            color: #5c4033;
            margin-bottom: 14px;
            line-height: 1.6;
            position: relative;
            z-index: 2;
        }
        .mission-task-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        .mission-expire {
            font-size: 12px;
            color: #8b6914;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(139, 115, 85, 0.15);
            padding: 6px 12px;
            border-radius: 12px;
        }
        .mission-expire::before { content: '‚è±'; font-size: 14px; }
        .mission-achievement-bubble {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #8b4513 0%, #654321 100%);
            color: #f5deb3;
            padding: 6px 12px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            z-index: 5;
            border: 1px solid #a0522d;
        }
        /* „Çπ„ÉØ„Ç§„Éó„Éí„É≥„Éà */
        .mission-swipe-hint {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 10px;
            color: #8b7355;
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0.7;
            z-index: 2;
        }
        .mission-swipe-hint::after {
            content: '‚Üê';
            animation: swipeHint 1.5s ease-in-out infinite;
        }
        @keyframes swipeHint {
            0%, 100% { transform: translateX(0); opacity: 0.7; }
            50% { transform: translateX(-5px); opacity: 1; }
        }
        /* ÂÆå‰∫Ü„Çπ„Çø„É≥„Éó */
        .mission-completed-stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg) scale(0);
            width: 180px;
            height: auto;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }
        .mission-task-card.completed .mission-completed-stamp {
            animation: stampSlam 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes stampSlam {
            0% {
                transform: translate(-50%, -50%) rotate(-15deg) scale(3);
                opacity: 0;
            }
            60% {
                transform: translate(-50%, -50%) rotate(-15deg) scale(0.9);
                opacity: 1;
            }
            80% {
                transform: translate(-50%, -50%) rotate(-15deg) scale(1.05);
            }
            100% {
                transform: translate(-50%, -50%) rotate(-15deg) scale(1);
                opacity: 1;
            }
        }
        /* ÂÆå‰∫ÜÊôÇ„ÅÆ„Ç´„Éº„ÉâÊöóËª¢ */
        .mission-task-card.completed::before {
            background: rgba(0, 0, 0, 0.15);
        }
        .mission-task-card.completed .mission-task-title,
        .mission-task-card.completed .mission-task-desc {
            opacity: 0.6;
        }
        /* „Éú„Çø„É≥„ÅØÈùûË°®Á§∫Ôºà„Çπ„ÉØ„Ç§„Éó„ÅÆ„ÅøÔºâ */
        .mission-complete-btn { display: none; }

        /* „Çπ„ÉÜ„Éº„Çø„Çπ„Çø„Éñ */
        .status-section { background: var(--bg-card); margin: 12px; border-radius: 16px; padding: 18px; box-shadow: 0 2px 12px rgba(13, 27, 42, 0.06); border: 1px solid rgba(13, 27, 42, 0.04); transition: all 0.3s ease; }
        .status-section:hover { box-shadow: 0 4px 20px rgba(13, 27, 42, 0.1); }
        .status-section-title { font-family: 'Noto Serif JP', serif; font-size: 15px; font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; color: var(--dark-navy); }
        .daily-task-card { cursor: pointer; }
        .daily-task-header { display: flex; justify-content: space-between; align-items: center; }
        .daily-task-arrow { font-size: 14px; color: var(--text-muted); transition: transform 0.3s ease; }
        .daily-task-card.expanded .daily-task-arrow { transform: rotate(180deg); color: var(--energy-orange); }
        .daily-task-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .daily-task-card.expanded .daily-task-content { max-height: 500px; }
        .habit-list { margin-top: 14px; display: flex; flex-direction: column; gap: 10px; }
        .habit-item { display: flex; align-items: center; gap: 14px; padding: 12px 14px; background: var(--bg-main); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; user-select: none; border: 2px solid transparent; }
        .habit-item:hover { background: rgba(255, 159, 67, 0.08); }
        .habit-item.checked { background: rgba(38, 222, 129, 0.12); border-color: rgba(38, 222, 129, 0.3); }
        .habit-checkbox { width: 26px; height: 26px; border: 2px solid var(--slate-gray); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: var(--success-green); transition: all 0.2s ease; }
        .habit-checkbox.checked { background: var(--success-green); border-color: var(--success-green); color: white; animation: checkBounce 0.3s ease; }
        @keyframes checkBounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .habit-name { flex: 1; font-size: 14px; font-weight: 500; }
        .habit-icon { font-size: 20px; }
        .daily-task-buttons { display: flex; gap: 12px; margin-top: 18px; }
        .daily-btn { flex: 1; padding: 12px; font-size: 14px; font-weight: 600; border-radius: 12px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s ease; }
        .daily-btn-cancel { background: var(--bg-main); color: var(--text-secondary); border-color: rgba(13, 27, 42, 0.1); }
        .daily-btn-save { background: var(--gradient-power); color: white; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }
        .daily-btn-save:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4); }

        /* ÈÄ±Èñì„Éì„É•„Éº */
        .week-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        .week-table th, .week-table td { padding: 10px 4px; text-align: center; border-bottom: 1px solid rgba(13, 27, 42, 0.06); }
        .week-table th { color: var(--text-muted); font-weight: 600; font-size: 10px; }
        .week-table td:first-child, .week-table th:first-child { text-align: left; font-size: 12px; }
        .week-table .checked { color: var(--success-green); font-weight: 700; }
        .week-table .unchecked { color: rgba(13, 27, 42, 0.15); }

        /* ÂàÜÊûê */
        .progress-bar-container { margin-top: 10px; }
        .progress-label { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; }
        .progress-label-name { color: var(--text-secondary); font-weight: 500; }
        .progress-label-value { color: var(--energy-orange); font-weight: 700; }
        .progress-bar-bg { height: 12px; background: rgba(13, 27, 42, 0.08); border-radius: 6px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--gradient-power); border-radius: 6px; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .progress-bar-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        /* „Ç∏„É£„Éº„Éä„É´„Çø„Éñ */
        .journal-form { background: var(--bg-card); margin: 12px; border-radius: 16px; padding: 20px; box-shadow: 0 2px 12px rgba(13, 27, 42, 0.06); border: 1px solid rgba(13, 27, 42, 0.04); }
        .form-group { margin-bottom: 16px; }
        .form-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input, .form-textarea { width: 100%; padding: 12px 14px; border: 2px solid rgba(13, 27, 42, 0.1); border-radius: 12px; font-size: 15px; font-family: inherit; background: var(--bg-main); transition: all 0.3s ease; }
        .form-textarea { min-height: 120px; resize: vertical; line-height: 1.6; }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--energy-orange); box-shadow: 0 0 0 4px rgba(255, 159, 67, 0.15); background: var(--bg-card); }
        .journal-submit-btn { width: 100%; padding: 14px; background: var(--gradient-power); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }
        .journal-submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4); }
        .journal-list { margin: 0 12px; }

        /* ÊúàÂà•„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥ */
        .journal-month-group { margin-bottom: 12px; }
        .journal-month-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; background: var(--bg-card); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; border: 1px solid rgba(13, 27, 42, 0.06); }
        .journal-month-header:hover { background: rgba(255, 159, 67, 0.05); }
        .journal-month-header.active { background: var(--gradient-dark); color: white; border-color: transparent; }
        .journal-month-title { font-family: 'Noto Serif JP', serif; font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 8px; }
        .journal-month-count { font-size: 12px; color: var(--text-muted); background: var(--bg-main); padding: 4px 10px; border-radius: 10px; }
        .journal-month-header.active .journal-month-count { background: rgba(255, 255, 255, 0.2); color: white; }
        .journal-month-arrow { font-size: 14px; color: var(--text-muted); transition: transform 0.3s ease; }
        .journal-month-header.active .journal-month-arrow { transform: rotate(180deg); color: white; }
        .journal-month-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .journal-month-content.active { max-height: 2000px; }
        .journal-month-content-inner { padding-top: 12px; }

        .journal-card { background: var(--bg-card); border-radius: 16px; padding: 16px 18px; margin-bottom: 12px; box-shadow: 0 2px 12px rgba(13, 27, 42, 0.06); cursor: pointer; transition: all 0.3s ease; border: 1px solid rgba(13, 27, 42, 0.04); border-left: 4px solid var(--energy-orange); }
        .journal-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(13, 27, 42, 0.1); }
        .journal-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .journal-date { font-size: 12px; color: var(--text-muted); font-weight: 500; }
        .journal-tasks-count { font-size: 12px; color: var(--success-green); font-weight: 600; background: rgba(38, 222, 129, 0.1); padding: 3px 10px; border-radius: 10px; }
        .journal-title-text { font-family: 'Noto Serif JP', serif; font-size: 15px; font-weight: 600; margin-bottom: 6px; color: var(--dark-navy); }
        .journal-preview { font-size: 13px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal-root { position: fixed; inset: 0; display: none; z-index: 50; align-items: flex-end; justify-content: center; }
        .modal-root.visible { display: flex; }
        .modal-backdrop { position: absolute; inset: 0; background: rgba(13, 27, 42, 0.6); backdrop-filter: blur(4px); z-index: 0; }
        .modal-panel { width: 100%; max-width: 480px; background: var(--bg-card); border-radius: 24px 24px 0 0; padding: 20px; animation: slideUp .25s cubic-bezier(0.4, 0, 0.2, 1); position: relative; z-index: 1; box-shadow: 0 -10px 40px rgba(13, 27, 42, 0.2); }
        .modal-panel::before { content: ''; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 40px; height: 4px; background: rgba(13, 27, 42, 0.15); border-radius: 2px; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .slider-group { margin: 16px 0; }
        .slider-label-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; }
        .slider-label-row span { font-weight: 500; color: var(--text-secondary); }
        .slider-label-row span.value { font-size: 15px; font-weight: 700; color: var(--energy-orange); }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 8px; border-radius: 4px; background: rgba(13, 27, 42, 0.1); outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: var(--gradient-power); cursor: pointer; box-shadow: 0 2px 10px rgba(255, 107, 107, 0.4); }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-secondary { padding: 12px 20px; border: 2px solid rgba(13, 27, 42, 0.15); border-radius: 25px; background: var(--bg-main); font-weight: 600; cursor: pointer; color: var(--text-secondary); }
        .btn-primary-solid { padding: 12px 24px; border-radius: 25px; background: var(--gradient-power); color: white; border: none; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }
        .btn-primary-solid:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4); }

        /* ÂÑ™ÂÖàÈ†Ü‰ΩçÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ */
        .priority-selector { display: flex; flex-direction: column; gap: 12px; margin: 20px 0; }
        .priority-option { display: flex; align-items: center; gap: 14px; padding: 16px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; }
        .priority-option:hover { transform: translateX(4px); }
        .priority-option.critical { background: linear-gradient(135deg, #1a0a0a 0%, #2d0a0a 100%); border-color: #ff3333; }
        .priority-option.critical:hover { box-shadow: 0 0 20px rgba(255, 51, 51, 0.3); }
        .priority-option.high { background: linear-gradient(135deg, #1a1a0a 0%, #2d2d0a 100%); border-color: #ffa500; }
        .priority-option.high:hover { box-shadow: 0 0 20px rgba(255, 165, 0, 0.3); }
        .priority-option.normal { background: var(--bg-main); border-color: rgba(13, 27, 42, 0.15); }
        .priority-option-icon { font-size: 24px; }
        .priority-option-text { flex: 1; }
        .priority-option-title { font-weight: 700; font-size: 15px; margin-bottom: 2px; }
        .priority-option.critical .priority-option-title { color: #ff4444; }
        .priority-option.high .priority-option-title { color: #ffaa00; }
        .priority-option.normal .priority-option-title { color: var(--text-primary); }
        .priority-option-desc { font-size: 12px; color: var(--text-muted); }
        .priority-option.critical .priority-option-desc, .priority-option.high .priority-option-desc { color: #999; }

        /* ÊúàÈñìÂàÜÊûê */
        .monthly-analysis-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 10px; }
        .month-selector { display: flex; align-items: center; gap: 14px; }
        .month-selector-btn { width: 36px; height: 36px; border-radius: 50%; border: 2px solid rgba(13, 27, 42, 0.15); background: var(--bg-card); cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; color: var(--text-secondary); }
        .month-selector-btn:hover { border-color: var(--energy-orange); color: var(--energy-orange); }
        .current-month { font-family: 'Noto Serif JP', serif; font-size: 18px; font-weight: 700; min-width: 110px; text-align: center; color: var(--dark-navy); }
        .monthly-stats-summary { display: flex; gap: 12px; margin-bottom: 20px; }
        .monthly-stat-card { flex: 1; background: var(--bg-main); border-radius: 14px; padding: 14px; text-align: center; }
        .monthly-stat-value { font-size: 28px; font-weight: 700; background: var(--gradient-power); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .monthly-stat-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .monthly-table-container { max-height: 200px; overflow-y: auto; margin-bottom: 16px; border-radius: 12px; border: 1px solid rgba(13, 27, 42, 0.08); }
        .monthly-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .monthly-table th, .monthly-table td { padding: 10px 4px; text-align: center; border-bottom: 1px solid rgba(13, 27, 42, 0.06); }
        .monthly-table th { background: var(--bg-main); position: sticky; top: 0; font-weight: 600; color: var(--text-secondary); }
        .monthly-table td:first-child { text-align: left; font-weight: 500; }
        .monthly-table .cell-check { color: var(--success-green); font-weight: 700; }
        .monthly-table .cell-uncheck { color: rgba(13, 27, 42, 0.15); }
        .monthly-chart-container { height: 180px; margin-top: 16px; }
        .detail-view-btn { background: var(--gradient-muscle); color: white; border: none; padding: 10px 18px; border-radius: 25px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 15px rgba(165, 94, 234, 0.3); }
        .week-view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }

        /* „Ç∏„É£„Éº„Éä„É´„É¢„Éº„ÉÄ„É´ */
        .journal-modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 18px; margin-top: 10px; }
        .journal-modal-date { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
        .journal-modal-title { font-family: 'Noto Serif JP', serif; font-size: 20px; font-weight: 700; color: var(--dark-navy); }
        .journal-tasks-section { background: var(--bg-main); border-radius: 14px; padding: 14px; margin-bottom: 18px; }
        .journal-tasks-header { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .journal-tasks-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .journal-task-chip { background: var(--gradient-power); color: white; font-size: 12px; font-weight: 600; padding: 6px 14px; border-radius: 20px; }
        .journal-content-section { margin-bottom: 18px; }
        .journal-content-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; }
        .journal-content-body { font-size: 15px; line-height: 1.8; color: var(--text-primary); white-space: pre-wrap; }
        .journal-modal-actions { display: flex; gap: 12px; }
        .journal-modal-actions button { flex: 1; padding: 14px; border-radius: 14px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .journal-close-btn { background: var(--bg-main); border: 2px solid rgba(13, 27, 42, 0.1); color: var(--text-secondary); }
        .journal-edit-modal-btn { background: var(--gradient-power); border: none; color: white; }
        .journal-edit-form { display: none; }
        .journal-edit-form.active { display: block; }
        .journal-view-content { display: block; }
        .journal-view-content.hidden { display: none; }

        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞„ÉªÁ©∫Áä∂ÊÖã */
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }
        .loading::after { content: 'üí™'; display: block; font-size: 32px; margin-top: 10px; animation: loadingBounce 1s infinite; }
        @keyframes loadingBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .empty-state { text-align: center; padding: 50px 20px; color: var(--text-muted); font-size: 14px; }
        .empty-state::before { content: 'üìù'; display: block; font-size: 48px; margin-bottom: 12px; opacity: 0.5; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(13, 27, 42, 0.05); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--energy-orange); border-radius: 3px; }

        /* „É†„Ç≠„É†„Ç≠„Çπ„ÉÜ„Éº„Çø„Çπ„Ç´„Éº„ÉâÔºàMSCÔºâ- ÊºÜÈªí√óÊ∑±Á¥Ö ÁÇé„Å®ÈâÑÊùø„Éá„Ç∂„Ç§„É≥ */
        .msc-container { padding: 16px; }
        .msc-card {
            background:
                /* ÈâÑÊùø„ÉÜ„ÇØ„Çπ„ÉÅ„É£È¢®„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ */
                repeating-linear-gradient(
                    90deg,
                    rgba(40, 40, 40, 0.1) 0px,
                    rgba(40, 40, 40, 0.1) 1px,
                    transparent 1px,
                    transparent 20px
                ),
                repeating-linear-gradient(
                    0deg,
                    rgba(40, 40, 40, 0.1) 0px,
                    rgba(40, 40, 40, 0.1) 1px,
                    transparent 1px,
                    transparent 20px
                ),
                /* „É°„Ç§„É≥„ÅÆÊºÜÈªí„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ */
                linear-gradient(180deg, #0a0a0a 0%, #1a0a0a 30%, #0d0505 70%, #050505 100%);
            border-radius: 4px;
            padding: 20px;
            color: #e8e8e8;
            position: relative;
            overflow: hidden;
            border: 2px solid #2a1a1a;
            box-shadow:
                0 15px 50px rgba(0, 0, 0, 0.8),
                inset 0 1px 0 rgba(255, 68, 34, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.5),
                0 0 30px rgba(204, 34, 0, 0.2);
        }
        /* ÁÇé„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà - ‰∏ãÈÉ® */
        .msc-card::before {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -10%;
            width: 120%;
            height: 60%;
            background:
                radial-gradient(ellipse at 20% 100%, rgba(255, 68, 34, 0.4) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 100%, rgba(204, 34, 0, 0.5) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 100%, rgba(255, 100, 50, 0.3) 0%, transparent 45%);
            pointer-events: none;
            animation: flameFlicker 3s ease-in-out infinite;
            z-index: 0;
        }
        /* ÁÇé„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà - ‰∏äÈÉ®„Ç¢„ÇØ„Çª„É≥„Éà */
        .msc-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg,
                transparent 0%,
                #cc2200 20%,
                #ff4422 50%,
                #cc2200 80%,
                transparent 100%);
            box-shadow: 0 0 15px rgba(255, 68, 34, 0.8), 0 0 30px rgba(204, 34, 0, 0.5);
            animation: topGlow 2s ease-in-out infinite;
        }
        @keyframes flameFlicker {
            0%, 100% { opacity: 0.7; transform: translateY(0) scale(1); }
            25% { opacity: 0.9; transform: translateY(-5px) scale(1.02); }
            50% { opacity: 0.8; transform: translateY(-2px) scale(1.01); }
            75% { opacity: 1; transform: translateY(-8px) scale(1.03); }
        }
        @keyframes topGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 68, 34, 0.8), 0 0 30px rgba(204, 34, 0, 0.5); }
            50% { box-shadow: 0 0 25px rgba(255, 68, 34, 1), 0 0 50px rgba(204, 34, 0, 0.8); }
        }
        .msc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            position: relative;
            z-index: 2;
        }
        .msc-header-left { display: flex; align-items: center; gap: 10px; }
        .msc-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, rgba(204, 34, 0, 0.4) 0%, rgba(100, 20, 10, 0.6) 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid rgba(204, 34, 0, 0.5);
            box-shadow: 0 0 15px rgba(255, 68, 34, 0.3), inset 0 1px 0 rgba(255, 100, 50, 0.2);
        }
        .msc-title-area {}
        .msc-title {
            font-family: 'Noto Serif JP', serif;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #fff;
            text-shadow: 0 0 15px rgba(255, 68, 34, 0.4), 0 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
        }
        .msc-mbti-tag {
            display: inline-block;
            background: linear-gradient(135deg, rgba(204, 34, 0, 0.4) 0%, rgba(100, 20, 10, 0.6) 100%);
            padding: 4px 12px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(204, 34, 0, 0.5);
            color: #ff8866;
            text-shadow: 0 0 6px rgba(255, 68, 34, 0.4);
            letter-spacing: 1px;
        }
        .msc-mbti-tag:hover {
            background: linear-gradient(135deg, #cc2200 0%, #990000 100%);
            color: #fff;
            box-shadow: 0 0 15px rgba(204, 34, 0, 0.5);
        }
        .msc-header-right { text-align: right; }
        .msc-level-badge {
            font-size: 11px;
            color: #ff8866;
            margin-bottom: 4px;
            text-shadow: 0 0 8px rgba(255, 68, 34, 0.4);
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .msc-level-score {
            display: flex;
            align-items: baseline;
            gap: 4px;
            justify-content: flex-end;
        }
        .msc-stars {
            font-size: 14px;
            letter-spacing: -2px;
            color: #ff6644;
            text-shadow: 0 0 10px rgba(255, 68, 34, 0.6);
        }
        .msc-score {
            font-size: 30px;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 20px rgba(255, 68, 34, 0.5), 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        .msc-exp-bar {
            width: 80px;
            height: 8px;
            background: rgba(50, 30, 30, 0.8);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
            border: 1px solid rgba(204, 34, 0, 0.4);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        .msc-exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #cc2200, #ff4422, #ff6644);
            border-radius: 2px;
            transition: width 0.8s ease;
            box-shadow: 0 0 10px rgba(255, 68, 34, 0.6);
            position: relative;
        }
        .msc-exp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.3), transparent);
        }
        .msc-exp-text {
            font-size: 10px;
            color: #ff8866;
            margin-top: 4px;
            text-shadow: 0 0 6px rgba(255, 68, 34, 0.3);
        }

        /* „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„Éà - ÈâÑÊùø√óÁÇé„Éá„Ç∂„Ç§„É≥ */
        .msc-radar-section {
            position: relative;
            z-index: 2;
            margin: 20px 0;
            padding: 20px;
            background:
                /* ÈâÑÊùø„ÉÜ„ÇØ„Çπ„ÉÅ„É£ */
                repeating-linear-gradient(
                    45deg,
                    rgba(60, 40, 40, 0.1) 0px,
                    rgba(60, 40, 40, 0.1) 1px,
                    transparent 1px,
                    transparent 10px
                ),
                linear-gradient(180deg, rgba(40, 25, 25, 0.95) 0%, rgba(20, 12, 12, 0.98) 100%);
            border-radius: 4px;
            border: 1px solid rgba(204, 34, 0, 0.4);
            box-shadow:
                inset 0 1px 0 rgba(255, 100, 50, 0.08),
                inset 0 -1px 0 rgba(0, 0, 0, 0.3),
                0 4px 12px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }
        .msc-radar-section::before {
            content: '‚öî POWER ANALYSIS ‚öî';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 700;
            color: #cc2200;
            letter-spacing: 3px;
            text-shadow: 0 0 8px rgba(204, 34, 0, 0.5);
        }
        .msc-radar-section::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #cc2200, #ff4422, #cc2200, transparent);
            box-shadow: 0 0 15px rgba(255, 68, 34, 0.6);
        }
        .msc-radar-container {
            width: 100%;
            max-width: 280px;
            margin: 0 auto;
            aspect-ratio: 1;
        }
        .msc-radar-date {
            text-align: center;
            font-size: 11px;
            opacity: 0.7;
            margin-top: 8px;
        }

        /* Âº∑„Åø„ÉªÂº±„Åø */
        .msc-traits-section {
            position: relative;
            z-index: 2;
            margin-bottom: 16px;
        }
        .msc-traits-title {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .msc-strength-title {
            color: #ff6644;
            text-shadow: 0 0 10px rgba(255, 68, 34, 0.5);
            letter-spacing: 1px;
        }
        .msc-strength-title::before {
            content: 'üî•';
            margin-right: 4px;
        }
        .msc-weakness-title {
            color: #888;
            letter-spacing: 1px;
        }
        .msc-weakness-title::before {
            content: '‚ö†';
            margin-right: 4px;
        }
        .msc-trait-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 14px;
            background:
                linear-gradient(135deg, rgba(204, 34, 0, 0.15) 0%, transparent 50%, rgba(204, 34, 0, 0.1) 100%),
                linear-gradient(180deg, rgba(40, 20, 20, 0.9) 0%, rgba(20, 10, 10, 0.95) 100%);
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid rgba(204, 34, 0, 0.4);
            box-shadow:
                inset 0 1px 0 rgba(255, 100, 50, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.3),
                0 2px 8px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }
        .msc-trait-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 68, 34, 0.5), transparent);
        }
        .msc-trait-item::after {
            content: '';
            position: absolute;
            bottom: -20%;
            left: 10%;
            width: 80%;
            height: 40%;
            background: radial-gradient(ellipse, rgba(204, 34, 0, 0.2) 0%, transparent 70%);
            pointer-events: none;
            animation: traitEmber 3s ease-in-out infinite;
        }
        @keyframes traitEmber {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }
        .msc-trait-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, rgba(204, 34, 0, 0.3) 0%, rgba(100, 20, 10, 0.5) 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            border: 1px solid rgba(204, 34, 0, 0.4);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 100, 50, 0.15);
        }
        .msc-trait-content { flex: 1; }
        .msc-trait-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 3px;
        }
        .msc-trait-name {
            font-size: 14px;
            font-weight: 700;
            color: #ff9966;
            text-shadow: 0 0 6px rgba(255, 100, 50, 0.3);
            letter-spacing: 0.5px;
        }
        .msc-trait-level {
            font-size: 10px;
            background: linear-gradient(135deg, #cc2200 0%, #990000 100%);
            padding: 3px 10px;
            border-radius: 2px;
            color: #fff;
            font-weight: 700;
            letter-spacing: 1px;
            box-shadow: 0 2px 6px rgba(204, 34, 0, 0.4);
        }
        .msc-trait-desc {
            font-size: 12px;
            color: #c0b0a0;
            line-height: 1.6;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
        }

        /* ÁîüÊÖã„É°„É¢ - ÈâÑÊùø√óÁÇé„Éá„Ç∂„Ç§„É≥ */
        .msc-bio-section {
            position: relative;
            z-index: 2;
            background:
                /* ÈâÑÊùø„É™„Éô„ÉÉ„ÉàÊ®°Êßò */
                radial-gradient(circle at 8px 8px, rgba(80, 80, 80, 0.3) 2px, transparent 2px),
                radial-gradient(circle at calc(100% - 8px) 8px, rgba(80, 80, 80, 0.3) 2px, transparent 2px),
                radial-gradient(circle at 8px calc(100% - 8px), rgba(80, 80, 80, 0.3) 2px, transparent 2px),
                radial-gradient(circle at calc(100% - 8px) calc(100% - 8px), rgba(80, 80, 80, 0.3) 2px, transparent 2px),
                /* ÈáëÂ±û„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ */
                linear-gradient(180deg, rgba(50, 30, 30, 0.95) 0%, rgba(25, 15, 15, 0.98) 50%, rgba(40, 25, 25, 0.95) 100%);
            border-radius: 4px;
            padding: 18px 20px;
            border: 2px solid rgba(204, 34, 0, 0.5);
            box-shadow:
                inset 0 2px 4px rgba(255, 100, 50, 0.1),
                inset 0 -2px 4px rgba(0, 0, 0, 0.4),
                0 4px 15px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(204, 34, 0, 0.15);
            overflow: hidden;
        }
        .msc-bio-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #cc2200, #ff4422, #cc2200);
            box-shadow: 0 0 10px rgba(255, 68, 34, 0.8);
        }
        .msc-bio-section::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: 0;
            right: 0;
            height: 50%;
            background: radial-gradient(ellipse at 50% 100%, rgba(255, 68, 34, 0.25) 0%, transparent 60%);
            pointer-events: none;
            animation: bioFlame 4s ease-in-out infinite;
        }
        @keyframes bioFlame {
            0%, 100% { opacity: 0.6; transform: scaleY(1); }
            50% { opacity: 1; transform: scaleY(1.1); }
        }
        .msc-bio-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
            color: #ff6644;
            text-shadow: 0 0 10px rgba(255, 68, 34, 0.5);
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .msc-bio-text {
            font-size: 14px;
            line-height: 1.8;
            text-align: center;
            font-style: italic;
            color: #f0e0d0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 1;
        }
        .msc-footer {
            text-align: center;
            font-size: 10px;
            color: #666;
            margin-top: 20px;
            position: relative;
            z-index: 2;
            padding-top: 12px;
            border-top: 1px solid rgba(204, 34, 0, 0.2);
            letter-spacing: 1px;
        }

        /* MSC „Çø„ÉñÂàá„ÇäÊõø„Åà */
        .msc-tab-switch {
            display: flex;
            gap: 8px;
            margin: 12px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 6px;
        }
        .msc-tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: var(--text-muted);
        }
        .msc-tab-btn.active {
            background: var(--gradient-power);
            color: white;
            box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
        }

        /* MBTIÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ */
        .mbti-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 16px 0;
        }
        .mbti-option {
            padding: 12px 8px;
            border: 2px solid rgba(13, 27, 42, 0.1);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-main);
        }
        .mbti-option:hover { border-color: var(--energy-orange); background: rgba(255, 159, 67, 0.1); }
        .mbti-option.selected { border-color: var(--energy-orange); background: rgba(255, 159, 67, 0.2); }
        .mbti-option-type { font-size: 14px; font-weight: 700; color: var(--dark-navy); }
        .mbti-option-name { font-size: 10px; color: var(--text-muted); margin-top: 2px; }

        /* MSC„Ç´„Éº„ÉâÂÖ®ÁîªÈù¢Ë°®Á§∫ÔºàLIFFÂÖ®‰ΩìË°®Á§∫ÂØæÂøúÔºâ */
        #msc-card-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            overflow: auto;
            padding: 20px;
        }
        #msc-card-view.active {
            display: flex;
        }
        #msc-card-view .msc-container {
            transform: scale(0.67);
            transform-origin: center center;
            max-width: 100%;
            max-height: 100%;
        }
        #msc-card-view .msc-card {
            max-width: 400px;
            width: 100vw;
        }
        /* MSC„Ç´„Éº„ÉâÈñâ„Åò„Çã„Éú„Çø„É≥ */
        .msc-close-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(255, 68, 34, 0.5);
            background: rgba(20, 10, 10, 0.9);
            color: #ff6644;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .msc-close-btn:hover {
            background: rgba(204, 34, 0, 0.3);
            border-color: #ff4422;
            transform: scale(1.1);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

    <nav class="tab-nav">
        <div class="tab-nav-item active" data-tab="list">„É™„Çπ„Éà</div>
        <div class="tab-nav-item" data-tab="status">„Çπ„ÉÜ„Éº„Çø„Çπ</div>
        <div class="tab-nav-item" data-tab="journal">„Ç∏„É£„Éº„Éä„É´</div>
    </nav>

    <!-- „É™„Çπ„Éà„Çø„Éñ -->
    <div id="tab-list" class="tab-content active">
        <header>
            <div class="bar">
                <div class="bar-title">„É™„Çπ„Éà</div>
                <div class="bar-add">
                    <input id="newTitle" placeholder="üí™ „Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ‚Ä¶" />
                    <button id="btnAdd">ËøΩÂä†</button>
                </div>
                <button class="bar-btn" id="refreshBtn">‚Üª</button>
            </div>
        </header>
        <main>
            <div id="missionTaskContainer"></div>
            <div class="divider-label">üéØ ToDo„Çø„Çπ„ÇØ</div>
            <div id="critical" class="list"></div>
            <div id="high" class="list"></div>
            <div id="active" class="list"></div>
            <div class="divider-label">‚úÖ ÈÅîÊàê„Çø„Çπ„ÇØ</div>
            <div id="completed" class="list"></div>
        </main>
    </div>

    <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„Çø„Éñ -->
    <div id="tab-status" class="tab-content">
        <header>
            <div class="bar">
                <div class="bar-title">„Çπ„ÉÜ„Éº„Çø„Çπ</div>
                <button class="msc-open-btn" id="mscOpenBtn">MSC</button>
                <button class="bar-btn" id="statusRefreshBtn">‚Üª</button>
            </div>
        </header>
        <main>
            <!-- MSC ÊàêÈï∑„Ç´„Éº„ÉâÔºà„Éá„Éï„Ç©„É´„ÉàÈùûË°®Á§∫„ÉªÂÖ®ÁîªÈù¢Ë°®Á§∫Ôºâ -->
            <div id="msc-card-view" class="msc-view">
                <button class="msc-close-btn" id="mscCloseBtn">&times;</button>
                <div class="msc-container">
                    <div class="msc-card">
                        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
                        <div class="msc-header">
                            <div class="msc-header-left">
                                <div class="msc-icon">üí™</div>
                                <div class="msc-title-area">
                                    <div class="msc-title">„É†„Ç≠„É†„Ç≠Â±ûÊÄß</div>
                                    <div class="msc-mbti-tag" id="mscMbtiTag" onclick="openMbtiModal()">MBTIÊú™Ë®≠ÂÆö</div>
                                </div>
                            </div>
                            <div class="msc-header-right">
                                <div class="msc-level-badge" id="mscLevelBadge">Lv.1 Ë¶ãÁøí„ÅÑ„Éà„É¨„Éº„Éã„Éº</div>
                                <div class="msc-level-score">
                                    <span class="msc-stars" id="mscStars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                                    <span class="msc-score" id="mscScore">3.5</span>
                                </div>
                                <div class="msc-exp-bar"><div class="msc-exp-fill" id="mscExpFill" style="width:35%"></div></div>
                                <div class="msc-exp-text" id="mscExpText">350 / 1000 EXP</div>
                            </div>
                        </div>

                        <!-- „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„Éà -->
                        <div class="msc-radar-section">
                            <div class="msc-radar-container">
                                <canvas id="mscRadarChart"></canvas>
                            </div>
                            <div class="msc-radar-date" id="mscRadarDate">‚ÄªÁ¥ØË®à„Éá„Éº„ÇøÂü∫Ê∫ñ</div>
                        </div>

                        <!-- Âº∑„Åø -->
                        <div class="msc-traits-section">
                            <div class="msc-traits-title msc-strength-title">Âº∑„Åø</div>
                            <div id="mscStrengths">
                                <div class="msc-trait-item">
                                    <div class="msc-trait-icon">üåÖ</div>
                                    <div class="msc-trait-content">
                                        <div class="msc-trait-header">
                                            <span class="msc-trait-name">Ë¶èÂæã„Ç∑„Éº„É´„Éâ</span>
                                            <span class="msc-trait-level">Lv.4.2</span>
                                        </div>
                                        <div class="msc-trait-desc">Êó©Ëµ∑„Åç„Å®Á¶ÅÈÖí„ÇíÁ∂ôÁ∂ö„Åó„ÄÅË¶èÂæãÊ≠£„Åó„ÅÑÁîüÊ¥ª„ÇíÈÄÅ„Å£„Å¶„ÅÑ„Çã„ÄÇ</div>
                                    </div>
                                </div>
                                <div class="msc-trait-item">
                                    <div class="msc-trait-icon">üìö</div>
                                    <div class="msc-trait-content">
                                        <div class="msc-trait-header">
                                            <span class="msc-trait-name">Êé¢Á©∂„Éñ„Éº„Çπ„Éà</span>
                                            <span class="msc-trait-level">Lv.3.8</span>
                                        </div>
                                        <div class="msc-trait-desc">Ë™≠Êõ∏„ÉªÂ≠¶ÁøíÁøíÊÖ£„ÅåÊ†π‰ªò„ÅÑ„Å¶„Åä„Çä„ÄÅÁü•ÁöÑÂ•ΩÂ•áÂøÉ„ÅåÊó∫Áõõ„ÄÇ</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Âº±„Åø -->
                        <div class="msc-traits-section">
                            <div class="msc-traits-title msc-weakness-title">Âº±„Åø</div>
                            <div id="mscWeaknesses">
                                <div class="msc-trait-item">
                                    <div class="msc-trait-icon">üìù</div>
                                    <div class="msc-trait-content">
                                        <div class="msc-trait-header">
                                            <span class="msc-trait-name">ÂÜÖÁúÅ„Çø„Ç§„É†</span>
                                            <span class="msc-trait-level">Lv.2.1</span>
                                        </div>
                                        <div class="msc-trait-desc">„Ç∏„É£„Éº„Éä„É´Ë®òÈå≤„Åå‰∏çÂÆâÂÆö„ÄÇÊåØ„ÇäËøî„Çä„ÅÆÁøíÊÖ£Âåñ„ÅåË™≤È°å„ÄÇ</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÁîüÊÖã„É°„É¢ -->
                        <div class="msc-bio-section">
                            <div class="msc-bio-title">ÁîüÊÖã„É°„É¢</div>
                            <div class="msc-bio-text" id="mscBioText">
                                ÊúùÂûã„ÅÆÁîüÊ¥ª„É™„Ç∫„É†„ÇíÂ•Ω„Åø„ÄÅ„Ç≥„ÉÑ„Ç≥„ÉÑ„Å®Á©ç„Åø‰∏ä„Åí„Çã„Åì„Å®„ÇíÂ§ßÂàá„Å´„Åó„Å¶„ÅÑ„Çã„ÄÇ
                                Áü•Ë≠òÊ¨≤„ÅåÂº∑„Åè„ÄÅÂ∏∏„Å´Êñ∞„Åó„ÅÑ„Åì„Å®„ÇíÂ≠¶„Åº„ÅÜ„Å®„Åô„ÇãÂßøÂã¢„ÇíÊåÅ„Å§„ÄÇ
                            </div>
                        </div>

                        <div class="msc-footer">¬©2025 „É†„Ç≠„É†„Ç≠„Çø„Çπ„Åè„Çì</div>
                    </div>
                </div>
            </div>

            <!-- „Éà„É¨„Éº„Éã„É≥„Ç∞„É≠„Ç∞Ôºà„Éá„Éï„Ç©„É´„ÉàË°®Á§∫Ôºâ -->
            <div id="msc-log-view" class="msc-view">
                <div class="status-section daily-task-card" id="dailyTaskCard">
                    <div class="daily-task-header">
                        <div class="status-section-title"><span>üèãÔ∏è</span> „Éá„Ç§„É™„Éº„Çø„Çπ„ÇØ</div>
                        <span class="daily-task-arrow">‚ñº</span>
                    </div>
                    <div class="daily-task-content">
                        <div class="habit-list" id="habitList"></div>
                        <div class="daily-task-buttons">
                            <button class="daily-btn daily-btn-cancel" id="habitCancelBtn">„Ç≠„É£„É≥„Çª„É´</button>
                            <button class="daily-btn daily-btn-save" id="habitSaveBtn">üí™ Ë®òÈå≤„Åô„Çã</button>
                        </div>
                    </div>
                </div>
                <div class="status-section">
                    <div class="week-view-header">
                        <div class="status-section-title" style="margin-bottom:0;"><span>üìÖ</span> ÈÄ±Èñì„É≠„Ç∞</div>
                        <button class="detail-view-btn" id="openMonthlyAnalysis"><span>üìä</span> Ë©≥„Åó„ÅèË¶ã„Çã</button>
                    </div>
                    <table class="week-table" id="weekTable">
                        <thead><tr><th>ÁøíÊÖ£</th><th>Êúà</th><th>ÁÅ´</th><th>Ê∞¥</th><th>Êú®</th><th>Èáë</th><th>Âúü</th><th>Êó•</th></tr></thead>
                        <tbody id="weekTableBody"></tbody>
                    </table>
                </div>
                <div class="status-section">
                    <div class="status-section-title"><span>üí™</span> ÊàêÈï∑ÂàÜÊûê</div>
                    <div class="progress-bar-container">
                        <div class="progress-label">
                            <span class="progress-label-name">ÈÄ±ÈñìÈÅîÊàêÁéá</span>
                            <span class="progress-label-value" id="weekProgressValue">0%</span>
                        </div>
                        <div class="progress-bar-bg"><div class="progress-bar-fill" id="weekProgressBar" style="width:0%"></div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- „Ç∏„É£„Éº„Éä„É´„Çø„Éñ -->
    <div id="tab-journal" class="tab-content">
        <header>
            <div class="bar">
                <div class="bar-title">„Ç∏„É£„Éº„Éä„É´</div>
                <button class="bar-btn" id="journalRefreshBtn">‚Üª</button>
            </div>
        </header>
        <main>
            <div class="journal-form">
                <div class="status-section-title" style="margin-bottom:16px;"><span>üìù</span> ‰ªäÊó•„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞Ë®òÈå≤</div>
                <div class="form-group">
                    <label class="form-label">Êó•‰ªò</label>
                    <input type="date" class="form-input" id="journalDate" />
                </div>
                <div class="form-group">
                    <label class="form-label">„Çø„Ç§„Éà„É´</label>
                    <input type="text" class="form-input" id="journalTitle" placeholder="‰ªäÊó•„ÅÆ„Å≤„Å®„Åì„Å®‚Ä¶" />
                </div>
                <div class="form-group">
                    <label class="form-label">ÊåØ„ÇäËøî„ÇäÂÜÖÂÆπ</label>
                    <textarea class="form-textarea" id="journalContent" placeholder="‰ªäÊó•„ÅÆÊàêÈï∑„ÇíË®òÈå≤„Åó„Çà„ÅÜ‚Ä¶"></textarea>
                </div>
                <button class="journal-submit-btn" id="journalSubmitBtn">üí™ Ë®òÈå≤„Çí‰øùÂ≠ò</button>
            </div>
            <div class="divider-label">üìö ÈÅéÂéª„ÅÆË®òÈå≤</div>
            <div class="journal-list" id="journalList"></div>
        </main>
    </div>

    <!-- „Ç∏„É£„Éº„Éä„É´Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
    <div id="journalDetailModal" class="modal-root">
        <div class="modal-backdrop" id="journalDetailBackdrop"></div>
        <div class="modal-panel" style="max-height:80vh;overflow-y:auto;">
            <div id="journalViewContent" class="journal-view-content">
                <div class="journal-modal-header">
                    <div>
                        <div class="journal-modal-date" id="journalModalDate"></div>
                        <div class="journal-modal-title" id="journalModalTitle"></div>
                    </div>
                    <button id="closeJournalDetail" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
                </div>
                <div class="journal-tasks-section">
                    <div class="journal-tasks-header"><span>‚úì</span> „Åì„ÅÆÊó•„Å´ÈÅîÊàê„Åó„Åü„Çø„Çπ„ÇØ</div>
                    <div class="journal-tasks-list" id="journalModalTasks"></div>
                </div>
                <div class="journal-content-section">
                    <div class="journal-content-label">ÊåØ„ÇäËøî„ÇäÂÜÖÂÆπ</div>
                    <div class="journal-content-body" id="journalModalContent"></div>
                </div>
                <div class="journal-modal-actions">
                    <button class="journal-close-btn" id="journalCloseBtn">Èñâ„Åò„Çã</button>
                    <button class="journal-edit-modal-btn" id="journalEditBtn">‚úèÔ∏è Á∑®ÈõÜ„Åô„Çã</button>
                </div>
            </div>
            <div id="journalEditContent" class="journal-edit-form">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;margin-top:10px;">
                    <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;">üìù „Ç∏„É£„Éº„Éä„É´„ÇíÁ∑®ÈõÜ</div>
                    <button id="closeJournalEdit" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
                </div>
                <div class="form-group"><label class="form-label">„Çø„Ç§„Éà„É´</label><input type="text" class="form-input" id="editJournalTitle" /></div>
                <div class="form-group"><label class="form-label">ÂÜÖÂÆπ</label><textarea class="form-textarea" id="editJournalContent" style="min-height:150px;"></textarea></div>
                <div class="journal-modal-actions">
                    <button class="journal-close-btn" id="journalCancelEditBtn">„Ç≠„É£„É≥„Çª„É´</button>
                    <button class="journal-edit-modal-btn" id="journalSaveEditBtn">üí™ ‰øùÂ≠ò„Åô„Çã</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÊúàÈñìÂàÜÊûê„É¢„Éº„ÉÄ„É´ -->
    <div id="monthlyAnalysisModal" class="modal-root">
        <div class="modal-backdrop" id="monthlyAnalysisBackdrop"></div>
        <div class="modal-panel" style="max-height:85vh;overflow-y:auto;">
            <div class="monthly-analysis-header">
                <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;">üìä ÊúàÈñì„Éà„É¨„Éº„Éã„É≥„Ç∞ÂàÜÊûê</div>
                <button id="closeMonthlyAnalysis" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
            </div>
            <div class="month-selector">
                <button class="month-selector-btn" id="prevMonthBtn">&lt;</button>
                <div class="current-month" id="currentMonthLabel"></div>
                <button class="month-selector-btn" id="nextMonthBtn">&gt;</button>
            </div>
            <div class="monthly-stats-summary" style="margin-top:16px;">
                <div class="monthly-stat-card"><div class="monthly-stat-value" id="monthlyTotalDays">0</div><div class="monthly-stat-label">Ë®òÈå≤Êó•Êï∞</div></div>
                <div class="monthly-stat-card"><div class="monthly-stat-value" id="monthlyAchievement">0%</div><div class="monthly-stat-label">Á∑èÂêàÈÅîÊàêÁéá</div></div>
                <div class="monthly-stat-card"><div class="monthly-stat-value" id="monthlyBestStreak">0</div><div class="monthly-stat-label">ÊúÄÈï∑ÈÄ£Á∂ö</div></div>
            </div>
            <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:14px;margin:16px 0 8px;">üìÖ Êó•Âà•ÈÅîÊàêÁä∂Ê≥Å</div>
            <div class="monthly-table-container">
                <table class="monthly-table">
                    <thead><tr><th>Êó•‰ªò</th><th>üåÖ</th><th>üéØ</th><th>üìö</th><th>üìù</th><th>üö´</th><th>üí™</th><th>ÈÅîÊàê</th></tr></thead>
                    <tbody id="monthlyTableBody"></tbody>
                </table>
            </div>
            <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:14px;margin:16px 0 8px;">üìà ÈÅîÊàêÁéá„ÅÆÊé®Áßª</div>
            <div class="monthly-chart-container"><canvas id="monthlyChart"></canvas></div>
        </div>
    </div>

    <!-- Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
    <div id="detailModal" class="modal-root">
        <div id="detailBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;" id="modalTitle">„Çø„Çπ„ÇØË©≥Á¥∞</div>
                <button id="detailCloseBtn" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
            </div>
            <div id="detailTaskTitle" style="font-size:14px;color:var(--text-secondary);margin:8px 0 16px;padding:10px;background:var(--bg-main);border-radius:10px;"></div>
            <div id="scoreGroup">
                <div class="slider-group"><div class="slider-label-row"><span>üéØ ÂÑ™ÂÖàÂ∫¶</span><span class="value" id="valPriority"></span></div><input id="inputPriority" type="range" min="0" max="10" step="1" style="width:100%" /></div>
                <div class="slider-group"><div class="slider-label-row"><span>üîÆ „Éì„Ç∏„Éß„É≥Èñ¢ÈÄ£Â∫¶</span><span class="value" id="valVision"></span></div><input id="inputVision" type="range" min="0" max="10" step="1" style="width:100%" /></div>
                <div class="slider-group"><div class="slider-label-row"><span>‚ú® „Çè„Åè„Çè„ÅèÂ∫¶</span><span class="value" id="valExcite"></span></div><input id="inputExcite" type="range" min="0" max="10" step="1" style="width:100%" /></div>
                <div class="slider-group"><div class="slider-label-row"><span>üí™ ÊàêÈï∑Â∫¶</span><span class="value" id="valGrowth"></span></div><input id="inputGrowth" type="range" min="0" max="10" step="1" style="width:100%" /></div>
            </div>
            <div id="remindGroup" class="slider-group">
                <div class="slider-label-row"><span>üîî „É™„Éû„Ç§„É≥„ÉâÊó•ÊôÇ</span><span class="value" id="valRemindAt"></span></div>
                <input id="inputRemindAt" type="datetime-local" style="width:100%;padding:12px;border:2px solid rgba(13,27,42,0.1);border-radius:12px;font-size:14px;" />
            </div>
            <div class="modal-footer">
                <button id="detailCancelBtn" class="btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
                <button id="detailSaveBtn" class="btn-primary-solid">üí™ ‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- MBTIÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="mbtiModal" class="modal-root">
        <div id="mbtiBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel" style="max-height:80vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;margin-bottom:10px;">
                <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;">üß† MBTI„Çø„Ç§„Éó„ÇíÈÅ∏Êäû</div>
                <button id="mbtiCloseBtn" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
            </div>
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">„ÅÇ„Å™„Åü„ÅÆÊÄßÊ†º„Çø„Ç§„Éó„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</div>
            <div class="mbti-grid" id="mbtiGrid">
                <div class="mbti-option" data-mbti="INTJ"><div class="mbti-option-type">INTJ</div><div class="mbti-option-name">Âª∫ÁØâÂÆ∂</div></div>
                <div class="mbti-option" data-mbti="INTP"><div class="mbti-option-type">INTP</div><div class="mbti-option-name">Ë´ñÁêÜÂ≠¶ËÄÖ</div></div>
                <div class="mbti-option" data-mbti="ENTJ"><div class="mbti-option-type">ENTJ</div><div class="mbti-option-name">ÊåáÊèÆÂÆò</div></div>
                <div class="mbti-option" data-mbti="ENTP"><div class="mbti-option-type">ENTP</div><div class="mbti-option-name">Ë®éË´ñËÄÖ</div></div>
                <div class="mbti-option" data-mbti="INFJ"><div class="mbti-option-type">INFJ</div><div class="mbti-option-name">ÊèêÂî±ËÄÖ</div></div>
                <div class="mbti-option" data-mbti="INFP"><div class="mbti-option-type">INFP</div><div class="mbti-option-name">‰ª≤‰ªãËÄÖ</div></div>
                <div class="mbti-option" data-mbti="ENFJ"><div class="mbti-option-type">ENFJ</div><div class="mbti-option-name">‰∏ª‰∫∫ÂÖ¨</div></div>
                <div class="mbti-option" data-mbti="ENFP"><div class="mbti-option-type">ENFP</div><div class="mbti-option-name">Â∫ÉÂ†±ÈÅãÂãïÂÆ∂</div></div>
                <div class="mbti-option" data-mbti="ISTJ"><div class="mbti-option-type">ISTJ</div><div class="mbti-option-name">ÁÆ°ÁêÜËÄÖ</div></div>
                <div class="mbti-option" data-mbti="ISFJ"><div class="mbti-option-type">ISFJ</div><div class="mbti-option-name">ÊìÅË≠∑ËÄÖ</div></div>
                <div class="mbti-option" data-mbti="ESTJ"><div class="mbti-option-type">ESTJ</div><div class="mbti-option-name">ÂππÈÉ®</div></div>
                <div class="mbti-option" data-mbti="ESFJ"><div class="mbti-option-type">ESFJ</div><div class="mbti-option-name">È†ò‰∫ãÂÆò</div></div>
                <div class="mbti-option" data-mbti="ISTP"><div class="mbti-option-type">ISTP</div><div class="mbti-option-name">Â∑®Âå†</div></div>
                <div class="mbti-option" data-mbti="ISFP"><div class="mbti-option-type">ISFP</div><div class="mbti-option-name">ÂÜíÈô∫ÂÆ∂</div></div>
                <div class="mbti-option" data-mbti="ESTP"><div class="mbti-option-type">ESTP</div><div class="mbti-option-name">Ëµ∑Ê•≠ÂÆ∂</div></div>
                <div class="mbti-option" data-mbti="ESFP"><div class="mbti-option-type">ESFP</div><div class="mbti-option-name">„Ç®„É≥„Çø„Éº„ÉÜ„Ç§„Éä„Éº</div></div>
            </div>
            <div class="modal-footer">
                <button id="mbtiClearBtn" class="btn-secondary">„ÇØ„É™„Ç¢</button>
                <button id="mbtiSaveBtn" class="btn-primary-solid">üí™ ‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- ÂÑ™ÂÖàÈ†Ü‰ΩçÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="priorityModal" class="modal-root">
        <div id="priorityBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;margin-bottom:10px;">
                <div style="font-family:'Noto Serif JP',serif;font-weight:700;font-size:18px;">‚ö° ÂÑ™ÂÖàÈ†Ü‰Ωç„ÇíË®≠ÂÆö</div>
                <button id="priorityCloseBtn" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>
            </div>
            <div id="priorityTaskTitle" style="font-size:14px;color:var(--text-secondary);margin-bottom:16px;"></div>
            <div class="priority-selector">
                <div class="priority-option critical" data-priority="critical">
                    <div class="priority-option-icon">üî•</div>
                    <div class="priority-option-text">
                        <div class="priority-option-title">ÊúÄÈáçË¶Å</div>
                        <div class="priority-option-desc">‰ªä„Åô„ÅêÂèñ„ÇäÁµÑ„ÇÄ„Åπ„ÅçÊúÄÂÑ™ÂÖà„Çø„Çπ„ÇØ</div>
                    </div>
                </div>
                <div class="priority-option high" data-priority="high">
                    <div class="priority-option-icon">‚ö°</div>
                    <div class="priority-option-text">
                        <div class="priority-option-title">ÈáçË¶Å</div>
                        <div class="priority-option-desc">ÂÑ™ÂÖàÁöÑ„Å´Âá¶ÁêÜ„Åô„Åπ„Åç„Çø„Çπ„ÇØ</div>
                    </div>
                </div>
                <div class="priority-option normal" data-priority="normal">
                    <div class="priority-option-icon">üìå</div>
                    <div class="priority-option-text">
                        <div class="priority-option-title">„Éé„Éº„Éû„É´</div>
                        <div class="priority-option-desc">ÈÄöÂ∏∏„ÅÆÂÑ™ÂÖàÂ∫¶„Å´Êàª„Åô</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008372898-2q9qWmxv";
        const API_BASE = "https://lumicreate.xvps.jp/webhook";

        let userId = null;
        let currentDetailTask = null;
        let currentPriorityTask = null;
        let modalMode = "detail";

        const HABITS = [
            { id: 'early_wake', name: 'Êó©Ëµ∑„Åç', icon: 'üåÖ' },
            { id: 'mission', name: '„Éü„ÉÉ„Ç∑„Éß„É≥', icon: 'üéØ' },
            { id: 'reading', name: 'Ë™≠Êõ∏/Â≠¶Áøí', icon: 'üìö' },
            { id: 'journal', name: '„Ç∏„É£„Éº„Éä„É´', icon: 'üìù' },
            { id: 'no_alcohol', name: 'Á¶ÅÈÖí', icon: 'üö´' },
            { id: 'workout', name: '‰ªäÊó•„Éà„É¨', icon: 'üí™' }
        ];

        let todayHabits = {};
        let weekHabitsData = {};
        let currentMission = null;
        let missionCompletedToday = false;
        let selectedMonth = new Date();
        let monthlyChart = null;
        let currentEditJournal = null;
        let journalsData = [];
        let journalsGrouped = [];
        let openMonthKey = null;

        // MSCÈñ¢ÈÄ£
        let mscRadarChart = null;
        let userMbti = null;
        let selectedMbti = null;
        let mscData = {
            level: 1,
            exp: 0,
            totalExp: 1000,
            score: 0,
            radarData: { discipline: 0, purpose: 0, curiosity: 0, reflection: 0, action: 0, consistency: 0 },
            strengths: [],
            weaknesses: [],
            bio: ''
        };

        const MBTI_NAMES = {
            'INTJ': 'Âª∫ÁØâÂÆ∂', 'INTP': 'Ë´ñÁêÜÂ≠¶ËÄÖ', 'ENTJ': 'ÊåáÊèÆÂÆò', 'ENTP': 'Ë®éË´ñËÄÖ',
            'INFJ': 'ÊèêÂî±ËÄÖ', 'INFP': '‰ª≤‰ªãËÄÖ', 'ENFJ': '‰∏ª‰∫∫ÂÖ¨', 'ENFP': 'Â∫ÉÂ†±ÈÅãÂãïÂÆ∂',
            'ISTJ': 'ÁÆ°ÁêÜËÄÖ', 'ISFJ': 'ÊìÅË≠∑ËÄÖ', 'ESTJ': 'ÂππÈÉ®', 'ESFJ': 'È†ò‰∫ãÂÆò',
            'ISTP': 'Â∑®Âå†', 'ISFP': 'ÂÜíÈô∫ÂÆ∂', 'ESTP': 'Ëµ∑Ê•≠ÂÆ∂', 'ESFP': '„Ç®„É≥„Çø„Éº„ÉÜ„Ç§„Éä„Éº'
        };

        const LEVEL_TITLES = [
            { min: 1, max: 5, title: 'Ë¶ãÁøí„ÅÑ„Éà„É¨„Éº„Éã„Éº' },
            { min: 6, max: 10, title: '„É´„Éº„Ç≠„Éº„Éï„Ç°„Ç§„Çø„Éº' },
            { min: 11, max: 20, title: '„É¨„ÇÆ„É•„É©„Éº„Ç¶„Ç©„É™„Ç¢„Éº' },
            { min: 21, max: 35, title: '„Ç∑„É´„Éê„Éº„ÉÅ„É£„É≥„Éî„Ç™„É≥' },
            { min: 36, max: 50, title: '„Ç¥„Éº„É´„Éâ„Éû„Çπ„Çø„Éº' },
            { min: 51, max: 75, title: '„Éó„É©„ÉÅ„Éä„Ç®„É™„Éº„Éà' },
            { min: 76, max: 100, title: '„ÉÄ„Ç§„É§„É¢„É≥„Éâ„É¨„Ç∏„Çß„É≥„Éâ' },
            { min: 101, max: 999, title: '„É†„Ç≠„É†„Ç≠Á•û' }
        ];

        const STRONG_RATIO = 0.85;
        const SNAP_THRESHOLD = 40;
        let isDraggingCard = false;

        const criticalEl = document.getElementById("critical");
        const highEl = document.getElementById("high");
        const activeEl = document.getElementById("active");
        const completedEl = document.getElementById("completed");

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                userId = profile.userId;
            } catch (e) {
                console.error("LIFFÂàùÊúüÂåñ„Ç®„É©„Éº:", e);
                userId = "demo_user";
            }
            bindUI();
            await loadAllData();
        }

        function bindUI() {
            document.querySelectorAll('.tab-nav-item').forEach(item => {
                item.addEventListener('click', () => switchTab(item.dataset.tab));
            });
            document.getElementById('refreshBtn').onclick = loadList;
            document.getElementById('btnAdd').onclick = addTask;
            document.getElementById('newTitle').addEventListener('keypress', e => { if (e.key === 'Enter') addTask(); });
            document.getElementById('statusRefreshBtn').onclick = loadHabits;
            document.getElementById('dailyTaskCard').addEventListener('click', e => {
                if (!e.target.closest('.habit-checkbox') && !e.target.closest('.daily-btn')) {
                    document.getElementById('dailyTaskCard').classList.toggle('expanded');
                }
            });
            document.getElementById('habitSaveBtn').onclick = saveHabits;
            document.getElementById('habitCancelBtn').onclick = () => document.getElementById('dailyTaskCard').classList.remove('expanded');
            renderHabitList();
            document.getElementById('journalRefreshBtn').onclick = loadJournals;
            document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('journalSubmitBtn').onclick = saveJournal;
            bindModalUI();
            bindMonthlyAnalysisUI();
            bindJournalDetailModalUI();
            bindPriorityModalUI();
            bindMscUI();
            bindMbtiModalUI();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-nav-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab-nav-item[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        async function loadAllData() {
            await Promise.all([loadList(), loadMissionTask(), loadHabits(), loadJournals(), loadMscData()]);
        }

        // „Éü„ÉÉ„Ç∑„Éß„É≥„Çø„Çπ„ÇØ
        function getNextSunday() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysUntilSunday = (7 - dayOfWeek) % 7 || 7;
            const nextSunday = new Date(today);
            nextSunday.setDate(today.getDate() + daysUntilSunday);
            nextSunday.setHours(23, 59, 59);
            return nextSunday.toISOString();
        }

        async function loadMissionTask() {
            // „Éá„É¢„Éá„Éº„ÇøÔºàAPI„Åå„Å™„ÅÑÂ†¥Âêà„Å´‰ΩøÁî®Ôºâ
            const demoData = {
                mission: {
                    id: 'demo',
                    title: '‰ªäÈÄ±„ÅÆÈôêÁïåÁ™ÅÁ†¥„Éü„ÉÉ„Ç∑„Éß„É≥',
                    description: 'ÊØéÊó•10ÂàÜÈñì„ÅÆÁûëÊÉ≥„ÅßÂøÉ„ÇíÈçõ„Åà„ÄÅÂÜÖ„Å™„ÇãÁÇé„ÇíÁáÉ„ÇÑ„Åõ',
                    expires_at: getNextSunday()
                },
                completed_today: false,
                today_completions: 42
            };

            try {
                const res = await fetch(`${API_BASE}/mission?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                currentMission = data.mission || null;
                missionCompletedToday = data.completed_today || false;
                renderMissionTask(data);
            } catch (e) {
                console.log('Mission API unavailable, showing demo mission');
                currentMission = demoData.mission;
                missionCompletedToday = demoData.completed_today;
                renderMissionTask(demoData);
            }
        }

        function renderMissionTask(data) {
            const container = document.getElementById('missionTaskContainer');
            if (!data.mission) { container.innerHTML = ''; return; }
            const mission = data.mission;
            const completedToday = data.completed_today;
            const todayCount = data.today_completions || 0;
            const daysLeft = Math.ceil((new Date(mission.expires_at) - new Date()) / (1000 * 60 * 60 * 24));

            container.innerHTML = `
                <div class="mission-task-wrapper">
                    <div class="mission-achievement-bubble">üî• ${todayCount}‰∫∫„ÅåÈÅîÊàê</div>
                    <div class="mission-task-card ${completedToday ? 'completed' : ''}" id="missionCard">
                        <div class="mission-peel-back"></div>
                        <img class="mission-completed-stamp" src="../ÁîªÂÉè/„Éü„ÉÉ„Ç∑„Éß„É≥„Çø„Çπ„ÇØ_COMPLETED„Éè„É≥„Ç≥.png" alt="COMPLETED" />
                        <div class="mission-task-header">
                            <div class="mission-task-badge"><span>üéØ</span><span>WEEKLY MISSION</span></div>
                        </div>
                        <div class="mission-task-title">${mission.title || '‰ªäÈÄ±„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥'}</div>
                        <div class="mission-task-desc">${mission.description || ''}</div>
                        <div class="mission-task-actions">
                            <div class="mission-expire">ÊÆã„Çä${daysLeft > 0 ? daysLeft : 0}Êó•</div>
                        </div>
                        ${!completedToday ? '<div class="mission-swipe-hint">„Çπ„ÉØ„Ç§„Éó„ÅßÈÅîÊàê</div>' : ''}
                    </div>
                </div>`;

            // ÂÆå‰∫ÜÊ∏à„Åø„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„Çπ„ÉØ„Ç§„ÉóÂá¶ÁêÜ„ÇíË®≠ÂÆö
            if (!completedToday) {
                setupMissionSwipe(mission.id);
            }
        }

        function setupMissionSwipe(missionId) {
            const card = document.getElementById('missionCard');
            if (!card) return;

            const peelBack = card.querySelector('.mission-peel-back');
            let startX = 0, currentX = 0, dx = 0;
            let isSwiping = false;
            const COMPLETE_THRESHOLD = 150; // „Åì„ÅÆË∑ùÈõ¢„ÇíË∂Ö„Åà„Åü„ÇâÂÆå‰∫Ü

            const updatePeelEffect = (swipeDistance) => {
                // „Çπ„ÉØ„Ç§„ÉóË∑ùÈõ¢„Å´Âøú„Åò„Å¶„ÇÅ„Åè„Çå„Ç®„Éï„Çß„ÇØ„Éà„ÇíÊõ¥Êñ∞
                const peelWidth = Math.min(Math.max(swipeDistance * 0.8, 0), 200);
                const shadowWidth = Math.min(Math.max(swipeDistance * 0.4, 0), 80);

                // Ë£èÈù¢„ÅÆÂπÖ„ÇíË™øÊï¥
                peelBack.style.width = `${peelWidth}px`;
                peelBack.style.transition = 'none';

                // ÂΩ±„ÅÆÂπÖ„ÇíCSSÂ§âÊï∞„ÅßË™øÊï¥
                card.style.setProperty('--peel-shadow', `${shadowWidth}px`);

                // „Ç´„Éº„Éâ„Å´ËªΩ„ÅÑÂÇæ„Åç„ÇíËøΩÂä†
                const rotateY = Math.min(swipeDistance * 0.03, 8);
                const rotateZ = Math.min(swipeDistance * 0.01, 2);
                card.style.transform = `perspective(1000px) rotateY(${rotateY}deg) rotateZ(${rotateZ}deg)`;
                card.style.transition = 'none';

                // „Åó„Åç„ÅÑÂÄ§„ÇíË∂Ö„Åà„Åü„Çâ„Ç´„Éº„Éâ„Å´peeling„ÇØ„É©„Çπ„ÇíËøΩÂä†
                if (swipeDistance > 30) {
                    card.classList.add('peeling');
                } else {
                    card.classList.remove('peeling');
                }
            };

            const resetPeelEffect = () => {
                peelBack.style.transition = 'width 0.3s ease-out';
                peelBack.style.width = '0';
                card.style.transition = 'transform 0.3s ease-out';
                card.style.transform = '';
                card.classList.remove('peeling');
            };

            const completeMissionWithAnimation = async () => {
                // „ÇÅ„Åè„ÇäÂÆå‰∫Ü„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                peelBack.style.transition = 'width 0.4s ease-out';
                peelBack.style.width = '100%';
                card.style.transition = 'transform 0.4s ease-out';
                card.style.transform = 'perspective(1000px) rotateY(15deg) rotateZ(3deg)';

                // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„Çπ„Çø„É≥„ÉóË°®Á§∫„Å®ÂÆå‰∫ÜÂá¶ÁêÜ
                setTimeout(async () => {
                    card.classList.add('completed');
                    card.classList.remove('peeling');

                    // „Çπ„ÉØ„Ç§„Éó„Éí„É≥„Éà„ÇíÂâäÈô§
                    const hint = card.querySelector('.mission-swipe-hint');
                    if (hint) hint.remove();

                    // „Ç´„Éº„Éâ„ÇíÂÖÉ„Å´Êàª„Åô
                    setTimeout(() => {
                        peelBack.style.width = '0';
                        card.style.transform = '';
                    }, 300);

                    await completeMission(missionId);
                }, 400);
            };

            // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà
            card.addEventListener('touchstart', (e) => {
                if (card.classList.contains('completed')) return;
                startX = e.touches[0].clientX;
                currentX = startX;
                isSwiping = true;
            }, { passive: true });

            card.addEventListener('touchmove', (e) => {
                if (!isSwiping || card.classList.contains('completed')) return;
                currentX = e.touches[0].clientX;
                dx = startX - currentX; // Â∑¶„Çπ„ÉØ„Ç§„Éó„Å™„ÅÆ„ÅßÊ≠£„ÅÆÂÄ§

                if (dx > 10) {
                    e.preventDefault(); // „Çπ„ÇØ„É≠„Éº„É´„ÇíÈò≤Ê≠¢
                    updatePeelEffect(dx);
                }
            }, { passive: false });

            card.addEventListener('touchend', async () => {
                if (!isSwiping || card.classList.contains('completed')) return;
                isSwiping = false;

                if (dx >= COMPLETE_THRESHOLD) {
                    await completeMissionWithAnimation();
                } else {
                    resetPeelEffect();
                }
                dx = 0;
            });

            // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„ÉàÔºàPCÂØæÂøúÔºâ
            let isMouseDown = false;

            card.addEventListener('mousedown', (e) => {
                if (card.classList.contains('completed')) return;
                startX = e.clientX;
                currentX = startX;
                isMouseDown = true;
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isMouseDown || card.classList.contains('completed')) return;
                currentX = e.clientX;
                dx = startX - currentX;

                if (dx > 10) {
                    updatePeelEffect(dx);
                }
            });

            document.addEventListener('mouseup', async () => {
                if (!isMouseDown || card.classList.contains('completed')) return;
                isMouseDown = false;

                if (dx >= COMPLETE_THRESHOLD) {
                    await completeMissionWithAnimation();
                } else {
                    resetPeelEffect();
                }
                dx = 0;
            });
        }

        async function completeMission(missionId) {
            const updateUI = () => {
                missionCompletedToday = true;
                const btn = document.getElementById('missionCompleteBtn');
                if (btn) {
                    btn.classList.add('completed');
                    btn.textContent = '‚úì COMPLETED';
                }
            };

            try {
                const res = await fetch(`${API_BASE}/mission/complete`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, mission_id: missionId })
                });
                if (res.ok) {
                    missionCompletedToday = true;
                    await loadMissionTask();
                } else {
                    updateUI();
                }
            } catch (e) {
                console.log('Mission complete - demo mode');
                updateUI();
            }
        }

        // „É™„Çπ„Éà
        async function loadList() {
            try {
                const res = await fetch(`${API_BASE}/list?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('API Error');
                renderList(await res.json());
            } catch (e) {
                renderList({ critical: [], high: [], active: [], completed: [] });
            }
        }

        function renderList(payload) {
            criticalEl.innerHTML = "";
            highEl.innerHTML = "";
            activeEl.innerHTML = "";
            completedEl.innerHTML = "";

            const critical = Array.isArray(payload.critical) ? payload.critical : [];
            const high = Array.isArray(payload.high) ? payload.high : [];
            const active = Array.isArray(payload.active) ? payload.active : [];
            const completed = Array.isArray(payload.completed) ? payload.completed : [];

            critical.forEach(t => { t.priority_level = 'critical'; criticalEl.appendChild(taskCard(t, false)); });
            high.forEach(t => { t.priority_level = 'high'; highEl.appendChild(taskCard(t, false)); });
            active.forEach(t => { t.priority_level = t.priority_level || 'normal'; activeEl.appendChild(taskCard(t, false)); });
            completed.forEach(t => completedEl.appendChild(taskCard(t, true)));
        }

        async function addTask() {
            const input = document.getElementById('newTitle');
            const title = input.value.trim();
            if (!title) return;
            await action("create", null, { task_name: title });
            input.value = "";
        }

        function taskCard(t, isCompleted = false) {
            const wrap = document.createElement("div");
            wrap.className = "card";
            const priorityLevel = t.priority_level || 'normal';
            wrap.classList.add(`priority-${priorityLevel}`);
            if (isCompleted) wrap.classList.add("completed");

            const rail = document.createElement("div");
            rail.className = "actions-rail";

            const left = document.createElement("div");
            left.className = "actions-left";
            if (!isCompleted) {
                left.append(mkBtn("ÂÆå‰∫Ü", () => action("complete", t.id), "btn-complete"), mkBtn("ÈÄöÁü•", () => openRemind(t), "btn-plus2h"));
            } else {
                left.append(mkBtn("Êú™ÂÆå", () => action("uncomplete", t.id), "btn-complete"));
            }

            const right = document.createElement("div");
            right.className = "actions-right";
            right.append(
                mkBtn("Ë©≥Á¥∞", () => openDetail(t), "btn-detail"),
                mkBtn("ÂÑ™ÂÖà", () => openPriorityModal(t), "btn-priority"),
                mkBtn("ÂâäÈô§", () => action("delete", t.id), "btn-delete")
            );

            rail.append(left, right);

            const sl = document.createElement("div");
            sl.className = "sl";

            const leftBox = document.createElement("div");
            leftBox.style.cssText = "display:flex;align-items:center;gap:8px;flex:1;";

            if (priorityLevel === 'critical') {
                const badge = document.createElement("span");
                badge.className = "priority-badge";
                badge.textContent = "ÊúÄÈáçË¶Å";
                leftBox.appendChild(badge);
            } else if (priorityLevel === 'high') {
                const badge = document.createElement("span");
                badge.className = "priority-badge";
                badge.textContent = "ÈáçË¶Å";
                leftBox.appendChild(badge);
            }

            const titleEl = document.createElement("div");
            titleEl.className = "title";
            titleEl.textContent = t.task_name || t.title || "(ÁÑ°È°å)";
            leftBox.appendChild(titleEl);

            const rightBox = document.createElement("div");
            rightBox.style.cssText = "display:flex;align-items:center;";

            if (t.remind_at) {
                const remindEl = document.createElement("div");
                remindEl.className = "remindAt";
                remindEl.textContent = formatRemindLabel(t.remind_at);
                rightBox.appendChild(remindEl);
            }

            const handle = document.createElement("div");
            handle.className = "handle";
            handle.textContent = "‚ò∞";
            rightBox.appendChild(handle);

            sl.append(leftBox, rightBox);
            wrap.append(rail, sl);

            requestAnimationFrame(() => {
                wrap.dataset.leftWidth = left.getBoundingClientRect().width || 140;
                wrap.dataset.rightWidth = right.getBoundingClientRect().width || 140;
            });

            // PCÁâà„ÇØ„É™„ÉÉ„ÇØ
            if (!/Mobi|Android/i.test(navigator.userAgent)) {
                sl.addEventListener("click", e => {
                    const rect = sl.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const leftW = Number(wrap.dataset.leftWidth) || 140;
                    const rightW = Number(wrap.dataset.rightWidth) || 140;
                    if (wrap.classList.contains("open-left") || wrap.classList.contains("open-right")) {
                        wrap.classList.remove("open-left", "open-right");
                        sl.style.transform = "translateX(0)";
                        return;
                    }
                    if (x < rect.width / 2) { wrap.classList.add("open-left"); sl.style.transform = `translateX(${leftW}px)`; }
                    else { wrap.classList.add("open-right"); sl.style.transform = `translateX(${-rightW}px)`; }
                });
            }

            // „Çπ„Éû„Éõ„Çπ„ÉØ„Ç§„ÉóÔºà‰∏ä‰∏ã„Çπ„ÇØ„É≠„Éº„É´ÂÑ™ÂÖàÔºâ
            let startX = 0, startY = 0, dx = 0, dy = 0, isScrolling = null, isHandleDrag = false;
            const SCROLL_THRESHOLD = 10; // „Çπ„ÇØ„É≠„Éº„É´Âà§ÂÆö„ÅÆÈñæÂÄ§

            wrap.addEventListener("touchstart", e => {
                if (isDraggingCard || e.target.closest("button")) return;
                if (e.target.closest(".handle")) { isHandleDrag = true; return; }
                isHandleDrag = false;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                dx = 0; dy = 0; isScrolling = null;
                sl.style.transition = "none";
            }, { passive: true });

            wrap.addEventListener("touchmove", e => {
                if (isDraggingCard || isHandleDrag || !e.touches.length) return;
                dy = e.touches[0].clientY - startY;
                dx = e.touches[0].clientX - startX;
                // ‰∏ä‰∏ãÁßªÂãï„ÅåÊ®™ÁßªÂãï„Çà„ÇäÂ§ß„Åç„ÅÑÂ†¥Âêà„ÅØ„Çπ„ÇØ„É≠„Éº„É´„Å®„Åó„Å¶Âà§ÂÆö
                if (isScrolling === null && (Math.abs(dx) > SCROLL_THRESHOLD || Math.abs(dy) > SCROLL_THRESHOLD)) {
                    isScrolling = Math.abs(dy) > Math.abs(dx);
                }
                // ‰∏ä‰∏ã„Çπ„ÇØ„É≠„Éº„É´„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà„Éñ„É©„Ç¶„Ç∂„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„Å´‰ªª„Åõ„ÇãÔºâ
                if (isScrolling) {
                    sl.style.transform = "translateX(0)";
                    return;
                }
                // Ê®™„Çπ„ÉØ„Ç§„Éó„ÅÆÂ†¥Âêà„ÅÆ„ÅøpreventDefault„Åß„Çπ„ÇØ„É≠„Éº„É´„ÇíÊ≠¢„ÇÅ„Çã
                if (Math.abs(dx) > SCROLL_THRESHOLD) e.preventDefault();
                sl.style.transform = `translateX(${dx}px)`;
            }, { passive: false });

            wrap.addEventListener("touchend", () => {
                if (isDraggingCard) return;
                if (isHandleDrag || isScrolling) { isHandleDrag = false; sl.style.transition = ""; sl.style.transform = "translateX(0)"; return; }
                sl.style.transition = "transform .15s";
                const leftW = Number(wrap.dataset.leftWidth) || 140;
                const rightW = Number(wrap.dataset.rightWidth) || 140;
                if (dx > leftW * STRONG_RATIO) { isCompleted ? action("uncomplete", t.id) : action("complete", t.id); wrap.classList.remove("open-left", "open-right"); sl.style.transform = "translateX(0)"; return; }
                if (dx < -rightW * STRONG_RATIO) { action("delete", t.id); wrap.classList.remove("open-left", "open-right"); sl.style.transform = "translateX(0)"; return; }
                if (dx > SNAP_THRESHOLD) { wrap.classList.add("open-left"); wrap.classList.remove("open-right"); sl.style.transform = `translateX(${leftW}px)`; }
                else if (dx < -SNAP_THRESHOLD) { wrap.classList.add("open-right"); wrap.classList.remove("open-left"); sl.style.transform = `translateX(${-rightW}px)`; }
                else { wrap.classList.remove("open-left", "open-right"); sl.style.transform = "translateX(0)"; }
            });

            // „Éâ„É©„ÉÉ„Ç∞Ôºà‰∏¶„Å≥Êõø„ÅàÔºâ- È´òÈÄüÁâà
            const startDrag = (startEvent) => {
                startEvent.preventDefault();
                startEvent.stopPropagation();
                const card = wrap, list = card.parentElement;
                if (!list) return;
                isDraggingCard = true;
                card.classList.remove("open-left", "open-right");
                sl.style.transition = "none"; sl.style.transform = "translateX(0)";

                const cardRect = card.getBoundingClientRect();
                const dragStartY = startEvent.clientY || (startEvent.touches && startEvent.touches[0].clientY);
                const cardStartTop = cardRect.top, cardHeight = cardRect.height, cardWidth = cardRect.width;

                // „Éâ„É©„ÉÉ„Ç∞Áî®„ÅÆ„ÇØ„É≠„Éº„É≥„Çí‰ΩúÊàêÔºàÂÖÉ„Ç´„Éº„Éâ„ÅØÈùûË°®Á§∫„Å´„Åó„Å™„ÅÑÔºâ
                const dragClone = card.cloneNode(true);
                dragClone.style.cssText = `position:fixed;left:${cardRect.left}px;top:${cardRect.top}px;width:${cardWidth}px;height:${cardHeight}px;pointer-events:none;z-index:1000;opacity:0.95;box-shadow:0 8px 20px rgba(0,0,0,0.3);transition:none;`;
                dragClone.classList.add("dragging");
                document.body.appendChild(dragClone);

                // ÂÖÉ„Ç´„Éº„Éâ„ÇíÈÄèÊòé„Å´„Åó„Å¶„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Å®„Åó„Å¶‰ΩøÁî®
                card.style.opacity = "0.3";
                card.style.transition = "none";
                document.body.style.userSelect = "none";

                let currentY = dragStartY;

                const getY = ev => ev.touches?.length ? ev.touches[0].clientY : ev.clientY;

                const updatePosition = (y) => {
                    const deltaY = y - dragStartY;
                    // Áõ¥Êé•DOM„ÇíÊõ¥Êñ∞ÔºàRAF„Çí‰Ωø„Çè„ÅöÂç≥Â∫ß„Å´ÂèçÊò†Ôºâ
                    dragClone.style.top = (cardStartTop + deltaY) + "px";

                    const cloneCenterY = cardStartTop + deltaY + cardHeight / 2;
                    const siblings = Array.from(list.querySelectorAll(".card"));

                    for (const sibling of siblings) {
                        if (sibling === card) continue;
                        const siblingRect = sibling.getBoundingClientRect();
                        if (cloneCenterY < siblingRect.top + siblingRect.height / 2) {
                            if (card.nextSibling !== sibling) list.insertBefore(card, sibling);
                            return;
                        }
                    }
                    // ÊúÄÂæå„Å´ÁßªÂãï
                    if (list.lastElementChild !== card) list.appendChild(card);
                };

                const onMove = ev => {
                    ev.preventDefault();
                    currentY = getY(ev);
                    updatePosition(currentY);
                };

                const onUp = () => {
                    document.removeEventListener("pointermove", onMove);
                    document.removeEventListener("pointerup", onUp);
                    document.removeEventListener("touchmove", onMove);
                    document.removeEventListener("touchend", onUp);

                    // „ÇØ„É≠„Éº„É≥„ÇíÂâäÈô§
                    dragClone.remove();

                    // ÂÖÉ„Ç´„Éº„Éâ„ÇíÂæ©ÂÖÉ
                    card.style.opacity = "";
                    card.style.transition = "";
                    card.classList.remove("open-left", "open-right");
                    const slEl = card.querySelector(".sl");
                    if (slEl) { slEl.style.transition = ""; slEl.style.transform = "translateX(0)"; }

                    document.body.style.userSelect = "";
                    setTimeout(() => isDraggingCard = false, 50);
                    saveSortOrder();
                };

                document.addEventListener("pointermove", onMove, { passive: false });
                document.addEventListener("pointerup", onUp);
                document.addEventListener("touchmove", onMove, { passive: false });
                document.addEventListener("touchend", onUp);
            };
            handle.addEventListener("pointerdown", e => { e.preventDefault(); startDrag(e); });
            handle.addEventListener("touchstart", e => { e.preventDefault(); e.stopPropagation(); startDrag(e); }, { passive: false });

            wrap.__taskData = t;
            wrap.dataset.taskId = t.id;
            return wrap;
        }

        async function saveSortOrder() {
            if (!userId) return;
            const orders = [];
            [criticalEl, highEl, activeEl, completedEl].forEach((listEl, idx) => {
                const section = ['critical', 'high', 'active', 'completed'][idx];
                listEl.querySelectorAll('.card').forEach((card, index) => {
                    const t = card.__taskData;
                    if (t) orders.push({ id: t.id, sort_order: index, section });
                });
            });
            if (orders.length) await action("sort_update", null, { orders });
        }

        // ÂÑ™ÂÖàÈ†Ü‰Ωç„É¢„Éº„ÉÄ„É´
        function bindPriorityModalUI() {
            const modal = document.getElementById('priorityModal');
            const close = () => { modal.classList.remove('visible'); currentPriorityTask = null; };
            document.getElementById('priorityBackdrop').onclick = close;
            document.getElementById('priorityCloseBtn').onclick = close;
            document.querySelectorAll('.priority-option').forEach(opt => {
                opt.addEventListener('click', async () => {
                    if (!currentPriorityTask) return;
                    const priority = opt.dataset.priority;
                    await action("set_priority", currentPriorityTask.id, { priority_level: priority });
                    close();
                });
            });
        }

        function openPriorityModal(t) {
            currentPriorityTask = t;
            document.getElementById('priorityTaskTitle').textContent = t.task_name || t.title || "(ÁÑ°È°å)";
            document.getElementById('priorityModal').classList.add('visible');
        }

        // „Çπ„ÉÜ„Éº„Çø„Çπ
        function renderHabitList() {
            const container = document.getElementById('habitList');
            container.innerHTML = HABITS.map(h => `<div class="habit-item" data-habit="${h.id}"><div class="habit-checkbox" data-habit="${h.id}"></div><span class="habit-name">${h.name}</span><span class="habit-icon">${h.icon}</span></div>`).join('');
            container.querySelectorAll('.habit-item').forEach(item => {
                item.addEventListener('click', e => {
                    e.stopPropagation();
                    const id = item.dataset.habit, cb = item.querySelector('.habit-checkbox');
                    todayHabits[id] = !todayHabits[id];
                    cb.classList.toggle('checked', todayHabits[id]);
                    cb.textContent = todayHabits[id] ? '‚úì' : '';
                    item.classList.toggle('checked', todayHabits[id]);
                });
            });
        }

        async function loadHabits() {
            try {
                const res = await fetch(`${API_BASE}/habits?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error();
                const data = await res.json();
                weekHabitsData = data.week || {};
                todayHabits = data.today || {};
                renderWeekView();
                renderHabitAnalysis(data);
                updateHabitCheckboxes();
            } catch (e) {
                renderWeekView();
                renderHabitAnalysis({ week_progress: 0 });
            }
        }

        function updateHabitCheckboxes() {
            document.querySelectorAll('.habit-item').forEach(item => {
                const id = item.dataset.habit, cb = item.querySelector('.habit-checkbox'), isChecked = !!todayHabits[id];
                cb.classList.toggle('checked', isChecked);
                cb.textContent = isChecked ? '‚úì' : '';
                item.classList.toggle('checked', isChecked);
            });
        }

        function renderWeekView() {
            const tbody = document.getElementById('weekTableBody');
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            tbody.innerHTML = HABITS.map(h => `<tr><td>${h.icon} ${h.name}</td>${days.map(d => `<td class="${weekHabitsData[d]?.[h.id] ? 'checked' : 'unchecked'}">${weekHabitsData[d]?.[h.id] ? '‚óè' : '‚óã'}</td>`).join('')}</tr>`).join('');
        }

        function renderHabitAnalysis(data) {
            const progress = data.week_progress || 0;
            document.getElementById('weekProgressValue').textContent = `${progress}%`;
            document.getElementById('weekProgressBar').style.width = `${progress}%`;
        }

        async function saveHabits() {
            try {
                await fetch(`${API_BASE}/habits/save`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: userId, date: new Date().toISOString().split('T')[0], habits: todayHabits }) });
                document.getElementById('dailyTaskCard').classList.remove('expanded');
                await loadHabits();
                alert('üí™ Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
            } catch (e) { alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'); }
        }

        // ÊúàÈñìÂàÜÊûê
        function bindMonthlyAnalysisUI() {
            const modal = document.getElementById('monthlyAnalysisModal');
            const close = () => modal.classList.remove('visible');
            document.getElementById('openMonthlyAnalysis').onclick = () => { selectedMonth = new Date(); modal.classList.add('visible'); loadMonthlyData(); };
            document.getElementById('monthlyAnalysisBackdrop').onclick = close;
            document.getElementById('closeMonthlyAnalysis').onclick = close;
            document.getElementById('prevMonthBtn').onclick = () => { selectedMonth.setMonth(selectedMonth.getMonth() - 1); loadMonthlyData(); };
            document.getElementById('nextMonthBtn').onclick = () => {
                const now = new Date();
                if (selectedMonth.getFullYear() < now.getFullYear() || (selectedMonth.getFullYear() === now.getFullYear() && selectedMonth.getMonth() < now.getMonth())) {
                    selectedMonth.setMonth(selectedMonth.getMonth() + 1);
                    loadMonthlyData();
                }
            };
        }

        async function loadMonthlyData() {
            const year = selectedMonth.getFullYear(), month = selectedMonth.getMonth() + 1;
            document.getElementById('currentMonthLabel').textContent = `${year}Âπ¥${month}Êúà`;
            try {
                const res = await fetch(`${API_BASE}/habits/monthly?user_id=${encodeURIComponent(userId)}&year=${year}&month=${month}`);
                if (!res.ok) throw new Error();
                renderMonthlyAnalysis(await res.json());
            } catch (e) {
                renderMonthlyAnalysis({ days: {} });
            }
        }

        function renderMonthlyAnalysis(data) {
            const days = data.days || {}, year = selectedMonth.getFullYear(), month = selectedMonth.getMonth() + 1;
            const daysInMonth = new Date(year, month, 0).getDate();
            let totalChecks = 0, totalPossible = 0, currentStreak = 0, bestStreak = 0;
            const dailyRates = [];
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`, dayData = days[dateStr];
                if (dayData && Object.keys(dayData).length > 0) {
                    const checked = Object.values(dayData).filter(v => v).length;
                    totalChecks += checked; totalPossible += 6; currentStreak++;
                    bestStreak = Math.max(bestStreak, currentStreak);
                    dailyRates.push({ day: d, rate: Math.round((checked / 6) * 100) });
                } else { currentStreak = 0; dailyRates.push({ day: d, rate: 0 }); }
            }
            document.getElementById('monthlyTotalDays').textContent = Object.keys(days).filter(k => Object.values(days[k] || {}).some(v => v)).length;
            document.getElementById('monthlyAchievement').textContent = `${totalPossible ? Math.round((totalChecks / totalPossible) * 100) : 0}%`;
            document.getElementById('monthlyBestStreak').textContent = bestStreak;

            const tbody = document.getElementById('monthlyTableBody');
            tbody.innerHTML = Array.from({ length: daysInMonth }, (_, i) => {
                const d = i + 1, dateStr = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayData = days[dateStr], dow = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'][new Date(dateStr).getDay()];
                const cells = HABITS.map(h => `<td class="${dayData?.[h.id] ? 'cell-check' : 'cell-uncheck'}">${dayData?.[h.id] ? '‚óè' : '‚óã'}</td>`).join('');
                const dayChecked = dayData ? Object.values(dayData).filter(v => v).length : 0;
                return `<tr><td>${month}/${d}(${dow})</td>${cells}<td>${dayChecked}/6</td></tr>`;
            }).join('');

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            if (monthlyChart) monthlyChart.destroy();
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: { labels: dailyRates.map(d => `${d.day}Êó•`), datasets: [{ label: 'ÈÅîÊàêÁéá', data: dailyRates.map(d => d.rate), borderColor: '#ff9f43', backgroundColor: 'rgba(255,159,67,0.15)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#ff9f43' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { stepSize: 25, callback: v => `${v}%` } }, x: { ticks: { maxTicksLimit: 10 } } }, plugins: { legend: { display: false } } }
            });
        }

        // „Ç∏„É£„Éº„Éä„É´
        async function loadJournals() {
            try {
                const res = await fetch(`${API_BASE}/journals?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error();
                const data = await res.json();
                journalsData = data.journals || [];
                journalsGrouped = data.grouped || [];
            } catch (e) {
                journalsData = [];
                journalsGrouped = [];
            }
            renderJournals();
        }

        function renderJournals() {
            const container = document.getElementById('journalList');
            if (!journalsGrouped.length) {
                container.innerHTML = '<div class="empty-state">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            // ‰ªäÊúà„ÅÆ„Ç≠„Éº„ÇíÁâπÂÆö
            const now = new Date();
            const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            if (!openMonthKey) openMonthKey = currentMonthKey;

            container.innerHTML = journalsGrouped.map(group => {
                const key = `${group.year}-${String(group.month).padStart(2, '0')}`;
                const isOpen = key === openMonthKey;
                return `
                    <div class="journal-month-group" data-month-key="${key}">
                        <div class="journal-month-header ${isOpen ? 'active' : ''}">
                            <div class="journal-month-title">üìÖ ${group.label}</div>
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div class="journal-month-count">${group.journals.length}‰ª∂</div>
                                <span class="journal-month-arrow">‚ñº</span>
                            </div>
                        </div>
                        <div class="journal-month-content ${isOpen ? 'active' : ''}">
                            <div class="journal-month-content-inner">
                                ${group.journals.map(j => `
                                    <div class="journal-card" data-id="${j.id}">
                                        <div class="journal-card-header">
                                            <div class="journal-date">üìÖ ${formatDate(j.date)}</div>
                                            <div class="journal-tasks-count">‚úì ${j.tasks_completed_count || 0}„Çø„Çπ„ÇØÈÅîÊàê</div>
                                        </div>
                                        <div class="journal-title-text">${j.title || 'ÁÑ°È°å'}</div>
                                        <div class="journal-preview">${(j.content || '').substring(0, 50)}...</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // ÊúàÂà•„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            container.querySelectorAll('.journal-month-header').forEach(header => {
                header.onclick = () => {
                    const group = header.closest('.journal-month-group');
                    const key = group.dataset.monthKey;

                    // ‰ªñ„ÅÆÊúà„ÇíÈñâ„Åò„Çã
                    container.querySelectorAll('.journal-month-group').forEach(g => {
                        if (g !== group) {
                            g.querySelector('.journal-month-header').classList.remove('active');
                            g.querySelector('.journal-month-content').classList.remove('active');
                        }
                    });

                    // „Éà„Ç∞„É´
                    const isNowOpen = header.classList.contains('active');
                    header.classList.toggle('active', !isNowOpen);
                    group.querySelector('.journal-month-content').classList.toggle('active', !isNowOpen);
                    openMonthKey = isNowOpen ? null : key;
                };
            });

            // „Ç∏„É£„Éº„Éä„É´„Ç´„Éº„Éâ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            container.querySelectorAll('.journal-card').forEach(card => {
                card.onclick = (e) => {
                    e.stopPropagation();
                    const cardId = String(card.dataset.id);
                    // journalsData„Åã„ÇâÊ§úÁ¥¢„ÄÅË¶ã„Å§„Åã„Çâ„Å™„Åë„Çå„Å∞grouped„Åã„Çâ„ÇÇÊ§úÁ¥¢
                    let j = journalsData.find(x => String(x.id) === cardId);
                    if (!j) {
                        for (const group of journalsGrouped) {
                            j = group.journals.find(x => String(x.id) === cardId);
                            if (j) break;
                        }
                    }
                    if (j) openJournalDetailModal(j);
                };
            });
        }

        function openJournalDetailModal(journal) {
            currentEditJournal = journal;
            document.getElementById('journalViewContent').classList.remove('hidden');
            document.getElementById('journalEditContent').classList.remove('active');
            const d = new Date(journal.date);
            document.getElementById('journalModalDate').textContent = `${d.getFullYear()}Âπ¥${d.getMonth()+1}Êúà${d.getDate()}Êó•`;
            document.getElementById('journalModalTitle').textContent = journal.title || 'ÁÑ°È°å';
            document.getElementById('journalModalContent').textContent = journal.content || 'ÂÜÖÂÆπ„Å™„Åó';
            const tasks = journal.completed_tasks || [];
            document.getElementById('journalModalTasks').innerHTML = tasks.length
                ? tasks.map(t => `<span class="journal-task-chip">${t}</span>`).join('')
                : '<span style="color:var(--text-muted);font-size:12px;">ÈÅîÊàê„Çø„Çπ„ÇØ„Å™„Åó</span>';
            document.getElementById('journalDetailModal').classList.add('visible');
        }

        function bindJournalDetailModalUI() {
            const modal = document.getElementById('journalDetailModal');
            const close = () => { modal.classList.remove('visible'); currentEditJournal = null; };
            document.getElementById('journalDetailBackdrop').onclick = close;
            document.getElementById('closeJournalDetail').onclick = close;
            document.getElementById('journalCloseBtn').onclick = close;
            document.getElementById('closeJournalEdit').onclick = close;
            document.getElementById('journalEditBtn').onclick = () => {
                if (!currentEditJournal) return;
                document.getElementById('journalViewContent').classList.add('hidden');
                document.getElementById('journalEditContent').classList.add('active');
                document.getElementById('editJournalTitle').value = currentEditJournal.title || '';
                document.getElementById('editJournalContent').value = currentEditJournal.content || '';
            };
            document.getElementById('journalCancelEditBtn').onclick = () => {
                document.getElementById('journalViewContent').classList.remove('hidden');
                document.getElementById('journalEditContent').classList.remove('active');
            };
            document.getElementById('journalSaveEditBtn').onclick = async () => {
                if (!currentEditJournal) return;
                const newTitle = document.getElementById('editJournalTitle').value.trim();
                const newContent = document.getElementById('editJournalContent').value.trim();
                try {
                    await fetch(`${API_BASE}/journals/update`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: currentEditJournal.id,
                            user_id: userId,
                            title: newTitle,
                            content: newContent
                        })
                    });
                    currentEditJournal.title = newTitle;
                    currentEditJournal.content = newContent;
                    document.getElementById('journalModalTitle').textContent = newTitle || 'ÁÑ°È°å';
                    document.getElementById('journalModalContent').textContent = newContent || 'ÂÜÖÂÆπ„Å™„Åó';
                    document.getElementById('journalViewContent').classList.remove('hidden');
                    document.getElementById('journalEditContent').classList.remove('active');
                    await loadJournals();
                    alert('üí™ Êõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ');
                } catch (e) {
                    alert('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            };
        }

        async function saveJournal() {
            const date = document.getElementById('journalDate').value;
            const title = document.getElementById('journalTitle').value.trim();
            const content = document.getElementById('journalContent').value.trim();
            if (!title && !content) { alert('„Çø„Ç§„Éà„É´„Åæ„Åü„ÅØÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            try {
                await fetch(`${API_BASE}/journals/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        date: date,
                        title: title,
                        content: content,
                        tasks_completed_count: 0,
                        completed_tasks: []
                    })
                });
                document.getElementById('journalTitle').value = '';
                document.getElementById('journalContent').value = '';
                await loadJournals();
                alert('üí™ ‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
            } catch (e) {
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // „É¢„Éº„ÉÄ„É´
        function bindModalUI() {
            const modal = document.getElementById('detailModal');
            const close = () => modal.classList.remove("visible");
            document.getElementById('detailBackdrop').onclick = close;
            document.getElementById('detailCloseBtn').onclick = close;
            document.getElementById('detailCancelBtn').onclick = close;
            ['Priority', 'Vision', 'Excite', 'Growth'].forEach(name => {
                const input = document.getElementById(`input${name}`), val = document.getElementById(`val${name}`);
                input.addEventListener('input', () => val.textContent = input.value);
            });
            document.getElementById('inputRemindAt').addEventListener('change', e => {
                document.getElementById('valRemindAt').textContent = e.target.value ? formatRemindLabel(new Date(e.target.value).toISOString()) : '';
            });
            document.getElementById('detailSaveBtn').onclick = async () => {
                if (!currentDetailTask) return;
                if (modalMode === "detail") {
                    await action("update_detail", currentDetailTask.id, {
                        priority: Number(document.getElementById('inputPriority').value),
                        vision_score: Number(document.getElementById('inputVision').value),
                        excite_score: Number(document.getElementById('inputExcite').value),
                        growth_score: Number(document.getElementById('inputGrowth').value),
                    });
                } else {
                    const inputVal = document.getElementById('inputRemindAt').value;
                    await action("remind_custom", currentDetailTask.id, { remind_at: inputVal ? new Date(inputVal).toISOString() : null, kind: inputVal ? "custom_datetime" : "clear" });
                }
                close();
            };
        }

        function openDetail(t) {
            modalMode = "detail"; currentDetailTask = t;
            document.getElementById('modalTitle').textContent = "üí™ „Çø„Çπ„ÇØË©≥Á¥∞";
            document.getElementById('detailTaskTitle').textContent = t.task_name || t.title || "(ÁÑ°È°å)";
            document.getElementById('scoreGroup').style.display = "block";
            document.getElementById('remindGroup').style.display = "none";
            ['Priority', 'Vision', 'Excite', 'Growth'].forEach(name => {
                const val = t[name.toLowerCase() + (name === 'Priority' ? '' : '_score')] ?? 0;
                document.getElementById(`input${name}`).value = val;
                document.getElementById(`val${name}`).textContent = val;
            });
            document.getElementById('detailModal').classList.add("visible");
        }

        function openRemind(t) {
            modalMode = "remind"; currentDetailTask = t;
            document.getElementById('modalTitle').textContent = "üîî ÈÄöÁü•Ë®≠ÂÆö";
            document.getElementById('detailTaskTitle').textContent = t.task_name || t.title || "(ÁÑ°È°å)";
            document.getElementById('scoreGroup').style.display = "none";
            document.getElementById('remindGroup').style.display = "block";
            const input = document.getElementById('inputRemindAt'), val = document.getElementById('valRemindAt');
            if (t.remind_at) { input.value = toLocalDatetimeValue(t.remind_at); val.textContent = formatRemindLabel(t.remind_at); }
            else { input.value = ''; val.textContent = ''; }
            document.getElementById('detailModal').classList.add("visible");
        }

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        function mkBtn(label, onClick, cls) {
            const b = document.createElement("button");
            b.textContent = label; if (cls) b.className = cls;
            b.addEventListener("click", e => { e.stopPropagation(); e.preventDefault(); onClick(); });
            return b;
        }

        async function action(kind, id, extra = {}) {
            try {
                const res = await fetch(`${API_BASE}/action`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ user_id: userId, action: kind, task_id: id, ...extra }) });
                if (!res.ok) alert("Êìç‰Ωú„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
            } catch (e) { console.error("[ACTION] error:", e); }
            finally { if (kind !== "remind_custom") loadList(); }
        }

        function formatRemindLabel(iso) { if (!iso) return ""; const d = new Date(iso); return `üîî${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`; }
        function toLocalDatetimeValue(iso) { if (!iso) return ""; const d = new Date(iso); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
        function formatDate(dateStr) { const d = new Date(dateStr); return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }

        // =====================
        // MSCÔºà„É†„Ç≠„É†„Ç≠„Çπ„ÉÜ„Éº„Çø„Çπ„Ç´„Éº„ÉâÔºâÈñ¢ÈÄ£
        // =====================

        function bindMscUI() {
            // MSC„Éú„Çø„É≥„Åß„Ç´„Éº„ÉâË°®Á§∫Âàá„ÇäÊõø„Åà
            const mscOpenBtn = document.getElementById('mscOpenBtn');
            const mscCloseBtn = document.getElementById('mscCloseBtn');
            const mscCardView = document.getElementById('msc-card-view');

            function showMsc() {
                mscCardView.classList.add('active');
                mscOpenBtn.classList.add('active');
                mscOpenBtn.textContent = '‚Üê Êàª„Çã';
            }

            function hideMsc() {
                mscCardView.classList.remove('active');
                mscOpenBtn.classList.remove('active');
                mscOpenBtn.textContent = 'MSC';
            }

            mscOpenBtn.addEventListener('click', () => {
                if (mscCardView.classList.contains('active')) {
                    hideMsc();
                } else {
                    showMsc();
                }
            });

            // Èñâ„Åò„Çã„Éú„Çø„É≥
            if (mscCloseBtn) {
                mscCloseBtn.addEventListener('click', hideMsc);
            }

            // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            mscCardView.addEventListener('click', (e) => {
                if (e.target === mscCardView) {
                    hideMsc();
                }
            });
        }

        async function loadMscData() {
            try {
                const res = await fetch(`${API_BASE}/msc?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('MSC API not available');
                const data = await res.json();
                mscData = data;
                userMbti = data.mbti || null;
            } catch (e) {
                console.log('MSC API unavailable, calculating from habits data');
                // API„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁøíÊÖ£„Éá„Éº„Çø„Åã„ÇâË®àÁÆó
                await calculateMscFromHabits();
            }
            renderMsc();
        }

        async function calculateMscFromHabits() {
            // ÁøíÊÖ£„Éá„Éº„Çø„Åå„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÂÄ§„Çí‰ΩøÁî®
            const habitData = weekHabitsData || {};
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

            // ÂêÑÁøíÊÖ£„ÅÆÈÅîÊàêÁéá„ÇíË®àÁÆó
            let disciplineScore = 0; // Êó©Ëµ∑„Åç + Á¶ÅÈÖí
            let purposeScore = 0;    // „Éü„ÉÉ„Ç∑„Éß„É≥
            let curiosityScore = 0;  // Ë™≠Êõ∏/Â≠¶Áøí
            let reflectionScore = 0; // „Ç∏„É£„Éº„Éä„É´
            let actionScore = 0;     // ‰ªäÊó•„Éà„É¨
            let activeDays = 0;

            days.forEach(day => {
                const dayData = habitData[day];
                if (dayData) {
                    if (dayData.early_wake) disciplineScore++;
                    if (dayData.no_alcohol) disciplineScore++;
                    if (dayData.mission) purposeScore++;
                    if (dayData.reading) curiosityScore++;
                    if (dayData.journal) reflectionScore++;
                    if (dayData.workout) actionScore++;
                    if (Object.values(dayData).some(v => v)) activeDays++;
                }
            });

            // „Çπ„Ç≥„Ç¢„Çí5ÊÆµÈöé„Å´Ê≠£Ë¶èÂåñÔºàÊúÄÂ§ß7Êó•ÂàÜÔºâ
            const maxDiscipline = 14; // 2È†ÖÁõÆ √ó 7Êó•
            const maxOther = 7; // 1È†ÖÁõÆ √ó 7Êó•

            mscData.radarData = {
                discipline: Math.round((disciplineScore / maxDiscipline) * 5 * 10) / 10,
                purpose: Math.round((purposeScore / maxOther) * 5 * 10) / 10,
                curiosity: Math.round((curiosityScore / maxOther) * 5 * 10) / 10,
                reflection: Math.round((reflectionScore / maxOther) * 5 * 10) / 10,
                action: Math.round((actionScore / maxOther) * 5 * 10) / 10,
                consistency: Math.round((activeDays / 7) * 5 * 10) / 10
            };

            // Á∑èÂêà„Çπ„Ç≥„Ç¢Ë®àÁÆó
            const values = Object.values(mscData.radarData);
            mscData.score = Math.round((values.reduce((a, b) => a + b, 0) / values.length) * 100) / 100;

            // „É¨„Éô„É´„ÉªEXPË®àÁÆóÔºàÁ∞°ÊòìÁâàÔºöÁ∑èÂêà„Çπ„Ç≥„Ç¢ √ó ÈÄ±Êï∞„ÇíÊÉ≥ÂÆöÔºâ
            const totalWeeks = 4; // ‰ªÆ„ÅÆÈÄ±Êï∞
            mscData.exp = Math.round(mscData.score * 200 * totalWeeks);
            mscData.level = Math.floor(mscData.exp / 1000) + 1;
            mscData.totalExp = mscData.level * 1000;

            // Âº∑„Åø„ÉªÂº±„Åø„ÇíÂàÜÊûê
            analyzeMscTraits();
        }

        function analyzeMscTraits() {
            const traits = [
                { key: 'discipline', name: 'Ë¶èÂæã„Ç∑„Éº„É´„Éâ', icon: 'üåÖ', desc: 'Êó©Ëµ∑„Åç„Å®Á¶ÅÈÖí„ÇíÁ∂ôÁ∂ö„Åó„ÄÅË¶èÂæãÊ≠£„Åó„ÅÑÁîüÊ¥ª„ÇíÈÄÅ„Å£„Å¶„ÅÑ„Çã„ÄÇ' },
                { key: 'purpose', name: 'ÁõÆÁöÑ„Éñ„Éº„Çπ„Éà', icon: 'üéØ', desc: '„Éü„ÉÉ„Ç∑„Éß„É≥ÈÅîÊàê„Å∏„ÅÆÊÑèË≠ò„ÅåÈ´ò„Åè„ÄÅÁõÆÊ®ô„Å´Âêë„Åã„Å£„Å¶ÈÄ≤„Çì„Åß„ÅÑ„Çã„ÄÇ' },
                { key: 'curiosity', name: 'Êé¢Á©∂„Éë„ÉØ„Éº', icon: 'üìö', desc: 'Ë™≠Êõ∏„ÉªÂ≠¶ÁøíÁøíÊÖ£„ÅåÊ†π‰ªò„ÅÑ„Å¶„Åä„Çä„ÄÅÁü•ÁöÑÂ•ΩÂ•áÂøÉ„ÅåÊó∫Áõõ„ÄÇ' },
                { key: 'reflection', name: 'ÂÜÖÁúÅ„Çø„Ç§„É†', icon: 'üìù', desc: '„Ç∏„É£„Éº„Éä„É´„ÅßÊåØ„ÇäËøî„Çä„ÇíË°å„ÅÑ„ÄÅËá™Â∑±ÁêÜËß£„ÇíÊ∑±„ÇÅ„Å¶„ÅÑ„Çã„ÄÇ' },
                { key: 'action', name: 'Ë°åÂãï„Ç®„Éä„Ç∏„Éº', icon: 'üí™', desc: '„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíÁ∂ôÁ∂ö„Åó„ÄÅË°åÂãïÂäõ„ÇíÁô∫ÊèÆ„Åó„Å¶„ÅÑ„Çã„ÄÇ' },
                { key: 'consistency', name: 'Á∂ôÁ∂ö„Éû„Ç§„É≥„Éâ', icon: 'üî•', desc: 'Á©∫ÁôΩÊó•„ÅåÂ∞ë„Å™„Åè„ÄÅ„Ç≥„É≥„Çπ„Çø„É≥„Éà„Å´Âèñ„ÇäÁµÑ„Çì„Åß„ÅÑ„Çã„ÄÇ' }
            ];

            const scores = traits.map(t => ({ ...t, score: mscData.radarData[t.key] }));
            scores.sort((a, b) => b.score - a.score);

            // Âº∑„ÅøÔºö‰∏ä‰Ωç2„Å§Ôºà„Çπ„Ç≥„Ç¢2.5‰ª•‰∏äÔºâ
            mscData.strengths = scores.filter(s => s.score >= 2.5).slice(0, 2);
            // Âº±„ÅøÔºö‰∏ã‰Ωç2„Å§Ôºà„Çπ„Ç≥„Ç¢3.0Êú™Ê∫ÄÔºâ
            mscData.weaknesses = scores.filter(s => s.score < 3.0).slice(-2).reverse();

            // ÁîüÊÖã„É°„É¢„ÇíÁîüÊàê
            generateBioMemo();
        }

        function generateBioMemo() {
            const strengths = mscData.strengths.map(s => s.name).join('„Å®');
            const topTrait = mscData.strengths[0];

            const bios = [
                `${topTrait ? topTrait.name.replace(/„Ç∑„Éº„É´„Éâ|„Éñ„Éº„Çπ„Éà|„Éë„ÉØ„Éº|„Çø„Ç§„É†|„Ç®„Éä„Ç∏„Éº|„Éû„Ç§„É≥„Éâ/, '') : 'ÊàêÈï∑'}„Å∏„ÅÆÊÉÖÁÜ±„ÇíÊåÅ„Å°„ÄÅÊó•„ÄÖ„ÅÆÁ©ç„ÅøÈáç„Å≠„ÇíÂ§ßÂàá„Å´„Åó„Å¶„ÅÑ„Çã„ÄÇ`,
                '‰∏ÄÊ≠©‰∏ÄÊ≠©ÁùÄÂÆü„Å´ÂâçÈÄ≤„Åó„ÄÅËá™ÂàÜ„ÅÆ„Éö„Éº„Çπ„ÅßÊàêÈï∑„ÇíÁ∂ö„Åë„Çã„Çø„Ç§„Éó„ÄÇ',
                'Âõ∞Èõ£„Åå„ÅÇ„Å£„Å¶„ÇÇË´¶„ÇÅ„Åö„ÄÅÁ≤ò„ÇäÂº∑„ÅèÂèñ„ÇäÁµÑ„ÇÄÂßøÂã¢„ÅåÂÖâ„Çã„ÄÇ'
            ];

            if (mscData.radarData.discipline >= 3.5) {
                bios.push('ÊúùÂûã„ÅÆÁîüÊ¥ª„É™„Ç∫„É†„ÇíÂ•Ω„Åø„ÄÅ„Ç≥„ÉÑ„Ç≥„ÉÑ„Å®Á©ç„Åø‰∏ä„Åí„Çã„Åì„Å®„ÇíÂæóÊÑè„Å®„Åô„Çã„ÄÇ');
            }
            if (mscData.radarData.curiosity >= 3.5) {
                bios.push('Áü•Ë≠òÊ¨≤„ÅåÂº∑„Åè„ÄÅÂ∏∏„Å´Êñ∞„Åó„ÅÑ„Åì„Å®„ÇíÂ≠¶„Åº„ÅÜ„Å®„Åô„ÇãÂßøÂã¢„ÇíÊåÅ„Å§„ÄÇ');
            }
            if (mscData.radarData.action >= 3.5) {
                bios.push('ÊÄù„ÅÑÁ´ã„Å£„Åü„ÇâÂç≥Ë°åÂãï„ÄÇ„Ç®„Éç„É´„ÇÆ„ÉÉ„Ç∑„É•„Å´Âãï„ÅçÂõû„Çã„Çø„Ç§„Éó„ÄÇ');
            }

            mscData.bio = bios.slice(0, 2).join('\n');
        }

        function renderMsc() {
            // MBTI
            const mbtiTag = document.getElementById('mscMbtiTag');
            if (userMbti && MBTI_NAMES[userMbti]) {
                mbtiTag.textContent = `${userMbti} (${MBTI_NAMES[userMbti]})`;
            } else {
                mbtiTag.textContent = 'MBTI„ÇíË®≠ÂÆö';
            }

            // „É¨„Éô„É´„ÉªEXP
            const levelTitle = LEVEL_TITLES.find(l => mscData.level >= l.min && mscData.level <= l.max)?.title || 'Ë¶ãÁøí„ÅÑ';
            document.getElementById('mscLevelBadge').textContent = `Lv.${mscData.level} ${levelTitle}`;

            const score = mscData.score || 0;
            const fullStars = Math.floor(score);
            const halfStar = score % 1 >= 0.5 ? 1 : 0;
            const emptyStars = 5 - fullStars - halfStar;
            document.getElementById('mscStars').textContent = '‚òÖ'.repeat(fullStars) + (halfStar ? '‚òÜ' : '') + '‚òÜ'.repeat(emptyStars);
            document.getElementById('mscScore').textContent = score.toFixed(2);

            const expInLevel = mscData.exp % 1000;
            document.getElementById('mscExpFill').style.width = `${(expInLevel / 1000) * 100}%`;
            document.getElementById('mscExpText').textContent = `${expInLevel} / 1000 EXP`;

            // „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„Éà
            renderMscRadarChart();

            // Âº∑„Åø
            const strengthsHtml = mscData.strengths.length > 0
                ? mscData.strengths.map(s => `
                    <div class="msc-trait-item">
                        <div class="msc-trait-icon">${s.icon}</div>
                        <div class="msc-trait-content">
                            <div class="msc-trait-header">
                                <span class="msc-trait-name">${s.name}</span>
                                <span class="msc-trait-level">Lv.${s.score.toFixed(1)}</span>
                            </div>
                            <div class="msc-trait-desc">${s.desc}</div>
                        </div>
                    </div>
                `).join('')
                : '<div class="msc-trait-item"><div class="msc-trait-desc">„Éá„Éº„Çø„ÇíËìÑÁ©ç‰∏≠...</div></div>';
            document.getElementById('mscStrengths').innerHTML = strengthsHtml;

            // Âº±„Åø
            const weaknessesHtml = mscData.weaknesses.length > 0
                ? mscData.weaknesses.map(w => `
                    <div class="msc-trait-item">
                        <div class="msc-trait-icon">${w.icon}</div>
                        <div class="msc-trait-content">
                            <div class="msc-trait-header">
                                <span class="msc-trait-name">${w.name}</span>
                                <span class="msc-trait-level">Lv.${w.score.toFixed(1)}</span>
                            </div>
                            <div class="msc-trait-desc">${w.desc.replace('„Åó„Å¶„ÅÑ„Çã', '„ÅåË™≤È°å')}</div>
                        </div>
                    </div>
                `).join('')
                : '<div class="msc-trait-item"><div class="msc-trait-desc">„Éá„Éº„Çø„ÇíËìÑÁ©ç‰∏≠...</div></div>';
            document.getElementById('mscWeaknesses').innerHTML = weaknessesHtml;

            // ÁîüÊÖã„É°„É¢
            document.getElementById('mscBioText').textContent = mscData.bio || '„Åæ„Å†„Éá„Éº„Çø„ÅåÂ∞ë„Å™„ÅÑ„Åß„Åô„ÄÇÊó•„ÄÖ„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíÁ∂ö„Åë„Å¶„ÄÅ„ÅÇ„Å™„Åü„ÅÆÁâπÊÄß„ÇíÂàÜÊûê„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ';
        }

        function renderMscRadarChart() {
            const ctx = document.getElementById('mscRadarChart').getContext('2d');

            if (mscRadarChart) {
                mscRadarChart.destroy();
            }

            const data = mscData.radarData;

            mscRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Ë¶èÂæãÂäõ', 'ÁõÆÁöÑÂäõ', 'Êé¢Á©∂Âäõ', 'ÂÜÖÁúÅÂäõ', 'Ë°åÂãïÂäõ', 'Á∂ôÁ∂öÂäõ'],
                    datasets: [{
                        label: '„É†„Ç≠„É†„Ç≠ÊåáÊï∞',
                        data: [data.discipline, data.purpose, data.curiosity, data.reflection, data.action, data.consistency],
                        backgroundColor: 'rgba(255, 255, 255, 0.2)',
                        borderColor: 'rgba(254, 202, 87, 1)',
                        borderWidth: 3,
                        pointBackgroundColor: 'rgba(254, 202, 87, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            min: 0,
                            max: 5,
                            ticks: {
                                stepSize: 1,
                                display: false
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            },
                            angleLines: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            },
                            pointLabels: {
                                color: 'rgba(255, 255, 255, 0.9)',
                                font: {
                                    size: 11,
                                    weight: '600'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // MBTIÈñ¢ÈÄ£
        function bindMbtiModalUI() {
            const modal = document.getElementById('mbtiModal');
            const close = () => { modal.classList.remove('visible'); selectedMbti = null; };

            document.getElementById('mbtiBackdrop').onclick = close;
            document.getElementById('mbtiCloseBtn').onclick = close;

            document.querySelectorAll('.mbti-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    document.querySelectorAll('.mbti-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    selectedMbti = opt.dataset.mbti;
                });
            });

            document.getElementById('mbtiClearBtn').onclick = () => {
                document.querySelectorAll('.mbti-option').forEach(o => o.classList.remove('selected'));
                selectedMbti = null;
            };

            document.getElementById('mbtiSaveBtn').onclick = async () => {
                userMbti = selectedMbti;
                await saveMbti();
                renderMsc();
                close();
            };
        }

        function openMbtiModal() {
            selectedMbti = userMbti;
            document.querySelectorAll('.mbti-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.mbti === userMbti);
            });
            document.getElementById('mbtiModal').classList.add('visible');
        }

        async function saveMbti() {
            try {
                await fetch(`${API_BASE}/msc/mbti`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, mbti: userMbti })
                });
            } catch (e) {
                console.log('MBTI save to API failed, storing locally');
                // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´„ÇÇ‰øùÂ≠ò
                localStorage.setItem(`msc_mbti_${userId}`, userMbti || '');
            }
        }

        init();
    </script>
</body>
</html>
