<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LISTÔΩú„Çø„Çπ„ÇØ‰∏ÄË¶ß</title>
<style>
  body { font-family: -apple-system, system-ui; margin:0; background:#f7f7f8; }

  header { position:sticky; top:0; background:#fff; border-bottom:1px solid #eee; z-index:10; }
  .bar { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; }

  .tab { padding:6px 12px; border-radius:14px; border:1px solid #ddd; font-size:13px; cursor:pointer; }
  .tab.active { background:#111; color:white; border-color:#111; }

  .add { display:flex; gap:8px; padding:12px 16px; }
  .add input { flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; }

  .list { display:flex; flex-direction:column; }

  .card {
    position:relative;
    background:white;
    border-bottom:1px solid #eee;
    height:60px;
    overflow:hidden;
    touch-action:pan-y;
  }
  .card.completed .title { color:#aaa; text-decoration:line-through; }

  .sl {
    position:relative;
    height:100%; width:100%;
    display:flex;
    align-items:center;
    padding:0 12px;
    transition:transform .15s ease;
    background:white;
    z-index:2;
  }

  .actions-rail {
    position:absolute; inset:0;
    display:flex; justify-content:space-between; align-items:center;
    pointer-events:none; z-index:1;
  }

  :root { --rail-w:140px; }

  .actions-left, .actions-right {
    width:var(--rail-w);
    height:100%;
    display:flex; align-items:center;
  }
  .actions-left { background:#e8f7ee; justify-content:flex-start; }
  .actions-right { background:#fdeeee; justify-content:flex-end; }

  .actions-rail button {
    height:100%; min-width:64px; border:none; color:white; font-size:13px;
    border-radius:0;
  }

  .btn-complete { background:#7e6dff; }
  .btn-plus2h   { background:#8012e2; }
  .btn-detail   { background:#1e928b; }
  .btn-pin      { background:#d97706; }
  .btn-delete   { background:#f03d30; }

  .handle {
    margin-left:auto; cursor:grab; opacity:0.1;
    -webkit-user-select:none; user-select:none;
    padding:0 12px; font-size:20px;
  }

  .divider-label { text-align:center; color:#888; font-size:12px; padding:6px 0; }

  /* Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ */
  .modal-root { position:fixed; inset:0; display:none; z-index:50; align-items:flex-end; justify-content:center; }
  .modal-root.visible { display:flex; }
  .modal-backdrop { position:absolute; inset:0; background:rgba(0,0,0,.25); }
  .modal-panel {
    width:100%; max-width:480px; background:#fff;
    border-radius:20px 20px 0 0; padding:16px;
    animation:slideUp .18s ease-out;
  }
  @keyframes slideUp { from{ transform:translateY(40px); opacity:0;} to{ transform:translateY(0); opacity:1;} }

  .slider-group { margin:14px 0; }
  .slider-label-row { display:flex; justify-content:space-between; font-size:12px; }
  .slider-label-row span.value { font-size:13px; font-weight:600; }

  .modal-footer { display:flex; justify-content:flex-end; gap:8px; margin-top:14px; }
  .btn-secondary { padding:8px 14px; border:1px solid #ddd; border-radius:20px; background:#fafafa; }
  .btn-primary-solid { padding:8px 16px; border-radius:20px; background:#7e6dff; color:white; border:none; }
</style>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<header>
  <div class="bar">
    <div style="font-weight:600">LIST</div>
    <div class="tab active">„Çø„Çπ„ÇØ</div>
    <div class="tab" id="refreshBtn">‚Üª</div>
  </div>
</header>

<main>
  <div class="add">
    <input id="newTitle" placeholder="„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ‚Ä¶" />
    <button id="btnAdd" class="tab" style="background:#111;color:white;border-color:#111">ËøΩÂä†</button>
  </div>

  <div class="divider-label">Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ</div>
  <div id="pinned" class="list"></div>
  <div id="active" class="list"></div>

  <div class="divider-label" style="margin-top:16px;">ÈÅîÊàê„Çø„Çπ„ÇØ</div>
  <div id="completed" class="list"></div>
</main>

<!-- Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
<div id="detailModal" class="modal-root">
  <div id="detailBackdrop" class="modal-backdrop"></div>
  <div class="modal-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:600">„Çø„Çπ„ÇØË©≥Á¥∞</div>
      <button id="detailCloseBtn" style="background:none;border:none;font-size:20px">&times;</button>
    </div>

    <div id="detailTaskTitle" style="font-size:13px;color:#555;margin-bottom:8px;"></div>

    <div class="slider-group">
      <div class="slider-label-row"><span>ÂÑ™ÂÖàÂ∫¶</span><span class="value" id="valPriority"></span></div>
      <input id="inputPriority" type="range" min="0" max="10" step="1"/>
    </div>

    <div class="slider-group">
      <div class="slider-label-row"><span>„Éì„Ç∏„Éß„É≥Èñ¢ÈÄ£Â∫¶</span><span class="value" id="valVision"></span></div>
      <input id="inputVision" type="range" min="0" max="10" step="1"/>
    </div>

    <div class="slider-group">
      <div class="slider-label-row"><span>„Çè„Åè„Çè„ÅèÂ∫¶</span><span class="value" id="valExcite"></span></div>
      <input id="inputExcite" type="range" min="0" max="10" step="1"/>
    </div>

    <div class="slider-group">
      <div class="slider-label-row"><span>ÊàêÈï∑Â∫¶</span><span class="value" id="valGrowth"></span></div>
      <input id="inputGrowth" type="range" min="0" max="10" step="1"/>
    </div>

    <div class="modal-footer">
      <button id="detailCancelBtn" class="btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
      <button id="detailSaveBtn" class="btn-primary-solid">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<script>
const LIFF_ID = "2008372898-2q9qWmxv";
const API_BASE = "https://yamasho.xvps.jp/webhook-test";
let userId = null;
let currentDetailTask = null;

const EXPOSE_W = 140;
const EXPOSE_X = 200;

/* ==========================
   INIT
========================== */
async function init() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();

  const profile = await liff.getProfile();
  userId = profile.userId;

  bindUI();
  bindModalUI();
  loadList();
}

document.getElementById("refreshBtn").onclick = loadList;

/* ==========================
  Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ UI
========================== */
function bindModalUI() {
  const close = () => detailModal.classList.remove("visible");

  detailBackdrop.onclick = close;
  detailCloseBtn.onclick = close;
  detailCancelBtn.onclick = close;

  detailSaveBtn.onclick = async () => {
    const payload = {
      priority: Number(inputPriority.value),
      vision_score: Number(inputVision.value),
      excite_score: Number(inputExcite.value),
      growth_score: Number(inputGrowth.value),
    };
    await action("update_detail", currentDetailTask.id, payload);
    close();
  };
}

/* ==========================
  LIST API
========================== */
async function loadList() {
  const res = await fetch(`${API_BASE}/list?user_id=${userId}`);
  const data = await res.json();
  renderList(data);
}

function renderList(payload) {
  pinned.innerHTML = "";
  active.innerHTML = "";
  completed.innerHTML = "";

  (payload.pinned || []).forEach(t => pinned.appendChild(taskCard(t)));
  (payload.active || []).forEach(t => active.appendChild(taskCard(t)));
  (payload.completed || []).forEach(t => completed.appendChild(taskCard(t, true)));
}

/* ==========================
  TASK CARD
========================== */
function taskCard(t, isCompleted = false) {
  const wrap = document.createElement("div");
  wrap.className = "card";
  if (isCompleted) wrap.classList.add("completed");

  // ËÉåÈù¢„É¨„Éº„É´
  const rail = document.createElement("div");
  rail.className = "actions-rail";

  const left = document.createElement("div");
  left.className = "actions-left";

  if (!isCompleted) {
    left.append(
      mkBtn("ÂÆå‰∫Ü", () => action("complete", t.id), "btn-complete"),
      mkBtn("+2h", () => action("remind_plus2h", t.id), "btn-plus2h")
    );
  } else {
    left.append(mkBtn("Êú™ÂÆå", () => action("uncomplete", t.id), "btn-complete"));
  }

  const right = document.createElement("div");
  right.className = "actions-right";
  right.append(
    mkBtn("Ë©≥Á¥∞", () => openDetail(t), "btn-detail"),
    mkBtn(t.pinned ? "„Éî„É≥Ëß£Èô§" : "„Éî„É≥", () => action("toggle_pin", t.id), "btn-pin"),
    mkBtn("ÂâäÈô§", () => {
      if (t.pinned) return alert("„Éî„É≥„ÇíÂ§ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
      action("delete", t.id);
    }, "btn-delete")
  );

  rail.append(left, right);

  // ÂâçÈù¢
  const sl = document.createElement("div");
  sl.className = "sl";

  const title = document.createElement("div");
  title.className = "title";
  if (t.pinned) title.innerHTML = "üìç " + t.task_name;
  else title.textContent = t.task_name;

  const handle = document.createElement("div");
  handle.className = "handle";
  handle.textContent = "‚ò∞";

  sl.append(title, handle);
  wrap.append(rail, sl);

  /* ==========================
      PCÁâà „ÇØ„É™„ÉÉ„ÇØ„Åß„Çπ„ÉØ„Ç§„Éó
  ========================== */
  if (!/Mobi|Android/i.test(navigator.userAgent)) {
    sl.addEventListener("click", e => {
      const rect = sl.getBoundingClientRect();
      const x = e.clientX - rect.left;

      if (wrap.classList.contains("open-left") || wrap.classList.contains("open-right")) {
        wrap.classList.remove("open-left", "open-right");
        sl.style.transform = "translateX(0)";
        return;
      }

      if (x < rect.width / 2) {
        wrap.classList.add("open-left");
        sl.style.transform = `translateX(${EXPOSE_W}px)`;
      } else {
        wrap.classList.add("open-right");
        sl.style.transform = `translateX(${-EXPOSE_X}px)`;
      }
    });
  }

  /* ==========================
      „Çπ„Éû„ÉõÁâà „Çπ„ÉØ„Ç§„Éó
  ========================== */
  let startX = 0, dx = 0;

  wrap.addEventListener("touchstart", e => {
    startX = e.touches[0].clientX;
    sl.style.transition = "none";
  });

  wrap.addEventListener("touchmove", e => {
    dx = e.touches[0].clientX - startX;
    if (Math.abs(dx) > 8) e.preventDefault();
    sl.style.transform = `translateX(${dx}px)`;
  }, { passive:false });

  wrap.addEventListener("touchend", () => {
    sl.style.transition = "transform .15s";
    if (dx > 60) {
      wrap.classList.add("open-left");
      sl.style.transform = `translateX(${EXPOSE_W}px)`;
    } else if (dx < -60) {
      wrap.classList.add("open-right");
      sl.style.transform = `translateX(${-EXPOSE_X}px)`;
    } else {
      wrap.classList.remove("open-left", "open-right");
      sl.style.transform = "translateX(0)";
    }
  });

  return wrap;
}

/* ==========================
   MODAL OPEN
========================== */
function openDetail(t) {
  currentDetailTask = t;

  detailTaskTitle.textContent = t.task_name;
  inputPriority.value = t.priority ?? 0;
  valPriority.textContent = inputPriority.value;

  inputVision.value = t.vision_score ?? 0;
  valVision.textContent = inputVision.value;

  inputExcite.value = t.excite_score ?? 0;
  valExcite.textContent = inputExcite.value;

  inputGrowth.value = t.growth_score ?? 0;
  valGrowth.textContent = inputGrowth.value;

  detailModal.classList.add("visible");
}

/* ==========================
   ADD
========================== */
btnAdd.onclick = async () => {
  const title = newTitle.value.trim();
  if (!title) return;

  await action("create", null, { task_name: title });
  newTitle.value = "";
};

/* ==========================
   API ACTION
========================== */
async function action(kind, id, extra={}) {
  await fetch(`${API_BASE}/action`, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({
      user_id: userId,
      action: kind,
      task_id: id,
      ...extra
    })
  });

  loadList();
}

init();
</script>
</body>
</html>

