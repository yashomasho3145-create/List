<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>„É†„Ç≠„É†„Ç≠„Çø„Çπ„Åè„Çì</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, system-ui;
            margin: 0;
            background: #f7f7f8;
            padding-bottom: 70px;
        }

        /* ========== „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ ========== */
        .tab-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            border-top: 1px solid #eee;
            display: flex;
            z-index: 100;
        }
        .tab-nav-item {
            flex: 1;
            padding: 12px 0;
            text-align: center;
            font-size: 12px;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-nav-item.active {
            color: #7e6dff;
            font-weight: 600;
        }
        .tab-nav-item span {
            display: block;
            font-size: 20px;
            margin-bottom: 2px;
        }

        /* ========== „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ ========== */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* ========== „Éò„ÉÉ„ÉÄ„Éº ========== */
        header {
            position: sticky;
            top: 0;
            background: #fff;
            border-bottom: 1px solid #eee;
            z-index: 10;
        }
        .bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
        }
        .bar-title {
            font-weight: 600;
            font-size: 16px;
        }
        .bar-btn {
            padding: 6px 12px;
            border-radius: 14px;
            border: 1px solid #ddd;
            font-size: 13px;
            cursor: pointer;
            background: #fff;
        }

        /* ========== „É™„Çπ„Éà„Çø„Éñ ========== */
        .add {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
        }
        .add input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        .add button {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            background: #111;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        .list {
            display: flex;
            flex-direction: column;
        }
        .card {
            position: relative;
            background: white;
            border-bottom: 1px solid #eee;
            height: 60px;
            overflow: hidden;
            touch-action: pan-y;
        }
        .card.completed .title {
            color: #aaa;
            text-decoration: line-through;
        }
        .card.dragging {
            opacity: 0.9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.18);
            z-index: 5;
        }
        .sl {
            position: relative;
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 0 12px;
            transition: transform .15s ease;
            background: white;
            z-index: 2;
        }
        .actions-rail {
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 1;
        }
        .card.open-left .actions-rail,
        .card.open-right .actions-rail {
            pointer-events: auto;
        }
        .actions-left, .actions-right {
            height: 100%;
            display: flex;
            align-items: center;
        }
        .actions-left {
            background: #e8f7ee;
            justify-content: flex-start;
        }
        .actions-right {
            background: #fdeeee;
            justify-content: flex-end;
        }
        .actions-rail button {
            height: 100%;
            min-width: 64px;
            border: none;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }
        .btn-complete { background: #7e6dff; }
        .btn-plus2h { background: #8012e2; }
        .btn-detail { background: #1e928b; }
        .btn-pin { background: #d97706; }
        .btn-delete { background: #f03d30; }
        .title { font-size: 15px; }
        .handle {
            margin-left: auto;
            cursor: grab;
            opacity: 0.25;
            padding: 0 8px;
            font-size: 20px;
            touch-action: none;
        }
        .divider-label {
            text-align: center;
            color: #888;
            font-size: 12px;
            padding: 10px 0 6px;
            background: #f7f7f8;
        }
        .remindAt {
            font-size: 11px;
            color: #666;
            margin-left: 8px;
            white-space: nowrap;
        }

        /* ========== „Çπ„ÉÜ„Éº„Çø„Çπ„Çø„Éñ ========== */
        .status-section {
            background: #fff;
            margin: 12px;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .status-section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .daily-task-card {
            cursor: pointer;
        }
        .daily-task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .daily-task-arrow {
            font-size: 14px;
            color: #888;
            transition: transform 0.2s;
        }
        .daily-task-card.expanded .daily-task-arrow {
            transform: rotate(180deg);
        }
        .daily-task-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .daily-task-card.expanded .daily-task-content {
            max-height: 400px;
        }
        .habit-list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .habit-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: #f7f7f8;
            border-radius: 8px;
        }
        .habit-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            color: #7e6dff;
            transition: all 0.15s;
        }
        .habit-checkbox.checked {
            background: #7e6dff;
            border-color: #7e6dff;
            color: white;
        }
        .habit-name { flex: 1; font-size: 14px; }
        .habit-icon { font-size: 18px; }
        .daily-task-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        .daily-btn {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        .daily-btn-cancel {
            background: #fafafa;
            color: #666;
        }
        .daily-btn-save {
            background: #7e6dff;
            color: white;
            border-color: #7e6dff;
        }
        /* ÈÄ±Èñì„Éì„É•„Éº */
        .week-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-top: 8px;
        }
        .week-table th, .week-table td {
            padding: 8px 4px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        .week-table th {
            color: #888;
            font-weight: normal;
        }
        .week-table td:first-child, .week-table th:first-child {
            text-align: left;
            font-size: 12px;
        }
        .week-table .checked { color: #7e6dff; }
        .week-table .unchecked { color: #ddd; }
        /* ÂàÜÊûê */
        .progress-bar-container { margin-top: 8px; }
        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 6px;
        }
        .progress-label-name { color: #888; }
        .progress-label-value { color: #7e6dff; font-weight: 600; }
        .progress-bar-bg {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: #7e6dff;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* ========== „Ç∏„É£„Éº„Éä„É´„Çø„Éñ ========== */
        .journal-form {
            background: #fff;
            margin: 12px;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .form-group { margin-bottom: 12px; }
        .form-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
            display: block;
        }
        .form-input, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #7e6dff;
        }
        .journal-submit-btn {
            width: 100%;
            padding: 12px;
            background: #7e6dff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        .journal-list {
            margin: 0 12px;
        }
        .journal-card {
            background: #fff;
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            cursor: pointer;
        }
        .journal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .journal-date {
            font-size: 11px;
            color: #888;
        }
        .journal-tasks-count {
            font-size: 11px;
            color: #7e6dff;
        }
        .journal-title-text {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .journal-preview {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .journal-card-expand {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .journal-card.expanded .journal-card-expand {
            max-height: 500px;
        }
        .journal-full-content {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }
        .journal-body {
            font-size: 13px;
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .journal-edit-btn {
            margin-top: 12px;
            width: 100%;
            padding: 8px;
            background: #f7f7f8;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }

        /* ========== „É¢„Éº„ÉÄ„É´ ========== */
        .modal-root {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 50;
            align-items: flex-end;
            justify-content: center;
        }
        .modal-root.visible { display: flex; }
        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,.25);
            z-index: 0;
        }
        .modal-panel {
            width: 100%;
            max-width: 480px;
            background: #fff;
            border-radius: 20px 20px 0 0;
            padding: 16px;
            animation: slideUp .18s ease-out;
            position: relative;
            z-index: 1;
        }
        @keyframes slideUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .slider-group { margin: 14px 0; }
        .slider-label-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }
        .slider-label-row span.value {
            font-size: 13px;
            font-weight: 600;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 14px;
        }
        .btn-secondary {
            padding: 8px 14px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: #fafafa;
            cursor: pointer;
        }
        .btn-primary-solid {
            padding: 8px 16px;
            border-radius: 20px;
            background: #7e6dff;
            color: white;
            border: none;
            cursor: pointer;
        }

        /* ========== „É≠„Éº„Éá„Ç£„É≥„Ç∞ ========== */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 14px;
        }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

    <!-- ========== „É™„Çπ„Éà„Çø„Éñ ========== -->
    <div id="tab-list" class="tab-content active">
        <header>
            <div class="bar">
                <div class="bar-title">„É™„Çπ„Éà</div>
                <button class="bar-btn" id="refreshBtn">‚Üª</button>
            </div>
        </header>
        <main>
            <div class="add">
                <input id="newTitle" placeholder="„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ‚Ä¶" />
                <button id="btnAdd">ËøΩÂä†</button>
            </div>
            <div class="divider-label">ToDo„Çø„Çπ„ÇØ</div>
            <div id="pinned" class="list"></div>
            <div id="active" class="list"></div>
            <div class="divider-label">ÈÅîÊàê„Çø„Çπ„ÇØ</div>
            <div id="completed" class="list"></div>
        </main>
    </div>

    <!-- ========== „Çπ„ÉÜ„Éº„Çø„Çπ„Çø„Éñ ========== -->
    <div id="tab-status" class="tab-content">
        <header>
            <div class="bar">
                <div class="bar-title">„Çπ„ÉÜ„Éº„Çø„Çπ</div>
                <button class="bar-btn" id="statusRefreshBtn">‚Üª</button>
            </div>
        </header>
        <main>
            <!-- „Éá„Ç§„É™„Éº„Çø„Çπ„ÇØ -->
            <div class="status-section daily-task-card" id="dailyTaskCard">
                <div class="daily-task-header">
                    <div class="status-section-title">
                        <span>üìã</span> „Éá„Ç§„É™„Éº„Çø„Çπ„ÇØ
                    </div>
                    <span class="daily-task-arrow">‚ñº</span>
                </div>
                <div class="daily-task-content">
                    <div class="habit-list" id="habitList"></div>
                    <div class="daily-task-buttons">
                        <button class="daily-btn daily-btn-cancel" id="habitCancelBtn">„Ç≠„É£„É≥„Çª„É´</button>
                        <button class="daily-btn daily-btn-save" id="habitSaveBtn">‰øùÂ≠ò„Åô„Çã</button>
                    </div>
                </div>
            </div>

            <!-- ÈÄ±Èñì„Éì„É•„Éº -->
            <div class="status-section">
                <div class="status-section-title">
                    <span>üìÖ</span> ÈÄ±Èñì„Éì„É•„Éº
                </div>
                <table class="week-table" id="weekTable">
                    <thead>
                        <tr>
                            <th>ÁøíÊÖ£</th>
                            <th>Êúà</th>
                            <th>ÁÅ´</th>
                            <th>Ê∞¥</th>
                            <th>Êú®</th>
                            <th>Èáë</th>
                            <th>Âúü</th>
                            <th>Êó•</th>
                        </tr>
                    </thead>
                    <tbody id="weekTableBody"></tbody>
                </table>
            </div>

            <!-- ÂàÜÊûê -->
            <div class="status-section">
                <div class="status-section-title">
                    <span>üìä</span> ÂàÜÊûê
                </div>
                <div class="progress-bar-container">
                    <div class="progress-label">
                        <span class="progress-label-name">ÈÄ±ÈñìÈÅîÊàêÁéá</span>
                        <span class="progress-label-value" id="weekProgressValue">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="weekProgressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ========== „Ç∏„É£„Éº„Éä„É´„Çø„Éñ ========== -->
    <div id="tab-journal" class="tab-content">
        <header>
            <div class="bar">
                <div class="bar-title">„Ç∏„É£„Éº„Éä„É´</div>
                <button class="bar-btn" id="journalRefreshBtn">‚Üª</button>
            </div>
        </header>
        <main>
            <div class="journal-form">
                <div class="status-section-title" style="margin-bottom:16px;">
                    <span>üìù</span> ‰ªäÊó•„ÅÆÊåØ„ÇäËøî„Çä
                </div>
                <div class="form-group">
                    <label class="form-label">Êó•‰ªò</label>
                    <input type="date" class="form-input" id="journalDate" />
                </div>
                <div class="form-group">
                    <label class="form-label">„Çø„Ç§„Éà„É´</label>
                    <input type="text" class="form-input" id="journalTitle" placeholder="‰ªäÊó•„ÅÆ„Å≤„Å®„Åì„Å®‚Ä¶" />
                </div>
                <div class="form-group">
                    <label class="form-label">ÂÜÖÂÆπ</label>
                    <textarea class="form-textarea" id="journalContent" placeholder="‰ªäÊó•„ÅÆÊåØ„ÇäËøî„Çä„ÇíË®òÈå≤„Åó„Çà„ÅÜ‚Ä¶"></textarea>
                </div>
                <button class="journal-submit-btn" id="journalSubmitBtn">‰øùÂ≠ò„Åô„Çã</button>
            </div>

            <div class="divider-label">ÈÅéÂéª„ÅÆË®òÈå≤</div>
            <div class="journal-list" id="journalList"></div>
        </main>
    </div>

    <!-- ========== „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ ========== -->
    <nav class="tab-nav">
        <div class="tab-nav-item active" data-tab="list">
            <span>üìã</span>
            „É™„Çπ„Éà
        </div>
        <div class="tab-nav-item" data-tab="status">
            <span>üìä</span>
            „Çπ„ÉÜ„Éº„Çø„Çπ
        </div>
        <div class="tab-nav-item" data-tab="journal">
            <span>üìù</span>
            „Ç∏„É£„Éº„Éä„É´
        </div>
    </nav>

    <!-- ========== Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ ========== -->
    <div id="detailModal" class="modal-root">
        <div id="detailBackdrop" class="modal-backdrop"></div>
        <div class="modal-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-weight:600" id="modalTitle">„Çø„Çπ„ÇØË©≥Á¥∞</div>
                <button id="detailCloseBtn" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
            </div>
            <div id="detailTaskTitle" style="font-size:13px;color:#555;margin-bottom:8px;"></div>

            <!-- „Çπ„Ç≥„Ç¢Ë®≠ÂÆö„Ç∞„É´„Éº„Éó -->
            <div id="scoreGroup">
                <div class="slider-group">
                    <div class="slider-label-row"><span>ÂÑ™ÂÖàÂ∫¶</span><span class="value" id="valPriority"></span></div>
                    <input id="inputPriority" type="range" min="0" max="10" step="1" style="width:100%" />
                </div>
                <div class="slider-group">
                    <div class="slider-label-row"><span>„Éì„Ç∏„Éß„É≥Èñ¢ÈÄ£Â∫¶</span><span class="value" id="valVision"></span></div>
                    <input id="inputVision" type="range" min="0" max="10" step="1" style="width:100%" />
                </div>
                <div class="slider-group">
                    <div class="slider-label-row"><span>„Çè„Åè„Çè„ÅèÂ∫¶</span><span class="value" id="valExcite"></span></div>
                    <input id="inputExcite" type="range" min="0" max="10" step="1" style="width:100%" />
                </div>
                <div class="slider-group">
                    <div class="slider-label-row"><span>ÊàêÈï∑Â∫¶</span><span class="value" id="valGrowth"></span></div>
                    <input id="inputGrowth" type="range" min="0" max="10" step="1" style="width:100%" />
                </div>
            </div>

            <!-- „É™„Éû„Ç§„É≥„ÉâË®≠ÂÆö„Ç∞„É´„Éº„Éó -->
            <div id="remindGroup" class="slider-group">
                <div class="slider-label-row">
                    <span>„É™„Éû„Ç§„É≥„ÉâÊó•ÊôÇ</span>
                    <span class="value" id="valRemindAt"></span>
                </div>
                <input id="inputRemindAt" type="datetime-local" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;" />
            </div>

            <div class="modal-footer">
                <button id="detailCancelBtn" class="btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
                <button id="detailSaveBtn" class="btn-primary-solid">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <script>
        // ========== Ë®≠ÂÆö ==========
        const LIFF_ID = "2008372898-2q9qWmxv";
        const API_BASE = "https://lumicreate.xvps.jp/webhook";

        let userId = null;
        let currentDetailTask = null;
        let modalMode = "detail";

        const HABITS = [
            { id: 'early_wake', name: 'Êó©Ëµ∑„Åç', icon: 'üåÖ' },
            { id: 'mission', name: '„Éü„ÉÉ„Ç∑„Éß„É≥', icon: 'üéØ' },
            { id: 'reading', name: 'Ë™≠Êõ∏/Â≠¶Áøí', icon: 'üìö' },
            { id: 'journal', name: '„Ç∏„É£„Éº„Éä„É´', icon: 'üìù' },
            { id: 'no_alcohol', name: 'Á¶ÅÈÖí', icon: 'üö´' },
            { id: 'workout', name: '‰ªäÊó•„Éà„É¨', icon: 'üí™' }
        ];

        let todayHabits = {};
        let weekHabitsData = {};

        // „Çπ„ÉØ„Ç§„ÉóË®≠ÂÆö
        const STRONG_RATIO = 0.85;
        const SNAP_THRESHOLD = 40;

        // DOMË¶ÅÁ¥†
        const pinnedEl = document.getElementById("pinned");
        const activeEl = document.getElementById("active");
        const completedEl = document.getElementById("completed");

        // ========== ÂàùÊúüÂåñ ==========
        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                userId = profile.userId;
            } catch (e) {
                console.error("LIFFÂàùÊúüÂåñ„Ç®„É©„Éº:", e);
                userId = "demo_user";
            }

            bindUI();
            await loadAllData();
        }

        function bindUI() {
            // „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
            document.querySelectorAll('.tab-nav-item').forEach(item => {
                item.addEventListener('click', () => switchTab(item.dataset.tab));
            });

            // „É™„Çπ„Éà„Çø„Éñ
            document.getElementById('refreshBtn').onclick = loadList;
            document.getElementById('btnAdd').onclick = addTask;
            document.getElementById('newTitle').addEventListener('keypress', e => {
                if (e.key === 'Enter') addTask();
            });

            // „Çπ„ÉÜ„Éº„Çø„Çπ„Çø„Éñ
            document.getElementById('statusRefreshBtn').onclick = loadHabits;
            document.getElementById('dailyTaskCard').addEventListener('click', e => {
                if (!e.target.closest('.habit-checkbox') && !e.target.closest('.daily-btn')) {
                    document.getElementById('dailyTaskCard').classList.toggle('expanded');
                }
            });
            document.getElementById('habitSaveBtn').onclick = saveHabits;
            document.getElementById('habitCancelBtn').onclick = () => {
                document.getElementById('dailyTaskCard').classList.remove('expanded');
            };
            renderHabitList();

            // „Ç∏„É£„Éº„Éä„É´„Çø„Éñ
            document.getElementById('journalRefreshBtn').onclick = loadJournals;
            document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('journalSubmitBtn').onclick = saveJournal;

            // „É¢„Éº„ÉÄ„É´
            bindModalUI();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-nav-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab-nav-item[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        async function loadAllData() {
            await Promise.all([
                loadList(),
                loadHabits(),
                loadJournals()
            ]);
        }

        // ========== „É™„Çπ„ÉàÊ©üËÉΩ ==========
        async function loadList() {
            try {
                const res = await fetch(`${API_BASE}/list?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                renderList(data);
            } catch (e) {
                console.error("[LIST] error:", e);
                renderList({ pinned: [], active: [], completed: [] });
            }
        }

        function renderList(payload) {
            pinnedEl.innerHTML = "";
            activeEl.innerHTML = "";
            completedEl.innerHTML = "";

            const pinned = Array.isArray(payload.pinned) ? payload.pinned : [];
            const active = Array.isArray(payload.active) ? payload.active : [];
            const completed = Array.isArray(payload.completed) ? payload.completed : [];

            pinned.forEach(t => pinnedEl.appendChild(taskCard(t, false)));
            active.forEach(t => activeEl.appendChild(taskCard(t, false)));
            completed.forEach(t => completedEl.appendChild(taskCard(t, true)));
        }

        async function addTask() {
            const input = document.getElementById('newTitle');
            const title = input.value.trim();
            if (!title) return;
            await action("create", null, { task_name: title });
            input.value = "";
        }

        function taskCard(t, isCompleted = false) {
            const wrap = document.createElement("div");
            wrap.className = "card";
            if (isCompleted) wrap.classList.add("completed");

            const rail = document.createElement("div");
            rail.className = "actions-rail";

            const left = document.createElement("div");
            left.className = "actions-left";
            if (!isCompleted) {
                left.append(
                    mkBtn("ÂÆå‰∫Ü", () => action("complete", t.id), "btn-complete"),
                    mkBtn("ÈÄöÁü•", () => openRemind(t), "btn-plus2h")
                );
            } else {
                left.append(mkBtn("Êú™ÂÆå", () => action("uncomplete", t.id), "btn-complete"));
            }

            const right = document.createElement("div");
            right.className = "actions-right";
            right.append(
                mkBtn("Ë©≥Á¥∞", () => openDetail(t), "btn-detail"),
                mkBtn(t.pinned ? "üìçËß£Èô§" : "üìç„Éî„É≥", () => action("toggle_pin", t.id), "btn-pin"),
                mkBtn("ÂâäÈô§", () => {
                    if (t.pinned) return alert("„Éî„É≥„ÇíÂ§ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
                    action("delete", t.id);
                }, "btn-delete")
            );

            rail.append(left, right);

            const sl = document.createElement("div");
            sl.className = "sl";

            const titleEl = document.createElement("div");
            titleEl.className = "title";
            const name = t.task_name || t.title || "(ÁÑ°È°å)";
            titleEl.textContent = t.pinned ? "üìç " + name : name;

            const leftBox = document.createElement("div");
            leftBox.style.flex = "1";
            leftBox.appendChild(titleEl);

            const rightBox = document.createElement("div");
            rightBox.className = "rightBox";
            rightBox.style.display = "flex";
            rightBox.style.alignItems = "center";

            if (t.remind_at) {
                const remindEl = document.createElement("div");
                remindEl.className = "remindAt";
                remindEl.textContent = formatRemindLabel(t.remind_at);
                rightBox.appendChild(remindEl);
            }

            const handle = document.createElement("div");
            handle.className = "handle";
            handle.textContent = "‚ò∞";
            rightBox.appendChild(handle);

            sl.append(leftBox, rightBox);
            wrap.append(rail, sl);

            // „Éú„Çø„É≥ÂπÖÊ∏¨ÂÆö
            requestAnimationFrame(() => {
                wrap.dataset.leftWidth = left.getBoundingClientRect().width || 140;
                wrap.dataset.rightWidth = right.getBoundingClientRect().width || 140;
            });

            // PCÁâà„ÇØ„É™„ÉÉ„ÇØ
            if (!/Mobi|Android/i.test(navigator.userAgent)) {
                sl.addEventListener("click", e => {
                    const rect = sl.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const leftW = Number(wrap.dataset.leftWidth) || 140;
                    const rightW = Number(wrap.dataset.rightWidth) || 140;

                    if (wrap.classList.contains("open-left") || wrap.classList.contains("open-right")) {
                        wrap.classList.remove("open-left", "open-right");
                        sl.style.transform = "translateX(0)";
                        return;
                    }
                    if (x < rect.width / 2) {
                        wrap.classList.add("open-left");
                        sl.style.transform = `translateX(${leftW}px)`;
                    } else {
                        wrap.classList.add("open-right");
                        sl.style.transform = `translateX(${-rightW}px)`;
                    }
                });
            }

            // „Çπ„Éû„ÉõÁâà„Çπ„ÉØ„Ç§„Éó
            let startX = 0, dx = 0;
            wrap.addEventListener("touchstart", e => {
                if (e.target.closest("button") || e.target.closest(".handle")) return;
                startX = e.touches[0].clientX;
                dx = 0;
                sl.style.transition = "none";
            }, { passive: true });

            wrap.addEventListener("touchmove", e => {
                if (e.touches.length === 0) return;
                dx = e.touches[0].clientX - startX;
                if (Math.abs(dx) > 8) e.preventDefault();
                sl.style.transform = `translateX(${dx}px)`;
            }, { passive: false });

            wrap.addEventListener("touchend", () => {
                sl.style.transition = "transform .15s";
                const leftW = Number(wrap.dataset.leftWidth) || 140;
                const rightW = Number(wrap.dataset.rightWidth) || 140;

                if (dx > leftW * STRONG_RATIO) {
                    isCompleted ? action("uncomplete", t.id) : action("complete", t.id);
                    sl.style.transform = "translateX(0)";
                    return;
                }
                if (dx < -rightW * STRONG_RATIO) {
                    if (t.pinned) alert("„Éî„É≥„ÇíÂ§ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
                    else action("delete", t.id);
                    sl.style.transform = "translateX(0)";
                    return;
                }

                if (dx > SNAP_THRESHOLD) {
                    wrap.classList.add("open-left");
                    sl.style.transform = `translateX(${leftW}px)`;
                } else if (dx < -SNAP_THRESHOLD) {
                    wrap.classList.add("open-right");
                    sl.style.transform = `translateX(${-rightW}px)`;
                } else {
                    wrap.classList.remove("open-left", "open-right");
                    sl.style.transform = "translateX(0)";
                }
            });

            wrap.__taskData = t;
            wrap.dataset.taskId = t.id;
            return wrap;
        }

        // ========== „Çπ„ÉÜ„Éº„Çø„ÇπÊ©üËÉΩ ==========
        function renderHabitList() {
            const container = document.getElementById('habitList');
            container.innerHTML = HABITS.map(h => `
                <div class="habit-item">
                    <div class="habit-checkbox" data-habit="${h.id}"></div>
                    <span class="habit-name">${h.name}</span>
                    <span class="habit-icon">${h.icon}</span>
                </div>
            `).join('');

            container.querySelectorAll('.habit-checkbox').forEach(cb => {
                cb.addEventListener('click', () => {
                    const id = cb.dataset.habit;
                    todayHabits[id] = !todayHabits[id];
                    cb.classList.toggle('checked', todayHabits[id]);
                    cb.textContent = todayHabits[id] ? '‚úì' : '';
                });
            });
        }

        async function loadHabits() {
            try {
                const res = await fetch(`${API_BASE}/habits?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                weekHabitsData = data.week || {};
                todayHabits = data.today || {};
                renderWeekView();
                renderHabitAnalysis(data);
                updateHabitCheckboxes();
            } catch (e) {
                console.error("[HABITS] error:", e);
                renderWeekView();
                renderHabitAnalysis({ week_progress: 0 });
            }
        }

        function updateHabitCheckboxes() {
            document.querySelectorAll('.habit-checkbox').forEach(cb => {
                const id = cb.dataset.habit;
                cb.classList.toggle('checked', !!todayHabits[id]);
                cb.textContent = todayHabits[id] ? '‚úì' : '';
            });
        }

        function renderWeekView() {
            const tbody = document.getElementById('weekTableBody');
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

            let html = '';
            HABITS.forEach(h => {
                html += `<tr><td>${h.icon} ${h.name}</td>`;
                days.forEach(day => {
                    const checked = weekHabitsData[day]?.[h.id] ? 'checked' : 'unchecked';
                    html += `<td class="${checked}">${checked === 'checked' ? '‚óè' : '‚óã'}</td>`;
                });
                html += '</tr>';
            });
            tbody.innerHTML = html;
        }

        function renderHabitAnalysis(data) {
            const progress = data.week_progress || 0;
            document.getElementById('weekProgressValue').textContent = `${progress}%`;
            document.getElementById('weekProgressBar').style.width = `${progress}%`;
        }

        async function saveHabits() {
            try {
                await fetch(`${API_BASE}/habits/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        date: new Date().toISOString().split('T')[0],
                        habits: todayHabits
                    })
                });
                document.getElementById('dailyTaskCard').classList.remove('expanded');
                await loadHabits();
                alert('‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
            } catch (e) {
                console.error("[HABITS] save error:", e);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // ========== „Ç∏„É£„Éº„Éä„É´Ê©üËÉΩ ==========
        async function loadJournals() {
            const container = document.getElementById('journalList');
            try {
                const res = await fetch(`${API_BASE}/journals?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                renderJournals(data.journals || []);
            } catch (e) {
                console.error("[JOURNALS] error:", e);
                container.innerHTML = '<div class="empty-state">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            }
        }

        function renderJournals(journals) {
            const container = document.getElementById('journalList');
            if (journals.length === 0) {
                container.innerHTML = '<div class="empty-state">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            container.innerHTML = journals.map(j => `
                <div class="journal-card" data-id="${j.id}">
                    <div class="journal-card-header">
                        <div class="journal-date">üìÖ ${formatDate(j.date)}</div>
                        <div class="journal-tasks-count">‚úì ${j.tasks_completed_count || 0}„Çø„Çπ„ÇØÈÅîÊàê</div>
                    </div>
                    <div class="journal-title-text">${j.title || 'ÁÑ°È°å'}</div>
                    <div class="journal-preview">${(j.content || '').substring(0, 50)}...</div>
                    <div class="journal-card-expand">
                        <div class="journal-full-content">
                            <div class="journal-body">${j.content || ''}</div>
                            <button class="journal-edit-btn">Á∑®ÈõÜ„Åô„Çã</button>
                        </div>
                    </div>
                </div>
            `).join('');

            container.querySelectorAll('.journal-card').forEach(card => {
                card.addEventListener('click', e => {
                    if (!e.target.closest('.journal-edit-btn')) {
                        card.classList.toggle('expanded');
                    }
                });
            });
        }

        async function saveJournal() {
            const date = document.getElementById('journalDate').value;
            const title = document.getElementById('journalTitle').value.trim();
            const content = document.getElementById('journalContent').value.trim();

            if (!title && !content) {
                alert('„Çø„Ç§„Éà„É´„Åæ„Åü„ÅØÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            try {
                await fetch(`${API_BASE}/journals/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, date, title, content })
                });
                document.getElementById('journalTitle').value = '';
                document.getElementById('journalContent').value = '';
                await loadJournals();
                alert('‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
            } catch (e) {
                console.error("[JOURNALS] save error:", e);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // ========== „É¢„Éº„ÉÄ„É´ ==========
        function bindModalUI() {
            const modal = document.getElementById('detailModal');
            const close = () => modal.classList.remove("visible");

            document.getElementById('detailBackdrop').onclick = close;
            document.getElementById('detailCloseBtn').onclick = close;
            document.getElementById('detailCancelBtn').onclick = close;

            ['Priority', 'Vision', 'Excite', 'Growth'].forEach(name => {
                const input = document.getElementById(`input${name}`);
                const val = document.getElementById(`val${name}`);
                input.addEventListener('input', () => val.textContent = input.value);
            });

            document.getElementById('inputRemindAt').addEventListener('change', e => {
                const val = document.getElementById('valRemindAt');
                val.textContent = e.target.value ? formatRemindLabel(new Date(e.target.value).toISOString()) : '';
            });

            document.getElementById('detailSaveBtn').onclick = async () => {
                if (!currentDetailTask) return;

                if (modalMode === "detail") {
                    await action("update_detail", currentDetailTask.id, {
                        priority: Number(document.getElementById('inputPriority').value),
                        vision_score: Number(document.getElementById('inputVision').value),
                        excite_score: Number(document.getElementById('inputExcite').value),
                        growth_score: Number(document.getElementById('inputGrowth').value),
                    });
                } else {
                    const inputVal = document.getElementById('inputRemindAt').value;
                    const remind_at = inputVal ? new Date(inputVal).toISOString() : null;
                    await action("remind_custom", currentDetailTask.id, {
                        remind_at,
                        kind: remind_at ? "custom_datetime" : "clear",
                    });
                }
                close();
            };
        }

        function openDetail(t) {
            modalMode = "detail";
            currentDetailTask = t;
            document.getElementById('modalTitle').textContent = "„Çø„Çπ„ÇØË©≥Á¥∞";
            document.getElementById('detailTaskTitle').textContent = t.task_name || t.title || "(ÁÑ°È°å)";
            document.getElementById('scoreGroup').style.display = "block";
            document.getElementById('remindGroup').style.display = "none";

            ['Priority', 'Vision', 'Excite', 'Growth'].forEach(name => {
                const key = name.toLowerCase() + (name === 'Priority' ? '' : '_score');
                const val = t[key] ?? t[name.toLowerCase() + '_score'] ?? 0;
                document.getElementById(`input${name}`).value = val;
                document.getElementById(`val${name}`).textContent = val;
            });

            document.getElementById('inputPriority').value = t.priority ?? 0;
            document.getElementById('valPriority').textContent = t.priority ?? 0;
            document.getElementById('inputVision').value = t.vision_score ?? 0;
            document.getElementById('valVision').textContent = t.vision_score ?? 0;
            document.getElementById('inputExcite').value = t.excite_score ?? 0;
            document.getElementById('valExcite').textContent = t.excite_score ?? 0;
            document.getElementById('inputGrowth').value = t.growth_score ?? 0;
            document.getElementById('valGrowth').textContent = t.growth_score ?? 0;

            document.getElementById('detailModal').classList.add("visible");
        }

        function openRemind(t) {
            modalMode = "remind";
            currentDetailTask = t;
            document.getElementById('modalTitle').textContent = "ÈÄöÁü•Ë®≠ÂÆö";
            document.getElementById('detailTaskTitle').textContent = t.task_name || t.title || "(ÁÑ°È°å)";
            document.getElementById('scoreGroup').style.display = "none";
            document.getElementById('remindGroup').style.display = "block";

            const input = document.getElementById('inputRemindAt');
            const val = document.getElementById('valRemindAt');
            if (t.remind_at) {
                input.value = toLocalDatetimeValue(t.remind_at);
                val.textContent = formatRemindLabel(t.remind_at);
            } else {
                input.value = '';
                val.textContent = '';
            }

            document.getElementById('detailModal').classList.add("visible");
        }

        // ========== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ==========
        function mkBtn(label, onClick, cls) {
            const b = document.createElement("button");
            b.textContent = label;
            if (cls) b.className = cls;
            b.addEventListener("click", e => {
                e.stopPropagation();
                e.preventDefault();
                onClick();
            });
            return b;
        }

        async function action(kind, id, extra = {}) {
            try {
                const res = await fetch(`${API_BASE}/action`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId, action: kind, task_id: id, ...extra })
                });
                if (!res.ok) alert("Êìç‰Ωú„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
            } catch (e) {
                console.error("[ACTION] error:", e);
                alert("ÈÄö‰ø°„Ç®„É©„Éº");
            } finally {
                if (kind !== "remind_custom") loadList();
            }
        }

        function formatRemindLabel(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            return `üîî${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        function toLocalDatetimeValue(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}T${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
        }

        init();
    </script>
</body>
</html>
