<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LISTÔΩú„Çø„Çπ„ÇØ‰∏ÄË¶ß</title>
<style>
  body { font-family: -apple-system, system-ui; margin:0; background:#f7f7f8; }

  header { position:sticky; top:0; background:#fff; border-bottom:1px solid #eee; z-index:10; }
  .bar { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; }

  .tab { padding:6px 12px; border-radius:14px; border:1px solid #ddd; font-size:13px; cursor:pointer; }
  .tab.active { background:#111; color:white; border-color:#111; }

  .add { display:flex; gap:8px; padding:12px 16px; }
  .add input { flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; }

  .list { display:flex; flex-direction:column; }

  .card {
    position:relative;
    background:white;
    border-bottom:1px solid #eee;
    height:60px;
    overflow:hidden;
    touch-action:pan-y;
  }
  .card.completed .title { color:#aaa; text-decoration:line-through; }

  .sl {
    position:relative;
    height:100%; width:100%;
    display:flex;
    align-items:center;
    padding:0 12px;
    transition:transform .15s ease;
    background:white;
    z-index:2;
  }

  .actions-rail {
    position:absolute; inset:0;
    display:flex; justify-content:space-between; align-items:center;
    pointer-events:none; z-index:1;
  }

    /* „Çπ„ÉØ„Ç§„Éó„ÅßÈñã„ÅÑ„Å¶„ÅÑ„Çã„Å®„Åç„Å†„Åë„Éú„Çø„É≥„ÇíÊäº„Åõ„Çã„Çà„ÅÜ„Å´„Åô„Çã */
  .card.open-left .actions-rail,
  .card.open-right .actions-rail {
    pointer-events: auto;
  }


  :root { --rail-w:140px; }

  .actions-left, .actions-right {
    width:var(--rail-w);
    height:100%;
    display:flex; align-items:center;
  }
  .actions-left { background:#e8f7ee; justify-content:flex-start; }
  .actions-right { background:#fdeeee; justify-content:flex-end; }

  .actions-rail button {
    height:100%; min-width:64px; border:none; color:white; font-size:13px;
    border-radius:0; cursor:pointer;
  }

  .btn-complete { background:#7e6dff; }
  .btn-plus2h   { background:#8012e2; }
  .btn-detail   { background:#1e928b; }
  .btn-pin      { background:#d97706; }
  .btn-delete   { background:#f03d30; }

  .title { font-size:15px; }

  .handle {
    margin-left:auto; cursor:grab; opacity:0.1;
    -webkit-user-select:none; user-select:none;
    padding:0 12px; font-size:20px;
  }

  .divider-label { text-align:center; color:#888; font-size:12px; padding:6px 0; }

  /* Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ */
  .modal-root { position:fixed; inset:0; display:none; z-index:50; align-items:flex-end; justify-content:center; }
  .modal-root.visible { display:flex; }
  .modal-backdrop { position:absolute; inset:0; background:rgba(0,0,0,.25); }
  .modal-panel {
    width:100%; max-width:480px; background:#fff;
    border-radius:20px 20px 0 0; padding:16px;
    animation:slideUp .18s ease-out;
  }
  @keyframes slideUp { from{ transform:translateY(40px); opacity:0;} to{ transform:translateY(0); opacity:1;} }

  .slider-group { margin:14px 0; }
  .slider-label-row { display:flex; justify-content:space-between; font-size:12px; }
  .slider-label-row span.value { font-size:13px; font-weight:600; }

  .modal-footer { display:flex; justify-content:flex-end; gap:8px; margin-top:14px; }
  .btn-secondary { padding:8px 14px; border:1px solid #ddd; border-radius:20px; background:#fafafa; cursor:pointer; }
  .btn-primary-solid { padding:8px 16px; border-radius:20px; background:#7e6dff; color:white; border:none; cursor:pointer; }
</style>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<header>
  <div class="bar">
    <div style="font-weight:600">LIST</div>
    <div class="tab active">„Çø„Çπ„ÇØ</div>
    <div class="tab" id="refreshBtn">‚Üª</div>
  </div>
</header>

<main>
  <div class="add">
    <input id="newTitle" placeholder="„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ‚Ä¶" />
    <button id="btnAdd" class="tab" style="background:#111;color:white;border-color:#111">ËøΩÂä†</button>
  </div>

  <div class="divider-label">Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ</div>
  <div id="pinned" class="list"></div>
  <div id="active" class="list"></div>

  <div class="divider-label" style="margin-top:16px;">ÈÅîÊàê„Çø„Çπ„ÇØ</div>
  <div id="completed" class="list"></div>
</main>

<!-- Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
<div id="detailModal" class="modal-root">
  <div id="detailBackdrop" class="modal-backdrop"></div>
  <div class="modal-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:600">„Çø„Çπ„ÇØË©≥Á¥∞</div>
      <button id="detailCloseBtn" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
    </div>

    <div id="detailTaskTitle" style="font-size:13px;color:#555;margin-bottom:8px;"></div>

    <div class="slider-group">
      <div class="slider-label-row"><span>ÂÑ™ÂÖàÂ∫¶</span><span class="value" id="valPriority"></span></div>
      <input id="inputPriority" type="range" min="0" max="10" step="1"/>
    </div>

    <div class="slider-group">
      <div class="slider-label-row"><span>„Éì„Ç∏„Éß„É≥Èñ¢ÈÄ£Â∫¶</span><span class="value" id="valVision"></span></div>
      <input id="inputVision" type="range" min="0" max="10" step="1"/>
    </div>

    <div class="slider-group">
      <div class="slider-label-row"><span>„Çè„Åè„Çè„ÅèÂ∫¶</span><span class="value" id="valExcite"></span></div>
      <input id="inputExcite" type="range" min="0" max="10" step="1"/>
    </div>

    <div class="slider-group">
      <div class="slider-label-row"><span>ÊàêÈï∑Â∫¶</span><span class="value" id="valGrowth"></span></div>
      <input id="inputGrowth" type="range" min="0" max="10" step="1"/>
    </div>

    <div class="modal-footer">
      <button id="detailCancelBtn" class="btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
      <button id="detailSaveBtn" class="btn-primary-solid">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<script>
const LIFF_ID = "2008372898-2q9qWmxv";
const API_BASE = "https://yamasho.xvps.jp/webhook";
let userId = null;
let currentDetailTask = null;

const EXPOSE_W = 140;
const EXPOSE_X = 200;

// DOM„Ç≠„É£„ÉÉ„Ç∑„É•
const pinnedEl    = document.getElementById("pinned");
const activeEl    = document.getElementById("active");
const completedEl = document.getElementById("completed");
const refreshBtn  = document.getElementById("refreshBtn");
const btnAdd      = document.getElementById("btnAdd");
const newTitle    = document.getElementById("newTitle");

// „É¢„Éº„ÉÄ„É´Ë¶ÅÁ¥†
const detailModal      = document.getElementById("detailModal");
const detailBackdrop   = document.getElementById("detailBackdrop");
const detailCloseBtn   = document.getElementById("detailCloseBtn");
const detailCancelBtn  = document.getElementById("detailCancelBtn");
const detailSaveBtn    = document.getElementById("detailSaveBtn");
const detailTaskTitle  = document.getElementById("detailTaskTitle");

const inputPriority = document.getElementById("inputPriority");
const inputVision   = document.getElementById("inputVision");
const inputExcite   = document.getElementById("inputExcite");
const inputGrowth   = document.getElementById("inputGrowth");
const valPriority   = document.getElementById("valPriority");
const valVision     = document.getElementById("valVision");
const valExcite     = document.getElementById("valExcite");
const valGrowth     = document.getElementById("valGrowth");

/* ==========================
   INIT
========================== */
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    const profile = await liff.getProfile();
    userId = profile.userId;

    bindUI();
    bindModalUI();
    await loadList();
  } catch (e) {
    console.error(e);
    alert("LIFFÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
  }
}

/* ==========================
   bindUI
========================== */
function bindUI() {
  refreshBtn.onclick = loadList;

  btnAdd.onclick = async () => {
    const title = newTitle.value.trim();
    if (!title) return;
    await action("create", null, { task_name: title });
    newTitle.value = "";
  };
}

/* ==========================
  Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ UI
========================== */
function bindModalUI() {
  const close = () => detailModal.classList.remove("visible");

  detailBackdrop.onclick = close;
  detailCloseBtn.onclick = close;
  detailCancelBtn.onclick = close;

  // „Çπ„É©„Ç§„ÉÄ„Éº„ÅÆ„É©„Éô„É´Êõ¥Êñ∞
  const bindSlider = (input, label) => {
    input.addEventListener("input", () => { label.textContent = input.value; });
  };
  bindSlider(inputPriority, valPriority);
  bindSlider(inputVision,   valVision);
  bindSlider(inputExcite,   valExcite);
  bindSlider(inputGrowth,   valGrowth);

  detailSaveBtn.onclick = async () => {
    if (!currentDetailTask) return;
    const payload = {
      priority:     Number(inputPriority.value),
      vision_score: Number(inputVision.value),
      excite_score: Number(inputExcite.value),
      growth_score: Number(inputGrowth.value),
    };
    await action("update_detail", currentDetailTask.id, payload);
    close();
  };
}

/* ==========================
  LIST API
========================== */
async function loadList() {
  try {
    const url = `${API_BASE}/list?user_id=${encodeURIComponent(userId)}`;
    console.log("[LIST] request:", url);

    const res = await fetch(url);
    const text = await res.text();
    console.log("[LIST] status:", res.status);
    console.log("[LIST] raw response:", text);

    if (!res.ok) {
      throw new Error(`list api error: ${res.status}`);
    }

    // „Å°„ÇÉ„Çì„Å®JSON„ÅåËøî„Å£„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åã„Çâ„Éë„Éº„Çπ
    const data = text ? JSON.parse(text) : {};
    console.log("[LIST] parsed json:", data);

    renderList(data);
  } catch (e) {
    console.error("[LIST] error:", e);
    alert("„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
  }
}


function renderList(payload) {
  pinnedEl.innerHTML    = "";
  activeEl.innerHTML    = "";
  completedEl.innerHTML = "";

  const pinned    = Array.isArray(payload.pinned)    ? payload.pinned    : [];
  const active    = Array.isArray(payload.active)    ? payload.active    : [];
  const completed = Array.isArray(payload.completed) ? payload.completed : [];

  pinned.forEach(t    => pinnedEl.appendChild(taskCard(t)));
  active.forEach(t    => activeEl.appendChild(taskCard(t)));
  completed.forEach(t => completedEl.appendChild(taskCard(t, true)));
}

/* ==========================
  TASK CARD
========================== */
function taskCard(t, isCompleted = false) {
  const wrap = document.createElement("div");
  wrap.className = "card";
  if (isCompleted) wrap.classList.add("completed");

  // ËÉåÈù¢„É¨„Éº„É´
  const rail = document.createElement("div");
  rail.className = "actions-rail";

  const left = document.createElement("div");
  left.className = "actions-left";

  if (!isCompleted) {
    left.append(
      mkBtn("ÂÆå‰∫Ü", () => action("complete", t.id), "btn-complete"),
      mkBtn("+2h", () => action("remind_plus2h", t.id), "btn-plus2h")
    );
  } else {
    left.append(mkBtn("Êú™ÂÆå", () => action("uncomplete", t.id), "btn-complete"));
  }

  const right = document.createElement("div");
  right.className = "actions-right";
  right.append(
    mkBtn("Ë©≥Á¥∞", () => openDetail(t), "btn-detail"),
    mkBtn(t.pinned ? "„Éî„É≥Ëß£Èô§" : "„Éî„É≥", () => action("toggle_pin", t.id), "btn-pin"),
    mkBtn("ÂâäÈô§", () => {
      if (t.pinned) return alert("„Éî„É≥„ÇíÂ§ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
      action("delete", t.id);
    }, "btn-delete")
  );

  rail.append(left, right);

  // ÂâçÈù¢
  const sl = document.createElement("div");
  sl.className = "sl";

  const titleEl = document.createElement("div");
  titleEl.className = "title";

  // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åå task_name „Åã title „Åã„ÄÅ‰∏°ÂØæÂøú„Å´„Åô„Çã
  const name = t.task_name || t.title || "(ÁÑ°È°å)";

  if (t.pinned) {
    titleEl.textContent = "üìç " + name;
  } else {
    titleEl.textContent = name;
  }

  const handle = document.createElement("div");
  handle.className = "handle";
  handle.textContent = "‚ò∞";

  sl.append(titleEl, handle);
  wrap.append(rail, sl);

  /* ==========================
      PCÁâà „ÇØ„É™„ÉÉ„ÇØ„Åß„Çπ„ÉØ„Ç§„Éó
  ========================== */
  if (!/Mobi|Android/i.test(navigator.userAgent)) {
    sl.addEventListener("click", e => {
      const rect = sl.getBoundingClientRect();
      const x = e.clientX - rect.left;

      if (wrap.classList.contains("open-left") || wrap.classList.contains("open-right")) {
        wrap.classList.remove("open-left", "open-right");
        sl.style.transform = "translateX(0)";
        return;
      }

      if (x < rect.width / 2) {
        wrap.classList.add("open-left");
        wrap.classList.remove("open-right");
        sl.style.transform = `translateX(${EXPOSE_W}px)`;
      } else {
        wrap.classList.add("open-right");
        wrap.classList.remove("open-left");
        sl.style.transform = `translateX(${-EXPOSE_X}px)`;
      }
    });
  }

  /* ==========================
      „Çπ„Éû„ÉõÁâà „Çπ„ÉØ„Ç§„Éó
  ========================== */
  let startX = 0, dx = 0;

  wrap.addEventListener("touchstart", e => {
    startX = e.touches[0].clientX;
    dx = 0;
    sl.style.transition = "none";
  }, { passive:true });

  wrap.addEventListener("touchmove", e => {
    dx = e.touches[0].clientX - startX;
    if (Math.abs(dx) > 8) e.preventDefault();
    sl.style.transform = `translateX(${dx}px)`;
  }, { passive:false });

  wrap.addEventListener("touchend", () => {
    sl.style.transition = "transform .15s";
    if (dx > 60) {
      wrap.classList.add("open-left");
      wrap.classList.remove("open-right");
      sl.style.transform = `translateX(${EXPOSE_W}px)`;
    } else if (dx < -60) {
      wrap.classList.add("open-right");
      wrap.classList.remove("open-left");
      sl.style.transform = `translateX(${-EXPOSE_X}px)`;
    } else {
      wrap.classList.remove("open-left", "open-right");
      sl.style.transform = "translateX(0)";
    }
  });

  return wrap;
}

/* ==========================
   MODAL OPEN
========================== */
function openDetail(t) {
  currentDetailTask = t;

  const name = t.task_name || t.title || "(ÁÑ°È°å)";
  detailTaskTitle.textContent = name;

  inputPriority.value = t.priority ?? 0;
  valPriority.textContent = inputPriority.value;

  inputVision.value = t.vision_score ?? 0;
  valVision.textContent = inputVision.value;

  inputExcite.value = t.excite_score ?? 0;
  valExcite.textContent = inputExcite.value;

  inputGrowth.value = t.growth_score ?? 0;
  valGrowth.textContent = inputGrowth.value;

  detailModal.classList.add("visible");
}

/* ==========================
   BUTTON HELPER
========================== */
function mkBtn(label, onClick, cls) {
  const b = document.createElement("button");
  b.textContent = label;
  if (cls) b.className = cls;
  b.onclick = e => {
    e.stopPropagation();
    onClick();
  };
  return b;
}

/* ==========================
   API ACTION
========================== */
async function action(kind, id, extra = {}) {
  try {
    const res = await fetch(`${API_BASE}/action`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: userId,
        action: kind,
        task_id: id,
        ...extra
      })
    });
    if (!res.ok) throw new Error("action api error");
    await res.json().catch(() => null); // ÂΩ¢Âºè„ÇÜ„Çã„ÇÅ
    await loadList();
  } catch (e) {
    console.error(e);
    alert("Êìç‰Ωú„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
  }
}

init();
</script>
</body>
</html>



